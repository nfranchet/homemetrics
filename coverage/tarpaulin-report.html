<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <style>:root {
  --color: black;
  --bg: white;
  --head-bg: white;
  --link: #338;

  --blue: #ccf;
  --red: #fcc;
  --yellow: #ffc;
  --green: #cfc;
}

[data-theme='dark'] {
  --color: white;
  --bg: black;
  --head-bg: #333;
  --link: #aaf;

  --blue: #225;
  --red: #522;
  --yellow: #552;
  --green: #252;
}

html,
body {
  margin: 0;
  padding: 0;
  color: var(--color);
  background: var(--bg);
}

.app {
  margin: 10px;
  padding: 0;
}

.files-list {
  margin: 10px 0 0;
  width: 100%;
  border-collapse: collapse;
}
.files-list__head {
  border: 1px solid #999;
}
.files-list__head > tr > th {
  padding: 10px;
  border: 1px solid #999;
  text-align: left;
  font-weight: normal;
  background: var(--head-bg);
}
.files-list__body {
}
.files-list__file {
  cursor: pointer;
}
.files-list__file:hover {
  background: var(--blue);
}
.files-list__file > td {
  padding: 10px;
  border: 1px solid #999;
}
.files-list__file > td:first-child::before {
  content: '\01F4C4';
  margin-right: 1em;
}
.files-list__file_low {
  background: var(--red);
}
.files-list__file_medium {
  background: var(--yellow);
}
.files-list__file_high {
  background: var(--green);
}
.files-list__file_folder > td:first-child::before {
  content: '\01F4C1';
  margin-right: 1em;
}

.file-header {
  border: 1px solid #999;
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: sticky;
  top: 0;
  background: var(--bg);
}

.file-header__back {
  margin: 10px;
  cursor: pointer;
  flex-shrink: 0;
  flex-grow: 0;
  text-decoration: underline;
  color: var(--link);
}

.file-header__name {
  margin: 10px;
  flex-shrink: 2;
  flex-grow: 2;
}

.file-header__stat {
  margin: 10px;
  flex-shrink: 0;
  flex-grow: 0;
}

.file-content {
  margin: 10px 0 0;
  border: 1px solid #999;
  padding: 10px;
  counter-reset: line;
  display: flex;
  flex-direction: column;
}

.code-line::before {
  content: counter(line);
  margin-right: 10px;
}
.code-line {
  margin: 0;
  padding: 0.3em;
  height: 1em;
  counter-increment: line;
}
.code-line_covered {
  background: var(--green);
}
.code-line_uncovered {
  background: var(--red);
}

#theme-toggle-label {
  margin-left: 1ch;
}
</style>
</head>
<body>
    <div id="root"></div>
    <script>
        var data = {"files":[{"path":["/","workspaces","homemetrics","src","attachment_parser.rs"],"content":"use anyhow::Result;\nuse log::{info, debug};\nuse mail_parser::{MessageParser, MimeHeaders};\nuse base64::{Engine as _, engine::general_purpose};\n\n#[derive(Debug)]\npub struct Attachment {\n    pub filename: String,\n    pub content: Vec\u003cu8\u003e,\n    pub content_type: String,\n}\n\npub struct AttachmentParser;\n\nimpl AttachmentParser {\n    pub fn parse_email(raw_email: \u0026[u8]) -\u003e Result\u003cVec\u003cAttachment\u003e\u003e {\n        debug!(\"Parsing email pour extraire les pi√®ces jointes\");\n        \n        // For now, using a basic but functional MIME parser\n        // We will improve this later with a better API\n        let email_str = String::from_utf8_lossy(raw_email);\n        let mut attachments = Vec::new();\n        \n        debug!(\"Email size: {} bytes\", email_str.len());\n        \n        // First analyze the MIME structure of the email\n        Self::analyze_email_structure(\u0026email_str);\n        \n        // Rechercher les sections avec Content-Disposition: attachment\n        let mut current_pos = 0;\n        while let Some(attachment_start) = email_str[current_pos..].find(\"Content-Disposition: attachment\") {\n            let abs_start = current_pos + attachment_start;\n            debug!(\"Found Content-Disposition: attachment at position {}\", abs_start);\n            \n            // Search for filename\n            if let Some(filename) = Self::extract_filename_from_headers(\u0026email_str[abs_start..]) {\n                debug!(\"Extracted filename: {}\", filename);\n                if Self::is_data_file(\u0026filename) {\n                    // Search for attachment content start\n                    if let Some(content_start) = email_str[abs_start..].find(\"\\r\\n\\r\\n\") {\n                        let abs_content_start = abs_start + content_start + 4;\n                        \n                        // Search for attachment end (next boundary)\n                        if let Some(content_end) = Self::find_attachment_end(\u0026email_str[abs_content_start..]) {\n                            let abs_content_end = abs_content_start + content_end;\n                            let content_str = \u0026email_str[abs_content_start..abs_content_end];\n                            \n                            debug!(\"Raw attachment content length: {} chars\", content_str.len());\n                            debug!(\"Raw content preview (first 200 chars): {}\", \n                                   \u0026content_str[..std::cmp::min(200, content_str.len())]);\n                            \n                            // Decode content (base64 or other)\n                            if let Ok(content) = Self::decode_attachment_content(content_str) {\n                                let content_type = Self::guess_content_type(\u0026filename);\n                                \n                                debug!(\"Attachment found: {} ({}), taille: {} bytes\", \n                                       filename, content_type, content.len());\n                                \n                                attachments.push(Attachment {\n                                    filename,\n                                    content,\n                                    content_type,\n                                });\n                            }\n                        }\n                    }\n                }\n            }\n            \n            current_pos = abs_start + 1;\n        }\n        \n        // If no attachment is found with manual approach,\n        // try alternative approaches\n        if attachments.is_empty() {\n            debug!(\"No attachments found with manual parsing, trying alternative methods\");\n            Self::try_alternative_parsing(\u0026email_str, \u0026mut attachments)?;\n        }\n        \n        info!(\"Found {} attachment(s)\", attachments.len());\n        Ok(attachments)\n    }\n    \n    fn analyze_email_structure(email_str: \u0026str) {\n        debug!(\"=== ANALYSIS OF EMAIL STRUCTURE ===\");\n        \n        // Search for boundaries\n        let boundaries: Vec\u003c_\u003e = email_str.matches(\"boundary=\").take(5).collect();\n        debug!(\"Found {} boundary declarations\", boundaries.len());\n        \n        // Search for Content-Type\n        let content_types: Vec\u003c_\u003e = email_str.matches(\"Content-Type:\").take(10).collect();\n        debug!(\"Found {} Content-Type headers\", content_types.len());\n        \n        // Search for Content-Disposition\n        let dispositions: Vec\u003c_\u003e = email_str.matches(\"Content-Disposition:\").take(10).collect();\n        debug!(\"Found {} Content-Disposition headers\", dispositions.len());\n        \n        // Display structure sample\n        let lines: Vec\u003c\u0026str\u003e = email_str.lines().collect();\n        debug!(\"Email has {} lines total\", lines.len());\n        \n        // Search for interesting patterns\n        for (i, line) in lines.iter().enumerate().take(100) {\n            if line.contains(\"Content-Type:\") || \n               line.contains(\"Content-Disposition:\") || \n               line.contains(\"boundary=\") ||\n               line.contains(\"filename=\") {\n                debug!(\"Line {}: {}\", i + 1, line.trim());\n            }\n        }\n        debug!(\"=== END EMAIL STRUCTURE ANALYSIS ===\");\n    }\n    \n    fn try_alternative_parsing(email_str: \u0026str, attachments: \u0026mut Vec\u003cAttachment\u003e) -\u003e Result\u003c()\u003e {\n        debug!(\"Trying alternative parsing methods\");\n        \n        // Method 1: Search directly for \"filename=\"\n        Self::try_filename_direct_search(email_str, attachments)?;\n        \n        // Method 2: Use mail-parser as fallback\n        if attachments.is_empty() {\n            Self::try_mail_parser_fallback(email_str.as_bytes(), attachments)?;\n        }\n        \n        Ok(())\n    }\n    \n    fn try_filename_direct_search(email_str: \u0026str, attachments: \u0026mut Vec\u003cAttachment\u003e) -\u003e Result\u003c()\u003e {\n        debug!(\"Trying direct filename search\");\n        \n        let mut current_pos = 0;\n        while let Some(filename_start) = email_str[current_pos..].find(\"filename=\") {\n            let abs_start = current_pos + filename_start;\n            let filename_line = \u0026email_str[abs_start..abs_start + std::cmp::min(200, email_str.len() - abs_start)];\n            \n            if let Some(filename) = Self::extract_filename_from_line(filename_line) {\n                debug!(\"Found filename via direct search: {}\", filename);\n                \n                if Self::is_data_file(\u0026filename) {\n                    // Search for content associated with this filename\n                    if let Some(content) = Self::find_content_for_filename(email_str, abs_start) {\n                        let content_type = Self::guess_content_type(\u0026filename);\n                        \n                        debug!(\"Found content for {}: {} bytes\", filename, content.len());\n                        \n                        attachments.push(Attachment {\n                            filename,\n                            content,\n                            content_type,\n                        });\n                    }\n                }\n            }\n            \n            current_pos = abs_start + 1;\n        }\n        \n        Ok(())\n    }\n    \n    fn extract_filename_from_line(line: \u0026str) -\u003e Option\u003cString\u003e {\n        if let Some(start) = line.find(\"filename=\") {\n            let filename_part = \u0026line[start + 9..];\n            if let Some(end) = filename_part.find(['\\r', '\\n', ';', ' ']) {\n                let filename = filename_part[..end].trim_matches('\"').trim();\n                if !filename.is_empty() {\n                    return Some(filename.to_string());\n                }\n            } else {\n                // Take rest of line\n                let filename = filename_part.trim_matches('\"').trim();\n                if !filename.is_empty() {\n                    return Some(filename.to_string());\n                }\n            }\n        }\n        None\n    }\n    \n    fn find_content_for_filename(email_str: \u0026str, filename_pos: usize) -\u003e Option\u003cVec\u003cu8\u003e\u003e {\n        // Start from filename position and search for content\n        let start_search = \u0026email_str[filename_pos..];\n        \n        // Search for end of headers (double CRLF)\n        if let Some(content_start_rel) = start_search.find(\"\\r\\n\\r\\n\") {\n            let content_start = filename_pos + content_start_rel + 4;\n            \n            // Search for content end (next boundary or email end)\n            let content_search = \u0026email_str[content_start..];\n            let content_end = if let Some(boundary_pos) = content_search.find(\"\\r\\n--\") {\n                content_start + boundary_pos\n            } else {\n                email_str.len()\n            };\n            \n            let content_str = \u0026email_str[content_start..content_end];\n            debug!(\"Found content block of {} chars for attachment\", content_str.len());\n            \n            if let Ok(decoded) = Self::decode_attachment_content(content_str) {\n                return Some(decoded);\n            }\n        }\n        \n        None\n    }\n    \n    fn try_mail_parser_fallback(raw_email: \u0026[u8], attachments: \u0026mut Vec\u003cAttachment\u003e) -\u003e Result\u003c()\u003e {\n        debug!(\"Trying mail-parser fallback\");\n        \n        if let Some(message) = MessageParser::default().parse(raw_email) {\n            debug!(\"mail-parser successfully parsed the message\");\n            debug!(\"Message has {} attachments\", message.attachments().count());\n            \n            for (i, part) in message.attachments().enumerate() {\n                debug!(\"Processing attachment {}\", i);\n                \n                \n                // Try to extract real attachment content\n                let contents = part.contents();\n                debug!(\"Attachment {} content size: {} bytes\", i, contents.len());\n                \n                // Essayer d'extraire le vrai nom du fichier\n                let filename = Self::extract_real_filename_from_part(part, i);\n                debug!(\"Extracted filename for attachment {}: {}\", i, filename);\n                \n                // If content seems valid, use it\n                if contents.len() \u003e 10 {\n                    let content_type = Self::guess_content_type(\u0026filename);\n                    \n                    debug!(\"Using real attachment content: {} bytes\", contents.len());\n                    \n                    attachments.push(Attachment {\n                        filename,\n                        content: contents.to_vec(),\n                        content_type,\n                    });\n                } else {\n                    debug!(\"Content too small for attachment {}, skipping\", i);\n                }\n            }\n        }\n        \n        Ok(())\n    }\n    \n    fn extract_real_filename_from_part(part: \u0026mail_parser::MessagePart, index: usize) -\u003e String {\n        // Try different methods to extract filename\n        \n        debug!(\"Trying to extract filename from attachment {}\", index);\n        \n        \n        let filename = part.attachment_name().unwrap().to_string();\n        debug!(\"Generated filename: {}\", filename);\n        filename\n    }    \n    \n    fn extract_filename_from_headers(headers: \u0026str) -\u003e Option\u003cString\u003e {\n        // Chercher filename= dans les headers\n        if let Some(filename_start) = headers.find(\"filename=\") {\n            let filename_part = \u0026headers[filename_start + 9..];\n            if let Some(filename_end) = filename_part.find(['\\r', '\\n', ';']) {\n                let filename = filename_part[..filename_end].trim_matches('\"').trim();\n                if !filename.is_empty() {\n                    return Some(filename.to_string());\n                }\n            }\n        }\n        None\n    }\n    \n    fn find_attachment_end(content: \u0026str) -\u003e Option\u003cusize\u003e {\n        // Search for next boundary or message end\n        if let Some(boundary_pos) = content.find(\"--\") {\n            Some(boundary_pos)\n        } else {\n            Some(content.len())\n        }\n    }\n    \n    fn decode_attachment_content(content_str: \u0026str) -\u003e Result\u003cVec\u003cu8\u003e\u003e {\n        let content_str = content_str.trim();\n        \n        debug!(\"Attempting to decode content of {} chars\", content_str.len());\n        \n        // Detect encoding type based on content\n        if Self::is_base64_content(content_str) {\n            debug!(\"Detected base64 encoding\");\n            if let Ok(decoded) = general_purpose::STANDARD.decode(content_str.replace(['\\r', '\\n', ' '], \"\")) {\n                debug!(\"Successfully decoded {} bytes from base64\", decoded.len());\n                return Ok(decoded);\n            } else {\n                debug!(\"Base64 decoding failed, trying without whitespace removal\");\n                if let Ok(decoded) = general_purpose::STANDARD.decode(content_str) {\n                    debug!(\"Successfully decoded {} bytes from base64 (second attempt)\", decoded.len());\n                    return Ok(decoded);\n                }\n            }\n        } else if Self::is_quoted_printable_content(content_str) {\n            debug!(\"Detected quoted-printable encoding\");\n            if let Ok(decoded) = Self::decode_quoted_printable(content_str) {\n                debug!(\"Successfully decoded {} bytes from quoted-printable\", decoded.len());\n                return Ok(decoded);\n            }\n        } else {\n            debug!(\"Content appears to be plain text\");\n        }\n        \n        // If no special decoding worked, treat as plain text\n        let result = content_str.as_bytes().to_vec();\n        debug!(\"Using content as raw bytes: {} bytes\", result.len());\n        Ok(result)\n    }\n    \n    fn is_base64_content(content: \u0026str) -\u003e bool {\n        // Base64 contains only A-Z, a-z, 0-9, +, /, = and whitespace characters\n        let clean_content: String = content.chars()\n            .filter(|c| !c.is_whitespace())\n            .collect();\n        \n        if clean_content.is_empty() {\n            return false;\n        }\n        \n        // Check that all characters are valid for base64\n        let valid_chars = clean_content.chars()\n            .all(|c| c.is_ascii_alphanumeric() || c == '+' || c == '/' || c == '=');\n        \n        // And check there is a reasonable density of base64 characters\n        let base64_ratio = clean_content.chars()\n            .filter(|c| c.is_ascii_alphanumeric() || *c == '+' || *c == '/')\n            .count() as f64 / clean_content.len() as f64;\n        \n        valid_chars \u0026\u0026 base64_ratio \u003e 0.8 \u0026\u0026 clean_content.len() \u003e 10\n    }\n    \n    fn is_quoted_printable_content(content: \u0026str) -\u003e bool {\n        // Quoted-printable contains =XX sequences where XX are hex digits\n        content.contains(\"=\") \u0026\u0026 \n        content.chars().filter(|c| *c == '=').count() \u003e 2\n    }\n    \n    fn decode_quoted_printable(content: \u0026str) -\u003e Result\u003cVec\u003cu8\u003e\u003e {\n        let mut result = Vec::new();\n        let mut chars = content.chars().peekable();\n        \n        while let Some(ch) = chars.next() {\n            if ch == '=' {\n                if let (Some(h1), Some(h2)) = (chars.next(), chars.next()) {\n                    if let (Some(d1), Some(d2)) = (h1.to_digit(16), h2.to_digit(16)) {\n                        result.push((d1 * 16 + d2) as u8);\n                    } else {\n                        // Malformed sequence, keep as is\n                        result.push(ch as u8);\n                        result.push(h1 as u8);\n                        result.push(h2 as u8);\n                    }\n                } else {\n                    // End of string, keep the =\n                    result.push(ch as u8);\n                }\n            } else if ch == '\\r' {\n                // Skip CR in CRLF sequences\n                if chars.peek() == Some(\u0026'\\n') {\n                    chars.next(); // Skip the LF too\n                }\n            } else if ch != '\\n' || !result.is_empty() {\n                // Keep LF only if it's not at the beginning\n                result.push(ch as u8);\n            }\n        }\n        \n        Ok(result)\n    }\n    \n    fn guess_content_type(filename: \u0026str) -\u003e String {\n        let lowercase_name = filename.to_lowercase();\n        if lowercase_name.ends_with(\".csv\") {\n            \"text/csv\".to_string()\n        } else if lowercase_name.ends_with(\".json\") {\n            \"application/json\".to_string()\n        } else if lowercase_name.ends_with(\".xml\") {\n            \"application/xml\".to_string()\n        } else if lowercase_name.ends_with(\".txt\") {\n            \"text/plain\".to_string()\n        } else if lowercase_name.ends_with(\".xlsx\") {\n            \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\".to_string()\n        } else if lowercase_name.ends_with(\".xls\") {\n            \"application/vnd.ms-excel\".to_string()\n        } else {\n            \"application/octet-stream\".to_string()\n        }\n    }\n    \n\n    \n    fn is_data_file(filename: \u0026str) -\u003e bool {\n        let lowercase_name = filename.to_lowercase();\n        lowercase_name.ends_with(\".csv\") ||\n        lowercase_name.ends_with(\".json\") ||\n        lowercase_name.ends_with(\".xml\") ||\n        lowercase_name.ends_with(\".txt\") ||\n        lowercase_name.ends_with(\".xlsx\") ||\n        lowercase_name.ends_with(\".xls\")\n    }\n    \n    \n}","traces":[{"line":16,"address":[7358564,7353536,7359843],"length":1,"stats":{"Line":1}},{"line":17,"address":[5180599,5180727],"length":1,"stats":{"Line":2}},{"line":21,"address":[5758132],"length":1,"stats":{"Line":1}},{"line":22,"address":[7353701],"length":1,"stats":{"Line":1}},{"line":24,"address":[7361443,7361580,7361536],"length":1,"stats":{"Line":3}},{"line":27,"address":[7354038,7354458],"length":1,"stats":{"Line":2}},{"line":30,"address":[7354465],"length":1,"stats":{"Line":1}},{"line":31,"address":[7354477,7358841],"length":1,"stats":{"Line":2}},{"line":32,"address":[7354747,7354800,7354687],"length":1,"stats":{"Line":2}},{"line":33,"address":[5181751,5181823,5181867],"length":1,"stats":{"Line":3}},{"line":36,"address":[5185705,5181829,5182167],"length":1,"stats":{"Line":2}},{"line":37,"address":[7355516,7355337,7355476],"length":1,"stats":{"Line":0}},{"line":38,"address":[7363320,7362994],"length":1,"stats":{"Line":0}},{"line":40,"address":[7355862],"length":1,"stats":{"Line":0}},{"line":41,"address":[7363700,7363580],"length":1,"stats":{"Line":0}},{"line":44,"address":[7363665,7363745,7366193],"length":1,"stats":{"Line":0}},{"line":45,"address":[7356455,7356388],"length":1,"stats":{"Line":0}},{"line":46,"address":[5760944,5760856],"length":1,"stats":{"Line":0}},{"line":48,"address":[7364100,7364206],"length":1,"stats":{"Line":0}},{"line":49,"address":[7357311,7357080,7356654,7357040],"length":1,"stats":{"Line":0}},{"line":53,"address":[5761953,5762969,5761506,5762044],"length":1,"stats":{"Line":0}},{"line":54,"address":[5184748,5184660],"length":1,"stats":{"Line":0}},{"line":56,"address":[5762684],"length":1,"stats":{"Line":0}},{"line":59,"address":[5184986],"length":1,"stats":{"Line":0}},{"line":60,"address":[5184866],"length":1,"stats":{"Line":0}},{"line":61,"address":[7365414],"length":1,"stats":{"Line":0}},{"line":62,"address":[5762386],"length":1,"stats":{"Line":0}},{"line":70,"address":[5763257,5763270,5763209],"length":1,"stats":{"Line":2}},{"line":75,"address":[5763298,5759158],"length":1,"stats":{"Line":2}},{"line":76,"address":[7366513,7366429],"length":1,"stats":{"Line":2}},{"line":77,"address":[5763401,5763666],"length":1,"stats":{"Line":2}},{"line":80,"address":[7366876,7366384,7366992],"length":1,"stats":{"Line":3}},{"line":81,"address":[7359386],"length":1,"stats":{"Line":1}},{"line":84,"address":[5767989,5767995,5764272],"length":1,"stats":{"Line":1}},{"line":85,"address":[7360101,7359895],"length":1,"stats":{"Line":2}},{"line":88,"address":[5764368],"length":1,"stats":{"Line":1}},{"line":89,"address":[5187291,5187344,5187017],"length":1,"stats":{"Line":3}},{"line":92,"address":[7360349,7360714],"length":1,"stats":{"Line":2}},{"line":93,"address":[5765162,5765258,5765311],"length":1,"stats":{"Line":3}},{"line":96,"address":[5187840,5188219],"length":1,"stats":{"Line":2}},{"line":97,"address":[5765689,5765785,5765825],"length":1,"stats":{"Line":3}},{"line":100,"address":[5765815,5766168],"length":1,"stats":{"Line":2}},{"line":101,"address":[5188831,5188735,5188875],"length":1,"stats":{"Line":3}},{"line":104,"address":[7369411,7369792],"length":1,"stats":{"Line":2}},{"line":105,"address":[7370111,7370501],"length":1,"stats":{"Line":2}},{"line":106,"address":[7370512,7370592],"length":1,"stats":{"Line":2}},{"line":107,"address":[7370603],"length":1,"stats":{"Line":1}},{"line":108,"address":[7370652],"length":1,"stats":{"Line":1}},{"line":109,"address":[7363042,7363203],"length":1,"stats":{"Line":2}},{"line":112,"address":[7362718,7362644],"length":1,"stats":{"Line":2}},{"line":115,"address":[5190576],"length":1,"stats":{"Line":1}},{"line":116,"address":[5768167,5768061],"length":1,"stats":{"Line":2}},{"line":119,"address":[5768306,5768106],"length":1,"stats":{"Line":1}},{"line":122,"address":[5768349],"length":1,"stats":{"Line":1}},{"line":123,"address":[7371533],"length":1,"stats":{"Line":1}},{"line":126,"address":[5190918],"length":1,"stats":{"Line":1}},{"line":129,"address":[7366470,7366569,7364160],"length":1,"stats":{"Line":1}},{"line":130,"address":[5768551,5768645],"length":1,"stats":{"Line":2}},{"line":132,"address":[7364292],"length":1,"stats":{"Line":1}},{"line":133,"address":[5191393,5193564,5191200],"length":1,"stats":{"Line":2}},{"line":134,"address":[5191601,5191484,5191559],"length":1,"stats":{"Line":0}},{"line":135,"address":[5191622,5191567,5191803],"length":1,"stats":{"Line":0}},{"line":137,"address":[5191816,5191743,5193440],"length":1,"stats":{"Line":0}},{"line":138,"address":[7372639,7372472,7372605],"length":1,"stats":{"Line":0}},{"line":140,"address":[5192011,5192307,5193408],"length":1,"stats":{"Line":0}},{"line":142,"address":[7372987,7373947],"length":1,"stats":{"Line":0}},{"line":143,"address":[7365713,7365591],"length":1,"stats":{"Line":0}},{"line":145,"address":[7365815,7365728,7366078],"length":1,"stats":{"Line":0}},{"line":147,"address":[5192849],"length":1,"stats":{"Line":0}},{"line":148,"address":[7365833],"length":1,"stats":{"Line":0}},{"line":149,"address":[5192769],"length":1,"stats":{"Line":0}},{"line":150,"address":[5770249],"length":1,"stats":{"Line":0}},{"line":156,"address":[7366677,7366627,7366664],"length":1,"stats":{"Line":0}},{"line":159,"address":[5768947],"length":1,"stats":{"Line":1}},{"line":162,"address":[7366704],"length":1,"stats":{"Line":0}},{"line":163,"address":[7366763],"length":1,"stats":{"Line":0}},{"line":164,"address":[7374377,7374319,7374494],"length":1,"stats":{"Line":0}},{"line":165,"address":[5193892,5193798],"length":1,"stats":{"Line":0}},{"line":166,"address":[5771345],"length":1,"stats":{"Line":0}},{"line":167,"address":[5193978],"length":1,"stats":{"Line":0}},{"line":168,"address":[5771521],"length":1,"stats":{"Line":0}},{"line":172,"address":[5771443],"length":1,"stats":{"Line":0}},{"line":173,"address":[5194056],"length":1,"stats":{"Line":0}},{"line":174,"address":[7374782],"length":1,"stats":{"Line":0}},{"line":178,"address":[7366840],"length":1,"stats":{"Line":0}},{"line":181,"address":[5194224],"length":1,"stats":{"Line":0}},{"line":183,"address":[5194304],"length":1,"stats":{"Line":0}},{"line":186,"address":[7367459],"length":1,"stats":{"Line":0}},{"line":187,"address":[5771836,5771879,5772007],"length":1,"stats":{"Line":0}},{"line":190,"address":[7367611],"length":1,"stats":{"Line":0}},{"line":191,"address":[5771966,5772025,5772085],"length":1,"stats":{"Line":0}},{"line":192,"address":[7367760,7367718,7367767],"length":1,"stats":{"Line":0}},{"line":194,"address":[7375247],"length":1,"stats":{"Line":0}},{"line":197,"address":[7375299],"length":1,"stats":{"Line":0}},{"line":198,"address":[5194718,5194817],"length":1,"stats":{"Line":0}},{"line":200,"address":[7368211,7367878],"length":1,"stats":{"Line":0}},{"line":201,"address":[5195138],"length":1,"stats":{"Line":0}},{"line":205,"address":[5771856],"length":1,"stats":{"Line":0}},{"line":208,"address":[5776922,5772688,5776793],"length":1,"stats":{"Line":1}},{"line":209,"address":[7368555,7368423],"length":1,"stats":{"Line":2}},{"line":211,"address":[5773091,5772804],"length":1,"stats":{"Line":2}},{"line":212,"address":[5773276,5773418,5773472],"length":1,"stats":{"Line":3}},{"line":213,"address":[7376896,7376608,7376940],"length":1,"stats":{"Line":3}},{"line":215,"address":[7372461,7369398,7369822],"length":1,"stats":{"Line":3}},{"line":216,"address":[5774440,5774366,5774484],"length":1,"stats":{"Line":3}},{"line":220,"address":[7370142,7370472],"length":1,"stats":{"Line":2}},{"line":221,"address":[5197382,5197474],"length":1,"stats":{"Line":2}},{"line":224,"address":[5197448,5197811],"length":1,"stats":{"Line":2}},{"line":225,"address":[5775375,5775259,5775346],"length":1,"stats":{"Line":3}},{"line":228,"address":[7371048,7372448],"length":1,"stats":{"Line":2}},{"line":229,"address":[7371422,7371755],"length":1,"stats":{"Line":2}},{"line":231,"address":[7379361,7379445,7379274],"length":1,"stats":{"Line":3}},{"line":233,"address":[5776630],"length":1,"stats":{"Line":1}},{"line":234,"address":[7379383],"length":1,"stats":{"Line":1}},{"line":235,"address":[5198791],"length":1,"stats":{"Line":1}},{"line":236,"address":[7372278],"length":1,"stats":{"Line":1}},{"line":239,"address":[7378876,7378975,7378950],"length":1,"stats":{"Line":0}},{"line":244,"address":[5199435],"length":1,"stats":{"Line":1}},{"line":247,"address":[5777698,5777704,5776944],"length":1,"stats":{"Line":1}},{"line":250,"address":[5776979,5777111],"length":1,"stats":{"Line":2}},{"line":253,"address":[7380215],"length":1,"stats":{"Line":1}},{"line":254,"address":[7373130,7373071,7372762],"length":1,"stats":{"Line":3}},{"line":255,"address":[5199951],"length":1,"stats":{"Line":1}},{"line":258,"address":[5200288],"length":1,"stats":{"Line":1}},{"line":260,"address":[5777787],"length":1,"stats":{"Line":1}},{"line":261,"address":[7381203,7381039,7381097],"length":1,"stats":{"Line":0}},{"line":262,"address":[7381142,7381226],"length":1,"stats":{"Line":0}},{"line":263,"address":[7373735],"length":1,"stats":{"Line":0}},{"line":264,"address":[5200671],"length":1,"stats":{"Line":0}},{"line":265,"address":[7373831],"length":1,"stats":{"Line":0}},{"line":269,"address":[7381064],"length":1,"stats":{"Line":1}},{"line":272,"address":[5778208],"length":1,"stats":{"Line":0}},{"line":274,"address":[5200791,5200854],"length":1,"stats":{"Line":0}},{"line":275,"address":[5200840],"length":1,"stats":{"Line":0}},{"line":277,"address":[7381505],"length":1,"stats":{"Line":0}},{"line":281,"address":[5202734,5200912,5202693],"length":1,"stats":{"Line":0}},{"line":282,"address":[7381629],"length":1,"stats":{"Line":0}},{"line":284,"address":[5201105,5201034],"length":1,"stats":{"Line":0}},{"line":287,"address":[7374223,7377877],"length":1,"stats":{"Line":0}},{"line":288,"address":[7374531,7376069],"length":1,"stats":{"Line":0}},{"line":289,"address":[5203148,5202778],"length":1,"stats":{"Line":0}},{"line":290,"address":[5780826,5780724,5780628],"length":1,"stats":{"Line":0}},{"line":291,"address":[7383946],"length":1,"stats":{"Line":0}},{"line":293,"address":[5781304,5780540,5781257],"length":1,"stats":{"Line":0}},{"line":294,"address":[5203839,5204134,5204079],"length":1,"stats":{"Line":0}},{"line":295,"address":[7377408,7377510,7377318],"length":1,"stats":{"Line":0}},{"line":296,"address":[7384926],"length":1,"stats":{"Line":0}},{"line":299,"address":[5781184,5782143,5781138,5782628,5778824,5782104],"length":1,"stats":{"Line":0}},{"line":300,"address":[7374620,7375005],"length":1,"stats":{"Line":0}},{"line":301,"address":[7374946,7375196],"length":1,"stats":{"Line":0}},{"line":302,"address":[5779531,5779627,5779774],"length":1,"stats":{"Line":0}},{"line":303,"address":[5779645],"length":1,"stats":{"Line":0}},{"line":306,"address":[5779059,5778881],"length":1,"stats":{"Line":0}},{"line":310,"address":[7382186],"length":1,"stats":{"Line":0}},{"line":311,"address":[5204882,5201571,5204780],"length":1,"stats":{"Line":0}},{"line":312,"address":[5204794],"length":1,"stats":{"Line":0}},{"line":315,"address":[7379041,7378384,7379035],"length":1,"stats":{"Line":0}},{"line":317,"address":[7378407],"length":1,"stats":{"Line":0}},{"line":318,"address":[5382814,5382800],"length":1,"stats":{"Line":0}},{"line":321,"address":[5205368,5205303],"length":1,"stats":{"Line":0}},{"line":322,"address":[7386063],"length":1,"stats":{"Line":0}},{"line":326,"address":[5205436,5205382],"length":1,"stats":{"Line":0}},{"line":327,"address":[5382832,5382845],"length":1,"stats":{"Line":0}},{"line":330,"address":[7386187,7386412],"length":1,"stats":{"Line":0}},{"line":331,"address":[7503056,7503086],"length":1,"stats":{"Line":0}},{"line":332,"address":[5783110],"length":1,"stats":{"Line":0}},{"line":334,"address":[5783268,5783195],"length":1,"stats":{"Line":0}},{"line":337,"address":[5783328],"length":1,"stats":{"Line":0}},{"line":339,"address":[7386583],"length":1,"stats":{"Line":0}},{"line":340,"address":[7503162,7503152],"length":1,"stats":{"Line":0}},{"line":343,"address":[7386688,7387827,7387821],"length":1,"stats":{"Line":0}},{"line":344,"address":[5783483],"length":1,"stats":{"Line":0}},{"line":345,"address":[7386758,7386829],"length":1,"stats":{"Line":0}},{"line":347,"address":[7386850],"length":1,"stats":{"Line":0}},{"line":348,"address":[5783676],"length":1,"stats":{"Line":0}},{"line":349,"address":[7379536,7379577,7379715],"length":1,"stats":{"Line":0}},{"line":350,"address":[7379918,7379756],"length":1,"stats":{"Line":0}},{"line":351,"address":[7379950],"length":1,"stats":{"Line":0}},{"line":354,"address":[7379889],"length":1,"stats":{"Line":0}},{"line":355,"address":[5206880],"length":1,"stats":{"Line":0}},{"line":356,"address":[7387598],"length":1,"stats":{"Line":0}},{"line":360,"address":[7387190,7387629],"length":1,"stats":{"Line":0}},{"line":362,"address":[7379563],"length":1,"stats":{"Line":0}},{"line":364,"address":[7380130,7380170],"length":1,"stats":{"Line":0}},{"line":365,"address":[5207033],"length":1,"stats":{"Line":0}},{"line":367,"address":[7380245,7380158,7380302],"length":1,"stats":{"Line":0}},{"line":369,"address":[7387816,7387776],"length":1,"stats":{"Line":0}},{"line":373,"address":[7386949],"length":1,"stats":{"Line":0}},{"line":376,"address":[7387840,7388674,7388680],"length":1,"stats":{"Line":1}},{"line":377,"address":[7387879],"length":1,"stats":{"Line":1}},{"line":378,"address":[5207224,5207307],"length":1,"stats":{"Line":2}},{"line":379,"address":[5785408,5784807],"length":1,"stats":{"Line":2}},{"line":380,"address":[7380603,7380542],"length":1,"stats":{"Line":0}},{"line":381,"address":[7388177,7388670],"length":1,"stats":{"Line":0}},{"line":382,"address":[7380648,7380709],"length":1,"stats":{"Line":0}},{"line":383,"address":[7380779,7381164],"length":1,"stats":{"Line":0}},{"line":384,"address":[5207570,5207631],"length":1,"stats":{"Line":0}},{"line":385,"address":[7388666,7388389],"length":1,"stats":{"Line":0}},{"line":386,"address":[7388425,7388364],"length":1,"stats":{"Line":0}},{"line":387,"address":[7380991,7381160],"length":1,"stats":{"Line":0}},{"line":388,"address":[7388470,7388531],"length":1,"stats":{"Line":0}},{"line":389,"address":[5207974,5207919],"length":1,"stats":{"Line":0}},{"line":391,"address":[7381072,7381126],"length":1,"stats":{"Line":0}},{"line":397,"address":[7381807,7381801,7381200],"length":1,"stats":{"Line":0}},{"line":398,"address":[5785469],"length":1,"stats":{"Line":0}},{"line":399,"address":[5208078,5208161,5208223],"length":1,"stats":{"Line":0}},{"line":400,"address":[7381390,7381430],"length":1,"stats":{"Line":0}},{"line":401,"address":[7388979],"length":1,"stats":{"Line":0}},{"line":402,"address":[7381551],"length":1,"stats":{"Line":0}},{"line":403,"address":[7381627],"length":1,"stats":{"Line":0}},{"line":404,"address":[7381703],"length":1,"stats":{"Line":0}}],"covered":76,"coverable":211},{"path":["/","workspaces","homemetrics","src","blueriot","extractor.rs"],"content":"use anyhow::Result;\nuse chrono::{DateTime, Utc};\nuse log::{debug, warn};\n\n#[derive(Debug, Clone)]\npub struct PoolReading {\n    pub timestamp: DateTime\u003cUtc\u003e,\n    pub temperature: Option\u003cf64\u003e,\n    pub ph: Option\u003cf64\u003e,\n    pub orp: Option\u003ci32\u003e,\n}\n\n/// Extract pool metrics from Blue Riot email text content\n/// \n/// Expected formats:\n/// - \"Temperature: 25.5¬∞C\" or \"Temp√©rature: 25.5¬∞C\" or \"Temp: 25.5\"\n/// - \"pH: 7.2\" or \"pH: 7,2\"\n/// - \"ORP: 720 mV\" or \"Redox: 720\" or \"ORP: 720mV\"\npub fn extract_pool_metrics(text: \u0026str, timestamp: DateTime\u003cUtc\u003e) -\u003e Result\u003cPoolReading\u003e {\n    debug!(\"Extracting pool metrics from text (length: {} bytes)\", text.len());\n    \n    let mut reading = PoolReading {\n        timestamp,\n        temperature: None,\n        ph: None,\n        orp: None,\n    };\n    \n    // Extract temperature\n    reading.temperature = extract_temperature(text);\n    \n    // Extract pH\n    reading.ph = extract_ph(text);\n    \n    // Extract ORP\n    reading.orp = extract_orp(text);\n    \n    // Validate that we extracted at least one metric\n    if reading.temperature.is_none() \u0026\u0026 reading.ph.is_none() \u0026\u0026 reading.orp.is_none() {\n        anyhow::bail!(\"No pool metrics found in email text\");\n    }\n    \n    debug!(\"Extracted pool reading: temp={:?}¬∞C, pH={:?}, ORP={:?} mV\", \n           reading.temperature, reading.ph, reading.orp);\n    \n    Ok(reading)\n}\n\n/// Extract temperature from text\n/// Patterns: \"Temperature: 25.5¬∞C\", \"Temp√©rature: 25.5\", \"Temp: 25,5\"\nfn extract_temperature(text: \u0026str) -\u003e Option\u003cf64\u003e {\n    // Try different patterns\n    let patterns = [\n        r\"(?i)temp[√©e]rature[:\\s]+([0-9]+[.,][0-9]+)\",\n        r\"(?i)temp[:\\s]+([0-9]+[.,][0-9]+)\",\n        r\"([0-9]+[.,][0-9]+)\\s*¬∞C\",\n    ];\n    \n    for pattern in \u0026patterns {\n        if let Ok(re) = regex::Regex::new(pattern) {\n            if let Some(caps) = re.captures(text) {\n                if let Some(temp_str) = caps.get(1) {\n                    let temp_normalized = temp_str.as_str().replace(',', \".\");\n                    if let Ok(temp) = temp_normalized.parse::\u003cf64\u003e() {\n                        debug!(\"Found temperature: {}¬∞C (pattern: {})\", temp, pattern);\n                        return Some(temp);\n                    }\n                }\n            }\n        }\n    }\n    \n    warn!(\"Temperature not found in text\");\n    None\n}\n\n/// Extract pH from text\n/// Patterns: \"pH: 7.2\", \"pH 7,2\", \"ph: 7.25\"\nfn extract_ph(text: \u0026str) -\u003e Option\u003cf64\u003e {\n    let patterns = [\n        r\"(?i)ph[:\\s]+([0-9]+[.,][0-9]+)\",\n        r\"(?i)ph\\s*=\\s*([0-9]+[.,][0-9]+)\",\n    ];\n    \n    for pattern in \u0026patterns {\n        if let Ok(re) = regex::Regex::new(pattern) {\n            if let Some(caps) = re.captures(text) {\n                if let Some(ph_str) = caps.get(1) {\n                    let ph_normalized = ph_str.as_str().replace(',', \".\");\n                    if let Ok(ph) = ph_normalized.parse::\u003cf64\u003e() {\n                        // Validate pH range (0-14)\n                        if (0.0..=14.0).contains(\u0026ph) {\n                            debug!(\"Found pH: {} (pattern: {})\", ph, pattern);\n                            return Some(ph);\n                        } else {\n                            warn!(\"pH value out of range: {}\", ph);\n                        }\n                    }\n                }\n            }\n        }\n    }\n    \n    warn!(\"pH not found in text\");\n    None\n}\n\n/// Extract ORP (Oxidation-Reduction Potential) from text\n/// Patterns: \"ORP: 720 mV\", \"Redox: 720\", \"ORP: 720mV\"\nfn extract_orp(text: \u0026str) -\u003e Option\u003ci32\u003e {\n    let patterns = [\n        r\"(?i)orp[:\\s]+([0-9]+)\\s*m?V?\",\n        r\"(?i)redox[:\\s]+([0-9]+)\\s*m?V?\",\n        r\"([0-9]+)\\s*mV\",\n    ];\n    \n    for pattern in \u0026patterns {\n        if let Ok(re) = regex::Regex::new(pattern) {\n            if let Some(caps) = re.captures(text) {\n                if let Some(orp_str) = caps.get(1) {\n                    if let Ok(orp) = orp_str.as_str().parse::\u003ci32\u003e() {\n                        // Validate ORP range (typically 0-1000 mV for pools)\n                        if (0..=1000).contains(\u0026orp) {\n                            debug!(\"Found ORP: {} mV (pattern: {})\", orp, pattern);\n                            return Some(orp);\n                        } else {\n                            warn!(\"ORP value out of range: {}\", orp);\n                        }\n                    }\n                }\n            }\n        }\n    }\n    \n    warn!(\"ORP not found in text\");\n    None\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    \n    #[test]\n    fn test_extract_temperature() {\n        assert_eq!(extract_temperature(\"Temperature: 25.5¬∞C\"), Some(25.5));\n        assert_eq!(extract_temperature(\"Temp√©rature: 24,8¬∞C\"), Some(24.8));\n        assert_eq!(extract_temperature(\"Temp: 26.2\"), Some(26.2));\n        assert_eq!(extract_temperature(\"No temp here\"), None);\n    }\n    \n    #[test]\n    fn test_extract_ph() {\n        assert_eq!(extract_ph(\"pH: 7.2\"), Some(7.2));\n        assert_eq!(extract_ph(\"pH 7,4\"), Some(7.4));\n        assert_eq!(extract_ph(\"ph = 7.15\"), Some(7.15));\n        assert_eq!(extract_ph(\"No pH here\"), None);\n        assert_eq!(extract_ph(\"pH: 15.0\"), None); // Out of range\n    }\n    \n    #[test]\n    fn test_extract_orp() {\n        assert_eq!(extract_orp(\"ORP: 720 mV\"), Some(720));\n        assert_eq!(extract_orp(\"Redox: 680\"), Some(680));\n        assert_eq!(extract_orp(\"ORP: 750mV\"), Some(750));\n        assert_eq!(extract_orp(\"No ORP here\"), None);\n        assert_eq!(extract_orp(\"ORP: 2000\"), None); // Out of range\n    }\n    \n    #[test]\n    fn test_extract_pool_metrics() {\n        let text = \"Pool Status Report\\nTemperature: 25.5¬∞C\\npH: 7.2\\nORP: 720 mV\";\n        let timestamp = Utc::now();\n        let reading = extract_pool_metrics(text, timestamp).unwrap();\n        \n        assert_eq!(reading.temperature, Some(25.5));\n        assert_eq!(reading.ph, Some(7.2));\n        assert_eq!(reading.orp, Some(720));\n    }\n}\n","traces":[{"line":19,"address":[5318704],"length":1,"stats":{"Line":4}},{"line":20,"address":[4686392,4686080],"length":1,"stats":{"Line":8}},{"line":30,"address":[4686282],"length":1,"stats":{"Line":4}},{"line":33,"address":[8395434],"length":1,"stats":{"Line":3}},{"line":36,"address":[8395466],"length":1,"stats":{"Line":5}},{"line":39,"address":[8395485,8395788],"length":1,"stats":{"Line":6}},{"line":40,"address":[8395836],"length":1,"stats":{"Line":0}},{"line":43,"address":[8395956,8395745],"length":1,"stats":{"Line":9}},{"line":46,"address":[8395902],"length":1,"stats":{"Line":5}},{"line":51,"address":[4689007,4689072,4687200],"length":1,"stats":{"Line":3}},{"line":53,"address":[4687233],"length":1,"stats":{"Line":3}},{"line":59,"address":[5907542,5909356],"length":1,"stats":{"Line":6}},{"line":60,"address":[4687414,4687783],"length":1,"stats":{"Line":9}},{"line":61,"address":[8396959,8397010],"length":1,"stats":{"Line":11}},{"line":62,"address":[5320707,5320795],"length":1,"stats":{"Line":9}},{"line":63,"address":[5320866,5320915],"length":1,"stats":{"Line":12}},{"line":64,"address":[8397479,8397408,8397540],"length":1,"stats":{"Line":17}},{"line":65,"address":[8397558,8397656],"length":1,"stats":{"Line":9}},{"line":66,"address":[8397610],"length":1,"stats":{"Line":4}},{"line":73,"address":[5320163,5320214],"length":1,"stats":{"Line":6}},{"line":74,"address":[8396648],"length":1,"stats":{"Line":3}},{"line":79,"address":[4691332,4689168,4691397],"length":1,"stats":{"Line":3}},{"line":80,"address":[8398321],"length":1,"stats":{"Line":3}},{"line":85,"address":[5321943,5324125],"length":1,"stats":{"Line":5}},{"line":86,"address":[8398859,8398490],"length":1,"stats":{"Line":6}},{"line":87,"address":[5910019,5910070],"length":1,"stats":{"Line":7}},{"line":88,"address":[8399111,8399199],"length":1,"stats":{"Line":7}},{"line":89,"address":[5322822,5322871],"length":1,"stats":{"Line":7}},{"line":90,"address":[4690376,4690244,4690315],"length":1,"stats":{"Line":10}},{"line":92,"address":[4690394],"length":1,"stats":{"Line":4}},{"line":93,"address":[8399979,8399927,8399596],"length":1,"stats":{"Line":15}},{"line":94,"address":[8399933],"length":1,"stats":{"Line":5}},{"line":96,"address":[5910745,5910654],"length":1,"stats":{"Line":4}},{"line":104,"address":[5322119,5322170],"length":1,"stats":{"Line":4}},{"line":105,"address":[4689484],"length":1,"stats":{"Line":2}},{"line":110,"address":[4693526,4693591,4691488],"length":1,"stats":{"Line":5}},{"line":111,"address":[5324193],"length":1,"stats":{"Line":5}},{"line":117,"address":[8400732,8402777],"length":1,"stats":{"Line":7}},{"line":118,"address":[5324380,5324745],"length":1,"stats":{"Line":10}},{"line":119,"address":[4692180,4692129],"length":1,"stats":{"Line":10}},{"line":120,"address":[4692325,4692413],"length":1,"stats":{"Line":10}},{"line":121,"address":[4692533,4692484],"length":1,"stats":{"Line":10}},{"line":123,"address":[5912836],"length":1,"stats":{"Line":5}},{"line":124,"address":[8402192,8401814,8402145],"length":1,"stats":{"Line":15}},{"line":125,"address":[4693031],"length":1,"stats":{"Line":5}},{"line":127,"address":[4692652,4692743],"length":1,"stats":{"Line":4}},{"line":135,"address":[4691785,4691835],"length":1,"stats":{"Line":4}},{"line":136,"address":[4691822],"length":1,"stats":{"Line":2}}],"covered":47,"coverable":48},{"path":["/","workspaces","homemetrics","src","blueriot","mod.rs"],"content":"/// Blue Riot pool monitoring email processing module\npub mod extractor;\npub mod processor;\n\npub use extractor::PoolReading;\npub use processor::BlueRiotEmailProcessor;\n","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","homemetrics","src","blueriot","processor.rs"],"content":"use anyhow::{Result, Context};\nuse log::{debug, info};\n\nuse crate::config::Config;\nuse crate::gmail_client::GmailClient;\nuse crate::database::Database;\nuse crate::slack_notifier::SlackNotifier;\nuse crate::email::{EmailProcessingStrategy, BaseEmailProcessor};\nuse super::extractor;\n\n/// Blue Riot specific processing strategy\npub struct BlueRiotStrategy;\n\nimpl EmailProcessingStrategy for BlueRiotStrategy {\n    fn search_emails\u003c'a, 'b: 'a\u003e(\u0026'a self, gmail: \u0026'b GmailClient) -\u003e \n        std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003cVec\u003cString\u003e\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(gmail.search_pool_emails())\n    }\n    \n    fn process_single_email\u003c'a, 'b: 'a, 'c: 'a\u003e(\n        \u0026'a self,\n        gmail: \u0026'b GmailClient,\n        database: Option\u003c\u0026'c Database\u003e,\n        slack: Option\u003c\u0026'c SlackNotifier\u003e,\n        message_id: \u0026'a str,\n        is_dry_run: bool,\n    ) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003cusize\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move {\n            debug!(\"Processing Blue Riot email ID: {}\", message_id);\n            \n            // Fetch email metadata\n            let (subject, _from) = gmail.fetch_email_metadata(message_id).await?;\n            debug!(\"Email subject: {}\", subject);\n            \n            // Fetch complete email content\n            let email = gmail.fetch_email_complete(message_id).await?;\n            debug!(\"Email date: {}\", email.date);\n            \n            // Parse email to extract text body\n            let parsed_email = mail_parser::MessageParser::default()\n                .parse(\u0026email.content)\n                .context(\"Failed to parse email\")?;\n            \n            // Extract text from email body\n            let mut text_content = String::new();\n            \n            // Try to get text/plain body first\n            if let Some(text_body) = parsed_email.body_text(0) {\n                text_content.push_str(\u0026text_body);\n            }\n            \n            // If no text/plain, try text/html\n            if text_content.is_empty() {\n                if let Some(html_body) = parsed_email.body_html(0) {\n                    // Simple HTML stripping (remove tags)\n                    let html_str = html_body.to_string()\n                        .replace(\"\u003cbr\u003e\", \"\\n\")\n                        .replace(\"\u003cBR\u003e\", \"\\n\")\n                        .replace(\"\u003c/p\u003e\", \"\\n\")\n                        .replace(\"\u003c/P\u003e\", \"\\n\");\n                    // Remove all HTML tags\n                    let tag_regex = regex::Regex::new(r\"\u003c[^\u003e]+\u003e\").unwrap();\n                    text_content = tag_regex.replace_all(\u0026html_str, \"\").to_string();\n                }\n            }\n            \n            // Fallback to raw content if still empty\n            if text_content.is_empty() {\n                text_content = String::from_utf8_lossy(\u0026email.content).to_string();\n            }\n            \n            if is_dry_run {\n                println!(\"\\nüìß Email: {}\", subject);\n                println!(\"üìÖ Date: {}\", email.date);\n                println!(\"üìÑ Text content (first 500 chars):\\n{}\\n\", \n                         \u0026text_content.chars().take(500).collect::\u003cString\u003e());\n            }\n            \n            // Extract pool metrics from email text\n            let pool_reading = extractor::extract_pool_metrics(\u0026text_content, email.date)\n                .context(\"Failed to extract pool metrics from email\")?;\n            \n            if is_dry_run {\n                println!(\"üèä Pool Metrics Extracted:\");\n                if let Some(temp) = pool_reading.temperature {\n                    println!(\"   üå°Ô∏è  Temperature: {:.1}¬∞C\", temp);\n                }\n                if let Some(ph) = pool_reading.ph {\n                    println!(\"   üß™ pH: {:.2}\", ph);\n                }\n                if let Some(orp) = pool_reading.orp {\n                    println!(\"   ‚ö° ORP: {} mV\", orp);\n                }\n                println!();\n            } else {\n                // Save to database\n                if let Some(db) = database {\n                    db.save_pool_reading(\u0026pool_reading, message_id).await?;\n                    \n                    // Send Slack notification\n                    if let Some(slack) = slack {\n                        let mut metrics = Vec::new();\n                        if let Some(temp) = pool_reading.temperature {\n                            metrics.push(format!(\"üå°Ô∏è {}¬∞C\", temp));\n                        }\n                        if let Some(ph) = pool_reading.ph {\n                            metrics.push(format!(\"üß™ pH {:.2}\", ph));\n                        }\n                        if let Some(orp) = pool_reading.orp {\n                            metrics.push(format!(\"‚ö° {} mV\", orp));\n                        }\n                        \n                        let message = format!(\n                            \"üèä New pool reading: {}\\nFrom: {}\",\n                            metrics.join(\" | \"),\n                            subject\n                        );\n                        \n                        info!(\"Sending Slack notification for Blue Riot reading\");\n                        if let Err(e) = slack.send_message(\u0026message).await {\n                            debug!(\"Failed to send Slack notification: {}\", e);\n                        } else {\n                            debug!(\"Slack notification sent successfully\");\n                        }\n                    }\n                }\n            }\n            \n            // Return 1 to indicate one record processed (the pool reading)\n            Ok(1)\n        })\n    }\n    \n    fn mark_email_processed\u003c'a, 'b: 'a\u003e(\n        \u0026'a self,\n        gmail: \u0026'b GmailClient,\n        message_id: \u0026'a str,\n    ) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003c()\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(gmail.mark_pool_email_as_processed(message_id))\n    }\n    \n    fn processor_name(\u0026self) -\u003e \u0026str {\n        \"Blue Riot\"\n    }\n    \n    fn label_name(\u0026self) -\u003e \u0026str {\n        \"homemetrics/todo/blueriot\"\n    }\n}\n\n/// Blue Riot email processor (wrapper around BaseEmailProcessor)\npub struct BlueRiotEmailProcessor {\n    base: BaseEmailProcessor\u003cBlueRiotStrategy\u003e,\n}\n\nimpl BlueRiotEmailProcessor {\n    pub async fn new(config: \u0026Config, dry_run: bool) -\u003e Result\u003cSelf\u003e {\n        let processor = if dry_run {\n            BlueRiotEmailProcessor {\n                base: BaseEmailProcessor::new_dry_run(config.clone(), BlueRiotStrategy)?,\n            }\n        } else {\n            BlueRiotEmailProcessor {\n                base: BaseEmailProcessor::new(config.clone(), BlueRiotStrategy).await?,\n            }\n        };\n        Ok(processor)\n    }\n    \n    pub async fn process_emails(\u0026self, limit: Option\u003cusize\u003e) -\u003e Result\u003c()\u003e {\n        self.base.process_emails(limit).await?;\n        Ok(())\n    }\n}\n","traces":[{"line":15,"address":[5639696],"length":1,"stats":{"Line":0}},{"line":17,"address":[8157729],"length":1,"stats":{"Line":0}},{"line":20,"address":[5639776],"length":1,"stats":{"Line":0}},{"line":28,"address":[5652071],"length":1,"stats":{"Line":0}},{"line":29,"address":[4207913,4207678,4207960],"length":1,"stats":{"Line":0}},{"line":32,"address":[8730176,8729080,8728735,8729176,8728596],"length":1,"stats":{"Line":0}},{"line":33,"address":[4208820,4208967,4208920],"length":1,"stats":{"Line":0}},{"line":36,"address":[8421775,8415166,8414009,8415499,8415705],"length":1,"stats":{"Line":0}},{"line":37,"address":[8730841,8730869,8730749],"length":1,"stats":{"Line":0}},{"line":40,"address":[8731177,8731339,8736181,8730847,8731228],"length":1,"stats":{"Line":0}},{"line":41,"address":[8416617],"length":1,"stats":{"Line":0}},{"line":42,"address":[8440793,8436188,8435871,8435724],"length":1,"stats":{"Line":0}},{"line":45,"address":[8731706],"length":1,"stats":{"Line":0}},{"line":48,"address":[4210912,4210985],"length":1,"stats":{"Line":0}},{"line":49,"address":[8417530,8417366],"length":1,"stats":{"Line":0}},{"line":53,"address":[8417577,8417683,8419299],"length":1,"stats":{"Line":0}},{"line":54,"address":[8732241,8732314],"length":1,"stats":{"Line":0}},{"line":56,"address":[8436951,8437076,8437156,8437296,8437436,8437576],"length":1,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[8418027,8418164,8418553,8418444,8418304],"length":1,"stats":{"Line":0}},{"line":62,"address":[8733316],"length":1,"stats":{"Line":0}},{"line":63,"address":[8418869,8418952,8419087],"length":1,"stats":{"Line":0}},{"line":68,"address":[8732209,8733842],"length":1,"stats":{"Line":0}},{"line":69,"address":[8733874,8734041],"length":1,"stats":{"Line":0}},{"line":72,"address":[8733848],"length":1,"stats":{"Line":0}},{"line":73,"address":[8438779],"length":1,"stats":{"Line":0}},{"line":74,"address":[8419807],"length":1,"stats":{"Line":0}},{"line":75,"address":[4213755],"length":1,"stats":{"Line":0}},{"line":76,"address":[8419907],"length":1,"stats":{"Line":0}},{"line":80,"address":[8439317,8438738,8440716,8439484],"length":1,"stats":{"Line":0}},{"line":81,"address":[8420396],"length":1,"stats":{"Line":0}},{"line":83,"address":[8734996],"length":1,"stats":{"Line":0}},{"line":84,"address":[8439634,8439878],"length":1,"stats":{"Line":0}},{"line":85,"address":[8420825],"length":1,"stats":{"Line":0}},{"line":86,"address":[4214588,4214531],"length":1,"stats":{"Line":0}},{"line":88,"address":[4214812,4214558],"length":1,"stats":{"Line":0}},{"line":89,"address":[8421235,8421177],"length":1,"stats":{"Line":0}},{"line":91,"address":[4215119,4214864],"length":1,"stats":{"Line":0}},{"line":92,"address":[8440552,8440605],"length":1,"stats":{"Line":0}},{"line":94,"address":[4215167,4215264],"length":1,"stats":{"Line":0}},{"line":97,"address":[8735079,8735013],"length":1,"stats":{"Line":0}},{"line":98,"address":[8414030,8420709,8420611,8421817,8424203],"length":1,"stats":{"Line":0}},{"line":101,"address":[8441257,8444656],"length":1,"stats":{"Line":0}},{"line":102,"address":[4215888],"length":1,"stats":{"Line":0}},{"line":103,"address":[8422278],"length":1,"stats":{"Line":0}},{"line":104,"address":[8441396,8441526],"length":1,"stats":{"Line":0}},{"line":106,"address":[8441445,8441665],"length":1,"stats":{"Line":0}},{"line":107,"address":[8441770,8441690],"length":1,"stats":{"Line":0}},{"line":109,"address":[8441739,8442057],"length":1,"stats":{"Line":0}},{"line":110,"address":[4216642,4216736],"length":1,"stats":{"Line":0}},{"line":113,"address":[4216923],"length":1,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[8423255,8423055],"length":1,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[4217346,4217243,4217387],"length":1,"stats":{"Line":0}},{"line":120,"address":[8424612,8424327,8424035,8423716,8414051],"length":1,"stats":{"Line":0}},{"line":121,"address":[8739258,8739230,8739095],"length":1,"stats":{"Line":0}},{"line":123,"address":[8443781,8444252],"length":1,"stats":{"Line":0}},{"line":130,"address":[8420656],"length":1,"stats":{"Line":0}},{"line":134,"address":[5652144],"length":1,"stats":{"Line":0}},{"line":139,"address":[5139697],"length":1,"stats":{"Line":0}},{"line":142,"address":[5640016],"length":1,"stats":{"Line":0}},{"line":146,"address":[5139760],"length":1,"stats":{"Line":0}},{"line":157,"address":[5640099,5640080],"length":1,"stats":{"Line":0}},{"line":158,"address":[8445060,8445958],"length":1,"stats":{"Line":0}},{"line":160,"address":[8445139,8445296,8445529],"length":1,"stats":{"Line":0}},{"line":164,"address":[8741279,8740572,8740453,8740941],"length":1,"stats":{"Line":0}},{"line":167,"address":[8426406],"length":1,"stats":{"Line":0}},{"line":170,"address":[4220505,4220480,4220655,4221195,4220618,4220767],"length":1,"stats":{"Line":0}},{"line":171,"address":[8427081,8427035,8427138,8427237,8427649],"length":1,"stats":{"Line":0}},{"line":172,"address":[8427581],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":73},{"path":["/","workspaces","homemetrics","src","config.rs"],"content":"use anyhow::Result;\nuse serde::Deserialize;\n\n#[derive(Debug, Deserialize, Clone)]\npub struct Config {\n    pub gmail: GmailConfig,\n    pub database: DatabaseConfig,\n    pub data_dir: String,\n    pub scheduler: SchedulerConfig,\n    pub slack: Option\u003cSlackConfig\u003e,\n}\n\n#[derive(Debug, Deserialize, Clone)]\npub struct SchedulerConfig {\n    pub enabled: bool,\n    pub schedule_times: Vec\u003cString\u003e, // Format: \"HH:MM\" (e.g., [\"02:00\", \"14:00\"])\n}\n\n#[derive(Debug, Deserialize, Clone)]\npub struct GmailConfig {\n    pub credentials_path: String,\n    pub token_cache_path: String,\n}\n\n#[derive(Debug, Deserialize, Clone)]\npub struct DatabaseConfig {\n    pub host: String,\n    pub port: u16,\n    pub database: String,\n    pub username: String,\n    pub password: String,\n}\n\n#[derive(Debug, Deserialize, Clone)]\npub struct SlackConfig {\n    pub bot_token: String,\n    pub channel_id: String,\n}\n\nimpl Config {\n    pub fn new() -\u003e Result\u003cSelf\u003e {\n        // Check that essential variables are defined\n        Self::check_required_env_vars()?;\n        \n        // Configuration loaded from environment variables\n        Ok(Config {\n            gmail: GmailConfig {\n                credentials_path: std::env::var(\"GMAIL_CREDENTIALS_PATH\")\n                    .expect(\"GMAIL_CREDENTIALS_PATH must be defined\"),\n                token_cache_path: std::env::var(\"GMAIL_TOKEN_CACHE_PATH\")\n                    .unwrap_or_else(|_| \"./gmail-token-cache.json\".to_string()),\n            },\n            database: DatabaseConfig {\n                host: std::env::var(\"DB_HOST\")\n                    .unwrap_or_else(|_| \"localhost\".to_string()),\n                port: std::env::var(\"DB_PORT\")\n                    .unwrap_or_else(|_| \"5432\".to_string())\n                    .parse()\n                    .unwrap_or(5432),\n                database: std::env::var(\"DB_NAME\")\n                    .unwrap_or_else(|_| \"homemetrics\".to_string()),\n                username: std::env::var(\"DB_USERNAME\")\n                    .unwrap_or_else(|_| \"postgres\".to_string()),\n                password: std::env::var(\"DB_PASSWORD\")\n                    .expect(\"DB_PASSWORD must be defined\"),\n            },\n            data_dir: std::env::var(\"DATA_DIR\")\n                .unwrap_or_else(|_| \"./data\".to_string()),\n            scheduler: SchedulerConfig {\n                enabled: std::env::var(\"SCHEDULER_ENABLED\")\n                    .unwrap_or_else(|_| \"false\".to_string())\n                    .parse()\n                    .unwrap_or(false),\n                schedule_times: std::env::var(\"SCHEDULER_TIMES\")\n                    .unwrap_or_else(|_| \"02:00\".to_string())\n                    .split(',')\n                    .map(|s| s.trim().to_string())\n                    .collect(),\n            },\n            slack: match (std::env::var(\"SLACK_BOT_TOKEN\"), std::env::var(\"SLACK_CHANNEL_ID\")) {\n                (Ok(bot_token), Ok(channel_id)) =\u003e Some(SlackConfig {\n                    bot_token,\n                    channel_id,\n                }),\n                _ =\u003e {\n                    log::warn!(\"SLACK_BOT_TOKEN or SLACK_CHANNEL_ID not defined - Slack notifications disabled\");\n                    None\n                }\n            },\n        })\n    }\n    \n    fn check_required_env_vars() -\u003e Result\u003c()\u003e {\n        let required_vars = [\n            \"GMAIL_CREDENTIALS_PATH\",\n        ];\n        \n        let mut missing_vars = Vec::new();\n        \n        for var in \u0026required_vars {\n            if std::env::var(var).is_err() {\n                missing_vars.push(*var);\n            }\n        }\n        \n        if !missing_vars.is_empty() {\n            anyhow::bail!(\n                \"Missing environment variables: {}\\n\\\n                 \\n\\\n                 üí° Solutions:\\n\\\n                 1. Create a .env file with your credentials:\\n\\\n                    cp .env.example .env\\n\\\n                    # Then edit .env with your values\\n\\\n                 \\n\\\n                 2. Or set variables manually:\\n\\\n                    export GMAIL_CREDENTIALS_PATH=/path/to/client_credentials.json\\n\\\n                    export GMAIL_TOKEN_CACHE_PATH=./gmail-token-cache.json\\n\\\n                    cargo run -- --dry-run\\n\\\n                 \\n\\\n                 3. See GMAIL_API_MIGRATION.md for more information\",\n                missing_vars.join(\", \")\n            );\n        }\n        \n        Ok(())\n    }\n}","traces":[{"line":40,"address":[12932850],"length":1,"stats":{"Line":0}},{"line":41,"address":[5951632,5954983,5955172],"length":1,"stats":{"Line":0}},{"line":43,"address":[5959156],"length":1,"stats":{"Line":0}},{"line":46,"address":[5954023],"length":1,"stats":{"Line":0}},{"line":47,"address":[5951952],"length":1,"stats":{"Line":0}},{"line":48,"address":[12933032],"length":1,"stats":{"Line":0}},{"line":49,"address":[44415585,44415444],"length":1,"stats":{"Line":0}},{"line":50,"address":[25806455],"length":1,"stats":{"Line":0}},{"line":51,"address":[25806463,25806736],"length":1,"stats":{"Line":0}},{"line":53,"address":[5952689],"length":1,"stats":{"Line":0}},{"line":54,"address":[5258950,5259021],"length":1,"stats":{"Line":0}},{"line":55,"address":[6592064,6592048],"length":1,"stats":{"Line":0}},{"line":56,"address":[5259232,5259051,5259123],"length":1,"stats":{"Line":0}},{"line":57,"address":[6592160,6592176],"length":1,"stats":{"Line":0}},{"line":60,"address":[5959896],"length":1,"stats":{"Line":0}},{"line":61,"address":[5855584,5855568],"length":1,"stats":{"Line":0}},{"line":62,"address":[5959961,5960036],"length":1,"stats":{"Line":0}},{"line":63,"address":[5855680,5855696],"length":1,"stats":{"Line":0}},{"line":64,"address":[5259480,5259552],"length":1,"stats":{"Line":0}},{"line":67,"address":[5952825,5952900],"length":1,"stats":{"Line":0}},{"line":68,"address":[7944816,7944832],"length":1,"stats":{"Line":0}},{"line":69,"address":[4137718],"length":1,"stats":{"Line":0}},{"line":70,"address":[5960623,5960510,5960438],"length":1,"stats":{"Line":0}},{"line":71,"address":[5855920,5855904],"length":1,"stats":{"Line":0}},{"line":74,"address":[4137504,4137644],"length":1,"stats":{"Line":0}},{"line":75,"address":[25655792,25658838,25659136],"length":1,"stats":{"Line":0}},{"line":76,"address":[25655823],"length":1,"stats":{"Line":0}},{"line":77,"address":[17224091],"length":1,"stats":{"Line":0}},{"line":78,"address":[17224766],"length":1,"stats":{"Line":0}},{"line":80,"address":[16932777,16932834],"length":1,"stats":{"Line":0}},{"line":81,"address":[5260667],"length":1,"stats":{"Line":0}},{"line":82,"address":[16933070,16933124,16932989],"length":1,"stats":{"Line":0}},{"line":85,"address":[17225395,17225034],"length":1,"stats":{"Line":0}},{"line":86,"address":[17227776],"length":1,"stats":{"Line":0}},{"line":87,"address":[17224812],"length":1,"stats":{"Line":0}},{"line":93,"address":[4140165,4139488,4140325],"length":1,"stats":{"Line":0}},{"line":94,"address":[5955207],"length":1,"stats":{"Line":0}},{"line":95,"address":[17226428],"length":1,"stats":{"Line":0}},{"line":98,"address":[4139521],"length":1,"stats":{"Line":0}},{"line":100,"address":[17225597,17225748],"length":1,"stats":{"Line":0}},{"line":101,"address":[12933815],"length":1,"stats":{"Line":0}},{"line":102,"address":[5262846],"length":1,"stats":{"Line":0}},{"line":106,"address":[5955446],"length":1,"stats":{"Line":0}},{"line":107,"address":[17226377,17226096,17226237],"length":1,"stats":{"Line":0}},{"line":125,"address":[5955502],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":45},{"path":["/","workspaces","homemetrics","src","database.rs"],"content":"use anyhow::{Result, Context};\nuse log::{info, debug, warn};\nuse sqlx::PgPool;\n\nuse crate::config::DatabaseConfig;\nuse crate::xsense::TemperatureReading;\nuse crate::blueriot::PoolReading;\n\npub struct Database {\n    pool: PgPool,\n}\n\nimpl Database {\n    pub async fn new(config: \u0026DatabaseConfig) -\u003e Result\u003cSelf\u003e {\n        info!(\"Connecting to TimescaleDB database\");\n        \n        let database_url = format!(\n            \"postgres://{}:{}@{}:{}/{}\",\n            config.username, config.password, config.host, config.port, config.database\n        );\n        \n        let pool = PgPool::connect(\u0026database_url)\n            .await\n            .context(\"Impossible de se connecter √† la base de donn√©es\")?;\n        \n        info!(\"Database connection established\");\n        \n        let db = Database { pool };\n        \n        // Create tables if they don't exist\n        db.create_tables_if_not_exists().await?;\n        \n        Ok(db)\n    }\n    \n    async fn create_tables_if_not_exists(\u0026self) -\u003e Result\u003c()\u003e {\n        info!(\"Checking/creating database tables\");\n        \n        // Try to create TimescaleDB extension if available\n        let _timescaledb_available = match sqlx::query(\"CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE\")\n            .execute(\u0026self.pool)\n            .await {\n                Ok(_) =\u003e {\n                    info!(\"‚úÖ TimescaleDB extension created/available\");\n                    true\n                },\n                Err(e) =\u003e {\n                    warn!(\"‚ö†Ô∏è  TimescaleDB not available, using standard PostgreSQL: {}\", e);\n                    false\n                }\n            };\n        \n        // Create sensors table\n        sqlx::query(\n            r#\"\n            CREATE TABLE IF NOT EXISTS sensors (\n                id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n                sensor_id VARCHAR(255) UNIQUE NOT NULL,\n                location VARCHAR(255),\n                created_at TIMESTAMPTZ DEFAULT NOW(),\n                updated_at TIMESTAMPTZ DEFAULT NOW()\n            )\n            \"#\n        )\n        .execute(\u0026self.pool)\n        .await\n        .context(\"Unable to create sensors table\")?;\n        \n        // Create temperature readings table\n        sqlx::query(\n            r#\"\n            CREATE TABLE IF NOT EXISTS temperature_readings (\n                id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n                sensor_id VARCHAR(255) NOT NULL,\n                timestamp TIMESTAMPTZ NOT NULL,\n                temperature DOUBLE PRECISION NOT NULL,\n                humidity DOUBLE PRECISION,\n                location VARCHAR(255),\n                processed_at TIMESTAMPTZ DEFAULT NOW(),\n                FOREIGN KEY (sensor_id) REFERENCES sensors(sensor_id) ON DELETE CASCADE\n            )\n            \"#\n        )\n        .execute(\u0026self.pool)\n        .await\n        .context(\"Unable to create temperature_readings table\")?;\n        \n        // Create TimescaleDB hypertable for temperature readings\n        let _result = sqlx::query(\n            \"SELECT create_hypertable('temperature_readings', 'timestamp', if_not_exists =\u003e TRUE)\"\n        )\n        .execute(\u0026self.pool)\n        .await;\n        // Ignore error if hypertable already exists\n        \n        // Create indexes to optimize queries\n        sqlx::query(\n            \"CREATE INDEX IF NOT EXISTS idx_temp_readings_sensor_time ON temperature_readings (sensor_id, timestamp DESC)\"\n        )\n        .execute(\u0026self.pool)\n        .await\n        .context(\"Unable to create index sur sensor_id et timestamp\")?;\n        \n        sqlx::query(\n            \"CREATE INDEX IF NOT EXISTS idx_temp_readings_timestamp ON temperature_readings (timestamp DESC)\"\n        )\n        .execute(\u0026self.pool)\n        .await\n        .context(\"Unable to create index sur timestamp\")?;\n        \n        // Create pool_readings table for Blue Riot pool monitoring\n        sqlx::query(\n            r#\"\n            CREATE TABLE IF NOT EXISTS pool_readings (\n                id SERIAL,\n                timestamp TIMESTAMPTZ NOT NULL,\n                temperature NUMERIC(5,2),\n                ph NUMERIC(4,2),\n                orp INTEGER,\n                email_id VARCHAR(255),\n                created_at TIMESTAMPTZ DEFAULT NOW(),\n                PRIMARY KEY (id, timestamp)\n            )\n            \"#\n        )\n        .execute(\u0026self.pool)\n        .await\n        .context(\"Unable to create pool_readings table\")?;\n        \n        // Create TimescaleDB hypertable for pool readings\n        let _result = sqlx::query(\n            \"SELECT create_hypertable('pool_readings', 'timestamp', if_not_exists =\u003e TRUE)\"\n        )\n        .execute(\u0026self.pool)\n        .await;\n        // Ignore error if hypertable already exists\n        \n        // Create indexes for pool readings\n        sqlx::query(\n            \"CREATE INDEX IF NOT EXISTS idx_pool_readings_timestamp ON pool_readings (timestamp DESC)\"\n        )\n        .execute(\u0026self.pool)\n        .await\n        .context(\"Unable to create index on pool_readings timestamp\")?;\n        \n        sqlx::query(\n            \"CREATE INDEX IF NOT EXISTS idx_pool_readings_email ON pool_readings (email_id)\"\n        )\n        .execute(\u0026self.pool)\n        .await\n        .context(\"Unable to create index on pool_readings email_id\")?;\n        \n        info!(\"Database tables checked/created successfully\");\n        Ok(())\n    }\n    \n    pub async fn save_temperature_readings(\u0026self, readings: \u0026[TemperatureReading]) -\u003e Result\u003cusize\u003e {\n        if readings.is_empty() {\n            return Ok(0);\n        }\n        \n        info!(\"Saving {} temperature readings\", readings.len());\n        \n        let mut transaction = self.pool.begin()\n            .await\n            .context(\"Unable to start transaction\")?;\n        \n        let mut saved_count = 0;\n        \n        for reading in readings {\n            // First, make sure the sensor exists\n            self.ensure_sensor_exists(\u0026mut transaction, \u0026reading.sensor_id, \u0026reading.location).await?;\n            \n            // Check if this reading already exists (avoid duplicates)\n            let exists = sqlx::query(\n                \"SELECT 1 FROM temperature_readings WHERE sensor_id = $1 AND timestamp = $2\"\n            )\n            .bind(\u0026reading.sensor_id)\n            .bind(reading.timestamp)\n            .fetch_optional(\u0026mut *transaction)\n            .await\n            .context(\"Error checking for duplicates\")?;\n            \n            if exists.is_some() {\n                saved_count += 1; // We count duplicates as \"saved\" to reflect total processed\n                debug!(\"Existing reading skipped: {} √† {}\", reading.sensor_id, reading.timestamp);\n                continue;\n            }\n            \n            // Insert new reading\n            sqlx::query(\n                r#\"\n                INSERT INTO temperature_readings \n                (sensor_id, timestamp, temperature, humidity, location)\n                VALUES ($1, $2, $3, $4, $5)\n                \"#\n            )\n            .bind(\u0026reading.sensor_id)\n            .bind(reading.timestamp)\n            .bind(reading.temperature)\n            .bind(reading.humidity)\n            .bind(\u0026reading.location)\n            .execute(\u0026mut *transaction)\n            .await\n            .context(\"Error inserting temperature reading\")?;\n            \n            saved_count += 1;\n            \n            debug!(\"Reading saved: {} = {}¬∞C √† {}\", \n                   reading.sensor_id, reading.temperature, reading.timestamp);\n        }\n        \n        transaction.commit()\n            .await\n            .context(\"Error committing transaction\")?;\n        \n        info!(\"Save completed: {} new readings out of {} processed\", saved_count, readings.len());\n        Ok(saved_count)\n    }\n    \n    async fn ensure_sensor_exists(\n        \u0026self, \n        transaction: \u0026mut sqlx::Transaction\u003c'_, sqlx::Postgres\u003e,\n        sensor_id: \u0026str,\n        location: \u0026Option\u003cString\u003e\n    ) -\u003e Result\u003c()\u003e {\n        let exists = sqlx::query(\"SELECT 1 FROM sensors WHERE sensor_id = $1\")\n            .bind(sensor_id)\n            .fetch_optional(\u0026mut **transaction)\n            .await\n            .context(\"Error checking sensor existence\")?;\n        \n        if exists.is_none() {\n            sqlx::query(\n                \"INSERT INTO sensors (sensor_id, location) VALUES ($1, $2)\"\n            )\n            .bind(sensor_id)\n            .bind(location)\n            .execute(\u0026mut **transaction)\n            .await\n            .context(\"Error inserting sensor\")?;\n            \n            debug!(\"New sensor created: {}\", sensor_id);\n        } else if let Some(loc) = location {\n            // Update location if provided\n            sqlx::query(\n                \"UPDATE sensors SET location = $2, updated_at = NOW() WHERE sensor_id = $1 AND location IS NULL\"\n            )\n            .bind(sensor_id)\n            .bind(loc)\n            .execute(\u0026mut **transaction)\n            .await\n            .context(\"Error updating sensor location\")?;\n        }\n        \n        Ok(())\n    }\n    \n    /// Save a pool reading to the database\n    pub async fn save_pool_reading(\u0026self, reading: \u0026PoolReading, email_id: \u0026str) -\u003e Result\u003c()\u003e {\n        debug!(\"Saving pool reading: temp={:?}¬∞C, pH={:?}, ORP={:?} mV\", \n               reading.temperature, reading.ph, reading.orp);\n        \n        // Check if this reading already exists (by email_id)\n        let exists = sqlx::query_scalar::\u003c_, bool\u003e(\n            \"SELECT EXISTS(SELECT 1 FROM pool_readings WHERE email_id = $1)\"\n        )\n        .bind(email_id)\n        .fetch_one(\u0026self.pool)\n        .await\n        .context(\"Failed to check for duplicate pool reading\")?;\n        \n        if exists {\n            info!(\"Pool reading from email {} already exists, skipping\", email_id);\n            return Ok(());\n        }\n        \n        sqlx::query(\n            r#\"\n            INSERT INTO pool_readings (timestamp, temperature, ph, orp, email_id)\n            VALUES ($1, $2, $3, $4, $5)\n            \"#\n        )\n        .bind(reading.timestamp)\n        .bind(reading.temperature)\n        .bind(reading.ph)\n        .bind(reading.orp)\n        .bind(email_id)\n        .execute(\u0026self.pool)\n        .await\n        .context(\"Failed to insert pool reading\")?;\n        \n        info!(\"‚úÖ Pool reading saved: temp={:?}¬∞C, pH={:?}, ORP={:?} mV\", \n              reading.temperature, reading.ph, reading.orp);\n        \n        Ok(())\n    }\n    \n}","traces":[{"line":13,"address":[33171136,33171161],"length":1,"stats":{"Line":0}},{"line":14,"address":[8258324,8259364,8257216,8257292,8257503,8257439],"length":1,"stats":{"Line":0}},{"line":15,"address":[6073901,6073861,6073698],"length":1,"stats":{"Line":0}},{"line":17,"address":[6074142,6073875],"length":1,"stats":{"Line":0}},{"line":22,"address":[8258518,8258217,8258263,8258589,8258723,8259314,8258114],"length":1,"stats":{"Line":0}},{"line":23,"address":[8265854,8265797,8266070,8265740,8264973],"length":1,"stats":{"Line":0}},{"line":26,"address":[8258790,8258881,8258953],"length":1,"stats":{"Line":0}},{"line":28,"address":[5298323],"length":1,"stats":{"Line":0}},{"line":31,"address":[8264994,8267339,8266423,8266723,8266874],"length":1,"stats":{"Line":0}},{"line":33,"address":[8267199],"length":1,"stats":{"Line":0}},{"line":36,"address":[8260075,8260761,8261992,8259904,8259950,8260307],"length":1,"stats":{"Line":0}},{"line":37,"address":[6076251,6076585,6076625],"length":1,"stats":{"Line":0}},{"line":40,"address":[8267871,8268204,8268530,8268459,8268150],"length":1,"stats":{"Line":0}},{"line":41,"address":[5300026],"length":1,"stats":{"Line":0}},{"line":42,"address":[5408833],"length":1,"stats":{"Line":0}},{"line":44,"address":[8268663,8268734],"length":1,"stats":{"Line":0}},{"line":45,"address":[8268721],"length":1,"stats":{"Line":0}},{"line":47,"address":[8268567],"length":1,"stats":{"Line":0}},{"line":48,"address":[5300479,5300916,5300949],"length":1,"stats":{"Line":0}},{"line":49,"address":[8269058],"length":1,"stats":{"Line":0}},{"line":65,"address":[6078061],"length":1,"stats":{"Line":0}},{"line":66,"address":[5408856],"length":1,"stats":{"Line":0}},{"line":84,"address":[8269969],"length":1,"stats":{"Line":0}},{"line":85,"address":[6697847],"length":1,"stats":{"Line":0}},{"line":92,"address":[5302431],"length":1,"stats":{"Line":0}},{"line":93,"address":[5421126],"length":1,"stats":{"Line":0}},{"line":100,"address":[5302917],"length":1,"stats":{"Line":0}},{"line":101,"address":[5408925],"length":1,"stats":{"Line":0}},{"line":107,"address":[6080307],"length":1,"stats":{"Line":0}},{"line":108,"address":[6697904],"length":1,"stats":{"Line":0}},{"line":126,"address":[6080907],"length":1,"stats":{"Line":0}},{"line":127,"address":[5421195],"length":1,"stats":{"Line":0}},{"line":134,"address":[6081486],"length":1,"stats":{"Line":0}},{"line":135,"address":[5421218],"length":1,"stats":{"Line":0}},{"line":142,"address":[8273511],"length":1,"stats":{"Line":0}},{"line":143,"address":[8260273,8266103,8266131,8266344,8266046],"length":1,"stats":{"Line":0}},{"line":149,"address":[8266568],"length":1,"stats":{"Line":0}},{"line":150,"address":[9094732],"length":1,"stats":{"Line":0}},{"line":153,"address":[8267137,8267227],"length":1,"stats":{"Line":0}},{"line":154,"address":[8274693],"length":1,"stats":{"Line":0}},{"line":157,"address":[7154416,7154434],"length":1,"stats":{"Line":0}},{"line":158,"address":[6083637,6083860],"length":1,"stats":{"Line":0}},{"line":159,"address":[6083911],"length":1,"stats":{"Line":0}},{"line":162,"address":[8275594,8275470,8275551],"length":1,"stats":{"Line":0}},{"line":164,"address":[8276468,8275557,8276358,8276815,8276330,8275970],"length":1,"stats":{"Line":0}},{"line":165,"address":[8267806,8268499,8268439,8268633,8268828],"length":1,"stats":{"Line":0}},{"line":168,"address":[8269104],"length":1,"stats":{"Line":0}},{"line":170,"address":[8278044,8276740,8276627,8276762],"length":1,"stats":{"Line":0}},{"line":172,"address":[8269353,8270879,8270602,8267827,8273503,8270982],"length":1,"stats":{"Line":0}},{"line":178,"address":[8271416],"length":1,"stats":{"Line":0}},{"line":179,"address":[6087330,6087262],"length":1,"stats":{"Line":0}},{"line":180,"address":[8271569,8271381,8271653,8273455,8271542],"length":1,"stats":{"Line":0}},{"line":181,"address":[5407989],"length":1,"stats":{"Line":0}},{"line":184,"address":[8272322],"length":1,"stats":{"Line":0}},{"line":185,"address":[8273009,8272393,8272952],"length":1,"stats":{"Line":0}},{"line":186,"address":[5311942,5311875,5311977],"length":1,"stats":{"Line":0}},{"line":198,"address":[5311396],"length":1,"stats":{"Line":0}},{"line":199,"address":[8280018],"length":1,"stats":{"Line":0}},{"line":200,"address":[8272586],"length":1,"stats":{"Line":0}},{"line":201,"address":[5311549],"length":1,"stats":{"Line":0}},{"line":202,"address":[8280187,8280233],"length":1,"stats":{"Line":0}},{"line":203,"address":[8272842,8272737,8272433,8272761,8272915],"length":1,"stats":{"Line":0}},{"line":204,"address":[5408015],"length":1,"stats":{"Line":0}},{"line":207,"address":[6085903,6085801],"length":1,"stats":{"Line":0}},{"line":209,"address":[6085965,6085930,6085858],"length":1,"stats":{"Line":0}},{"line":213,"address":[8270777,8273830,8274432,8273756,8273947,8270670],"length":1,"stats":{"Line":0}},{"line":214,"address":[6697005],"length":1,"stats":{"Line":0}},{"line":217,"address":[8273978,8274085],"length":1,"stats":{"Line":0}},{"line":218,"address":[6089754],"length":1,"stats":{"Line":0}},{"line":221,"address":[5158432],"length":1,"stats":{"Line":0}},{"line":227,"address":[6090419,6091103,6090813,6092507,6091316,6090701,6091205,6090586],"length":1,"stats":{"Line":0}},{"line":228,"address":[6090570,6090613],"length":1,"stats":{"Line":0}},{"line":229,"address":[8282413,8282327,8282528,8282680,8282444],"length":1,"stats":{"Line":0}},{"line":230,"address":[5313648,5314105,5313924,5314014,5314351],"length":1,"stats":{"Line":0}},{"line":233,"address":[8275816,8275901],"length":1,"stats":{"Line":0}},{"line":237,"address":[8283996],"length":1,"stats":{"Line":0}},{"line":238,"address":[8284039,8284078],"length":1,"stats":{"Line":0}},{"line":239,"address":[8276697,8276457,8276613,8276582,8276799],"length":1,"stats":{"Line":0}},{"line":240,"address":[5417784],"length":1,"stats":{"Line":0}},{"line":243,"address":[8277329],"length":1,"stats":{"Line":0}},{"line":244,"address":[6091663,6091583,6093755],"length":1,"stats":{"Line":0}},{"line":249,"address":[6091795],"length":1,"stats":{"Line":0}},{"line":250,"address":[6091869],"length":1,"stats":{"Line":0}},{"line":251,"address":[8276205,8276084,8276320,8276425,8276236],"length":1,"stats":{"Line":0}},{"line":252,"address":[8274810,8276328,8277696,8276388,8277918],"length":1,"stats":{"Line":0}},{"line":256,"address":[8276046],"length":1,"stats":{"Line":0}},{"line":260,"address":[6095870,6093985,6093792,6093823,6094049,6094675],"length":1,"stats":{"Line":0}},{"line":261,"address":[6093940,6094103,6094143],"length":1,"stats":{"Line":0}},{"line":268,"address":[8286389],"length":1,"stats":{"Line":0}},{"line":269,"address":[8278928],"length":1,"stats":{"Line":0}},{"line":270,"address":[8286528,8286471,8285871,8286801,8286585],"length":1,"stats":{"Line":0}},{"line":273,"address":[5318231],"length":1,"stats":{"Line":0}},{"line":274,"address":[8287434,8287006,8287457],"length":1,"stats":{"Line":0}},{"line":275,"address":[6095504],"length":1,"stats":{"Line":0}},{"line":284,"address":[8287051],"length":1,"stats":{"Line":0}},{"line":285,"address":[5318376],"length":1,"stats":{"Line":0}},{"line":286,"address":[8287167],"length":1,"stats":{"Line":0}},{"line":287,"address":[5318463],"length":1,"stats":{"Line":0}},{"line":288,"address":[8279756],"length":1,"stats":{"Line":0}},{"line":289,"address":[6095379],"length":1,"stats":{"Line":0}},{"line":290,"address":[5403106],"length":1,"stats":{"Line":0}},{"line":293,"address":[8280714,8280783],"length":1,"stats":{"Line":0}},{"line":296,"address":[8280766],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":103},{"path":["/","workspaces","homemetrics","src","email","mod.rs"],"content":"pub mod processor_base;\n\n// Re-export commonly used items\npub use processor_base::{EmailProcessingStrategy, BaseEmailProcessor};\n","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","homemetrics","src","email","processor_base.rs"],"content":"use anyhow::{Result, Context};\nuse log::{info, error, warn};\n\nuse crate::config::Config;\nuse crate::gmail_client::GmailClient;\nuse crate::database::Database;\nuse crate::slack_notifier::SlackNotifier;\n\n/// Trait that defines the specific processing logic for each email type\npub trait EmailProcessingStrategy: Send {\n    /// Search for emails to process (returns message IDs)\n    fn search_emails\u003c'a, 'b: 'a\u003e(\u0026'a self, gmail: \u0026'b GmailClient) -\u003e \n        std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003cVec\u003cString\u003e\u003e\u003e + Send + 'a\u003e\u003e;\n    \n    /// Process a single email and return the number of records processed\n    fn process_single_email\u003c'a, 'b: 'a, 'c: 'a\u003e(\n        \u0026'a self,\n        gmail: \u0026'b GmailClient,\n        database: Option\u003c\u0026'c Database\u003e,\n        slack: Option\u003c\u0026'c SlackNotifier\u003e,\n        message_id: \u0026'a str,\n        is_dry_run: bool,\n    ) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003cusize\u003e\u003e + Send + 'a\u003e\u003e;\n    \n    /// Mark email as processed (labels, archive, etc.)\n    fn mark_email_processed\u003c'a, 'b: 'a\u003e(\n        \u0026'a self,\n        gmail: \u0026'b GmailClient,\n        message_id: \u0026'a str,\n    ) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003c()\u003e\u003e + Send + 'a\u003e\u003e;\n    \n    /// Get the name of this processor (for logging)\n    fn processor_name(\u0026self) -\u003e \u0026str;\n    \n    /// Get the label name (for logging)\n    fn label_name(\u0026self) -\u003e \u0026str;\n}\n\n/// Base email processor that handles common logic\npub struct BaseEmailProcessor\u003cS: EmailProcessingStrategy\u003e {\n    config: Config,\n    database: Option\u003cDatabase\u003e,\n    slack: Option\u003cSlackNotifier\u003e,\n    strategy: S,\n}\n\nimpl\u003cS: EmailProcessingStrategy\u003e BaseEmailProcessor\u003cS\u003e {\n    pub async fn new(config: Config, strategy: S) -\u003e Result\u003cSelf\u003e {\n        info!(\"Initializing {} email processor\", strategy.processor_name());\n        \n        // Initialize database connection\n        let database = Database::new(\u0026config.database).await\n            .context(\"Unable to initialize database\")?;\n        \n        // Initialize Slack notifier if configured\n        let slack = if let Some(slack_config) = \u0026config.slack {\n            match SlackNotifier::new(slack_config) {\n                Ok(notifier) =\u003e {\n                    info!(\"‚úÖ Slack notifications enabled\");\n                    Some(notifier)\n                },\n                Err(e) =\u003e {\n                    warn!(\"‚ö†Ô∏è  Unable to initialize Slack notifier: {} - notifications disabled\", e);\n                    None\n                }\n            }\n        } else {\n            info!(\"‚ÑπÔ∏è  Slack notifications not configured\");\n            None\n        };\n        \n        Ok(BaseEmailProcessor {\n            config,\n            database: Some(database),\n            slack,\n            strategy,\n        })\n    }\n    \n    pub fn new_dry_run(config: Config, strategy: S) -\u003e Result\u003cSelf\u003e {\n        info!(\"üß™ Initializing {} email processor in dry-run mode (without database)\", strategy.processor_name());\n        \n        Ok(BaseEmailProcessor {\n            config,\n            database: None,\n            slack: None,  // No Slack notifications in dry-run mode\n            strategy,\n        })\n    }\n    \n    pub async fn process_emails(\u0026self, limit: Option\u003cusize\u003e) -\u003e Result\u003cusize\u003e {\n        info!(\"Starting {} email processing\", self.strategy.processor_name());\n        self.process_emails_common(limit, false).await\n    }\n    \n    pub async fn process_emails_dry_run(\u0026self, limit: Option\u003cusize\u003e) -\u003e Result\u003cusize\u003e {\n        println!(\"\\n{}\", \"=\".repeat(80));\n        println!(\"üß™ MODE DRY-RUN - {} ANALYSIS\", self.strategy.processor_name().to_uppercase());\n        println!(\"{}\", \"=\".repeat(80));\n        \n        self.process_emails_common(limit, true).await\n    }\n    \n    /// Common processing logic for both normal and dry-run modes\n    async fn process_emails_common(\u0026self, limit: Option\u003cusize\u003e, is_dry_run: bool) -\u003e Result\u003cusize\u003e {\n        // 1. Connect to Gmail API\n        let gmail_client = GmailClient::new(\u0026self.config.gmail).await\n            .context(\"Unable to connect to Gmail API\")?;\n        \n        // 2. Search for emails using strategy\n        let message_ids = self.strategy.search_emails(\u0026gmail_client).await\n            .context(\"Error searching for emails\")?;\n        \n        if message_ids.is_empty() {\n            if is_dry_run {\n                println!(\"‚ùå No emails found with label '{}'\", self.strategy.label_name());\n                println!(\"   Hint: Add the label '{}' to emails to process\", self.strategy.label_name());\n            } else {\n                info!(\"No emails found with label '{}'\", self.strategy.label_name());\n            }\n            return Ok(0);\n        }\n        \n        if is_dry_run {\n            println!(\"‚úÖ Found {} email(s) matching criteria\\n\", message_ids.len());\n        }\n        \n        let mut total_processed = 0;\n        let mut total_records_saved = 0;\n        \n        // 3. Process each found email (with optional limit)\n        let emails_to_process = if let Some(limit) = limit {\n            message_ids.into_iter().take(limit).collect()\n        } else {\n            message_ids\n        };\n        \n        for (index, message_id) in emails_to_process.iter().enumerate() {\n            if is_dry_run {\n                println!(\"üìß Email {}/{} (ID: {})\", index + 1, emails_to_process.len(), message_id);\n                println!(\"{}\", \"-\".repeat(60));\n            }\n            \n            match self.strategy.process_single_email(\n                \u0026gmail_client,\n                self.database.as_ref(),\n                self.slack.as_ref(),\n                message_id,\n                is_dry_run\n            ).await {\n                Ok(records_count) =\u003e {\n                    total_processed += 1;\n                    \n                    if records_count == 0 {\n                        // Special case: email skipped (no data extracted)\n                        if is_dry_run {\n                            println!(\"‚ö†Ô∏è  Email {} analyzed but no data extracted\\n\", message_id);\n                        } else {\n                            warn!(\"Email {} processed but no data extracted\", message_id);\n                        }\n                        continue; // Skip marking as processed if no data\n                    }\n                    \n                    total_records_saved += records_count;\n                    \n                    // Mark email as processed (unless dry-run)\n                    if !is_dry_run {\n                        if let Err(e) = self.strategy.mark_email_processed(\u0026gmail_client, message_id).await {\n                            error!(\"Failed to mark email {} as processed: {}\", message_id, e);\n                        }\n                    }\n                    \n                    if is_dry_run {\n                        println!(\"‚úÖ Email {} analyzed successfully ({} record(s))\\n\", message_id, records_count);\n                    } else {\n                        info!(\"Email {} processed successfully: {} record(s) saved\", message_id, records_count);\n                    }\n                }\n                Err(e) =\u003e {\n                    if is_dry_run {\n                        println!(\"‚ùå Error analyzing email {}: {}\\n\", message_id, e);\n                    } else {\n                        error!(\"Error processing email {}: {}\", message_id, e);\n                        \n                        // Send error notification to Slack\n                        if let Some(slack) = \u0026self.slack {\n                            let _ = slack.send_message(\u0026format!(\n                                \"‚ùå Error processing {} email {}: {}\",\n                                self.strategy.processor_name(),\n                                message_id,\n                                e\n                            )).await;\n                        }\n                    }\n                }\n            }\n        }\n        \n        if is_dry_run {\n            println!(\"{}\", \"=\".repeat(80));\n            println!(\"üèÅ Analysis completed: {} emails analyzed out of {}\", total_processed, emails_to_process.len());\n            println!(\"üìä Total records: {}\", total_records_saved);\n            println!(\"{}\", \"=\".repeat(80));\n        } else {\n            info!(\"Processing completed: {} emails processed, {} records saved\", \n                  total_processed, total_records_saved);\n        }\n        \n        Ok(total_processed)\n    }\n}\n","traces":[{"line":48,"address":[8611328,8612182,8614320,8614554,8616483,8611468,8614236,8613539,8611610,8614412,8611280,8611344,8611296,8611376,8615126,8617180],"length":1,"stats":{"Line":0}},{"line":49,"address":[8595602,8592615,8592493,8592658,8595437,8595559],"length":1,"stats":{"Line":0}},{"line":52,"address":[6501245,6504072,6501192,6501648,6505020,6501744,6504125,6504624,6504528,6502140],"length":1,"stats":{"Line":0}},{"line":56,"address":[5857805,5860685,5859045,5861925],"length":1,"stats":{"Line":0}},{"line":57,"address":[8593790,8593682,8596734,8596626],"length":1,"stats":{"Line":0}},{"line":58,"address":[5860988,5858108],"length":1,"stats":{"Line":0}},{"line":59,"address":[8596862,8597015,8594071,8594008,8596952,8593918],"length":1,"stats":{"Line":0}},{"line":60,"address":[8613086,8616030],"length":1,"stats":{"Line":0}},{"line":62,"address":[8615843,8612899],"length":1,"stats":{"Line":0}},{"line":63,"address":[8612915,8613593,8613639,8616537,8615859,8616583],"length":1,"stats":{"Line":0}},{"line":64,"address":[8616553,8613609],"length":1,"stats":{"Line":0}},{"line":68,"address":[8616882,8615717,8612773,8613938,8616853,8613909],"length":1,"stats":{"Line":0}},{"line":69,"address":[6503411,6506291],"length":1,"stats":{"Line":0}},{"line":72,"address":[6502933,6505813],"length":1,"stats":{"Line":0}},{"line":73,"address":[5858474,5861354],"length":1,"stats":{"Line":0}},{"line":74,"address":[8594319,8597263],"length":1,"stats":{"Line":0}},{"line":75,"address":[8597279,8594335],"length":1,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[5863468,5862876,5862304,5862896],"length":1,"stats":{"Line":0}},{"line":81,"address":[8618149,8617894,8617541,8617286,8617367,8617975],"length":1,"stats":{"Line":0}},{"line":83,"address":[6507442,6506850],"length":1,"stats":{"Line":0}},{"line":84,"address":[5863010,5862418],"length":1,"stats":{"Line":0}},{"line":85,"address":[5863028,5862436],"length":1,"stats":{"Line":0}},{"line":86,"address":[5862448,5863040],"length":1,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[6509031,6508166,6509040,6509068,6507968,6509278,6507996,6508700,6507890,6507938,6510103,6509238,6508206,6507872,6507920,6509772],"length":1,"stats":{"Line":0}},{"line":92,"address":[6509332,6509374,6508302,6508124,6508260,6509196],"length":1,"stats":{"Line":0}},{"line":93,"address":[5455399,5454391],"length":1,"stats":{"Line":0}},{"line":96,"address":[5865746,5865776,5865801,5866704,5865986,5865946,5865728],"length":1,"stats":{"Line":0}},{"line":97,"address":[8620970,8621089],"length":1,"stats":{"Line":0}},{"line":98,"address":[8602178],"length":1,"stats":{"Line":0}},{"line":99,"address":[8602394],"length":1,"stats":{"Line":0}},{"line":101,"address":[8621672,8621808,8621029],"length":1,"stats":{"Line":0}},{"line":105,"address":[5877136,5877197,5877501,5867104,5878417,5867261,5867008,5867165,5867200,5867069,5877374,5867438,5877637,5867565,5868481,5867701],"length":1,"stats":{"Line":0}},{"line":107,"address":[8622827,8622707,8632640,8632851,8622496,8633302,8623534,8632704,8633678,8632971,8623158,8622560],"length":1,"stats":{"Line":0}},{"line":111,"address":[6733415,6731879],"length":1,"stats":{"Line":0}},{"line":114,"address":[8605028,8605116,8615172,8615260],"length":1,"stats":{"Line":0}},{"line":115,"address":[8605141,8615285],"length":1,"stats":{"Line":0}},{"line":116,"address":[8625546,8635690,8635194,8625050],"length":1,"stats":{"Line":0}},{"line":117,"address":[6514862,6524798],"length":1,"stats":{"Line":0}},{"line":119,"address":[5879925,5869989,5869833,5869930,5879769,5879866],"length":1,"stats":{"Line":0}},{"line":121,"address":[8616184,8606040],"length":1,"stats":{"Line":0}},{"line":124,"address":[8615266,8605122],"length":1,"stats":{"Line":0}},{"line":125,"address":[8634448,8624304],"length":1,"stats":{"Line":0}},{"line":128,"address":[8624239,8634383],"length":1,"stats":{"Line":0}},{"line":129,"address":[8624258,8634402],"length":1,"stats":{"Line":0}},{"line":132,"address":[8615349,8615708,8605205,8605564,8605383,8615527],"length":1,"stats":{"Line":0}},{"line":133,"address":[8624483,8624646,8634627,8634790],"length":1,"stats":{"Line":0}},{"line":135,"address":[8634707,8624563],"length":1,"stats":{"Line":0}},{"line":138,"address":[6525554,6513921,6523966,6514172,6514030,6523857,6524108,6515618],"length":1,"stats":{"Line":0}},{"line":139,"address":[6515712,6525648],"length":1,"stats":{"Line":0}},{"line":140,"address":[6517020,6526956],"length":1,"stats":{"Line":0}},{"line":141,"address":[8638296,8628152],"length":1,"stats":{"Line":0}},{"line":144,"address":[8619650,8609414,8609506,8609818,8619882,8619962,8609738,8618853,8608709,8619558],"length":1,"stats":{"Line":0}},{"line":145,"address":[6516975,6526911],"length":1,"stats":{"Line":0}},{"line":146,"address":[8608751,8618895],"length":1,"stats":{"Line":0}},{"line":147,"address":[5883058,5873122],"length":1,"stats":{"Line":0}},{"line":148,"address":[8609312,8619456],"length":1,"stats":{"Line":0}},{"line":149,"address":[6527562,6517626],"length":1,"stats":{"Line":0}},{"line":150,"address":[5873369,5883556,5883305,5873303,5880660,5883300,5870724,5877446,5867510,5873620,5873364,5883239],"length":1,"stats":{"Line":0}},{"line":151,"address":[8628967,8639111],"length":1,"stats":{"Line":0}},{"line":152,"address":[8629074,8628997,8639218,8639141],"length":1,"stats":{"Line":0}},{"line":154,"address":[5873806,5883742],"length":1,"stats":{"Line":0}},{"line":156,"address":[5873847,5883783],"length":1,"stats":{"Line":0}},{"line":157,"address":[8629213,8639704,8629560,8639357],"length":1,"stats":{"Line":0}},{"line":159,"address":[8620329,8610185,8620240,8610096],"length":1,"stats":{"Line":0}},{"line":164,"address":[6518812,6518250,6528714,6528186,6528748,6518778],"length":1,"stats":{"Line":0}},{"line":167,"address":[6518793,6528729,6519895,6529831],"length":1,"stats":{"Line":0}},{"line":168,"address":[5444127,5445711],"length":1,"stats":{"Line":0}},{"line":169,"address":[8630437,8640556,8630276,8640581,8640420,8630412],"length":1,"stats":{"Line":0}},{"line":173,"address":[8629766,8639910],"length":1,"stats":{"Line":0}},{"line":174,"address":[5875577,5885889,5875953,5885513],"length":1,"stats":{"Line":0}},{"line":176,"address":[8630807,8640951,8641034,8630890],"length":1,"stats":{"Line":0}},{"line":179,"address":[8628911,8639055],"length":1,"stats":{"Line":0}},{"line":180,"address":[6528013,6518077],"length":1,"stats":{"Line":0}},{"line":181,"address":[8622463,8612319,8613207,8623351],"length":1,"stats":{"Line":0}},{"line":183,"address":[5886173,5876160,5886096,5876077,5886013,5876237],"length":1,"stats":{"Line":0}},{"line":186,"address":[5876564,5886500,5876166,5886102],"length":1,"stats":{"Line":0}},{"line":187,"address":[8632241,8631914,8636355,8626211,8642385,8642058],"length":1,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[5886508,5876572],"length":1,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[5886918,5876982,5880756,5880726,5880963,5877488,5880985,5867552,5870790,5886878,5870820,5871027,5876942,5871049],"length":1,"stats":{"Line":0}},{"line":199,"address":[8617642,8607498],"length":1,"stats":{"Line":0}},{"line":200,"address":[5881352,5871416,5871872,5881808],"length":1,"stats":{"Line":0}},{"line":201,"address":[5872031,5881967],"length":1,"stats":{"Line":0}},{"line":202,"address":[5872227,5882163],"length":1,"stats":{"Line":0}},{"line":203,"address":[8637690,8627546],"length":1,"stats":{"Line":0}},{"line":205,"address":[8617816,8607515,8617659,8607672,8607602,8617746],"length":1,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[8607608,8617752],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":92},{"path":["/","workspaces","homemetrics","src","gmail_client.rs"],"content":"use anyhow::{Result, Context};\nuse google_gmail1::{Gmail, hyper, hyper_rustls, oauth2};\nuse log::{info, debug, warn};\n\nuse crate::config::GmailConfig;\n\npub struct EmailInfo {\n    pub content: Vec\u003cu8\u003e,\n    pub date: chrono::DateTime\u003cchrono::Utc\u003e,\n    pub headers: String,\n}\n\npub struct GmailClient {\n    hub: Gmail\u003chyper_rustls::HttpsConnector\u003chyper::client::HttpConnector\u003e\u003e,\n}\n\nimpl GmailClient {\n    pub async fn new(config: \u0026GmailConfig) -\u003e Result\u003cSelf\u003e {\n        info!(\"Connecting to Gmail API via OAuth2\");\n        \n        // Read OAuth2 client credentials from file\n        let secret = oauth2::read_application_secret(\u0026config.credentials_path)\n            .await\n            .context(\"Unable to read OAuth2 client credentials file\")?;\n        \n        // Create authenticator with token persistence\n        // Note: We use Scope::Modify on all API calls, which is the broadest scope available\n        // in google-gmail1 (covers reading, modifying labels, and managing emails)\n        let auth = oauth2::InstalledFlowAuthenticator::builder(\n            secret,\n            oauth2::InstalledFlowReturnMethod::HTTPRedirect,\n        )\n        .persist_tokens_to_disk(\u0026config.token_cache_path)\n        .build()\n        .await\n        .context(\"Unable to create OAuth2 authenticator\")?;\n        \n        // Create HTTP client\n        let connector = hyper_rustls::HttpsConnectorBuilder::new()\n            .with_native_roots()?\n            .https_or_http()\n            .enable_http1()\n            .build();\n        \n        let client = hyper::Client::builder().build(connector);\n        \n        // Create Gmail hub with appropriate scopes\n        let hub = Gmail::new(client, auth);\n        \n        info!(\"‚úÖ Gmail API connection established successfully\");\n        \n        Ok(GmailClient { hub })\n    }\n    \n    pub async fn search_xsense_emails(\u0026self) -\u003e Result\u003cVec\u003cString\u003e\u003e {\n        info!(\"Searching for emails with label 'homemetrics/todo/xsense'\");\n        \n        let user_id = \"me\";\n        let query = \"label:homemetrics/todo/xsense\";\n        \n        debug!(\"Search criteria: {}\", query);\n        \n        let result = self.hub\n            .users()\n            .messages_list(user_id)\n            .q(query)\n            .add_scope(google_gmail1::api::Scope::Modify)\n            .doit()\n            .await\n            .context(\"Error searching for emails\")?;\n        \n        let message_ids: Vec\u003cString\u003e = result.1\n            .messages\n            .unwrap_or_default()\n            .into_iter()\n            .filter_map(|msg| msg.id)\n            .collect();\n        \n        info!(\"Found {} email(s) with label 'homemetrics/todo/xsense'\", message_ids.len());\n        \n        Ok(message_ids)\n    }\n    \n    /// List all Gmail labels with their IDs and names\n    pub async fn list_labels(\u0026self) -\u003e Result\u003c()\u003e {\n        info!(\"Retrieving Gmail labels list\");\n        \n        let user_id = \"me\";\n        \n        let result = self.hub\n            .users()\n            .labels_list(user_id)\n            .add_scope(google_gmail1::api::Scope::Modify)\n            .doit()\n            .await\n            .context(\"Unable to list labels\")?;\n        \n        let labels = result.1.labels.unwrap_or_default();\n        \n        if labels.is_empty() {\n            println!(\"No labels found.\");\n            return Ok(());\n        }\n        \n        println!(\"Found {} label(s):\\n\", labels.len());\n        println!(\"{:\u003c40} {:\u003c30} {:\u003c15}\", \"Label Name\", \"Label ID\", \"Type\");\n        println!(\"{}\", \"=\".repeat(85));\n        \n        // Sort labels: homemetrics labels first, then system, then user\n        let mut sorted_labels = labels;\n        sorted_labels.sort_by(|a, b| {\n            let a_name = a.name.as_deref().unwrap_or(\"\");\n            let b_name = b.name.as_deref().unwrap_or(\"\");\n            \n            let a_is_homemetrics = a_name.starts_with(\"homemetrics\");\n            let b_is_homemetrics = b_name.starts_with(\"homemetrics\");\n            \n            match (a_is_homemetrics, b_is_homemetrics) {\n                (true, false) =\u003e std::cmp::Ordering::Less,\n                (false, true) =\u003e std::cmp::Ordering::Greater,\n                _ =\u003e a_name.cmp(b_name),\n            }\n        });\n        \n        for label in sorted_labels {\n            let name = label.name.unwrap_or_else(|| \"Unknown\".to_string());\n            let id = label.id.unwrap_or_else(|| \"Unknown\".to_string());\n            let label_type = label.type_.unwrap_or_else(|| \"Unknown\".to_string());\n            \n            // Highlight homemetrics labels\n            if name.starts_with(\"homemetrics\") {\n                println!(\"‚ú® {:\u003c38} {:\u003c30} {:\u003c15}\", name, id, label_type);\n            } else {\n                println!(\"{:\u003c40} {:\u003c30} {:\u003c15}\", name, id, label_type);\n            }\n        }\n        \n        Ok(())\n    }\n    \n    /// Retrieve only email metadata (subject and sender)\n    pub async fn fetch_email_metadata(\u0026self, message_id: \u0026str) -\u003e Result\u003c(String, String)\u003e {\n        debug!(\"Retrieving email metadata for ID: {}\", message_id);\n        \n        let user_id = \"me\";\n        \n        // Retrieve only headers with METADATA format\n        let result = self.hub\n            .users()\n            .messages_get(user_id, message_id)\n            .format(\"metadata\")\n            .add_metadata_headers(\"From\")\n            .add_metadata_headers(\"Subject\")\n            .add_scope(google_gmail1::api::Scope::Modify)\n            .doit()\n            .await\n            .context(\"Unable to retrieve email metadata\")?;\n        \n        let message = result.1;\n        \n        // Extract subject and sender from headers\n        let mut subject = String::from(\"No subject\");\n        let mut from = String::from(\"Unknown sender\");\n        \n        if let Some(payload) = message.payload {\n            if let Some(headers) = payload.headers {\n                for header in headers {\n                    if let (Some(name), Some(value)) = (header.name, header.value) {\n                        match name.as_str() {\n                            \"Subject\" =\u003e subject = value,\n                            \"From\" =\u003e from = value,\n                            _ =\u003e {}\n                        }\n                    }\n                }\n            }\n        }\n        \n        Ok((subject, from))\n    }\n    \n    pub async fn fetch_email_complete(\u0026self, message_id: \u0026str) -\u003e Result\u003cEmailInfo\u003e {\n        debug!(\"Complete email retrieval for ID: {}\", message_id);\n        \n        let user_id = \"me\";\n        \n        // Retrieve complete message with RAW format\n        let result = self.hub\n            .users()\n            .messages_get(user_id, message_id)\n            .format(\"raw\")\n            .add_scope(google_gmail1::api::Scope::Modify)\n            .doit()\n            .await;\n        \n        let message = match result {\n            Ok((_, msg)) =\u003e msg,\n            Err(e) =\u003e {\n                warn!(\"Error retrieving in RAW format: {}\", e);\n                return Err(anyhow::anyhow!(\"Unable to retrieve email: {}\", e));\n            }\n        };\n        \n        // Raw content is already decoded by Gmail API (RFC822 format)\n        let raw_content = message.raw\n            .context(\"No raw content in email\")?;\n        \n        debug!(\"Email retrieved, size: {} bytes\", raw_content.len());\n        \n        // raw_content is already the raw RFC822 content (not base64)\n        let raw_bytes = raw_content;\n        \n        debug!(\"Email retrieved, size: {} bytes\", raw_bytes.len());\n        \n        // Parser le contenu avec mail-parser\n        let email_str = String::from_utf8_lossy(\u0026raw_bytes);\n        let parsed_email = mail_parser::MessageParser::default()\n            .parse(email_str.as_bytes())\n            .context(\"Unable to parse email\")?;\n        \n        // Extraire la date\n        let email_date = if let Some(date_header) = parsed_email.date() {\n            chrono::DateTime::from_timestamp(date_header.to_timestamp(), 0)\n                .map(|dt| dt.with_timezone(\u0026chrono::Utc))\n                .unwrap_or_else(chrono::Utc::now)\n        } else {\n            warn!(\"No date in email, using current date\");\n            chrono::Utc::now()\n        };\n        \n        // Extraire les headers principaux\n        let from = parsed_email.from()\n            .and_then(|addrs| addrs.first())\n            .map(|addr| {\n                match (\u0026addr.name, \u0026addr.address) {\n                    (Some(name), Some(email)) =\u003e format!(\"{} \u003c{}\u003e\", name, email),\n                    (None, Some(email)) =\u003e email.to_string(),\n                    _ =\u003e \"Unknown sender\".to_string(),\n                }\n            })\n            .unwrap_or_else(|| \"Unknown sender\".to_string());\n        \n        let subject = parsed_email.subject()\n            .unwrap_or(\"No subject\")\n            .to_string();\n        \n        let headers = format!(\"De: {}\\nObjet: {}\", from, subject);\n        \n        Ok(EmailInfo {\n            content: raw_bytes,\n            date: email_date,\n            headers,\n        })\n    }\n    \n    pub async fn mark_email_as_processed(\u0026self, message_id: \u0026str) -\u003e Result\u003c()\u003e {\n        info!(\"Marking email {} as processed\", message_id);\n        \n        let user_id = \"me\";\n        \n        // First, retrieve existing labels to get IDs\n        let labels_result = self.hub\n            .users()\n            .labels_list(user_id)\n            .add_scope(google_gmail1::api::Scope::Modify)\n            .doit()\n            .await\n            .context(\"Unable to list labels\")?;\n        \n        let labels = labels_result.1.labels.unwrap_or_default();\n        \n        // Trouver les IDs des labels\n        let todo_label_id = labels.iter()\n            .find(|l| l.name.as_deref() == Some(\"homemetrics/todo/xsense\"))\n            .and_then(|l| l.id.clone());\n        \n        let done_label_id = labels.iter()\n            .find(|l| l.name.as_deref() == Some(\"homemetrics/done/xsense\"))\n            .and_then(|l| l.id.clone());\n        \n        // Create modification request\n        let mut modify_request = google_gmail1::api::ModifyMessageRequest::default();\n        \n        // Supprimer le label \"todo\"\n        if let Some(todo_id) = todo_label_id {\n            modify_request.remove_label_ids = Some(vec![todo_id]);\n            debug!(\"Removing label 'homemetrics/todo/xsense'\");\n        } else {\n            warn!(\"Label 'homemetrics/todo/xsense' not found\");\n        }\n        \n        // Ajouter le label \"done\"\n        if let Some(done_id) = done_label_id {\n            modify_request.add_label_ids = Some(vec![done_id]);\n            debug!(\"Adding label 'homemetrics/done/xsense'\");\n        } else {\n            warn!(\"Label 'homemetrics/done/xsense' not found, it will need to be created in Gmail\");\n        }\n        \n        // Apply modifications\n        self.hub\n            .users()\n            .messages_modify(modify_request, user_id, message_id)\n            .add_scope(google_gmail1::api::Scope::Modify)\n            .doit()\n            .await\n            .context(\"Unable to modify email labels\")?;\n        \n        info!(\"‚úÖ Email {} marked as processed with label 'homemetrics/done/xsense'\", message_id);\n        Ok(())\n    }\n    \n    // ============================================================================\n    // Blue Riot Pool Monitoring Methods\n    // ============================================================================\n    \n    pub async fn search_pool_emails(\u0026self) -\u003e Result\u003cVec\u003cString\u003e\u003e {\n        info!(\"Searching for emails with label 'homemetrics/todo/blueriot'\");\n        \n        let user_id = \"me\";\n        let query = \"label:homemetrics/todo/blueriot\";\n        \n        debug!(\"Search criteria: {}\", query);\n        \n        let result = self.hub\n            .users()\n            .messages_list(user_id)\n            .q(query)\n            .add_scope(google_gmail1::api::Scope::Modify)\n            .doit()\n            .await\n            .context(\"Error searching for pool emails\")?;\n        \n        let message_ids: Vec\u003cString\u003e = result.1\n            .messages\n            .unwrap_or_default()\n            .into_iter()\n            .filter_map(|msg| msg.id)\n            .collect();\n        \n        info!(\"Found {} email(s) with label 'homemetrics/todo/blueriot'\", message_ids.len());\n        \n        Ok(message_ids)\n    }\n    \n    pub async fn mark_pool_email_as_processed(\u0026self, message_id: \u0026str) -\u003e Result\u003c()\u003e {\n        info!(\"Marking pool email {} as processed\", message_id);\n        \n        let user_id = \"me\";\n        \n        // First, retrieve existing labels to get IDs\n        let labels_result = self.hub\n            .users()\n            .labels_list(user_id)\n            .add_scope(google_gmail1::api::Scope::Modify)\n            .doit()\n            .await\n            .context(\"Unable to list labels\")?;\n        \n        let labels = labels_result.1.labels.unwrap_or_default();\n        \n        // Find label IDs for Blue Riot\n        let todo_label_id = labels.iter()\n            .find(|l| l.name.as_deref() == Some(\"homemetrics/todo/blueriot\"))\n            .and_then(|l| l.id.clone());\n        \n        let done_label_id = labels.iter()\n            .find(|l| l.name.as_deref() == Some(\"homemetrics/done/blueriot\"))\n            .and_then(|l| l.id.clone());\n        \n        let inbox_label_id = labels.iter()\n            .find(|l| l.name.as_deref() == Some(\"INBOX\"))\n            .and_then(|l| l.id.clone());\n        \n        let unread_label_id = labels.iter()\n            .find(|l| l.name.as_deref() == Some(\"UNREAD\"))\n            .and_then(|l| l.id.clone());\n        \n        // Create modification request\n        let mut modify_request = google_gmail1::api::ModifyMessageRequest::default();\n        let mut remove_labels = Vec::new();\n        let mut add_labels = Vec::new();\n        \n        // Remove \"todo\" label\n        if let Some(todo_id) = todo_label_id {\n            remove_labels.push(todo_id);\n            debug!(\"Removing label 'homemetrics/todo/blueriot'\");\n        } else {\n            warn!(\"Label 'homemetrics/todo/blueriot' not found\");\n        }\n        \n        // Remove INBOX\n        if let Some(inbox_id) = inbox_label_id {\n            remove_labels.push(inbox_id);\n            debug!(\"Removing from INBOX\");\n        }\n        \n        // Remove UNREAD (mark as read)\n        if let Some(unread_id) = unread_label_id {\n            remove_labels.push(unread_id);\n            debug!(\"Marking as read\");\n        }\n        \n        // Add \"done\" label\n        if let Some(done_id) = done_label_id {\n            add_labels.push(done_id);\n            debug!(\"Adding label 'homemetrics/done/blueriot'\");\n        } else {\n            warn!(\"Label 'homemetrics/done/blueriot' not found, it will need to be created in Gmail\");\n        }\n        \n        modify_request.remove_label_ids = Some(remove_labels);\n        modify_request.add_label_ids = Some(add_labels);\n        \n        // Apply modifications\n        self.hub\n            .users()\n            .messages_modify(modify_request, user_id, message_id)\n            .add_scope(google_gmail1::api::Scope::Modify)\n            .doit()\n            .await\n            .context(\"Unable to modify pool email labels\")?;\n        \n        info!(\"‚úÖ Pool email {} marked as processed (read, archived, labeled 'done')\", message_id);\n        Ok(())\n    }\n}\n","traces":[{"line":18,"address":[5128064,5128072],"length":1,"stats":{"Line":0}},{"line":19,"address":[4152655,4152818,4152853],"length":1,"stats":{"Line":0}},{"line":22,"address":[4153971,4153546,4152824,4153414,4153148,4153435],"length":1,"stats":{"Line":0}},{"line":23,"address":[4152730,4153231,4153416,4153141,4153178],"length":1,"stats":{"Line":0}},{"line":30,"address":[4943365],"length":1,"stats":{"Line":0}},{"line":31,"address":[4931179],"length":1,"stats":{"Line":0}},{"line":33,"address":[4943501],"length":1,"stats":{"Line":0}},{"line":35,"address":[4931456,4931677,4931346,4930159,4931403],"length":1,"stats":{"Line":0}},{"line":39,"address":[4931951,4932041,4931891],"length":1,"stats":{"Line":0}},{"line":45,"address":[4944479,4944423],"length":1,"stats":{"Line":0}},{"line":48,"address":[4154970],"length":1,"stats":{"Line":0}},{"line":50,"address":[4944855,4944765,4944980],"length":1,"stats":{"Line":0}},{"line":52,"address":[4932637],"length":1,"stats":{"Line":0}},{"line":55,"address":[5655576,5655568],"length":1,"stats":{"Line":0}},{"line":56,"address":[4933583,4933502,4933357],"length":1,"stats":{"Line":0}},{"line":58,"address":[4155710],"length":1,"stats":{"Line":0}},{"line":59,"address":[4945732],"length":1,"stats":{"Line":0}},{"line":61,"address":[5670095,5670420,5670374],"length":1,"stats":{"Line":0}},{"line":63,"address":[5671284,5670735,5670824,5671161,5670388,5670809,5670901,5671182],"length":1,"stats":{"Line":0}},{"line":66,"address":[4156697],"length":1,"stats":{"Line":0}},{"line":67,"address":[4156736],"length":1,"stats":{"Line":0}},{"line":69,"address":[5421959],"length":1,"stats":{"Line":0}},{"line":72,"address":[4947103,4947214],"length":1,"stats":{"Line":0}},{"line":76,"address":[4158192,4158220],"length":1,"stats":{"Line":0}},{"line":79,"address":[4157573,4157665,4157483],"length":1,"stats":{"Line":0}},{"line":81,"address":[4947391],"length":1,"stats":{"Line":0}},{"line":85,"address":[4158569,4158789,4158496,4163283,4158746,4159345],"length":1,"stats":{"Line":0}},{"line":86,"address":[4158846,4158898,4158701],"length":1,"stats":{"Line":0}},{"line":88,"address":[4158542],"length":1,"stats":{"Line":0}},{"line":90,"address":[4949119,4949030,4949415,4948976,4948668,4949390,4949525,4953481],"length":1,"stats":{"Line":0}},{"line":93,"address":[4159206],"length":1,"stats":{"Line":0}},{"line":95,"address":[4936868,4936360,4936979,4936925,4937168],"length":1,"stats":{"Line":0}},{"line":98,"address":[4159888,4159773],"length":1,"stats":{"Line":0}},{"line":100,"address":[4949756,4949821],"length":1,"stats":{"Line":0}},{"line":101,"address":[4163424,4159983],"length":1,"stats":{"Line":0}},{"line":102,"address":[4953347],"length":1,"stats":{"Line":0}},{"line":105,"address":[4937603,4937661],"length":1,"stats":{"Line":0}},{"line":106,"address":[4160121],"length":1,"stats":{"Line":0}},{"line":107,"address":[5674768],"length":1,"stats":{"Line":0}},{"line":110,"address":[5674959],"length":1,"stats":{"Line":0}},{"line":111,"address":[4950875,4950795,4953504],"length":1,"stats":{"Line":0}},{"line":112,"address":[4953539],"length":1,"stats":{"Line":0}},{"line":113,"address":[4953595],"length":1,"stats":{"Line":0}},{"line":115,"address":[5677832],"length":1,"stats":{"Line":0}},{"line":116,"address":[5677870],"length":1,"stats":{"Line":0}},{"line":118,"address":[4941505],"length":1,"stats":{"Line":0}},{"line":119,"address":[4163894],"length":1,"stats":{"Line":0}},{"line":120,"address":[4953784],"length":1,"stats":{"Line":0}},{"line":121,"address":[4941549],"length":1,"stats":{"Line":0}},{"line":125,"address":[5675090,5675280,5677358],"length":1,"stats":{"Line":0}},{"line":126,"address":[4953820,4953808,4951171],"length":1,"stats":{"Line":0}},{"line":127,"address":[5678032,5678044,5675609],"length":1,"stats":{"Line":0}},{"line":128,"address":[4941692,4939319,4941680],"length":1,"stats":{"Line":0}},{"line":131,"address":[4161833,4161765],"length":1,"stats":{"Line":0}},{"line":132,"address":[5676574,5675977],"length":1,"stats":{"Line":0}},{"line":134,"address":[5676007,5675950],"length":1,"stats":{"Line":0}},{"line":138,"address":[5675443],"length":1,"stats":{"Line":0}},{"line":142,"address":[4957506,4954247,4954290,4955038,4954041,4953952],"length":1,"stats":{"Line":0}},{"line":143,"address":[5678378,5678523,5678566],"length":1,"stats":{"Line":0}},{"line":145,"address":[4941790],"length":1,"stats":{"Line":0}},{"line":148,"address":[4954735,4955387,4954709,4954891,4954358,4954980,4955277,4955252],"length":1,"stats":{"Line":0}},{"line":150,"address":[4942503],"length":1,"stats":{"Line":0}},{"line":154,"address":[5679039],"length":1,"stats":{"Line":0}},{"line":156,"address":[4942729,4943030,4942840,4942053,4942786],"length":1,"stats":{"Line":0}},{"line":159,"address":[4943275],"length":1,"stats":{"Line":0}},{"line":162,"address":[4943314],"length":1,"stats":{"Line":0}},{"line":163,"address":[5679725],"length":1,"stats":{"Line":0}},{"line":165,"address":[5679793,5682339],"length":1,"stats":{"Line":0}},{"line":166,"address":[4943783,4943539],"length":1,"stats":{"Line":0}},{"line":167,"address":[4943916,4944051,4945480,4943823],"length":1,"stats":{"Line":0}},{"line":168,"address":[4944470,4944387,4944118],"length":1,"stats":{"Line":0}},{"line":169,"address":[4956790,4956858],"length":1,"stats":{"Line":0}},{"line":170,"address":[4944650,4944716,4944994],"length":1,"stats":{"Line":0}},{"line":171,"address":[4166937,4167110,4167051,4167026],"length":1,"stats":{"Line":0}},{"line":179,"address":[5679925],"length":1,"stats":{"Line":0}},{"line":182,"address":[5655680,5655698],"length":1,"stats":{"Line":0}},{"line":183,"address":[4959253,4959398,4959454],"length":1,"stats":{"Line":0}},{"line":185,"address":[4946862],"length":1,"stats":{"Line":0}},{"line":188,"address":[4947188,4947762,4947595,4948064,4947569,4947673],"length":1,"stats":{"Line":0}},{"line":190,"address":[4169839],"length":1,"stats":{"Line":0}},{"line":192,"address":[5683989],"length":1,"stats":{"Line":0}},{"line":194,"address":[4169360,4170024,4170328,4169987,4170077],"length":1,"stats":{"Line":0}},{"line":196,"address":[5684427],"length":1,"stats":{"Line":0}},{"line":197,"address":[4170453],"length":1,"stats":{"Line":0}},{"line":198,"address":[4960411],"length":1,"stats":{"Line":0}},{"line":199,"address":[4964816,4960413,4964852],"length":1,"stats":{"Line":0}},{"line":200,"address":[5688866,5689138],"length":1,"stats":{"Line":0}},{"line":205,"address":[4960672,4960752,4964404,4960549],"length":1,"stats":{"Line":0}},{"line":208,"address":[4948824,4948629,4948722],"length":1,"stats":{"Line":0}},{"line":211,"address":[4948728],"length":1,"stats":{"Line":0}},{"line":213,"address":[4961426,4961470,4961000],"length":1,"stats":{"Line":0}},{"line":216,"address":[4961813,4961432],"length":1,"stats":{"Line":0}},{"line":217,"address":[4962026,4961832,4962172],"length":1,"stats":{"Line":0}},{"line":218,"address":[4171967,4171875],"length":1,"stats":{"Line":0}},{"line":222,"address":[4962520],"length":1,"stats":{"Line":0}},{"line":223,"address":[4950386,4950459],"length":1,"stats":{"Line":0}},{"line":224,"address":[4965392,4965404],"length":1,"stats":{"Line":0}},{"line":227,"address":[4950560,4950402,4950588],"length":1,"stats":{"Line":0}},{"line":228,"address":[5687067,5686830],"length":1,"stats":{"Line":0}},{"line":232,"address":[4962753,4963037],"length":1,"stats":{"Line":0}},{"line":233,"address":[4965449,4965440],"length":1,"stats":{"Line":0}},{"line":234,"address":[5689472],"length":1,"stats":{"Line":0}},{"line":235,"address":[4965500],"length":1,"stats":{"Line":0}},{"line":236,"address":[5689692],"length":1,"stats":{"Line":0}},{"line":237,"address":[4175555],"length":1,"stats":{"Line":0}},{"line":238,"address":[4175581],"length":1,"stats":{"Line":0}},{"line":241,"address":[4965888,4965900],"length":1,"stats":{"Line":0}},{"line":243,"address":[4173142,4173059],"length":1,"stats":{"Line":0}},{"line":247,"address":[4951103,4951032],"length":1,"stats":{"Line":0}},{"line":249,"address":[4173488],"length":1,"stats":{"Line":0}},{"line":250,"address":[4951246],"length":1,"stats":{"Line":0}},{"line":251,"address":[4963510],"length":1,"stats":{"Line":0}},{"line":256,"address":[5655746,5655728],"length":1,"stats":{"Line":0}},{"line":257,"address":[4953971,4954218,4954137],"length":1,"stats":{"Line":0}},{"line":259,"address":[4954143],"length":1,"stats":{"Line":0}},{"line":262,"address":[4971152,4967218,4966843,4966932,4966787,4966394,4967356,4966816,4967246],"length":1,"stats":{"Line":0}},{"line":264,"address":[4966808],"length":1,"stats":{"Line":0}},{"line":265,"address":[5690827],"length":1,"stats":{"Line":0}},{"line":267,"address":[4954741,4954681,4954801,4954046,4954996],"length":1,"stats":{"Line":0}},{"line":270,"address":[4955268],"length":1,"stats":{"Line":0}},{"line":273,"address":[4955527,4955403],"length":1,"stats":{"Line":0}},{"line":274,"address":[4960640,4960654],"length":1,"stats":{"Line":0}},{"line":275,"address":[4972928,4967871,4972944],"length":1,"stats":{"Line":0}},{"line":277,"address":[5691957,5691815],"length":1,"stats":{"Line":0}},{"line":278,"address":[5696832,5696846],"length":1,"stats":{"Line":0}},{"line":279,"address":[4955928,4960800,4960816],"length":1,"stats":{"Line":0}},{"line":282,"address":[4968167],"length":1,"stats":{"Line":0}},{"line":285,"address":[4968292,4969006],"length":1,"stats":{"Line":0}},{"line":286,"address":[4968792,4968549,4968437],"length":1,"stats":{"Line":0}},{"line":287,"address":[5692924,5692853],"length":1,"stats":{"Line":0}},{"line":289,"address":[4957163,4956228],"length":1,"stats":{"Line":0}},{"line":293,"address":[4957408,4958048,4957020],"length":1,"stats":{"Line":0}},{"line":294,"address":[4179644,4179883,4179532],"length":1,"stats":{"Line":0}},{"line":295,"address":[4180102,4180031],"length":1,"stats":{"Line":0}},{"line":297,"address":[4957494,4958370],"length":1,"stats":{"Line":0}},{"line":301,"address":[4958767,4958726,4958607,4958856,4959146,4959284,4959174,4960115,4958286],"length":1,"stats":{"Line":0}},{"line":303,"address":[4180673],"length":1,"stats":{"Line":0}},{"line":304,"address":[4180800],"length":1,"stats":{"Line":0}},{"line":306,"address":[4180981,4180918,4176211,4180878,4181165],"length":1,"stats":{"Line":0}},{"line":309,"address":[4181398,4181545],"length":1,"stats":{"Line":0}},{"line":310,"address":[4959453],"length":1,"stats":{"Line":0}},{"line":317,"address":[4183109,4185298,4183066,4184059,4182832,4182921],"length":1,"stats":{"Line":0}},{"line":318,"address":[4961021,4961247,4961166],"length":1,"stats":{"Line":0}},{"line":320,"address":[4973118],"length":1,"stats":{"Line":0}},{"line":321,"address":[4973396],"length":1,"stats":{"Line":0}},{"line":323,"address":[4183478,4183524,4183199],"length":1,"stats":{"Line":0}},{"line":325,"address":[4183839,4184388,4183928,4184265,4184005,4184286,4183492,4183913],"length":1,"stats":{"Line":0}},{"line":328,"address":[4961889],"length":1,"stats":{"Line":0}},{"line":329,"address":[5698016],"length":1,"stats":{"Line":0}},{"line":331,"address":[5408423],"length":1,"stats":{"Line":0}},{"line":334,"address":[4184491,4184614],"length":1,"stats":{"Line":0}},{"line":338,"address":[4963468,4963440],"length":1,"stats":{"Line":0}},{"line":341,"address":[4962735,4962825,4962917],"length":1,"stats":{"Line":0}},{"line":343,"address":[4962831],"length":1,"stats":{"Line":0}},{"line":346,"address":[4977075,4976029,4982478,4976380,4976316,4975968],"length":1,"stats":{"Line":0}},{"line":347,"address":[4976437,4976518,4976271],"length":1,"stats":{"Line":0}},{"line":349,"address":[5700251],"length":1,"stats":{"Line":0}},{"line":352,"address":[5700667,5701094,5700278,5701070,5700796,5706115,5700719,5700704,5701196],"length":1,"stats":{"Line":0}},{"line":354,"address":[4964660],"length":1,"stats":{"Line":0}},{"line":355,"address":[4186615],"length":1,"stats":{"Line":0}},{"line":357,"address":[5426946],"length":1,"stats":{"Line":0}},{"line":360,"address":[4187232],"length":1,"stats":{"Line":0}},{"line":363,"address":[4965603,4965479],"length":1,"stats":{"Line":0}},{"line":364,"address":[5708448,5708462],"length":1,"stats":{"Line":0}},{"line":365,"address":[4187588,4194416,4194432],"length":1,"stats":{"Line":0}},{"line":367,"address":[4187603,4187745],"length":1,"stats":{"Line":0}},{"line":368,"address":[5708558,5708544],"length":1,"stats":{"Line":0}},{"line":369,"address":[4972736,4972752,4966004],"length":1,"stats":{"Line":0}},{"line":371,"address":[4966019,4966165],"length":1,"stats":{"Line":0}},{"line":372,"address":[4194558,4194544],"length":1,"stats":{"Line":0}},{"line":373,"address":[5708720,5702214,5708704],"length":1,"stats":{"Line":0}},{"line":375,"address":[4188275,4188133],"length":1,"stats":{"Line":0}},{"line":376,"address":[4985102,4985088],"length":1,"stats":{"Line":0}},{"line":377,"address":[4972944,4972928,4966566],"length":1,"stats":{"Line":0}},{"line":380,"address":[4978805],"length":1,"stats":{"Line":0}},{"line":381,"address":[4188523],"length":1,"stats":{"Line":0}},{"line":382,"address":[4979049],"length":1,"stats":{"Line":0}},{"line":385,"address":[5702842],"length":1,"stats":{"Line":0}},{"line":386,"address":[4188858],"length":1,"stats":{"Line":0}},{"line":387,"address":[4189106,4188995],"length":1,"stats":{"Line":0}},{"line":389,"address":[4967082,4967532],"length":1,"stats":{"Line":0}},{"line":393,"address":[4979460,4980001],"length":1,"stats":{"Line":0}},{"line":394,"address":[4980054],"length":1,"stats":{"Line":0}},{"line":395,"address":[5703837],"length":1,"stats":{"Line":0}},{"line":399,"address":[5704131,5703784],"length":1,"stats":{"Line":0}},{"line":400,"address":[4980495],"length":1,"stats":{"Line":0}},{"line":401,"address":[4190182],"length":1,"stats":{"Line":0}},{"line":405,"address":[4968312,4968659],"length":1,"stats":{"Line":0}},{"line":406,"address":[4190529],"length":1,"stats":{"Line":0}},{"line":407,"address":[4981025,4981197],"length":1,"stats":{"Line":0}},{"line":409,"address":[5705129,5704666],"length":1,"stats":{"Line":0}},{"line":412,"address":[4191266,4190676],"length":1,"stats":{"Line":0}},{"line":413,"address":[4191525,4191414],"length":1,"stats":{"Line":0}},{"line":416,"address":[4192259,4192361,4191837,4192235,4193422,4191673,4191874,4191951],"length":1,"stats":{"Line":0}},{"line":418,"address":[5705835],"length":1,"stats":{"Line":0}},{"line":419,"address":[4191866],"length":1,"stats":{"Line":0}},{"line":421,"address":[9101444],"length":1,"stats":{"Line":0}},{"line":424,"address":[4982929,4983106],"length":1,"stats":{"Line":0}},{"line":425,"address":[4982981],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":199},{"path":["/","workspaces","homemetrics","src","lib.rs"],"content":"// Library exports for homemetrics crate\n// This allows tests and other crates to use the modules\n\npub mod attachment_parser;\npub mod config;\npub mod database;\npub mod gmail_client;\npub mod slack_notifier;\npub mod email;\n\n// X-Sense temperature monitoring module\npub mod xsense;\n\n// Blue Riot pool monitoring module\npub mod blueriot;\n","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","homemetrics","src","main.rs"],"content":"use anyhow::Result;\nuse log::{info, error};\nuse clap::Parser;\n\nmod config;\nmod gmail_client;\nmod attachment_parser;\nmod database;\nmod slack_notifier;\nmod email;\n\n// X-Sense temperature monitoring module\nmod xsense;\n\n// Blue Riot pool monitoring module\nmod blueriot;\n\nuse config::Config;\nuse xsense::XSenseEmailProcessor;\nuse blueriot::BlueRiotEmailProcessor;\n\n#[derive(Parser)]\n#[command(name = \"homemetrics\")]\n#[command(about = \"HomeMetrics mail client to retrieve X-Sense data\")]\n#[command(version = \"0.1.0\")]\nstruct Args {\n    /// Dry-run mode: analyze emails without saving to database\n    #[arg(short, long)]\n    dry_run: bool,\n    \n    /// Daemon mode: run the program as a daemon with scheduling\n    #[arg(long)]\n    daemon: bool,\n    \n    /// Attachment save directory (default: ./data)\n    #[arg(short = 'o', long, default_value = \"./data\")]\n    data_dir: String,\n    \n    /// Limit the number of emails to process (default: unlimited)\n    #[arg(short = 'l', long)]\n    limit: Option\u003cusize\u003e,\n    \n    /// List all Gmail labels with their IDs\n    #[arg(long)]\n    list_labels: bool,\n    \n    /// Check configuration without connecting\n    #[arg(long)]\n    check_config: bool,\n}\n\n#[tokio::main]\nasync fn main() -\u003e Result\u003c()\u003e {\n    // Load .env file if it exists\n    dotenv::dotenv().ok();\n    \n    // Parse CLI arguments\n    let args = Args::parse();\n    \n    // Initialize logging\n    env_logger::init();\n    \n    if args.dry_run {\n        info!(\"üß™ Starting HomeMetrics X-Sense mail client in DRY-RUN mode\");\n    } else {\n        info!(\"üöÄ Starting HomeMetrics X-Sense mail client\");\n    }\n    \n    // Load configuration\n    let mut config = Config::new()?;\n    \n    // If requested, list Gmail labels and exit\n    if args.list_labels {\n        use gmail_client::GmailClient;\n        \n        println!(\"üìã Listing Gmail labels...\\n\");\n        let gmail = GmailClient::new(\u0026config.gmail).await?;\n        gmail.list_labels().await?;\n        return Ok(());\n    }\n    \n    // If requested, only check configuration\n    if args.check_config {\n        println!(\"‚úÖ Configuration valide !\");\n        println!(\"üìß Gmail API OAuth2\");\n        println!(\"üîë Credentials: {}\", config.gmail.credentials_path);\n        println!(\"üíæ Token cache: {}\", config.gmail.token_cache_path);\n        println!(\"üìÅ Data directory: {}\", config.data_dir);\n        if !args.dry_run {\n            println!(\"üóÑÔ∏è  Database: {}@{}:{}/{}\", \n                     config.database.username, config.database.host, \n                     config.database.port, config.database.database);\n        }\n        return Ok(());\n    }\n    \n    // Override data_dir with CLI argument if provided\n    if args.data_dir != \"./data\" {\n        config.data_dir = args.data_dir.clone();\n    }\n    \n    // If daemon mode is enabled\n    if args.daemon {\n        info!(\"üîÑ Starting in daemon mode\");\n        run_daemon_mode(config, args).await?;\n        return Ok(());\n    }\n    \n    // One-shot mode (default behavior)\n    info!(\"üöÄ Processing both X-Sense and Blue Riot emails in parallel\");\n    \n    let result = if args.dry_run {\n        // Dry-run mode: no database connection\n        let xsense_processor = XSenseEmailProcessor::new_dry_run(config.clone())?;\n        let pool_processor = BlueRiotEmailProcessor::new(\u0026config, true).await?;\n        \n        // Process both types in parallel\n        let (xsense_result, pool_result) = tokio::join!(\n            xsense_processor.process_emails_dry_run(args.limit),\n            pool_processor.process_emails(args.limit)\n        );\n        \n        let xsense_count = xsense_result?;\n        pool_result?; // Just check for errors\n        \n        Ok(xsense_count)\n    } else {\n        // Production mode: with database\n        let xsense_processor = XSenseEmailProcessor::new(config.clone()).await?;\n        let pool_processor = BlueRiotEmailProcessor::new(\u0026config, false).await?;\n        \n        // Process both types in parallel\n        let (xsense_result, pool_result) = tokio::join!(\n            xsense_processor.process_emails(args.limit),\n            pool_processor.process_emails(args.limit)\n        );\n        \n        let xsense_count = xsense_result?;\n        pool_result?; // Just check for errors\n        \n        Ok(xsense_count)\n    };\n    \n    match result {\n        Ok(count) =\u003e {\n            if args.dry_run {\n                info!(\"‚úÖ Dry-run analysis completed successfully. {} emails analyzed.\", count);\n            } else {\n                info!(\"‚úÖ Processing completed successfully. {} emails processed.\", count);\n            }\n        }\n        Err(e) =\u003e {\n            error!(\"‚ùå Error processing emails: {}\", e);\n            return Err(e);\n        }\n    }\n    \n    Ok(())\n}\n\nasync fn run_daemon_mode(config: Config, args: Args) -\u003e Result\u003c()\u003e {\n    use tokio_cron_scheduler::{JobScheduler, Job};\n    use chrono::{Local, Timelike};\n    \n    // Check that the scheduler is enabled in configuration\n    if !config.scheduler.enabled {\n        error!(\"‚ùå Daemon mode requires SCHEDULER_ENABLED=true in configuration\");\n        anyhow::bail!(\"Scheduler not enabled in configuration\");\n    }\n    \n    if config.scheduler.schedule_times.is_empty() {\n        error!(\"‚ùå No scheduling times defined (SCHEDULER_TIMES)\");\n        anyhow::bail!(\"No scheduling times defined\");\n    }\n    \n    info!(\"üìÖ Configured retrieval times: {:?}\", config.scheduler.schedule_times);\n    \n    // First, process emails immediately at startup\n    info!(\"üöÄ Daemon starting - processing emails immediately...\");\n    let initial_result = if args.dry_run {\n        let xsense_processor = XSenseEmailProcessor::new_dry_run(config.clone())?;\n        let pool_processor = BlueRiotEmailProcessor::new(\u0026config, true).await?;\n        \n        let (xsense_result, pool_result) = tokio::join!(\n            xsense_processor.process_emails_dry_run(args.limit),\n            pool_processor.process_emails(args.limit)\n        );\n        \n        let _ = pool_result?; // Check for errors\n        xsense_result\n    } else {\n        let xsense_processor = XSenseEmailProcessor::new(config.clone()).await?;\n        let pool_processor = BlueRiotEmailProcessor::new(\u0026config, false).await?;\n        \n        let (xsense_result, pool_result) = tokio::join!(\n            xsense_processor.process_emails(args.limit),\n            pool_processor.process_emails(args.limit)\n        );\n        \n        let _ = pool_result?; // Check for errors\n        xsense_result\n    };\n    \n    match initial_result {\n        Ok(count) =\u003e {\n            info!(\"‚úÖ Initial processing completed. {} emails processed.\", count);\n        }\n        Err(e) =\u003e {\n            error!(\"‚ùå Error during initial processing: {}\", e);\n            error!(\"‚ö†Ô∏è  Continuing with scheduled mode despite initial error...\");\n        }\n    }\n    \n    // Create the scheduler\n    let scheduler = JobScheduler::new().await?;\n    \n    // Add a job for each configured time\n    for schedule_time in \u0026config.scheduler.schedule_times {\n        let parts: Vec\u003c\u0026str\u003e = schedule_time.split(':').collect();\n        if parts.len() != 2 {\n            error!(\"‚ùå Invalid time format: {}. Use HH:MM format\", schedule_time);\n            continue;\n        }\n        \n        let hour = parts[0];\n        let minute = parts[1];\n        \n        // Cron format: \"0 minute hour * * *\" (every day)\n        let cron_expr = format!(\"0 {} {} * * *\", minute, hour);\n        info!(\"üìÜ Adding scheduled job: {} (cron: {})\", schedule_time, cron_expr);\n        \n        // Clone variables needed for the closure\n        let config_clone = config.clone();\n        let dry_run = args.dry_run;\n        let limit = args.limit;\n        let schedule_time_clone = schedule_time.clone();\n        \n        let job = Job::new_async(cron_expr.as_str(), move |_uuid, _l| {\n            let config = config_clone.clone();\n            let schedule_time = schedule_time_clone.clone();\n            \n            Box::pin(async move {\n                info!(\"‚è∞ Scheduled execution at {} - Retrieving emails...\", schedule_time);\n                \n                let result = if dry_run {\n                    let xsense_processor = match XSenseEmailProcessor::new_dry_run(config.clone()) {\n                        Ok(p) =\u003e p,\n                        Err(e) =\u003e {\n                            error!(\"‚ùå Error creating X-Sense processor: {}\", e);\n                            return;\n                        }\n                    };\n                    \n                    let pool_processor = match BlueRiotEmailProcessor::new(\u0026config, true).await {\n                        Ok(p) =\u003e p,\n                        Err(e) =\u003e {\n                            error!(\"‚ùå Error creating pool processor: {}\", e);\n                            return;\n                        }\n                    };\n                    \n                    let (xsense_result, pool_result) = tokio::join!(\n                        xsense_processor.process_emails_dry_run(limit),\n                        pool_processor.process_emails(limit)\n                    );\n                    \n                    let _ = pool_result; // Ignore pool result for count\n                    xsense_result\n                } else {\n                    let xsense_processor = match XSenseEmailProcessor::new(config.clone()).await {\n                        Ok(p) =\u003e p,\n                        Err(e) =\u003e {\n                            error!(\"‚ùå Error creating X-Sense processor: {}\", e);\n                            return;\n                        }\n                    };\n                    \n                    let pool_processor = match BlueRiotEmailProcessor::new(\u0026config, false).await {\n                        Ok(p) =\u003e p,\n                        Err(e) =\u003e {\n                            error!(\"‚ùå Error creating pool processor: {}\", e);\n                            return;\n                        }\n                    };\n                    \n                    let (xsense_result, pool_result) = tokio::join!(\n                        xsense_processor.process_emails(limit),\n                        pool_processor.process_emails(limit)\n                    );\n                    \n                    let _ = pool_result; // Ignore pool result for count\n                    xsense_result\n                };\n                \n                match result {\n                    Ok(count) =\u003e {\n                        info!(\"‚úÖ Scheduled processing completed. {} emails processed at {}\", count, schedule_time);\n                    }\n                    Err(e) =\u003e {\n                        error!(\"‚ùå Error during scheduled processing at {}: {}\", schedule_time, e);\n                    }\n                }\n            })\n        })?;\n        \n        scheduler.add(job).await?;\n    }\n    \n    // Start the scheduler\n    scheduler.start().await?;\n    \n    info!(\"‚úÖ Daemon mode started. Waiting for scheduled times...\");\n    info!(\"üìã Next executions: {:?}\", config.scheduler.schedule_times);\n    info!(\"‚è∏Ô∏è  Press Ctrl+C to stop the daemon\");\n    \n    // Keep the program alive\n    loop {\n        tokio::time::sleep(tokio::time::Duration::from_secs(60)).await;\n        \n        // Periodic log to show the daemon is active\n        let now = Local::now();\n        if now.minute() == 0 {\n            info!(\"üíì Daemon active - {}\", now.format(\"%Y-%m-%d %H:%M\"));\n        }\n    }\n}\n","traces":[{"line":53,"address":[9418311,9418317,9417856],"length":1,"stats":{"Line":0}},{"line":55,"address":[5889185,5888846],"length":1,"stats":{"Line":0}},{"line":58,"address":[5889231],"length":1,"stats":{"Line":0}},{"line":61,"address":[5889295],"length":1,"stats":{"Line":0}},{"line":63,"address":[5889366],"length":1,"stats":{"Line":0}},{"line":64,"address":[5889747,5889428],"length":1,"stats":{"Line":0}},{"line":66,"address":[5889507,5889383,5889483],"length":1,"stats":{"Line":0}},{"line":70,"address":[5889497,5890065,5892922],"length":1,"stats":{"Line":0}},{"line":73,"address":[5890232],"length":1,"stats":{"Line":0}},{"line":76,"address":[5892783,5890268],"length":1,"stats":{"Line":0}},{"line":77,"address":[5893012,5893579,5888975,5892802],"length":1,"stats":{"Line":0}},{"line":78,"address":[5893598,5888996,5893501,5893980,5893408],"length":1,"stats":{"Line":0}},{"line":79,"address":[5893935],"length":1,"stats":{"Line":0}},{"line":83,"address":[5890249],"length":1,"stats":{"Line":0}},{"line":84,"address":[5890333,5892137],"length":1,"stats":{"Line":0}},{"line":85,"address":[5892156],"length":1,"stats":{"Line":0}},{"line":86,"address":[5892201],"length":1,"stats":{"Line":0}},{"line":87,"address":[5892297],"length":1,"stats":{"Line":0}},{"line":88,"address":[5892397],"length":1,"stats":{"Line":0}},{"line":89,"address":[5892500],"length":1,"stats":{"Line":0}},{"line":90,"address":[5892565,5892517],"length":1,"stats":{"Line":0}},{"line":94,"address":[5892548],"length":1,"stats":{"Line":0}},{"line":98,"address":[5890297,5890417,5890672],"length":1,"stats":{"Line":0}},{"line":99,"address":[5890449,5890509],"length":1,"stats":{"Line":0}},{"line":103,"address":[5890423],"length":1,"stats":{"Line":0}},{"line":104,"address":[5891812,5890722,5891632],"length":1,"stats":{"Line":0}},{"line":105,"address":[9204956],"length":1,"stats":{"Line":0}},{"line":106,"address":[5894327],"length":1,"stats":{"Line":0}},{"line":110,"address":[5890677,5890777,5890809],"length":1,"stats":{"Line":0}},{"line":112,"address":[5890783],"length":1,"stats":{"Line":0}},{"line":114,"address":[5891065,5891216,5891591],"length":1,"stats":{"Line":0}},{"line":115,"address":[5891510,5891419,5894365,5889038,5895431],"length":1,"stats":{"Line":0}},{"line":118,"address":[5895152,5894951,5895273,5889059,5895472,5894889],"length":1,"stats":{"Line":0}},{"line":119,"address":[5894779],"length":1,"stats":{"Line":0}},{"line":120,"address":[5894896],"length":1,"stats":{"Line":0}},{"line":123,"address":[5896154,5895796,5895692],"length":1,"stats":{"Line":0}},{"line":124,"address":[5895891,5896126],"length":1,"stats":{"Line":0}},{"line":126,"address":[5896015],"length":1,"stats":{"Line":0}},{"line":129,"address":[5896305,5891042,5891104,5889080,5896885],"length":1,"stats":{"Line":0}},{"line":130,"address":[9205040],"length":1,"stats":{"Line":0}},{"line":133,"address":[5897484,5897685,5897806,5898005,5897422,5889122],"length":1,"stats":{"Line":0}},{"line":134,"address":[5897312],"length":1,"stats":{"Line":0}},{"line":135,"address":[5897429],"length":1,"stats":{"Line":0}},{"line":138,"address":[5899880,5898225,5898323],"length":1,"stats":{"Line":0}},{"line":139,"address":[5898412,5899855],"length":1,"stats":{"Line":0}},{"line":141,"address":[5898527],"length":1,"stats":{"Line":0}},{"line":144,"address":[5896095],"length":1,"stats":{"Line":0}},{"line":145,"address":[5898671],"length":1,"stats":{"Line":0}},{"line":146,"address":[5898687],"length":1,"stats":{"Line":0}},{"line":147,"address":[5898746,5899101],"length":1,"stats":{"Line":0}},{"line":149,"address":[5898795,5898704,5898831],"length":1,"stats":{"Line":0}},{"line":152,"address":[5898610],"length":1,"stats":{"Line":0}},{"line":153,"address":[5899588,5898626,5899561],"length":1,"stats":{"Line":0}},{"line":154,"address":[5899567],"length":1,"stats":{"Line":0}},{"line":158,"address":[5898801],"length":1,"stats":{"Line":0}},{"line":161,"address":[5866909,5870537,5879811,5869453,5866848,5867131],"length":1,"stats":{"Line":0}},{"line":166,"address":[5867105],"length":1,"stats":{"Line":0}},{"line":167,"address":[5867342,5867477,5867512],"length":1,"stats":{"Line":0}},{"line":168,"address":[5867483,5867753],"length":1,"stats":{"Line":0}},{"line":171,"address":[5867824,5867387],"length":1,"stats":{"Line":0}},{"line":172,"address":[5869133,5867875,5869168],"length":1,"stats":{"Line":0}},{"line":173,"address":[5869139,5869409],"length":1,"stats":{"Line":0}},{"line":176,"address":[5867830,5867984,5867930],"length":1,"stats":{"Line":0}},{"line":179,"address":[5868310,5868278,5867936],"length":1,"stats":{"Line":0}},{"line":180,"address":[5868284],"length":1,"stats":{"Line":0}},{"line":181,"address":[5868573,5868731,5869113],"length":1,"stats":{"Line":0}},{"line":182,"address":[9210879],"length":1,"stats":{"Line":0}},{"line":184,"address":[9210900],"length":1,"stats":{"Line":0}},{"line":185,"address":[5869893],"length":1,"stats":{"Line":0}},{"line":186,"address":[5870010],"length":1,"stats":{"Line":0}},{"line":189,"address":[5870884,5871089,5870804],"length":1,"stats":{"Line":0}},{"line":190,"address":[5870961],"length":1,"stats":{"Line":0}},{"line":192,"address":[9210921],"length":1,"stats":{"Line":0}},{"line":193,"address":[5871600,5872852,5867224,5871786,5871695],"length":1,"stats":{"Line":0}},{"line":195,"address":[5872310,5867245,5872372,5872573,5872694,5872893],"length":1,"stats":{"Line":0}},{"line":196,"address":[5872200],"length":1,"stats":{"Line":0}},{"line":197,"address":[5872317],"length":1,"stats":{"Line":0}},{"line":200,"address":[5873185,5874566,5873105],"length":1,"stats":{"Line":0}},{"line":201,"address":[5873265],"length":1,"stats":{"Line":0}},{"line":204,"address":[5871051],"length":1,"stats":{"Line":0}},{"line":205,"address":[5873429],"length":1,"stats":{"Line":0}},{"line":206,"address":[5873452,5873532],"length":1,"stats":{"Line":0}},{"line":208,"address":[5873358],"length":1,"stats":{"Line":0}},{"line":209,"address":[5873921,5873381,5873867],"length":1,"stats":{"Line":0}},{"line":210,"address":[5873873,5874208,5874236],"length":1,"stats":{"Line":0}},{"line":215,"address":[5874485,5867266,5875347,5874663,5873510],"length":1,"stats":{"Line":0}},{"line":218,"address":[5875171,5875915,5875302,5875280],"length":1,"stats":{"Line":0}},{"line":219,"address":[5876154,5875977],"length":1,"stats":{"Line":0}},{"line":220,"address":[5876212],"length":1,"stats":{"Line":0}},{"line":221,"address":[5876305,5878017,5878052],"length":1,"stats":{"Line":0}},{"line":225,"address":[5876260,5876361],"length":1,"stats":{"Line":0}},{"line":226,"address":[5876390],"length":1,"stats":{"Line":0}},{"line":229,"address":[5876473],"length":1,"stats":{"Line":0}},{"line":230,"address":[5876664,5876806,5876767],"length":1,"stats":{"Line":0}},{"line":233,"address":[5877189,5876773],"length":1,"stats":{"Line":0}},{"line":234,"address":[5877204],"length":1,"stats":{"Line":0}},{"line":235,"address":[5877232],"length":1,"stats":{"Line":0}},{"line":236,"address":[5877286,5877383],"length":1,"stats":{"Line":0}},{"line":238,"address":[5877928,5881105,5877398,5877499,5877743,5880704],"length":1,"stats":{"Line":0}},{"line":239,"address":[5880773,5880835],"length":1,"stats":{"Line":0}},{"line":240,"address":[5880843],"length":1,"stats":{"Line":0}},{"line":242,"address":[5881136,5880912,5881197,5882766,5880765,5881326,5886969],"length":1,"stats":{"Line":0}},{"line":243,"address":[5881262,5881540,5881508],"length":1,"stats":{"Line":0}},{"line":245,"address":[5881514],"length":1,"stats":{"Line":0}},{"line":246,"address":[5881855,5882010],"length":1,"stats":{"Line":0}},{"line":247,"address":[5882170],"length":1,"stats":{"Line":0}},{"line":248,"address":[5882054],"length":1,"stats":{"Line":0}},{"line":249,"address":[5882460,5882070,5882432],"length":1,"stats":{"Line":0}},{"line":254,"address":[9115158],"length":1,"stats":{"Line":0}},{"line":255,"address":[5883158],"length":1,"stats":{"Line":0}},{"line":256,"address":[5883042],"length":1,"stats":{"Line":0}},{"line":257,"address":[5883882,5883058,5883910],"length":1,"stats":{"Line":0}},{"line":262,"address":[9115180],"length":1,"stats":{"Line":0}},{"line":263,"address":[5883201],"length":1,"stats":{"Line":0}},{"line":264,"address":[5883311],"length":1,"stats":{"Line":0}},{"line":268,"address":[5884424],"length":1,"stats":{"Line":0}},{"line":270,"address":[5881898,5881828,5884616,5881398],"length":1,"stats":{"Line":0}},{"line":271,"address":[5884976],"length":1,"stats":{"Line":0}},{"line":272,"address":[5884860],"length":1,"stats":{"Line":0}},{"line":273,"address":[5884876,5885263,5885235],"length":1,"stats":{"Line":0}},{"line":278,"address":[9115224],"length":1,"stats":{"Line":0}},{"line":279,"address":[5885903],"length":1,"stats":{"Line":0}},{"line":280,"address":[5885787],"length":1,"stats":{"Line":0}},{"line":281,"address":[5886594,5885803,5886622],"length":1,"stats":{"Line":0}},{"line":286,"address":[5886104,5886296,5887064,5886049,5881440,5886411],"length":1,"stats":{"Line":0}},{"line":287,"address":[5885946],"length":1,"stats":{"Line":0}},{"line":288,"address":[5886056],"length":1,"stats":{"Line":0}},{"line":292,"address":[5887265],"length":1,"stats":{"Line":0}},{"line":295,"address":[5884565],"length":1,"stats":{"Line":0}},{"line":296,"address":[5887477],"length":1,"stats":{"Line":0}},{"line":297,"address":[5887493,5887550],"length":1,"stats":{"Line":0}},{"line":299,"address":[5887416],"length":1,"stats":{"Line":0}},{"line":300,"address":[5887937,5887962,5887432],"length":1,"stats":{"Line":0}},{"line":306,"address":[9211005],"length":1,"stats":{"Line":0}},{"line":310,"address":[5867308,5876015,5879732,5878481],"length":1,"stats":{"Line":0}},{"line":312,"address":[5878809,5878915],"length":1,"stats":{"Line":0}},{"line":313,"address":[5879155,5879206,5878867],"length":1,"stats":{"Line":0}},{"line":314,"address":[5879509,5879479,5879161],"length":1,"stats":{"Line":0}},{"line":318,"address":[5867329,5879490,5879928,5879959,5880600],"length":1,"stats":{"Line":0}},{"line":321,"address":[5880132],"length":1,"stats":{"Line":0}},{"line":322,"address":[5880159],"length":1,"stats":{"Line":0}},{"line":323,"address":[5880183],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":142},{"path":["/","workspaces","homemetrics","src","slack_notifier.rs"],"content":"use anyhow::Result;\nuse log::{info, error};\nuse slack_morphism::prelude::*;\n\nuse crate::config::SlackConfig;\n\npub struct SlackNotifier {\n    client: SlackClient\u003cSlackClientHyperHttpsConnector\u003e,\n    token: SlackApiToken,\n    channel_id: SlackChannelId,\n}\n\nimpl SlackNotifier {\n    pub fn new(config: \u0026SlackConfig) -\u003e Result\u003cSelf\u003e {\n        info!(\"Initializing Slack notifier\");\n        \n        let client = SlackClient::new(SlackClientHyperHttpsConnector::new()?);\n        let token = SlackApiToken::new(config.bot_token.clone().into());\n        let channel_id = SlackChannelId::new(config.channel_id.clone());\n        \n        Ok(SlackNotifier {\n            client,\n            token,\n            channel_id,\n        })\n    }\n    \n    /// Send a simple text message to Slack\n    pub async fn send_message(\u0026self, text: \u0026str) -\u003e Result\u003c()\u003e {\n        info!(\"Sending Slack message\");\n        \n        let post_chat_req = SlackApiChatPostMessageRequest::new(\n            self.channel_id.clone(),\n            SlackMessageContent::new().with_text(text.to_string()),\n        );\n        \n        let session = self.client.open_session(\u0026self.token);\n        \n        match session.chat_post_message(\u0026post_chat_req).await {\n            Ok(response) =\u003e {\n                info!(\"‚úÖ Slack message sent successfully: {:?}\", response.ts);\n                Ok(())\n            }\n            Err(e) =\u003e {\n                error!(\"‚ùå Error sending Slack message: {}\", e);\n                Err(anyhow::anyhow!(\"Unable to send Slack message: {}\", e))\n            }\n        }\n    }\n}\n","traces":[{"line":14,"address":[5242015,5242021,5241264],"length":1,"stats":{"Line":0}},{"line":15,"address":[6635454,6635558],"length":1,"stats":{"Line":0}},{"line":17,"address":[6642989,6643212],"length":1,"stats":{"Line":0}},{"line":18,"address":[6643371,6643308],"length":1,"stats":{"Line":0}},{"line":19,"address":[5162786,5162719],"length":1,"stats":{"Line":0}},{"line":21,"address":[5162857],"length":1,"stats":{"Line":0}},{"line":22,"address":[5241853],"length":1,"stats":{"Line":0}},{"line":23,"address":[6636040],"length":1,"stats":{"Line":0}},{"line":29,"address":[7739420,7738256,7738302,7739496,7738534,7738491],"length":1,"stats":{"Line":0}},{"line":30,"address":[7730945,7731084,7731117],"length":1,"stats":{"Line":0}},{"line":33,"address":[7456279,7456551],"length":1,"stats":{"Line":0}},{"line":34,"address":[7731394,7731466,7731375,7731948],"length":1,"stats":{"Line":0}},{"line":37,"address":[7739156],"length":1,"stats":{"Line":0}},{"line":39,"address":[6696055],"length":1,"stats":{"Line":0}},{"line":40,"address":[7457636],"length":1,"stats":{"Line":0}},{"line":41,"address":[7732620,7732490,7732580],"length":1,"stats":{"Line":0}},{"line":42,"address":[7732586],"length":1,"stats":{"Line":0}},{"line":44,"address":[8156395],"length":1,"stats":{"Line":0}},{"line":45,"address":[7733011,7733047,7732415],"length":1,"stats":{"Line":0}},{"line":46,"address":[7733017,7733313],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":20},{"path":["/","workspaces","homemetrics","src","xsense","extractor.rs"],"content":"use anyhow::{Result, Context};\nuse chrono::{DateTime, Utc, NaiveDateTime};\nuse csv::ReaderBuilder;\nuse log::{info, debug, warn};\nuse regex::Regex;\nuse serde::{Deserialize, Serialize};\n\n\nuse crate::attachment_parser::Attachment;\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct TemperatureReading {\n    pub sensor_id: String,\n    pub timestamp: DateTime\u003cUtc\u003e,\n    pub temperature: f64,\n    pub humidity: Option\u003cf64\u003e,\n    pub location: Option\u003cString\u003e,\n}\n\npub struct TemperatureExtractor;\n\nimpl TemperatureExtractor {\n    pub fn extract_from_attachment(attachment: \u0026Attachment) -\u003e Result\u003cVec\u003cTemperatureReading\u003e\u003e {\n        info!(\"Extracting temperature data from: {}\", attachment.filename);\n        \n        // Extract sensor name from filename\n        let sensor_name = Self::extract_sensor_name(\u0026attachment.filename)?;\n        debug!(\"Extracted sensor name: {}\", sensor_name);\n        \n        match attachment.filename.to_lowercase() {\n            name if name.ends_with(\".csv\") =\u003e {\n                Self::extract_from_xsense_csv(\u0026attachment.content, \u0026sensor_name)\n            }\n            name if name.ends_with(\".json\") =\u003e {\n                Self::extract_from_json(\u0026attachment.content)\n            }\n            name if name.ends_with(\".xml\") =\u003e {\n                Self::extract_from_xml(\u0026attachment.content)\n            }\n            name if name.ends_with(\".txt\") =\u003e {\n                Self::extract_from_text(\u0026attachment.content)\n            }\n            _ =\u003e {\n                warn!(\"Unsupported file format: {}\", attachment.filename);\n                Ok(Vec::new())\n            }\n        }\n    }\n    \n    pub fn extract_sensor_name(filename: \u0026str) -\u003e Result\u003cString\u003e {\n        // Expected format: \"Thermo-{sensor_name}_Export data_{date}.csv\"\n        // Examples: \"Thermo-cabane_...\", \"Thermo-patio_...\", \"Thermo-poolhouse_...\"\n        \n        if let Some(captures) = Regex::new(r\"Thermo-([^_]+)_\")?.captures(filename) {\n            if let Some(sensor_match) = captures.get(1) {\n                return Ok(sensor_match.as_str().to_string());\n            }\n        }\n        \n        // Fallback: use full filename without extension\n        let name = filename\n            .split('.')\n            .next()\n            .unwrap_or(filename);\n        \n        Ok(name.to_string())\n    }\n    \n    pub fn extract_from_xsense_csv(content: \u0026[u8], sensor_name: \u0026str) -\u003e Result\u003cVec\u003cTemperatureReading\u003e\u003e {\n        debug!(\"Extracting from X-Sense CSV file for sensor: {}\", sensor_name);\n        \n        // Try UTF-8 first, then other encodings\n        let content_str = match std::str::from_utf8(content) {\n            Ok(s) =\u003e s.to_string(),\n            Err(_) =\u003e {\n                // Fallback: replace invalid characters with placeholders\n                String::from_utf8_lossy(content).to_string()\n            }\n        };\n        \n        debug!(\"CSV content size: {} characters\", content_str.len());\n        \n        let mut readings = Vec::new();\n        let mut rdr = ReaderBuilder::new()\n            .has_headers(true)\n            .flexible(true)  // Tolerant to column differences\n            .from_reader(content_str.as_bytes());\n        \n        // Check expected headers\n        let headers = rdr.headers()\n            .context(\"Unable to read CSV headers\")?;\n        debug!(\"Found CSV headers: {:?}\", headers);\n        \n        // Validate we have at least 3 columns\n        if headers.len() \u003c 3 {\n            return Err(anyhow::anyhow!(\"Invalid CSV: found {} columns, expected at least 3\", headers.len()));\n        }\n        \n        // Parse each data line\n        for (line_num, result) in rdr.records().enumerate() {\n            let record = result.context(format!(\"Error on line {}\", line_num + 2))?;\n            \n            if record.len() \u003c 3 {\n                warn!(\"Line {} skipped: not enough columns ({} \u003c 3)\", line_num + 2, record.len());\n                continue;\n            }\n            \n            // Column 1: Timestamp (format: \"2023/12/26 23:59\")\n            let timestamp_str = record.get(0).unwrap_or(\"\");\n            let timestamp = Self::parse_xsense_timestamp(timestamp_str)\n                .with_context(|| format!(\"Unable to parse timestamp '{}' on line {}\", timestamp_str, line_num + 2))?;\n            \n            // Column 2: Temperature (format: \"5.5\")\n            let temperature_str = record.get(1).unwrap_or(\"\");\n            let temperature: f64 = temperature_str.parse()\n                .with_context(|| format!(\"Unable to parse temperature '{}' on line {}\", temperature_str, line_num + 2))?;\n            \n            // Column 3: Humidity (format: \"89.6\")\n            let humidity_str = record.get(2).unwrap_or(\"\");\n            let humidity: f64 = humidity_str.parse()\n                .with_context(|| format!(\"Unable to parse humidity '{}' on line {}\", humidity_str, line_num + 2))?;\n            \n            readings.push(TemperatureReading {\n                sensor_id: sensor_name.to_string(),\n                timestamp,\n                temperature,\n                humidity: Some(humidity),\n                location: Some(sensor_name.to_string()),\n            });\n        }\n        \n        info!(\"Extraction completed: {} temperature readings for sensor '{}'\", readings.len(), sensor_name);\n        Ok(readings)\n    }\n    \n    fn parse_xsense_timestamp(timestamp_str: \u0026str) -\u003e Result\u003cDateTime\u003cUtc\u003e\u003e {\n        // X-Sense format: \"2023/12/26 23:59\"\n        let naive_dt = NaiveDateTime::parse_from_str(timestamp_str, \"%Y/%m/%d %H:%M\")\n            .context(format!(\"Invalid timestamp format: '{}'\", timestamp_str))?;\n        \n        // Convert to UTC (assuming data is in local time)\n        Ok(DateTime::from_naive_utc_and_offset(naive_dt, Utc))\n    }\n    \n\n    \n    fn extract_from_json(content: \u0026[u8]) -\u003e Result\u003cVec\u003cTemperatureReading\u003e\u003e {\n        debug!(\"Extracting from JSON file\");\n        \n        let content_str = std::str::from_utf8(content)\n            .context(\"Unable to decode JSON content as UTF-8\")?;\n        \n        // Try to deserialize directly as an array of readings\n        if let Ok(readings) = serde_json::from_str::\u003cVec\u003cTemperatureReading\u003e\u003e(content_str) {\n            info!(\"Extracted {} temperature readings from JSON (direct format)\", readings.len());\n            return Ok(readings);\n        }\n        \n        // Try other common JSON formats\n        let value: serde_json::Value = serde_json::from_str(content_str)\n            .context(\"Unable to parse JSON\")?;\n        \n        let mut readings = Vec::new();\n        \n        // Format: {\"data\": [readings...]}\n        if let Some(data_array) = value.get(\"data\").and_then(|v| v.as_array()) {\n            for item in data_array {\n                if let Ok(reading) = Self::parse_json_reading(item) {\n                    readings.push(reading);\n                }\n            }\n        }\n        // Format: {\"readings\": [readings...]}\n        else if let Some(readings_array) = value.get(\"readings\").and_then(|v| v.as_array()) {\n            for item in readings_array {\n                if let Ok(reading) = Self::parse_json_reading(item) {\n                    readings.push(reading);\n                }\n            }\n        }\n        \n        info!(\"Extracted {} temperature readings from JSON\", readings.len());\n        Ok(readings)\n    }\n    \n    fn parse_json_reading(value: \u0026serde_json::Value) -\u003e Result\u003cTemperatureReading\u003e {\n        let timestamp_str = value.get(\"timestamp\")\n            .or_else(|| value.get(\"time\"))\n            .or_else(|| value.get(\"date\"))\n            .and_then(|v| v.as_str())\n            .context(\"Missing timestamp in JSON\")?;\n        \n        let timestamp = Self::parse_timestamp(timestamp_str)?;\n        \n        let sensor_id = value.get(\"sensor_id\")\n            .or_else(|| value.get(\"sensor\"))\n            .or_else(|| value.get(\"device_id\"))\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"unknown\")\n            .to_string();\n        \n        let temperature = value.get(\"temperature\")\n            .or_else(|| value.get(\"temp\"))\n            .and_then(|v| v.as_f64())\n            .context(\"Missing temperature in JSON\")?;\n        \n        let humidity = value.get(\"humidity\")\n            .or_else(|| value.get(\"hum\"))\n            .and_then(|v| v.as_f64());\n        \n        let location = value.get(\"location\")\n            .or_else(|| value.get(\"room\"))\n            .and_then(|v| v.as_str())\n            .map(|s| s.to_string());\n        \n        Ok(TemperatureReading {\n            sensor_id,\n            timestamp,\n            temperature,\n            humidity,\n            location,\n        })\n    }\n    \n    fn extract_from_xml(_content: \u0026[u8]) -\u003e Result\u003cVec\u003cTemperatureReading\u003e\u003e {\n        debug!(\"Extracting from XML file\");\n        // For now, return empty list\n        // XML implementation to be added according to specific X-Sense format\n        warn!(\"XML extraction not yet implemented\");\n        Ok(Vec::new())\n    }\n    \n    fn extract_from_text(content: \u0026[u8]) -\u003e Result\u003cVec\u003cTemperatureReading\u003e\u003e {\n        debug!(\"Extracting from text file\");\n        \n        let content_str = std::str::from_utf8(content)\n            .context(\"Unable to decode text content as UTF-8\")?;\n        \n        let mut readings = Vec::new();\n        \n        // Regex to capture common temperature patterns\n        let temp_regex = Regex::new(r\"(\\d{4}-\\d{2}-\\d{2}[\\sT]\\d{2}:\\d{2}:\\d{2})[^\\d]*(\\w+)[^\\d]*(-?\\d+\\.?\\d*)[¬∞C]*\")?;\n        \n        for line in content_str.lines() {\n            if let Some(captures) = temp_regex.captures(line) {\n                if let (Some(timestamp_str), Some(sensor_id), Some(temp_str)) = \n                   (captures.get(1), captures.get(2), captures.get(3)) {\n                    \n                    if let (Ok(timestamp), Ok(temperature)) = \n                       (Self::parse_timestamp(timestamp_str.as_str()), temp_str.as_str().parse::\u003cf64\u003e()) {\n                        \n                        readings.push(TemperatureReading {\n                            sensor_id: sensor_id.as_str().to_string(),\n                            timestamp,\n                            temperature,\n                            humidity: None,\n                            location: None,\n                        });\n                    }\n                }\n            }\n        }\n        \n        info!(\"Extracted {} temperature readings from text file\", readings.len());\n        Ok(readings)\n    }\n    \n    fn parse_timestamp(timestamp_str: \u0026str) -\u003e Result\u003cDateTime\u003cUtc\u003e\u003e {\n        // Try different timestamp formats\n        \n        // ISO 8601 format with timezone\n        if let Ok(dt) = DateTime::parse_from_rfc3339(timestamp_str) {\n            return Ok(dt.with_timezone(\u0026Utc));\n        }\n        \n        // ISO 8601 format without timezone (assume UTC)\n        if let Ok(naive_dt) = NaiveDateTime::parse_from_str(timestamp_str, \"%Y-%m-%d %H:%M:%S\") {\n            return Ok(DateTime::from_naive_utc_and_offset(naive_dt, Utc));\n        }\n        \n        // Format with T\n        if let Ok(naive_dt) = NaiveDateTime::parse_from_str(timestamp_str, \"%Y-%m-%dT%H:%M:%S\") {\n            return Ok(DateTime::from_naive_utc_and_offset(naive_dt, Utc));\n        }\n        \n        // European format\n        if let Ok(naive_dt) = NaiveDateTime::parse_from_str(timestamp_str, \"%d/%m/%Y %H:%M:%S\") {\n            return Ok(DateTime::from_naive_utc_and_offset(naive_dt, Utc));\n        }\n        \n        // American format\n        if let Ok(naive_dt) = NaiveDateTime::parse_from_str(timestamp_str, \"%m/%d/%Y %H:%M:%S\") {\n            return Ok(DateTime::from_naive_utc_and_offset(naive_dt, Utc));\n        }\n        \n        anyhow::bail!(\"Unsupported timestamp format: {}\", timestamp_str);\n    }\n}\n","traces":[{"line":23,"address":[5939408,5941617,5942053],"length":1,"stats":{"Line":1}},{"line":24,"address":[5939447,5939590],"length":1,"stats":{"Line":2}},{"line":27,"address":[6594396,6594729],"length":1,"stats":{"Line":1}},{"line":28,"address":[5939933,5940029,5940069],"length":1,"stats":{"Line":3}},{"line":30,"address":[8656577,8656251],"length":1,"stats":{"Line":2}},{"line":31,"address":[6595478,6595388,6595297],"length":1,"stats":{"Line":3}},{"line":32,"address":[8656833,8658097],"length":1,"stats":{"Line":2}},{"line":34,"address":[5715888,5715978,5715759],"length":1,"stats":{"Line":0}},{"line":35,"address":[6595698,6596671],"length":1,"stats":{"Line":0}},{"line":37,"address":[5940933,5940726,5940855],"length":1,"stats":{"Line":0}},{"line":38,"address":[5940973,5941685],"length":1,"stats":{"Line":0}},{"line":40,"address":[5716113,5716224,5716311],"length":1,"stats":{"Line":0}},{"line":41,"address":[8657799,8657346],"length":1,"stats":{"Line":0}},{"line":44,"address":[6596087,6595941,6596063],"length":1,"stats":{"Line":0}},{"line":45,"address":[6596077,6596361],"length":1,"stats":{"Line":0}},{"line":50,"address":[5943082,5942096,5942868],"length":1,"stats":{"Line":1}},{"line":54,"address":[5717339,5717641],"length":1,"stats":{"Line":2}},{"line":55,"address":[8658778,8658863],"length":1,"stats":{"Line":2}},{"line":56,"address":[5942775,5942726],"length":1,"stats":{"Line":2}},{"line":61,"address":[8659128],"length":1,"stats":{"Line":0}},{"line":66,"address":[6597872],"length":1,"stats":{"Line":0}},{"line":69,"address":[5943104,5947878,5948686],"length":1,"stats":{"Line":1}},{"line":70,"address":[6598055,6598161],"length":1,"stats":{"Line":2}},{"line":73,"address":[6598124],"length":1,"stats":{"Line":1}},{"line":74,"address":[6598466],"length":1,"stats":{"Line":1}},{"line":77,"address":[8659739],"length":1,"stats":{"Line":0}},{"line":81,"address":[6598512,6598692,6598668],"length":1,"stats":{"Line":3}},{"line":83,"address":[5943794],"length":1,"stats":{"Line":1}},{"line":84,"address":[8660347,8660415,8660496,8660575],"length":1,"stats":{"Line":4}},{"line":87,"address":[6599258,6599196,6599115],"length":1,"stats":{"Line":2}},{"line":90,"address":[5944449,5944652,5948613],"length":1,"stats":{"Line":1}},{"line":92,"address":[6599557,6599657],"length":1,"stats":{"Line":2}},{"line":95,"address":[8660971,8661305],"length":1,"stats":{"Line":2}},{"line":96,"address":[5948421,5945138],"length":1,"stats":{"Line":0}},{"line":100,"address":[5720368,5720509,5720279],"length":1,"stats":{"Line":3}},{"line":101,"address":[5721273,5723475,5720585,5721220,5723444],"length":1,"stats":{"Line":2}},{"line":103,"address":[8662788,8662721],"length":1,"stats":{"Line":2}},{"line":104,"address":[6601425,6602698,6602726],"length":1,"stats":{"Line":0}},{"line":109,"address":[6601489,6601402],"length":1,"stats":{"Line":2}},{"line":110,"address":[5947907,5946751,5946891],"length":1,"stats":{"Line":1}},{"line":111,"address":[9026240,9026266],"length":1,"stats":{"Line":0}},{"line":114,"address":[5946955],"length":1,"stats":{"Line":1}},{"line":115,"address":[6602669,6601828,6601963],"length":1,"stats":{"Line":1}},{"line":116,"address":[8030496,8030522],"length":1,"stats":{"Line":0}},{"line":119,"address":[6602017],"length":1,"stats":{"Line":1}},{"line":120,"address":[5947461,5947884,5947318],"length":1,"stats":{"Line":1}},{"line":121,"address":[9026752,9026778],"length":1,"stats":{"Line":0}},{"line":123,"address":[5947685],"length":1,"stats":{"Line":1}},{"line":124,"address":[5722594],"length":1,"stats":{"Line":1}},{"line":127,"address":[5722635],"length":1,"stats":{"Line":1}},{"line":128,"address":[8663776,8663861],"length":1,"stats":{"Line":2}},{"line":132,"address":[8661722,8661873],"length":1,"stats":{"Line":2}},{"line":133,"address":[8661788],"length":1,"stats":{"Line":1}},{"line":136,"address":[8664912],"length":1,"stats":{"Line":1}},{"line":138,"address":[8665087,8664939,8665154],"length":1,"stats":{"Line":2}},{"line":139,"address":[5948765,5948933],"length":1,"stats":{"Line":1}},{"line":142,"address":[8665193],"length":1,"stats":{"Line":1}},{"line":147,"address":[6605190,6605149,6603840],"length":1,"stats":{"Line":0}},{"line":148,"address":[5724392,5724215],"length":1,"stats":{"Line":0}},{"line":150,"address":[5949521,5949212],"length":1,"stats":{"Line":0}},{"line":154,"address":[5949778,5949587],"length":1,"stats":{"Line":0}},{"line":155,"address":[5950053,5949810,5949906],"length":1,"stats":{"Line":0}},{"line":156,"address":[6604665],"length":1,"stats":{"Line":0}},{"line":160,"address":[5950510,5949672],"length":1,"stats":{"Line":0}},{"line":163,"address":[6605328],"length":1,"stats":{"Line":0}},{"line":166,"address":[8023504,8023513],"length":1,"stats":{"Line":0}},{"line":167,"address":[5726388,5725845,5725911],"length":1,"stats":{"Line":0}},{"line":168,"address":[8667321,8667248,8667196],"length":1,"stats":{"Line":0}},{"line":169,"address":[6606012,6605928],"length":1,"stats":{"Line":0}},{"line":174,"address":[8667606,8667039],"length":1,"stats":{"Line":0}},{"line":175,"address":[8667686,8668165],"length":1,"stats":{"Line":0}},{"line":176,"address":[8667829,8667909],"length":1,"stats":{"Line":0}},{"line":177,"address":[8668013,8668101],"length":1,"stats":{"Line":0}},{"line":182,"address":[5727096,5726980,5726026],"length":1,"stats":{"Line":0}},{"line":183,"address":[5726994],"length":1,"stats":{"Line":0}},{"line":186,"address":[5953763,5952416,5953769],"length":1,"stats":{"Line":0}},{"line":187,"address":[5952634,5952466],"length":1,"stats":{"Line":0}},{"line":188,"address":[7816181,7816176],"length":1,"stats":{"Line":0}},{"line":189,"address":[7816208,7816213],"length":1,"stats":{"Line":0}},{"line":190,"address":[9027136,9027145],"length":1,"stats":{"Line":0}},{"line":193,"address":[6607343],"length":1,"stats":{"Line":0}},{"line":195,"address":[8669022],"length":1,"stats":{"Line":0}},{"line":196,"address":[7816272,7816277],"length":1,"stats":{"Line":0}},{"line":197,"address":[9027200,9027205],"length":1,"stats":{"Line":0}},{"line":198,"address":[8023728,8023737],"length":1,"stats":{"Line":0}},{"line":202,"address":[5953186,5952952,5953036],"length":1,"stats":{"Line":0}},{"line":203,"address":[8031269,8031264],"length":1,"stats":{"Line":0}},{"line":204,"address":[9027296,9027305],"length":1,"stats":{"Line":0}},{"line":207,"address":[8669447],"length":1,"stats":{"Line":0}},{"line":208,"address":[9027328,9027333],"length":1,"stats":{"Line":0}},{"line":209,"address":[8031369,8031360],"length":1,"stats":{"Line":0}},{"line":211,"address":[5728286],"length":1,"stats":{"Line":0}},{"line":212,"address":[7816496,7816501],"length":1,"stats":{"Line":0}},{"line":213,"address":[8023929,8023920],"length":1,"stats":{"Line":0}},{"line":214,"address":[9027478,9027456],"length":1,"stats":{"Line":0}},{"line":216,"address":[6608130],"length":1,"stats":{"Line":0}},{"line":217,"address":[5953513],"length":1,"stats":{"Line":0}},{"line":225,"address":[5953792],"length":1,"stats":{"Line":0}},{"line":226,"address":[5728704,5728775],"length":1,"stats":{"Line":0}},{"line":229,"address":[5728735,5728976],"length":1,"stats":{"Line":0}},{"line":230,"address":[5728911],"length":1,"stats":{"Line":0}},{"line":233,"address":[8673329,8673404,8670480],"length":1,"stats":{"Line":0}},{"line":234,"address":[6608887,6609064],"length":1,"stats":{"Line":0}},{"line":236,"address":[6608956,6609263],"length":1,"stats":{"Line":0}},{"line":239,"address":[6609325],"length":1,"stats":{"Line":0}},{"line":242,"address":[5954865,5954793],"length":1,"stats":{"Line":0}},{"line":244,"address":[5955128,5957145,5955077],"length":1,"stats":{"Line":0}},{"line":245,"address":[8671519,8672004],"length":1,"stats":{"Line":0}},{"line":246,"address":[6610837,6610868,6610921],"length":1,"stats":{"Line":0}},{"line":249,"address":[5956707,5956749],"length":1,"stats":{"Line":0}},{"line":252,"address":[5731794],"length":1,"stats":{"Line":0}},{"line":253,"address":[6611348,6611415],"length":1,"stats":{"Line":0}},{"line":256,"address":[8673123],"length":1,"stats":{"Line":0}},{"line":257,"address":[8673145],"length":1,"stats":{"Line":0}},{"line":264,"address":[6609862,6610007],"length":1,"stats":{"Line":0}},{"line":265,"address":[5730246],"length":1,"stats":{"Line":0}},{"line":268,"address":[6611744],"length":1,"stats":{"Line":0}},{"line":272,"address":[8673575,8673467],"length":1,"stats":{"Line":0}},{"line":273,"address":[6611899],"length":1,"stats":{"Line":0}},{"line":277,"address":[8673719,8673512],"length":1,"stats":{"Line":0}},{"line":278,"address":[5732377],"length":1,"stats":{"Line":0}},{"line":282,"address":[5732296,5732521],"length":1,"stats":{"Line":0}},{"line":283,"address":[5957700],"length":1,"stats":{"Line":0}},{"line":287,"address":[8674067,8673812],"length":1,"stats":{"Line":0}},{"line":288,"address":[8674097],"length":1,"stats":{"Line":0}},{"line":292,"address":[8673998,8674347],"length":1,"stats":{"Line":0}},{"line":293,"address":[8674377],"length":1,"stats":{"Line":0}},{"line":296,"address":[8674187],"length":1,"stats":{"Line":0}}],"covered":41,"coverable":128},{"path":["/","workspaces","homemetrics","src","xsense","mod.rs"],"content":"/// X-Sense temperature sensor email processing module\npub mod extractor;\npub mod processor;\n\npub use extractor::{TemperatureReading, TemperatureExtractor};\npub use processor::XSenseEmailProcessor;\n","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","homemetrics","src","xsense","processor.rs"],"content":"use anyhow::Result;\nuse log::{debug, info};\n\nuse crate::config::Config;\nuse crate::gmail_client::GmailClient;\nuse crate::database::Database;\nuse crate::slack_notifier::SlackNotifier;\nuse crate::attachment_parser::AttachmentParser;\nuse crate::email::{EmailProcessingStrategy, BaseEmailProcessor};\nuse super::extractor::TemperatureExtractor;\n\n/// X-Sense specific processing strategy\npub struct XSenseStrategy;\n\nimpl EmailProcessingStrategy for XSenseStrategy {\n    fn search_emails\u003c'a, 'b: 'a\u003e(\u0026'a self, gmail: \u0026'b GmailClient) -\u003e \n        std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003cVec\u003cString\u003e\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(gmail.search_xsense_emails())\n    }\n    \n    fn process_single_email\u003c'a, 'b: 'a, 'c: 'a\u003e(\n        \u0026'a self,\n        gmail: \u0026'b GmailClient,\n        database: Option\u003c\u0026'c Database\u003e,\n        slack: Option\u003c\u0026'c SlackNotifier\u003e,\n        message_id: \u0026'a str,\n        is_dry_run: bool,\n    ) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003cusize\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move {\n            debug!(\"Processing X-Sense email ID: {}\", message_id);\n            \n            // 1. Retrieve complete email information\n            let email_info = match gmail.fetch_email_complete(message_id).await {\n                Ok(info) =\u003e info,\n                Err(e) =\u003e {\n                    let (subject, from) = gmail.fetch_email_metadata(message_id)\n                        .await\n                        .unwrap_or((String::from(\"Unknown subject\"), String::from(\"Unknown sender\")));\n                    \n                    return Err(anyhow::anyhow!(\n                        \"Unable to retrieve complete email\\n  Subject: {}\\n  From: {}\\n  Error: {}\", \n                        subject, from, e\n                    ));\n                }\n            };\n            \n            // 2. In dry-run mode, display headers and date\n            if is_dry_run {\n                println!(\"üìã Headers:\");\n                println!(\"{}\", email_info.headers);\n                println!();\n                \n                println!(\"üìÖ Email date: {}\", email_info.date.format(\"%Y-%m-%d %H:%M:%S UTC\"));\n                println!();\n                println!(\"üìÑ Email content:\");\n                println!(\"   Size: {} bytes\", email_info.content.len());\n                println!();\n            }\n            \n            // 3. Parse attachments\n            let attachments = AttachmentParser::parse_email(\u0026email_info.content)?;\n            \n            if attachments.is_empty() {\n                if is_dry_run {\n                    println!(\"‚ö†Ô∏è  No attachments found in this email\");\n                }\n                return Ok(0);\n            }\n            \n            if is_dry_run {\n                println!(\"üìé Found {} attachment(s):\", attachments.len());\n                for (i, att) in attachments.iter().enumerate() {\n                    println!(\"   {}. {} ({} bytes, type: {})\", \n                             i + 1, att.filename, att.content.len(), att.content_type);\n                }\n                println!();\n            }\n            \n            // 4. Process each attachment\n            let mut total_readings = 0;\n            \n            for (index, attachment) in attachments.iter().enumerate() {\n                if is_dry_run {\n                    println!(\"üîç Processing attachment {}/{}: {}\", \n                             index + 1, attachments.len(), attachment.filename);\n                }\n                \n                match TemperatureExtractor::extract_from_attachment(attachment) {\n                    Ok(readings) =\u003e {\n                        if is_dry_run {\n                            Self::display_readings_dry_run(\u0026readings);\n                        } else if let Some(db) = database {\n                            // Save to database\n                            match db.save_temperature_readings(\u0026readings).await {\n                                Ok(count) =\u003e {\n                                    total_readings += count;\n                                    debug!(\"Saved {} readings from {}\", count, attachment.filename);\n                                }\n                                Err(e) =\u003e {\n                                    debug!(\"Error saving readings from {}: {}\", attachment.filename, e);\n                                }\n                            }\n                        }\n                    }\n                    Err(e) =\u003e {\n                        if is_dry_run {\n                            println!(\"   ‚ö†Ô∏è  Unable to extract data: {}\", e);\n                        }\n                    }\n                }\n            }\n            \n            // 5. Send Slack notification (if not dry-run and has data)\n            if !is_dry_run \u0026\u0026 total_readings \u003e 0 {\n                if let Some(slack) = slack {\n                    let message = format!(\n                        \"üìä New X-Sense data: {} temperature readings\\nFrom: {}\",\n                        total_readings,\n                        email_info.headers.lines().find(|l| l.starts_with(\"Subject:\"))\n                            .unwrap_or(\"Subject: Unknown\")\n                            .trim_start_matches(\"Subject:\")\n                            .trim()\n                    );\n                    info!(\"Sending Slack notification for X-Sense readings\");\n                    if let Err(e) = slack.send_message(\u0026message).await {\n                        debug!(\"Failed to send Slack notification: {}\", e);\n                    } else {\n                        debug!(\"Slack notification sent successfully\");\n                    }\n                }\n            }\n            \n            Ok(total_readings)\n        })\n    }\n    \n    fn mark_email_processed\u003c'a, 'b: 'a\u003e(\n        \u0026'a self,\n        gmail: \u0026'b GmailClient,\n        message_id: \u0026'a str,\n    ) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003c()\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(gmail.mark_email_as_processed(message_id))\n    }\n    \n    fn processor_name(\u0026self) -\u003e \u0026str {\n        \"X-Sense\"\n    }\n    \n    fn label_name(\u0026self) -\u003e \u0026str {\n        \"homemetrics-todo-xsense\"\n    }\n}\n\nimpl XSenseStrategy {\n    fn display_readings_dry_run(readings: \u0026[crate::xsense::TemperatureReading]) {\n        if readings.is_empty() {\n            println!(\"   ‚ö†Ô∏è  No valid readings extracted\");\n            return;\n        }\n        \n        println!(\"   ‚úÖ Extracted {} reading(s):\", readings.len());\n        \n        // Group by sensor\n        let mut by_sensor: std::collections::HashMap\u003cString, Vec\u003c\u0026crate::xsense::TemperatureReading\u003e\u003e = \n            std::collections::HashMap::new();\n        \n        for reading in readings {\n            by_sensor.entry(reading.sensor_id.clone())\n                .or_insert_with(Vec::new)\n                .push(reading);\n        }\n        \n        for (sensor_id, sensor_readings) in by_sensor.iter() {\n            println!(\"\\n   üì° Sensor: {}\", sensor_id);\n            \n            // Display first and last reading\n            if let Some(first) = sensor_readings.first() {\n                let humidity_str = first.humidity\n                    .map(|h| format!(\"{:.1}%\", h))\n                    .unwrap_or_else(|| \"N/A\".to_string());\n                println!(\"      First: {} | Temp: {:.1}¬∞C | Humidity: {}\",\n                         first.timestamp.format(\"%Y-%m-%d %H:%M:%S\"),\n                         first.temperature,\n                         humidity_str);\n            }\n            \n            if sensor_readings.len() \u003e 1 {\n                if let Some(last) = sensor_readings.last() {\n                    let humidity_str = last.humidity\n                        .map(|h| format!(\"{:.1}%\", h))\n                        .unwrap_or_else(|| \"N/A\".to_string());\n                    println!(\"      Last:  {} | Temp: {:.1}¬∞C | Humidity: {}\",\n                             last.timestamp.format(\"%Y-%m-%d %H:%M:%S\"),\n                             last.temperature,\n                             humidity_str);\n                }\n                \n                if sensor_readings.len() \u003e 2 {\n                    println!(\"      ... {} more readings\", sensor_readings.len() - 2);\n                }\n            }\n        }\n        println!();\n    }\n}\n\n/// X-Sense email processor (wrapper around BaseEmailProcessor)\npub struct XSenseEmailProcessor {\n    base: BaseEmailProcessor\u003cXSenseStrategy\u003e,\n}\n\nimpl XSenseEmailProcessor {\n    pub async fn new(config: Config) -\u003e Result\u003cSelf\u003e {\n        Ok(XSenseEmailProcessor {\n            base: BaseEmailProcessor::new(config, XSenseStrategy).await?,\n        })\n    }\n    \n    pub fn new_dry_run(config: Config) -\u003e Result\u003cSelf\u003e {\n        Ok(XSenseEmailProcessor {\n            base: BaseEmailProcessor::new_dry_run(config, XSenseStrategy)?,\n        })\n    }\n    \n    pub async fn process_emails(\u0026self, limit: Option\u003cusize\u003e) -\u003e Result\u003cusize\u003e {\n        self.base.process_emails(limit).await\n    }\n    \n    pub async fn process_emails_dry_run(\u0026self, limit: Option\u003cusize\u003e) -\u003e Result\u003cusize\u003e {\n        self.base.process_emails_dry_run(limit).await\n    }\n}\n","traces":[{"line":16,"address":[5662768],"length":1,"stats":{"Line":0}},{"line":18,"address":[7603639],"length":1,"stats":{"Line":0}},{"line":21,"address":[6104448],"length":1,"stats":{"Line":0}},{"line":29,"address":[6104534],"length":1,"stats":{"Line":0}},{"line":30,"address":[7269563,7269847,7269790],"length":1,"stats":{"Line":0}},{"line":33,"address":[8307220,8307081,8307571,8307667],"length":1,"stats":{"Line":0}},{"line":34,"address":[4999122],"length":1,"stats":{"Line":0}},{"line":35,"address":[7270619],"length":1,"stats":{"Line":0}},{"line":36,"address":[5001641,5002304,5001899,5002257,4999075],"length":1,"stats":{"Line":0}},{"line":37,"address":[6746647],"length":1,"stats":{"Line":0}},{"line":38,"address":[5459204,5459248],"length":1,"stats":{"Line":0}},{"line":40,"address":[5002368,5002439],"length":1,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[7270745],"length":1,"stats":{"Line":0}},{"line":49,"address":[4999233,4999299],"length":1,"stats":{"Line":0}},{"line":50,"address":[8308278],"length":1,"stats":{"Line":0}},{"line":51,"address":[7278493],"length":1,"stats":{"Line":0}},{"line":53,"address":[7278538],"length":1,"stats":{"Line":0}},{"line":54,"address":[7271236],"length":1,"stats":{"Line":0}},{"line":55,"address":[4999694],"length":1,"stats":{"Line":0}},{"line":56,"address":[4999739],"length":1,"stats":{"Line":0}},{"line":57,"address":[7278969],"length":1,"stats":{"Line":0}},{"line":61,"address":[4999952,4999195,5001491],"length":1,"stats":{"Line":0}},{"line":63,"address":[7279241,7279332],"length":1,"stats":{"Line":0}},{"line":64,"address":[8309206],"length":1,"stats":{"Line":0}},{"line":65,"address":[8310373],"length":1,"stats":{"Line":0}},{"line":67,"address":[7280522],"length":1,"stats":{"Line":0}},{"line":70,"address":[5000227],"length":1,"stats":{"Line":0}},{"line":71,"address":[5000332],"length":1,"stats":{"Line":0}},{"line":72,"address":[5000474],"length":1,"stats":{"Line":0}},{"line":73,"address":[7280342,7280276,7280221],"length":1,"stats":{"Line":0}},{"line":74,"address":[7280248,7280303,7279926,7280213],"length":1,"stats":{"Line":0}},{"line":76,"address":[7279952],"length":1,"stats":{"Line":0}},{"line":80,"address":[7271879],"length":1,"stats":{"Line":0}},{"line":82,"address":[5000291,5000879,5004183,5001009],"length":1,"stats":{"Line":0}},{"line":83,"address":[5004277],"length":1,"stats":{"Line":0}},{"line":84,"address":[7277412,7277320],"length":1,"stats":{"Line":0}},{"line":85,"address":[7284791,7284851,7284872],"length":1,"stats":{"Line":0}},{"line":88,"address":[7277579,7277243],"length":1,"stats":{"Line":0}},{"line":89,"address":[7277672],"length":1,"stats":{"Line":0}},{"line":90,"address":[5005979],"length":1,"stats":{"Line":0}},{"line":91,"address":[7277790,7278002],"length":1,"stats":{"Line":0}},{"line":92,"address":[5005996,5006074],"length":1,"stats":{"Line":0}},{"line":94,"address":[7277203,7282066,7285361,7282032,7282380],"length":1,"stats":{"Line":0}},{"line":95,"address":[8312203],"length":1,"stats":{"Line":0}},{"line":96,"address":[8312219,8312325],"length":1,"stats":{"Line":0}},{"line":97,"address":[7282643,7282608,7282535],"length":1,"stats":{"Line":0}},{"line":99,"address":[7282394],"length":1,"stats":{"Line":0}},{"line":100,"address":[5003837,5003809,5003195],"length":1,"stats":{"Line":0}},{"line":105,"address":[5005872],"length":1,"stats":{"Line":0}},{"line":106,"address":[7277646],"length":1,"stats":{"Line":0}},{"line":107,"address":[8315296,8315245],"length":1,"stats":{"Line":0}},{"line":114,"address":[5004303],"length":1,"stats":{"Line":0}},{"line":115,"address":[7276121,7279367],"length":1,"stats":{"Line":0}},{"line":116,"address":[7276506,7276190],"length":1,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[7282238,7276224,7282224],"length":1,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[7284310,7284263,7284160],"length":1,"stats":{"Line":0}},{"line":125,"address":[5471372],"length":1,"stats":{"Line":0}},{"line":126,"address":[5006741,5006904,5006876],"length":1,"stats":{"Line":0}},{"line":128,"address":[8315743,8316210],"length":1,"stats":{"Line":0}},{"line":133,"address":[8313298],"length":1,"stats":{"Line":0}},{"line":137,"address":[7603872],"length":1,"stats":{"Line":0}},{"line":142,"address":[7603911],"length":1,"stats":{"Line":0}},{"line":145,"address":[7596464],"length":1,"stats":{"Line":0}},{"line":149,"address":[7596496],"length":1,"stats":{"Line":0}},{"line":155,"address":[7604032,7605799,7607036],"length":1,"stats":{"Line":0}},{"line":156,"address":[7596567],"length":1,"stats":{"Line":0}},{"line":157,"address":[5663370],"length":1,"stats":{"Line":0}},{"line":161,"address":[7604093],"length":1,"stats":{"Line":0}},{"line":164,"address":[5663326],"length":1,"stats":{"Line":0}},{"line":167,"address":[6104963,6105082],"length":1,"stats":{"Line":0}},{"line":168,"address":[7596969,7599437],"length":1,"stats":{"Line":0}},{"line":173,"address":[5663618],"length":1,"stats":{"Line":0}},{"line":174,"address":[7604708,7604802],"length":1,"stats":{"Line":0}},{"line":177,"address":[7597372],"length":1,"stats":{"Line":0}},{"line":178,"address":[6105732,6105686],"length":1,"stats":{"Line":0}},{"line":179,"address":[8316656,8316679],"length":1,"stats":{"Line":0}},{"line":180,"address":[7287264,7287276],"length":1,"stats":{"Line":0}},{"line":181,"address":[7597659],"length":1,"stats":{"Line":0}},{"line":187,"address":[7605023,7605810],"length":1,"stats":{"Line":0}},{"line":188,"address":[7605825],"length":1,"stats":{"Line":0}},{"line":189,"address":[7598433,7598487],"length":1,"stats":{"Line":0}},{"line":190,"address":[7287312,7287335],"length":1,"stats":{"Line":0}},{"line":191,"address":[8317260,8317248],"length":1,"stats":{"Line":0}},{"line":192,"address":[7606030],"length":1,"stats":{"Line":0}},{"line":198,"address":[7599249,7598468],"length":1,"stats":{"Line":0}},{"line":199,"address":[5665786],"length":1,"stats":{"Line":0}},{"line":203,"address":[6105442],"length":1,"stats":{"Line":0}},{"line":213,"address":[7280208,7280351,7280128,7280314,7280483,7280956],"length":1,"stats":{"Line":0}},{"line":214,"address":[7288358],"length":1,"stats":{"Line":0}},{"line":215,"address":[7280295,7280398,7280341,7280954,7280509],"length":1,"stats":{"Line":0}},{"line":219,"address":[6107744],"length":1,"stats":{"Line":0}},{"line":220,"address":[7607270],"length":1,"stats":{"Line":0}},{"line":221,"address":[7599632],"length":1,"stats":{"Line":0}},{"line":225,"address":[7281583,7281118,7280976,7281001,7281155,7281275],"length":1,"stats":{"Line":0}},{"line":226,"address":[7288706,7288603,7288649,7288805],"length":1,"stats":{"Line":0}},{"line":229,"address":[7281625,7281742,7281600,7281899,7282207,7281779],"length":1,"stats":{"Line":0}},{"line":230,"address":[7281723,7281826,7281769,7281925],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":104},{"path":["/","workspaces","homemetrics","tests","blueriot_test.rs"],"content":"use std::fs;\nuse homemetrics::blueriot::extractor;\n\n#[test]\nfn test_extract_from_blueriot_email() {\n    // Load test email file\n    let email_content = fs::read(\"data_test/blueriot.eml\")\n        .expect(\"Failed to read test email file data_test/blueriot.eml\");\n    \n    // Parse email to extract text body\n    let parsed_email = mail_parser::MessageParser::default()\n        .parse(\u0026email_content)\n        .expect(\"Failed to parse email\");\n    \n    // Extract text from email body\n    let mut text_content = String::new();\n    \n    // Try to get text/plain body first\n    if let Some(text_body) = parsed_email.body_text(0) {\n        text_content.push_str(\u0026text_body);\n    }\n    \n    // If no text/plain, try text/html\n    if text_content.is_empty() {\n        if let Some(html_body) = parsed_email.body_html(0) {\n            // Simple HTML stripping\n            let html_str = html_body.to_string()\n                .replace(\"\u003cbr\u003e\", \"\\n\")\n                .replace(\"\u003cBR\u003e\", \"\\n\")\n                .replace(\"\u003c/p\u003e\", \"\\n\")\n                .replace(\"\u003c/P\u003e\", \"\\n\");\n            let tag_regex = regex::Regex::new(r\"\u003c[^\u003e]+\u003e\").unwrap();\n            text_content = tag_regex.replace_all(\u0026html_str, \"\").to_string();\n        }\n    }\n    \n    assert!(!text_content.is_empty(), \"No text content found in email\");\n    println!(\"üìß Email content extracted ({} chars)\", text_content.len());\n    \n    // Extract pool metrics\n    let email_date = chrono::Utc::now(); // Use current time for test\n    let pool_reading = extractor::extract_pool_metrics(\u0026text_content, email_date)\n        .expect(\"Failed to extract pool metrics\");\n    \n    println!(\"‚úÖ Pool metrics extracted:\");\n    \n    // Verify temperature\n    if let Some(temp) = pool_reading.temperature {\n        println!(\"   üå°Ô∏è  Temperature: {:.1}¬∞C\", temp);\n        assert!(temp \u003e 0.0 \u0026\u0026 temp \u003c 40.0, \n               \"Temperature {} should be in reasonable pool range\", temp);\n    }\n    \n    // Verify pH\n    if let Some(ph) = pool_reading.ph {\n        println!(\"   üß™ pH: {:.2}\", ph);\n        assert!(ph \u003e 0.0 \u0026\u0026 ph \u003c 14.0, \n               \"pH {} should be between 0 and 14\", ph);\n    }\n    \n    // Verify ORP\n    if let Some(orp) = pool_reading.orp {\n        println!(\"   ‚ö° ORP: {} mV\", orp);\n        assert!(orp \u003e -1000 \u0026\u0026 orp \u003c 1000, \n               \"ORP {} should be in reasonable range\", orp);\n    }\n    \n    // At least one metric should be present\n    assert!(\n        pool_reading.temperature.is_some() || \n        pool_reading.ph.is_some() || \n        pool_reading.orp.is_some(),\n        \"At least one pool metric should be extracted\"\n    );\n}\n\n#[test]\nfn test_extract_pool_metrics_from_text() {\n    let text_sample = r#\"\n        Bonjour,\n        \n        Voici les derni√®res mesures de votre piscine:\n        \n        Temp√©rature: 15,8¬∞C\n        pH: 6,80\n        ORP: 249 mV\n        \n        Cordialement,\n        Blue Riot\n    \"#;\n    \n    let email_date = chrono::Utc::now();\n    let pool_reading = extractor::extract_pool_metrics(text_sample, email_date)\n        .expect(\"Failed to extract pool metrics from sample text\");\n    \n    assert_eq!(pool_reading.temperature, Some(15.8));\n    assert_eq!(pool_reading.ph, Some(6.80));\n    assert_eq!(pool_reading.orp, Some(249));\n    \n    println!(\"‚úÖ Text parsing test passed:\");\n    println!(\"   Temperature: {:?}¬∞C\", pool_reading.temperature);\n    println!(\"   pH: {:?}\", pool_reading.ph);\n    println!(\"   ORP: {:?} mV\", pool_reading.orp);\n}\n\n#[test]\nfn test_extract_pool_metrics_various_formats() {\n    // Test with dots as decimal separator\n    let text1 = \"Temperature: 18.5¬∞C, pH: 7.2, ORP: 650 mV\";\n    let result1 = extractor::extract_pool_metrics(text1, chrono::Utc::now())\n        .expect(\"Failed to parse format 1\");\n    assert_eq!(result1.temperature, Some(18.5));\n    assert_eq!(result1.ph, Some(7.2));\n    assert_eq!(result1.orp, Some(650));\n    \n    // Test with commas as decimal separator\n    let text2 = \"Temp√©rature: 16,3¬∞C\\npH: 7,45\\nORP: 550 mV\";\n    let result2 = extractor::extract_pool_metrics(text2, chrono::Utc::now())\n        .expect(\"Failed to parse format 2\");\n    assert_eq!(result2.temperature, Some(16.3));\n    assert_eq!(result2.ph, Some(7.45));\n    assert_eq!(result2.orp, Some(550));\n    \n    println!(\"‚úÖ Various format parsing tests passed\");\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","homemetrics","tests","xsense_test.rs"],"content":"use std::fs;\nuse homemetrics::attachment_parser::AttachmentParser;\nuse homemetrics::xsense::TemperatureExtractor;\n\n#[test]\nfn test_extract_from_xsense_email() {\n    // Load test email file\n    let email_content = fs::read(\"data_test/xsense.eml\")\n        .expect(\"Failed to read test email file data_test/xsense.eml\");\n    \n    // Parse email to extract attachments\n    let attachments = AttachmentParser::parse_email(\u0026email_content)\n        .expect(\"Failed to parse email\");\n    \n    assert!(!attachments.is_empty(), \"No attachments found in test email\");\n    println!(\"üìé Found {} attachment(s)\", attachments.len());\n    \n    // Extract temperature data from first attachment\n    let readings = TemperatureExtractor::extract_from_attachment(\u0026attachments[0])\n        .expect(\"Failed to extract temperature readings\");\n    \n    assert!(!readings.is_empty(), \"No temperature readings extracted\");\n    \n    // Verify data structure\n    for reading in \u0026readings {\n        assert!(!reading.sensor_id.is_empty(), \"Sensor ID should not be empty\");\n        assert!(reading.temperature \u003e -50.0 \u0026\u0026 reading.temperature \u003c 50.0, \n               \"Temperature {} should be in reasonable range\", reading.temperature);\n        if let Some(humidity) = reading.humidity {\n            assert!(humidity \u003e= 0.0 \u0026\u0026 humidity \u003c= 100.0, \n                   \"Humidity {} should be between 0 and 100\", humidity);\n        }\n    }\n    \n    println!(\"‚úÖ Extracted {} temperature readings from X-Sense email\", readings.len());\n    println!(\"   Sensor ID: {}\", readings[0].sensor_id);\n    println!(\"   First reading: {:.1}¬∞C at {}\", \n             readings[0].temperature, \n             readings[0].timestamp);\n    if let Some(humidity) = readings[0].humidity {\n        println!(\"   Humidity: {:.1}%\", humidity);\n    }\n}\n\n#[test]\nfn test_extract_sensor_name() {\n    // Test extracting sensor name from actual X-Sense filename format\n    assert_eq!(\n        TemperatureExtractor::extract_sensor_name(\"Thermo-cabane_Exporter les donn√©es_20251104.csv\").unwrap(),\n        \"cabane\"\n    );\n    \n    assert_eq!(\n        TemperatureExtractor::extract_sensor_name(\"Thermo-patio_Exporter les donn√©es_20251105.csv\").unwrap(),\n        \"patio\"\n    );\n}\n\n#[test]\nfn test_csv_parsing() {\n    // Test CSV parsing with actual X-Sense CSV format\n    let csv_content = b\"Temps,Temp\\xC3\\xA9rature_Celsius,Humidit\\xC3\\xA9 relative_Pourcentage\n2025/11/04 23:59,15.0,84.0\n2025/11/04 23:58,15.1,83.2\n2025/11/04 23:57,15.2,84.0\";\n    \n    let readings = TemperatureExtractor::extract_from_xsense_csv(csv_content, \"TEST_SENSOR\")\n        .expect(\"Failed to parse CSV\");\n    \n    assert_eq!(readings.len(), 3);\n    \n    // Check first reading\n    assert_eq!(readings[0].sensor_id, \"TEST_SENSOR\");\n    assert_eq!(readings[0].temperature, 15.0);\n    assert_eq!(readings[0].humidity, Some(84.0));\n    \n    println!(\"‚úÖ CSV parsing test passed:\");\n    println!(\"   Parsed {} readings\", readings.len());\n    println!(\"   First reading: {}¬∞C, {}% humidity\", \n             readings[0].temperature, \n             readings[0].humidity.unwrap());\n}\n","traces":[],"covered":0,"coverable":0}]};
        var previousData = {"files":[{"path":["/","workspaces","homemetrics","src","attachment_parser.rs"],"content":"use anyhow::Result;\nuse log::{info, debug};\nuse mail_parser::{MessageParser, MimeHeaders};\nuse base64::{Engine as _, engine::general_purpose};\n\n#[derive(Debug)]\npub struct Attachment {\n    pub filename: String,\n    pub content: Vec\u003cu8\u003e,\n    pub content_type: String,\n}\n\npub struct AttachmentParser;\n\nimpl AttachmentParser {\n    pub fn parse_email(raw_email: \u0026[u8]) -\u003e Result\u003cVec\u003cAttachment\u003e\u003e {\n        debug!(\"Parsing email pour extraire les pi√®ces jointes\");\n        \n        // For now, using a basic but functional MIME parser\n        // We will improve this later with a better API\n        let email_str = String::from_utf8_lossy(raw_email);\n        let mut attachments = Vec::new();\n        \n        debug!(\"Email size: {} bytes\", email_str.len());\n        \n        // First analyze the MIME structure of the email\n        Self::analyze_email_structure(\u0026email_str);\n        \n        // Rechercher les sections avec Content-Disposition: attachment\n        let mut current_pos = 0;\n        while let Some(attachment_start) = email_str[current_pos..].find(\"Content-Disposition: attachment\") {\n            let abs_start = current_pos + attachment_start;\n            debug!(\"Found Content-Disposition: attachment at position {}\", abs_start);\n            \n            // Search for filename\n            if let Some(filename) = Self::extract_filename_from_headers(\u0026email_str[abs_start..]) {\n                debug!(\"Extracted filename: {}\", filename);\n                if Self::is_data_file(\u0026filename) {\n                    // Search for attachment content start\n                    if let Some(content_start) = email_str[abs_start..].find(\"\\r\\n\\r\\n\") {\n                        let abs_content_start = abs_start + content_start + 4;\n                        \n                        // Search for attachment end (next boundary)\n                        if let Some(content_end) = Self::find_attachment_end(\u0026email_str[abs_content_start..]) {\n                            let abs_content_end = abs_content_start + content_end;\n                            let content_str = \u0026email_str[abs_content_start..abs_content_end];\n                            \n                            debug!(\"Raw attachment content length: {} chars\", content_str.len());\n                            debug!(\"Raw content preview (first 200 chars): {}\", \n                                   \u0026content_str[..std::cmp::min(200, content_str.len())]);\n                            \n                            // Decode content (base64 or other)\n                            if let Ok(content) = Self::decode_attachment_content(content_str) {\n                                let content_type = Self::guess_content_type(\u0026filename);\n                                \n                                debug!(\"Attachment found: {} ({}), taille: {} bytes\", \n                                       filename, content_type, content.len());\n                                \n                                attachments.push(Attachment {\n                                    filename,\n                                    content,\n                                    content_type,\n                                });\n                            }\n                        }\n                    }\n                }\n            }\n            \n            current_pos = abs_start + 1;\n        }\n        \n        // If no attachment is found with manual approach,\n        // try alternative approaches\n        if attachments.is_empty() {\n            debug!(\"No attachments found with manual parsing, trying alternative methods\");\n            Self::try_alternative_parsing(\u0026email_str, \u0026mut attachments)?;\n        }\n        \n        info!(\"Found {} attachment(s)\", attachments.len());\n        Ok(attachments)\n    }\n    \n    fn analyze_email_structure(email_str: \u0026str) {\n        debug!(\"=== ANALYSIS OF EMAIL STRUCTURE ===\");\n        \n        // Search for boundaries\n        let boundaries: Vec\u003c_\u003e = email_str.matches(\"boundary=\").take(5).collect();\n        debug!(\"Found {} boundary declarations\", boundaries.len());\n        \n        // Search for Content-Type\n        let content_types: Vec\u003c_\u003e = email_str.matches(\"Content-Type:\").take(10).collect();\n        debug!(\"Found {} Content-Type headers\", content_types.len());\n        \n        // Search for Content-Disposition\n        let dispositions: Vec\u003c_\u003e = email_str.matches(\"Content-Disposition:\").take(10).collect();\n        debug!(\"Found {} Content-Disposition headers\", dispositions.len());\n        \n        // Display structure sample\n        let lines: Vec\u003c\u0026str\u003e = email_str.lines().collect();\n        debug!(\"Email has {} lines total\", lines.len());\n        \n        // Search for interesting patterns\n        for (i, line) in lines.iter().enumerate().take(100) {\n            if line.contains(\"Content-Type:\") || \n               line.contains(\"Content-Disposition:\") || \n               line.contains(\"boundary=\") ||\n               line.contains(\"filename=\") {\n                debug!(\"Line {}: {}\", i + 1, line.trim());\n            }\n        }\n        debug!(\"=== END EMAIL STRUCTURE ANALYSIS ===\");\n    }\n    \n    fn try_alternative_parsing(email_str: \u0026str, attachments: \u0026mut Vec\u003cAttachment\u003e) -\u003e Result\u003c()\u003e {\n        debug!(\"Trying alternative parsing methods\");\n        \n        // Method 1: Search directly for \"filename=\"\n        Self::try_filename_direct_search(email_str, attachments)?;\n        \n        // Method 2: Use mail-parser as fallback\n        if attachments.is_empty() {\n            Self::try_mail_parser_fallback(email_str.as_bytes(), attachments)?;\n        }\n        \n        Ok(())\n    }\n    \n    fn try_filename_direct_search(email_str: \u0026str, attachments: \u0026mut Vec\u003cAttachment\u003e) -\u003e Result\u003c()\u003e {\n        debug!(\"Trying direct filename search\");\n        \n        let mut current_pos = 0;\n        while let Some(filename_start) = email_str[current_pos..].find(\"filename=\") {\n            let abs_start = current_pos + filename_start;\n            let filename_line = \u0026email_str[abs_start..abs_start + std::cmp::min(200, email_str.len() - abs_start)];\n            \n            if let Some(filename) = Self::extract_filename_from_line(filename_line) {\n                debug!(\"Found filename via direct search: {}\", filename);\n                \n                if Self::is_data_file(\u0026filename) {\n                    // Search for content associated with this filename\n                    if let Some(content) = Self::find_content_for_filename(email_str, abs_start) {\n                        let content_type = Self::guess_content_type(\u0026filename);\n                        \n                        debug!(\"Found content for {}: {} bytes\", filename, content.len());\n                        \n                        attachments.push(Attachment {\n                            filename,\n                            content,\n                            content_type,\n                        });\n                    }\n                }\n            }\n            \n            current_pos = abs_start + 1;\n        }\n        \n        Ok(())\n    }\n    \n    fn extract_filename_from_line(line: \u0026str) -\u003e Option\u003cString\u003e {\n        if let Some(start) = line.find(\"filename=\") {\n            let filename_part = \u0026line[start + 9..];\n            if let Some(end) = filename_part.find(['\\r', '\\n', ';', ' ']) {\n                let filename = filename_part[..end].trim_matches('\"').trim();\n                if !filename.is_empty() {\n                    return Some(filename.to_string());\n                }\n            } else {\n                // Take rest of line\n                let filename = filename_part.trim_matches('\"').trim();\n                if !filename.is_empty() {\n                    return Some(filename.to_string());\n                }\n            }\n        }\n        None\n    }\n    \n    fn find_content_for_filename(email_str: \u0026str, filename_pos: usize) -\u003e Option\u003cVec\u003cu8\u003e\u003e {\n        // Start from filename position and search for content\n        let start_search = \u0026email_str[filename_pos..];\n        \n        // Search for end of headers (double CRLF)\n        if let Some(content_start_rel) = start_search.find(\"\\r\\n\\r\\n\") {\n            let content_start = filename_pos + content_start_rel + 4;\n            \n            // Search for content end (next boundary or email end)\n            let content_search = \u0026email_str[content_start..];\n            let content_end = if let Some(boundary_pos) = content_search.find(\"\\r\\n--\") {\n                content_start + boundary_pos\n            } else {\n                email_str.len()\n            };\n            \n            let content_str = \u0026email_str[content_start..content_end];\n            debug!(\"Found content block of {} chars for attachment\", content_str.len());\n            \n            if let Ok(decoded) = Self::decode_attachment_content(content_str) {\n                return Some(decoded);\n            }\n        }\n        \n        None\n    }\n    \n    fn try_mail_parser_fallback(raw_email: \u0026[u8], attachments: \u0026mut Vec\u003cAttachment\u003e) -\u003e Result\u003c()\u003e {\n        debug!(\"Trying mail-parser fallback\");\n        \n        if let Some(message) = MessageParser::default().parse(raw_email) {\n            debug!(\"mail-parser successfully parsed the message\");\n            debug!(\"Message has {} attachments\", message.attachments().count());\n            \n            for (i, part) in message.attachments().enumerate() {\n                debug!(\"Processing attachment {}\", i);\n                \n                \n                // Try to extract real attachment content\n                let contents = part.contents();\n                debug!(\"Attachment {} content size: {} bytes\", i, contents.len());\n                \n                // Essayer d'extraire le vrai nom du fichier\n                let filename = Self::extract_real_filename_from_part(part, i);\n                debug!(\"Extracted filename for attachment {}: {}\", i, filename);\n                \n                // If content seems valid, use it\n                if contents.len() \u003e 10 {\n                    let content_type = Self::guess_content_type(\u0026filename);\n                    \n                    debug!(\"Using real attachment content: {} bytes\", contents.len());\n                    \n                    attachments.push(Attachment {\n                        filename,\n                        content: contents.to_vec(),\n                        content_type,\n                    });\n                } else {\n                    debug!(\"Content too small for attachment {}, skipping\", i);\n                }\n            }\n        }\n        \n        Ok(())\n    }\n    \n    fn extract_real_filename_from_part(part: \u0026mail_parser::MessagePart, index: usize) -\u003e String {\n        // Try different methods to extract filename\n        \n        debug!(\"Trying to extract filename from attachment {}\", index);\n        \n        \n        let filename = part.attachment_name().unwrap().to_string();\n        debug!(\"Generated filename: {}\", filename);\n        filename\n    }    \n    \n    fn extract_filename_from_headers(headers: \u0026str) -\u003e Option\u003cString\u003e {\n        // Chercher filename= dans les headers\n        if let Some(filename_start) = headers.find(\"filename=\") {\n            let filename_part = \u0026headers[filename_start + 9..];\n            if let Some(filename_end) = filename_part.find(['\\r', '\\n', ';']) {\n                let filename = filename_part[..filename_end].trim_matches('\"').trim();\n                if !filename.is_empty() {\n                    return Some(filename.to_string());\n                }\n            }\n        }\n        None\n    }\n    \n    fn find_attachment_end(content: \u0026str) -\u003e Option\u003cusize\u003e {\n        // Search for next boundary or message end\n        if let Some(boundary_pos) = content.find(\"--\") {\n            Some(boundary_pos)\n        } else {\n            Some(content.len())\n        }\n    }\n    \n    fn decode_attachment_content(content_str: \u0026str) -\u003e Result\u003cVec\u003cu8\u003e\u003e {\n        let content_str = content_str.trim();\n        \n        debug!(\"Attempting to decode content of {} chars\", content_str.len());\n        \n        // Detect encoding type based on content\n        if Self::is_base64_content(content_str) {\n            debug!(\"Detected base64 encoding\");\n            if let Ok(decoded) = general_purpose::STANDARD.decode(content_str.replace(['\\r', '\\n', ' '], \"\")) {\n                debug!(\"Successfully decoded {} bytes from base64\", decoded.len());\n                return Ok(decoded);\n            } else {\n                debug!(\"Base64 decoding failed, trying without whitespace removal\");\n                if let Ok(decoded) = general_purpose::STANDARD.decode(content_str) {\n                    debug!(\"Successfully decoded {} bytes from base64 (second attempt)\", decoded.len());\n                    return Ok(decoded);\n                }\n            }\n        } else if Self::is_quoted_printable_content(content_str) {\n            debug!(\"Detected quoted-printable encoding\");\n            if let Ok(decoded) = Self::decode_quoted_printable(content_str) {\n                debug!(\"Successfully decoded {} bytes from quoted-printable\", decoded.len());\n                return Ok(decoded);\n            }\n        } else {\n            debug!(\"Content appears to be plain text\");\n        }\n        \n        // If no special decoding worked, treat as plain text\n        let result = content_str.as_bytes().to_vec();\n        debug!(\"Using content as raw bytes: {} bytes\", result.len());\n        Ok(result)\n    }\n    \n    fn is_base64_content(content: \u0026str) -\u003e bool {\n        // Base64 contains only A-Z, a-z, 0-9, +, /, = and whitespace characters\n        let clean_content: String = content.chars()\n            .filter(|c| !c.is_whitespace())\n            .collect();\n        \n        if clean_content.is_empty() {\n            return false;\n        }\n        \n        // Check that all characters are valid for base64\n        let valid_chars = clean_content.chars()\n            .all(|c| c.is_ascii_alphanumeric() || c == '+' || c == '/' || c == '=');\n        \n        // And check there is a reasonable density of base64 characters\n        let base64_ratio = clean_content.chars()\n            .filter(|c| c.is_ascii_alphanumeric() || *c == '+' || *c == '/')\n            .count() as f64 / clean_content.len() as f64;\n        \n        valid_chars \u0026\u0026 base64_ratio \u003e 0.8 \u0026\u0026 clean_content.len() \u003e 10\n    }\n    \n    fn is_quoted_printable_content(content: \u0026str) -\u003e bool {\n        // Quoted-printable contains =XX sequences where XX are hex digits\n        content.contains(\"=\") \u0026\u0026 \n        content.chars().filter(|c| *c == '=').count() \u003e 2\n    }\n    \n    fn decode_quoted_printable(content: \u0026str) -\u003e Result\u003cVec\u003cu8\u003e\u003e {\n        let mut result = Vec::new();\n        let mut chars = content.chars().peekable();\n        \n        while let Some(ch) = chars.next() {\n            if ch == '=' {\n                if let (Some(h1), Some(h2)) = (chars.next(), chars.next()) {\n                    if let (Some(d1), Some(d2)) = (h1.to_digit(16), h2.to_digit(16)) {\n                        result.push((d1 * 16 + d2) as u8);\n                    } else {\n                        // Malformed sequence, keep as is\n                        result.push(ch as u8);\n                        result.push(h1 as u8);\n                        result.push(h2 as u8);\n                    }\n                } else {\n                    // End of string, keep the =\n                    result.push(ch as u8);\n                }\n            } else if ch == '\\r' {\n                // Skip CR in CRLF sequences\n                if chars.peek() == Some(\u0026'\\n') {\n                    chars.next(); // Skip the LF too\n                }\n            } else if ch != '\\n' || !result.is_empty() {\n                // Keep LF only if it's not at the beginning\n                result.push(ch as u8);\n            }\n        }\n        \n        Ok(result)\n    }\n    \n    fn guess_content_type(filename: \u0026str) -\u003e String {\n        let lowercase_name = filename.to_lowercase();\n        if lowercase_name.ends_with(\".csv\") {\n            \"text/csv\".to_string()\n        } else if lowercase_name.ends_with(\".json\") {\n            \"application/json\".to_string()\n        } else if lowercase_name.ends_with(\".xml\") {\n            \"application/xml\".to_string()\n        } else if lowercase_name.ends_with(\".txt\") {\n            \"text/plain\".to_string()\n        } else if lowercase_name.ends_with(\".xlsx\") {\n            \"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet\".to_string()\n        } else if lowercase_name.ends_with(\".xls\") {\n            \"application/vnd.ms-excel\".to_string()\n        } else {\n            \"application/octet-stream\".to_string()\n        }\n    }\n    \n\n    \n    fn is_data_file(filename: \u0026str) -\u003e bool {\n        let lowercase_name = filename.to_lowercase();\n        lowercase_name.ends_with(\".csv\") ||\n        lowercase_name.ends_with(\".json\") ||\n        lowercase_name.ends_with(\".xml\") ||\n        lowercase_name.ends_with(\".txt\") ||\n        lowercase_name.ends_with(\".xlsx\") ||\n        lowercase_name.ends_with(\".xls\")\n    }\n    \n    \n}","traces":[{"line":16,"address":[7358564,7353536,7359843],"length":1,"stats":{"Line":1}},{"line":17,"address":[5180599,5180727],"length":1,"stats":{"Line":2}},{"line":21,"address":[5758132],"length":1,"stats":{"Line":1}},{"line":22,"address":[7353701],"length":1,"stats":{"Line":1}},{"line":24,"address":[7361536,7361580,7361443],"length":1,"stats":{"Line":3}},{"line":27,"address":[7354458,7354038],"length":1,"stats":{"Line":2}},{"line":30,"address":[7354465],"length":1,"stats":{"Line":1}},{"line":31,"address":[7354477,7358841],"length":1,"stats":{"Line":2}},{"line":32,"address":[7354687,7354800,7354747],"length":1,"stats":{"Line":2}},{"line":33,"address":[5181823,5181751,5181867],"length":1,"stats":{"Line":3}},{"line":36,"address":[5182167,5181829,5185705],"length":1,"stats":{"Line":2}},{"line":37,"address":[7355337,7355516,7355476],"length":1,"stats":{"Line":0}},{"line":38,"address":[7363320,7362994],"length":1,"stats":{"Line":0}},{"line":40,"address":[7355862],"length":1,"stats":{"Line":0}},{"line":41,"address":[7363580,7363700],"length":1,"stats":{"Line":0}},{"line":44,"address":[7363745,7366193,7363665],"length":1,"stats":{"Line":0}},{"line":45,"address":[7356388,7356455],"length":1,"stats":{"Line":0}},{"line":46,"address":[5760944,5760856],"length":1,"stats":{"Line":0}},{"line":48,"address":[7364206,7364100],"length":1,"stats":{"Line":0}},{"line":49,"address":[7357174],"length":1,"stats":{"Line":0}},{"line":53,"address":[5762044,5761953,5761506,5762969],"length":1,"stats":{"Line":0}},{"line":54,"address":[5184748,5184660],"length":1,"stats":{"Line":0}},{"line":56,"address":[5762296,5762721,5762203,5762555],"length":1,"stats":{"Line":0}},{"line":59,"address":[5184986],"length":1,"stats":{"Line":0}},{"line":60,"address":[5184866],"length":1,"stats":{"Line":0}},{"line":61,"address":[7365414],"length":1,"stats":{"Line":0}},{"line":62,"address":[5762386],"length":1,"stats":{"Line":0}},{"line":70,"address":[5763270,5763257,5763209],"length":1,"stats":{"Line":2}},{"line":75,"address":[5759158,5763298],"length":1,"stats":{"Line":2}},{"line":76,"address":[7366429,7366513],"length":1,"stats":{"Line":2}},{"line":77,"address":[5763666,5763401],"length":1,"stats":{"Line":2}},{"line":80,"address":[7366876,7366992,7366384],"length":1,"stats":{"Line":3}},{"line":81,"address":[7359386],"length":1,"stats":{"Line":1}},{"line":84,"address":[5767995,5767989,5764272],"length":1,"stats":{"Line":1}},{"line":85,"address":[7360101,7359895],"length":1,"stats":{"Line":2}},{"line":88,"address":[5764368],"length":1,"stats":{"Line":1}},{"line":89,"address":[5187017,5187291,5187344],"length":1,"stats":{"Line":3}},{"line":92,"address":[7360714,7360349],"length":1,"stats":{"Line":2}},{"line":93,"address":[5765311,5765258,5765162],"length":1,"stats":{"Line":3}},{"line":96,"address":[5188219,5187840],"length":1,"stats":{"Line":2}},{"line":97,"address":[5765785,5765825,5765689],"length":1,"stats":{"Line":3}},{"line":100,"address":[5766168,5765815],"length":1,"stats":{"Line":2}},{"line":101,"address":[5188735,5188875,5188831],"length":1,"stats":{"Line":3}},{"line":104,"address":[7369411,7369792],"length":1,"stats":{"Line":2}},{"line":105,"address":[7370501,7370111],"length":1,"stats":{"Line":2}},{"line":106,"address":[7370512,7370592],"length":1,"stats":{"Line":2}},{"line":107,"address":[7370603],"length":1,"stats":{"Line":1}},{"line":108,"address":[7370652],"length":1,"stats":{"Line":1}},{"line":109,"address":[7363203,7363042],"length":1,"stats":{"Line":2}},{"line":112,"address":[7362718,7362644],"length":1,"stats":{"Line":2}},{"line":115,"address":[5190576],"length":1,"stats":{"Line":1}},{"line":116,"address":[5768061,5768167],"length":1,"stats":{"Line":2}},{"line":119,"address":[5768306,5768106],"length":1,"stats":{"Line":1}},{"line":122,"address":[5768349],"length":1,"stats":{"Line":1}},{"line":123,"address":[7371533],"length":1,"stats":{"Line":1}},{"line":126,"address":[5190918],"length":1,"stats":{"Line":1}},{"line":129,"address":[7366470,7366569,7364160],"length":1,"stats":{"Line":1}},{"line":130,"address":[5768645,5768551],"length":1,"stats":{"Line":2}},{"line":132,"address":[7364292],"length":1,"stats":{"Line":1}},{"line":133,"address":[5191393,5191200,5193564],"length":1,"stats":{"Line":2}},{"line":134,"address":[5191601,5191559,5191484],"length":1,"stats":{"Line":0}},{"line":135,"address":[5191567,5191803,5191622],"length":1,"stats":{"Line":0}},{"line":137,"address":[5193440,5191743,5191816],"length":1,"stats":{"Line":0}},{"line":138,"address":[7372605,7372472,7372639],"length":1,"stats":{"Line":0}},{"line":140,"address":[5192011,5193408,5192307],"length":1,"stats":{"Line":0}},{"line":142,"address":[7373947,7372987],"length":1,"stats":{"Line":0}},{"line":143,"address":[7365591,7365713],"length":1,"stats":{"Line":0}},{"line":145,"address":[7366078,7365728,7365815],"length":1,"stats":{"Line":0}},{"line":147,"address":[5192849],"length":1,"stats":{"Line":0}},{"line":148,"address":[7365833],"length":1,"stats":{"Line":0}},{"line":149,"address":[5192769],"length":1,"stats":{"Line":0}},{"line":150,"address":[5770249],"length":1,"stats":{"Line":0}},{"line":156,"address":[7366664,7366627,7366677],"length":1,"stats":{"Line":0}},{"line":159,"address":[5768947],"length":1,"stats":{"Line":1}},{"line":162,"address":[7366704],"length":1,"stats":{"Line":0}},{"line":163,"address":[7366763],"length":1,"stats":{"Line":0}},{"line":164,"address":[7374494,7374319,7374377],"length":1,"stats":{"Line":0}},{"line":165,"address":[5193892,5193798],"length":1,"stats":{"Line":0}},{"line":166,"address":[5771345],"length":1,"stats":{"Line":0}},{"line":167,"address":[5193978],"length":1,"stats":{"Line":0}},{"line":168,"address":[5771521],"length":1,"stats":{"Line":0}},{"line":172,"address":[5771443],"length":1,"stats":{"Line":0}},{"line":173,"address":[5194056],"length":1,"stats":{"Line":0}},{"line":174,"address":[7374782],"length":1,"stats":{"Line":0}},{"line":178,"address":[7366840],"length":1,"stats":{"Line":0}},{"line":181,"address":[5194224],"length":1,"stats":{"Line":0}},{"line":183,"address":[5194304],"length":1,"stats":{"Line":0}},{"line":186,"address":[7367459],"length":1,"stats":{"Line":0}},{"line":187,"address":[5771879,5771836,5772007],"length":1,"stats":{"Line":0}},{"line":190,"address":[7367611],"length":1,"stats":{"Line":0}},{"line":191,"address":[5772085,5771966,5772025],"length":1,"stats":{"Line":0}},{"line":192,"address":[7367767,7367718,7367760],"length":1,"stats":{"Line":0}},{"line":194,"address":[7375247],"length":1,"stats":{"Line":0}},{"line":197,"address":[7375299],"length":1,"stats":{"Line":0}},{"line":198,"address":[5194718,5194817],"length":1,"stats":{"Line":0}},{"line":200,"address":[7368211,7367878],"length":1,"stats":{"Line":0}},{"line":201,"address":[5195138],"length":1,"stats":{"Line":0}},{"line":205,"address":[5771856],"length":1,"stats":{"Line":0}},{"line":208,"address":[5776922,5776793,5772688],"length":1,"stats":{"Line":1}},{"line":209,"address":[7368423,7368555],"length":1,"stats":{"Line":2}},{"line":211,"address":[5772804,5773091],"length":1,"stats":{"Line":2}},{"line":212,"address":[5773472,5773418,5773276],"length":1,"stats":{"Line":3}},{"line":213,"address":[7376896,7376940,7376608],"length":1,"stats":{"Line":3}},{"line":215,"address":[7369822,7372461,7369398],"length":1,"stats":{"Line":3}},{"line":216,"address":[5774366,5774440,5774484],"length":1,"stats":{"Line":3}},{"line":220,"address":[7370142,7370472],"length":1,"stats":{"Line":2}},{"line":221,"address":[5197382,5197474],"length":1,"stats":{"Line":2}},{"line":224,"address":[5197811,5197448],"length":1,"stats":{"Line":2}},{"line":225,"address":[5775375,5775346,5775259],"length":1,"stats":{"Line":3}},{"line":228,"address":[7372448,7371048],"length":1,"stats":{"Line":2}},{"line":229,"address":[7371422,7371755],"length":1,"stats":{"Line":2}},{"line":231,"address":[7379361,7379445,7379274],"length":1,"stats":{"Line":3}},{"line":233,"address":[5776630],"length":1,"stats":{"Line":1}},{"line":234,"address":[7379383],"length":1,"stats":{"Line":1}},{"line":235,"address":[5198791],"length":1,"stats":{"Line":1}},{"line":236,"address":[7372278],"length":1,"stats":{"Line":1}},{"line":239,"address":[7378975,7378950,7378876],"length":1,"stats":{"Line":0}},{"line":244,"address":[5199435],"length":1,"stats":{"Line":1}},{"line":247,"address":[5777698,5777704,5776944],"length":1,"stats":{"Line":1}},{"line":250,"address":[5777111,5776979],"length":1,"stats":{"Line":2}},{"line":253,"address":[7380215],"length":1,"stats":{"Line":1}},{"line":254,"address":[7372762,7373071,7373130],"length":1,"stats":{"Line":3}},{"line":255,"address":[5199951],"length":1,"stats":{"Line":1}},{"line":258,"address":[5200288],"length":1,"stats":{"Line":1}},{"line":260,"address":[5777787],"length":1,"stats":{"Line":1}},{"line":261,"address":[7381039,7381203,7381097],"length":1,"stats":{"Line":0}},{"line":262,"address":[7381226,7381142],"length":1,"stats":{"Line":0}},{"line":263,"address":[7373735],"length":1,"stats":{"Line":0}},{"line":264,"address":[5200671],"length":1,"stats":{"Line":0}},{"line":265,"address":[7373831],"length":1,"stats":{"Line":0}},{"line":269,"address":[7381064],"length":1,"stats":{"Line":1}},{"line":272,"address":[5778208],"length":1,"stats":{"Line":0}},{"line":274,"address":[5200791,5200854],"length":1,"stats":{"Line":0}},{"line":275,"address":[5200840],"length":1,"stats":{"Line":0}},{"line":277,"address":[7381505],"length":1,"stats":{"Line":0}},{"line":281,"address":[5202734,5200912,5202693],"length":1,"stats":{"Line":0}},{"line":282,"address":[7381629],"length":1,"stats":{"Line":0}},{"line":284,"address":[5201034,5201105],"length":1,"stats":{"Line":0}},{"line":287,"address":[7374223,7377877],"length":1,"stats":{"Line":0}},{"line":288,"address":[7376069,7374531],"length":1,"stats":{"Line":0}},{"line":289,"address":[5202778,5203148],"length":1,"stats":{"Line":0}},{"line":290,"address":[5780628,5780826,5780724],"length":1,"stats":{"Line":0}},{"line":291,"address":[7383946],"length":1,"stats":{"Line":0}},{"line":293,"address":[5780540,5781304,5781257],"length":1,"stats":{"Line":0}},{"line":294,"address":[5204079,5204134,5203839],"length":1,"stats":{"Line":0}},{"line":295,"address":[7377408,7377510,7377318],"length":1,"stats":{"Line":0}},{"line":296,"address":[7384926],"length":1,"stats":{"Line":0}},{"line":299,"address":[5782143,5778824,5782628,5781184,5781138,5782104],"length":1,"stats":{"Line":0}},{"line":300,"address":[7375005,7374620],"length":1,"stats":{"Line":0}},{"line":301,"address":[7375196,7374946],"length":1,"stats":{"Line":0}},{"line":302,"address":[5779774,5779627,5779531],"length":1,"stats":{"Line":0}},{"line":303,"address":[5779645],"length":1,"stats":{"Line":0}},{"line":306,"address":[5779059,5778881],"length":1,"stats":{"Line":0}},{"line":310,"address":[7382186],"length":1,"stats":{"Line":0}},{"line":311,"address":[5201571,5204780,5204882],"length":1,"stats":{"Line":0}},{"line":312,"address":[5204794],"length":1,"stats":{"Line":0}},{"line":315,"address":[7379041,7379035,7378384],"length":1,"stats":{"Line":0}},{"line":317,"address":[7378407],"length":1,"stats":{"Line":0}},{"line":318,"address":[5382814,5382800],"length":1,"stats":{"Line":0}},{"line":321,"address":[5205303,5205368],"length":1,"stats":{"Line":0}},{"line":322,"address":[7386063],"length":1,"stats":{"Line":0}},{"line":326,"address":[5205382,5205436],"length":1,"stats":{"Line":0}},{"line":327,"address":[5382845,5382832],"length":1,"stats":{"Line":0}},{"line":330,"address":[7386187,7386412],"length":1,"stats":{"Line":0}},{"line":331,"address":[7503056,7503086],"length":1,"stats":{"Line":0}},{"line":332,"address":[5783110],"length":1,"stats":{"Line":0}},{"line":334,"address":[5783268,5783195],"length":1,"stats":{"Line":0}},{"line":337,"address":[5783328],"length":1,"stats":{"Line":0}},{"line":339,"address":[7386583],"length":1,"stats":{"Line":0}},{"line":340,"address":[7503152,7503162],"length":1,"stats":{"Line":0}},{"line":343,"address":[7387821,7386688,7387827],"length":1,"stats":{"Line":0}},{"line":344,"address":[5783483],"length":1,"stats":{"Line":0}},{"line":345,"address":[7386758,7386829],"length":1,"stats":{"Line":0}},{"line":347,"address":[7386850],"length":1,"stats":{"Line":0}},{"line":348,"address":[5783676],"length":1,"stats":{"Line":0}},{"line":349,"address":[7379577,7379536,7379715],"length":1,"stats":{"Line":0}},{"line":350,"address":[7379756,7379918],"length":1,"stats":{"Line":0}},{"line":351,"address":[7379950],"length":1,"stats":{"Line":0}},{"line":354,"address":[7379889],"length":1,"stats":{"Line":0}},{"line":355,"address":[5206880],"length":1,"stats":{"Line":0}},{"line":356,"address":[7387598],"length":1,"stats":{"Line":0}},{"line":360,"address":[7387629,7387190],"length":1,"stats":{"Line":0}},{"line":362,"address":[7379563],"length":1,"stats":{"Line":0}},{"line":364,"address":[7380130,7380170],"length":1,"stats":{"Line":0}},{"line":365,"address":[5207033],"length":1,"stats":{"Line":0}},{"line":367,"address":[7380302,7380158,7380245],"length":1,"stats":{"Line":0}},{"line":369,"address":[7387776,7387816],"length":1,"stats":{"Line":0}},{"line":373,"address":[7386949],"length":1,"stats":{"Line":0}},{"line":376,"address":[7388674,7388680,7387840],"length":1,"stats":{"Line":1}},{"line":377,"address":[7387879],"length":1,"stats":{"Line":1}},{"line":378,"address":[5207307,5207224],"length":1,"stats":{"Line":2}},{"line":379,"address":[5784807,5785408],"length":1,"stats":{"Line":2}},{"line":380,"address":[7380542,7380603],"length":1,"stats":{"Line":0}},{"line":381,"address":[7388670,7388177],"length":1,"stats":{"Line":0}},{"line":382,"address":[7380648,7380709],"length":1,"stats":{"Line":0}},{"line":383,"address":[7380779,7381164],"length":1,"stats":{"Line":0}},{"line":384,"address":[5207631,5207570],"length":1,"stats":{"Line":0}},{"line":385,"address":[7388389,7388666],"length":1,"stats":{"Line":0}},{"line":386,"address":[7388364,7388425],"length":1,"stats":{"Line":0}},{"line":387,"address":[7381160,7380991],"length":1,"stats":{"Line":0}},{"line":388,"address":[7388531,7388470],"length":1,"stats":{"Line":0}},{"line":389,"address":[5207974,5207919],"length":1,"stats":{"Line":0}},{"line":391,"address":[7381072,7381126],"length":1,"stats":{"Line":0}},{"line":397,"address":[7381801,7381807,7381200],"length":1,"stats":{"Line":0}},{"line":398,"address":[5785469],"length":1,"stats":{"Line":0}},{"line":399,"address":[5208161,5208223,5208078],"length":1,"stats":{"Line":0}},{"line":400,"address":[7381430,7381390],"length":1,"stats":{"Line":0}},{"line":401,"address":[7388979],"length":1,"stats":{"Line":0}},{"line":402,"address":[7381551],"length":1,"stats":{"Line":0}},{"line":403,"address":[7381627],"length":1,"stats":{"Line":0}},{"line":404,"address":[7381703],"length":1,"stats":{"Line":0}}],"covered":76,"coverable":211},{"path":["/","workspaces","homemetrics","src","blueriot","extractor.rs"],"content":"use anyhow::Result;\nuse chrono::{DateTime, Utc};\nuse log::{debug, warn};\n\n#[derive(Debug, Clone)]\npub struct PoolReading {\n    pub timestamp: DateTime\u003cUtc\u003e,\n    pub temperature: Option\u003cf64\u003e,\n    pub ph: Option\u003cf64\u003e,\n    pub orp: Option\u003ci32\u003e,\n}\n\n/// Extract pool metrics from Blue Riot email text content\n/// \n/// Expected formats:\n/// - \"Temperature: 25.5¬∞C\" or \"Temp√©rature: 25.5¬∞C\" or \"Temp: 25.5\"\n/// - \"pH: 7.2\" or \"pH: 7,2\"\n/// - \"ORP: 720 mV\" or \"Redox: 720\" or \"ORP: 720mV\"\npub fn extract_pool_metrics(text: \u0026str, timestamp: DateTime\u003cUtc\u003e) -\u003e Result\u003cPoolReading\u003e {\n    debug!(\"Extracting pool metrics from text (length: {} bytes)\", text.len());\n    \n    let mut reading = PoolReading {\n        timestamp,\n        temperature: None,\n        ph: None,\n        orp: None,\n    };\n    \n    // Extract temperature\n    reading.temperature = extract_temperature(text);\n    \n    // Extract pH\n    reading.ph = extract_ph(text);\n    \n    // Extract ORP\n    reading.orp = extract_orp(text);\n    \n    // Validate that we extracted at least one metric\n    if reading.temperature.is_none() \u0026\u0026 reading.ph.is_none() \u0026\u0026 reading.orp.is_none() {\n        anyhow::bail!(\"No pool metrics found in email text\");\n    }\n    \n    debug!(\"Extracted pool reading: temp={:?}¬∞C, pH={:?}, ORP={:?} mV\", \n           reading.temperature, reading.ph, reading.orp);\n    \n    Ok(reading)\n}\n\n/// Extract temperature from text\n/// Patterns: \"Temperature: 25.5¬∞C\", \"Temp√©rature: 25.5\", \"Temp: 25,5\"\nfn extract_temperature(text: \u0026str) -\u003e Option\u003cf64\u003e {\n    // Try different patterns\n    let patterns = [\n        r\"(?i)temp[√©e]rature[:\\s]+([0-9]+[.,][0-9]+)\",\n        r\"(?i)temp[:\\s]+([0-9]+[.,][0-9]+)\",\n        r\"([0-9]+[.,][0-9]+)\\s*¬∞C\",\n    ];\n    \n    for pattern in \u0026patterns {\n        if let Ok(re) = regex::Regex::new(pattern) {\n            if let Some(caps) = re.captures(text) {\n                if let Some(temp_str) = caps.get(1) {\n                    let temp_normalized = temp_str.as_str().replace(',', \".\");\n                    if let Ok(temp) = temp_normalized.parse::\u003cf64\u003e() {\n                        debug!(\"Found temperature: {}¬∞C (pattern: {})\", temp, pattern);\n                        return Some(temp);\n                    }\n                }\n            }\n        }\n    }\n    \n    warn!(\"Temperature not found in text\");\n    None\n}\n\n/// Extract pH from text\n/// Patterns: \"pH: 7.2\", \"pH 7,2\", \"ph: 7.25\"\nfn extract_ph(text: \u0026str) -\u003e Option\u003cf64\u003e {\n    let patterns = [\n        r\"(?i)ph[:\\s]+([0-9]+[.,][0-9]+)\",\n        r\"(?i)ph\\s*=\\s*([0-9]+[.,][0-9]+)\",\n    ];\n    \n    for pattern in \u0026patterns {\n        if let Ok(re) = regex::Regex::new(pattern) {\n            if let Some(caps) = re.captures(text) {\n                if let Some(ph_str) = caps.get(1) {\n                    let ph_normalized = ph_str.as_str().replace(',', \".\");\n                    if let Ok(ph) = ph_normalized.parse::\u003cf64\u003e() {\n                        // Validate pH range (0-14)\n                        if (0.0..=14.0).contains(\u0026ph) {\n                            debug!(\"Found pH: {} (pattern: {})\", ph, pattern);\n                            return Some(ph);\n                        } else {\n                            warn!(\"pH value out of range: {}\", ph);\n                        }\n                    }\n                }\n            }\n        }\n    }\n    \n    warn!(\"pH not found in text\");\n    None\n}\n\n/// Extract ORP (Oxidation-Reduction Potential) from text\n/// Patterns: \"ORP: 720 mV\", \"Redox: 720\", \"ORP: 720mV\"\nfn extract_orp(text: \u0026str) -\u003e Option\u003ci32\u003e {\n    let patterns = [\n        r\"(?i)orp[:\\s]+([0-9]+)\\s*m?V?\",\n        r\"(?i)redox[:\\s]+([0-9]+)\\s*m?V?\",\n        r\"([0-9]+)\\s*mV\",\n    ];\n    \n    for pattern in \u0026patterns {\n        if let Ok(re) = regex::Regex::new(pattern) {\n            if let Some(caps) = re.captures(text) {\n                if let Some(orp_str) = caps.get(1) {\n                    if let Ok(orp) = orp_str.as_str().parse::\u003ci32\u003e() {\n                        // Validate ORP range (typically 0-1000 mV for pools)\n                        if (0..=1000).contains(\u0026orp) {\n                            debug!(\"Found ORP: {} mV (pattern: {})\", orp, pattern);\n                            return Some(orp);\n                        } else {\n                            warn!(\"ORP value out of range: {}\", orp);\n                        }\n                    }\n                }\n            }\n        }\n    }\n    \n    warn!(\"ORP not found in text\");\n    None\n}\n\n#[cfg(test)]\nmod tests {\n    use super::*;\n    \n    #[test]\n    fn test_extract_temperature() {\n        assert_eq!(extract_temperature(\"Temperature: 25.5¬∞C\"), Some(25.5));\n        assert_eq!(extract_temperature(\"Temp√©rature: 24,8¬∞C\"), Some(24.8));\n        assert_eq!(extract_temperature(\"Temp: 26.2\"), Some(26.2));\n        assert_eq!(extract_temperature(\"No temp here\"), None);\n    }\n    \n    #[test]\n    fn test_extract_ph() {\n        assert_eq!(extract_ph(\"pH: 7.2\"), Some(7.2));\n        assert_eq!(extract_ph(\"pH 7,4\"), Some(7.4));\n        assert_eq!(extract_ph(\"ph = 7.15\"), Some(7.15));\n        assert_eq!(extract_ph(\"No pH here\"), None);\n        assert_eq!(extract_ph(\"pH: 15.0\"), None); // Out of range\n    }\n    \n    #[test]\n    fn test_extract_orp() {\n        assert_eq!(extract_orp(\"ORP: 720 mV\"), Some(720));\n        assert_eq!(extract_orp(\"Redox: 680\"), Some(680));\n        assert_eq!(extract_orp(\"ORP: 750mV\"), Some(750));\n        assert_eq!(extract_orp(\"No ORP here\"), None);\n        assert_eq!(extract_orp(\"ORP: 2000\"), None); // Out of range\n    }\n    \n    #[test]\n    fn test_extract_pool_metrics() {\n        let text = \"Pool Status Report\\nTemperature: 25.5¬∞C\\npH: 7.2\\nORP: 720 mV\";\n        let timestamp = Utc::now();\n        let reading = extract_pool_metrics(text, timestamp).unwrap();\n        \n        assert_eq!(reading.temperature, Some(25.5));\n        assert_eq!(reading.ph, Some(7.2));\n        assert_eq!(reading.orp, Some(720));\n    }\n}\n","traces":[{"line":19,"address":[5318704],"length":1,"stats":{"Line":4}},{"line":20,"address":[4686080,4686392],"length":1,"stats":{"Line":8}},{"line":30,"address":[4686282],"length":1,"stats":{"Line":4}},{"line":33,"address":[8395434],"length":1,"stats":{"Line":4}},{"line":36,"address":[8395466],"length":1,"stats":{"Line":5}},{"line":39,"address":[8395788,8395485],"length":1,"stats":{"Line":6}},{"line":40,"address":[8395836],"length":1,"stats":{"Line":0}},{"line":43,"address":[8395745,8395956],"length":1,"stats":{"Line":9}},{"line":46,"address":[8395902],"length":1,"stats":{"Line":5}},{"line":51,"address":[4687200,4689007,4689072],"length":1,"stats":{"Line":4}},{"line":53,"address":[4687233],"length":1,"stats":{"Line":4}},{"line":59,"address":[5907542,5909356],"length":1,"stats":{"Line":7}},{"line":60,"address":[4687783,4687414],"length":1,"stats":{"Line":10}},{"line":61,"address":[8397010,8396959],"length":1,"stats":{"Line":11}},{"line":62,"address":[5320707,5320795],"length":1,"stats":{"Line":8}},{"line":63,"address":[5320866,5320915],"length":1,"stats":{"Line":11}},{"line":64,"address":[8397408,8397540,8397479],"length":1,"stats":{"Line":17}},{"line":65,"address":[8397558,8397656],"length":1,"stats":{"Line":10}},{"line":66,"address":[8397610],"length":1,"stats":{"Line":5}},{"line":73,"address":[5320163,5320214],"length":1,"stats":{"Line":6}},{"line":74,"address":[8396648],"length":1,"stats":{"Line":3}},{"line":79,"address":[4691397,4691332,4689168],"length":1,"stats":{"Line":4}},{"line":80,"address":[8398321],"length":1,"stats":{"Line":4}},{"line":85,"address":[5324125,5321943],"length":1,"stats":{"Line":6}},{"line":86,"address":[8398859,8398490],"length":1,"stats":{"Line":8}},{"line":87,"address":[5910070,5910019],"length":1,"stats":{"Line":8}},{"line":88,"address":[8399111,8399199],"length":1,"stats":{"Line":7}},{"line":89,"address":[5322822,5322871],"length":1,"stats":{"Line":7}},{"line":90,"address":[4690376,4690244,4690315],"length":1,"stats":{"Line":10}},{"line":92,"address":[4690394],"length":1,"stats":{"Line":4}},{"line":93,"address":[8399979,8399596,8399927],"length":1,"stats":{"Line":15}},{"line":94,"address":[8399933],"length":1,"stats":{"Line":6}},{"line":96,"address":[5910654,5910745],"length":1,"stats":{"Line":4}},{"line":104,"address":[5322170,5322119],"length":1,"stats":{"Line":4}},{"line":105,"address":[4689484],"length":1,"stats":{"Line":2}},{"line":110,"address":[4693591,4693526,4691488],"length":1,"stats":{"Line":5}},{"line":111,"address":[5324193],"length":1,"stats":{"Line":5}},{"line":117,"address":[8402777,8400732],"length":1,"stats":{"Line":7}},{"line":118,"address":[5324745,5324380],"length":1,"stats":{"Line":9}},{"line":119,"address":[4692180,4692129],"length":1,"stats":{"Line":7}},{"line":120,"address":[4692325,4692413],"length":1,"stats":{"Line":7}},{"line":121,"address":[4692533,4692484],"length":1,"stats":{"Line":7}},{"line":123,"address":[5912836],"length":1,"stats":{"Line":4}},{"line":124,"address":[8402145,8401814,8402192],"length":1,"stats":{"Line":15}},{"line":125,"address":[4693031],"length":1,"stats":{"Line":5}},{"line":127,"address":[4692743,4692652],"length":1,"stats":{"Line":4}},{"line":135,"address":[4691835,4691785],"length":1,"stats":{"Line":4}},{"line":136,"address":[4691822],"length":1,"stats":{"Line":2}}],"covered":47,"coverable":48},{"path":["/","workspaces","homemetrics","src","blueriot","mod.rs"],"content":"/// Blue Riot pool monitoring email processing module\npub mod extractor;\npub mod processor;\n\npub use extractor::PoolReading;\npub use processor::BlueRiotEmailProcessor;\n","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","homemetrics","src","blueriot","processor.rs"],"content":"use anyhow::{Result, Context};\nuse log::{debug, info};\n\nuse crate::config::Config;\nuse crate::gmail_client::GmailClient;\nuse crate::database::Database;\nuse crate::slack_notifier::SlackNotifier;\nuse crate::email::{EmailProcessingStrategy, BaseEmailProcessor};\nuse super::extractor;\n\n/// Blue Riot specific processing strategy\npub struct BlueRiotStrategy;\n\nimpl EmailProcessingStrategy for BlueRiotStrategy {\n    fn search_emails\u003c'a, 'b: 'a\u003e(\u0026'a self, gmail: \u0026'b GmailClient) -\u003e \n        std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003cVec\u003cString\u003e\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(gmail.search_pool_emails())\n    }\n    \n    fn process_single_email\u003c'a, 'b: 'a, 'c: 'a\u003e(\n        \u0026'a self,\n        gmail: \u0026'b GmailClient,\n        database: Option\u003c\u0026'c Database\u003e,\n        slack: Option\u003c\u0026'c SlackNotifier\u003e,\n        message_id: \u0026'a str,\n        is_dry_run: bool,\n    ) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003cusize\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move {\n            debug!(\"Processing Blue Riot email ID: {}\", message_id);\n            \n            // Fetch email metadata\n            let (subject, _from) = gmail.fetch_email_metadata(message_id).await?;\n            debug!(\"Email subject: {}\", subject);\n            \n            // Fetch complete email content\n            let email = gmail.fetch_email_complete(message_id).await?;\n            debug!(\"Email date: {}\", email.date);\n            \n            // Parse email to extract text body\n            let parsed_email = mail_parser::MessageParser::default()\n                .parse(\u0026email.content)\n                .context(\"Failed to parse email\")?;\n            \n            // Extract text from email body\n            let mut text_content = String::new();\n            \n            // Try to get text/plain body first\n            if let Some(text_body) = parsed_email.body_text(0) {\n                text_content.push_str(\u0026text_body);\n            }\n            \n            // If no text/plain, try text/html\n            if text_content.is_empty() {\n                if let Some(html_body) = parsed_email.body_html(0) {\n                    // Simple HTML stripping (remove tags)\n                    let html_str = html_body.to_string()\n                        .replace(\"\u003cbr\u003e\", \"\\n\")\n                        .replace(\"\u003cBR\u003e\", \"\\n\")\n                        .replace(\"\u003c/p\u003e\", \"\\n\")\n                        .replace(\"\u003c/P\u003e\", \"\\n\");\n                    // Remove all HTML tags\n                    let tag_regex = regex::Regex::new(r\"\u003c[^\u003e]+\u003e\").unwrap();\n                    text_content = tag_regex.replace_all(\u0026html_str, \"\").to_string();\n                }\n            }\n            \n            // Fallback to raw content if still empty\n            if text_content.is_empty() {\n                text_content = String::from_utf8_lossy(\u0026email.content).to_string();\n            }\n            \n            if is_dry_run {\n                println!(\"\\nüìß Email: {}\", subject);\n                println!(\"üìÖ Date: {}\", email.date);\n                println!(\"üìÑ Text content (first 500 chars):\\n{}\\n\", \n                         \u0026text_content.chars().take(500).collect::\u003cString\u003e());\n            }\n            \n            // Extract pool metrics from email text\n            let pool_reading = extractor::extract_pool_metrics(\u0026text_content, email.date)\n                .context(\"Failed to extract pool metrics from email\")?;\n            \n            if is_dry_run {\n                println!(\"üèä Pool Metrics Extracted:\");\n                if let Some(temp) = pool_reading.temperature {\n                    println!(\"   üå°Ô∏è  Temperature: {:.1}¬∞C\", temp);\n                }\n                if let Some(ph) = pool_reading.ph {\n                    println!(\"   üß™ pH: {:.2}\", ph);\n                }\n                if let Some(orp) = pool_reading.orp {\n                    println!(\"   ‚ö° ORP: {} mV\", orp);\n                }\n                println!();\n            } else {\n                // Save to database\n                if let Some(db) = database {\n                    db.save_pool_reading(\u0026pool_reading, message_id).await?;\n                    \n                    // Send Slack notification\n                    if let Some(slack) = slack {\n                        let mut metrics = Vec::new();\n                        if let Some(temp) = pool_reading.temperature {\n                            metrics.push(format!(\"üå°Ô∏è {}¬∞C\", temp));\n                        }\n                        if let Some(ph) = pool_reading.ph {\n                            metrics.push(format!(\"üß™ pH {:.2}\", ph));\n                        }\n                        if let Some(orp) = pool_reading.orp {\n                            metrics.push(format!(\"‚ö° {} mV\", orp));\n                        }\n                        \n                        let message = format!(\n                            \"üèä New pool reading: {}\\nFrom: {}\",\n                            metrics.join(\" | \"),\n                            subject\n                        );\n                        \n                        info!(\"Sending Slack notification for Blue Riot reading\");\n                        if let Err(e) = slack.send_message(\u0026message).await {\n                            debug!(\"Failed to send Slack notification: {}\", e);\n                        } else {\n                            debug!(\"Slack notification sent successfully\");\n                        }\n                    }\n                }\n            }\n            \n            // Return 1 to indicate one record processed (the pool reading)\n            Ok(1)\n        })\n    }\n    \n    fn mark_email_processed\u003c'a, 'b: 'a\u003e(\n        \u0026'a self,\n        gmail: \u0026'b GmailClient,\n        message_id: \u0026'a str,\n    ) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003c()\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(gmail.mark_pool_email_as_processed(message_id))\n    }\n    \n    fn processor_name(\u0026self) -\u003e \u0026str {\n        \"Blue Riot\"\n    }\n    \n    fn label_name(\u0026self) -\u003e \u0026str {\n        \"homemetrics/todo/blueriot\"\n    }\n}\n\n/// Blue Riot email processor (wrapper around BaseEmailProcessor)\npub struct BlueRiotEmailProcessor {\n    base: BaseEmailProcessor\u003cBlueRiotStrategy\u003e,\n}\n\nimpl BlueRiotEmailProcessor {\n    pub async fn new(config: \u0026Config, dry_run: bool) -\u003e Result\u003cSelf\u003e {\n        let processor = if dry_run {\n            BlueRiotEmailProcessor {\n                base: BaseEmailProcessor::new_dry_run(config.clone(), BlueRiotStrategy)?,\n            }\n        } else {\n            BlueRiotEmailProcessor {\n                base: BaseEmailProcessor::new(config.clone(), BlueRiotStrategy).await?,\n            }\n        };\n        Ok(processor)\n    }\n    \n    pub async fn process_emails(\u0026self, limit: Option\u003cusize\u003e) -\u003e Result\u003c()\u003e {\n        self.base.process_emails(limit).await?;\n        Ok(())\n    }\n}\n","traces":[{"line":15,"address":[5639696],"length":1,"stats":{"Line":0}},{"line":17,"address":[8157729],"length":1,"stats":{"Line":0}},{"line":20,"address":[5639776],"length":1,"stats":{"Line":0}},{"line":28,"address":[5652071],"length":1,"stats":{"Line":0}},{"line":29,"address":[4207678,4207913,4207960],"length":1,"stats":{"Line":0}},{"line":32,"address":[8728596,8730176,8729080,8729176,8728735],"length":1,"stats":{"Line":0}},{"line":33,"address":[4208920,4208820,4208967],"length":1,"stats":{"Line":0}},{"line":36,"address":[8421775,8415705,8415499,8415166,8414009],"length":1,"stats":{"Line":0}},{"line":37,"address":[8730869,8730841,8730749],"length":1,"stats":{"Line":0}},{"line":40,"address":[8731339,8731177,8731228,8730847,8736181],"length":1,"stats":{"Line":0}},{"line":41,"address":[8416617],"length":1,"stats":{"Line":0}},{"line":42,"address":[8435724,8435871,8436188,8440793],"length":1,"stats":{"Line":0}},{"line":45,"address":[8731706],"length":1,"stats":{"Line":0}},{"line":48,"address":[4210985,4210912],"length":1,"stats":{"Line":0}},{"line":49,"address":[8417530,8417366],"length":1,"stats":{"Line":0}},{"line":53,"address":[8417577,8417683,8419299],"length":1,"stats":{"Line":0}},{"line":54,"address":[8732241,8732314],"length":1,"stats":{"Line":0}},{"line":56,"address":[8437296,8436951,8437576,8437076,8437156,8437436],"length":1,"stats":{"Line":0}},{"line":57,"address":[],"length":0,"stats":{"Line":0}},{"line":58,"address":[],"length":0,"stats":{"Line":0}},{"line":59,"address":[],"length":0,"stats":{"Line":0}},{"line":60,"address":[8418304,8418553,8418164,8418027,8418444],"length":1,"stats":{"Line":0}},{"line":62,"address":[8733316],"length":1,"stats":{"Line":0}},{"line":63,"address":[8418952,8419087,8418869],"length":1,"stats":{"Line":0}},{"line":68,"address":[8732209,8733842],"length":1,"stats":{"Line":0}},{"line":69,"address":[8733874,8734041],"length":1,"stats":{"Line":0}},{"line":72,"address":[8733848],"length":1,"stats":{"Line":0}},{"line":73,"address":[8438779],"length":1,"stats":{"Line":0}},{"line":74,"address":[8419807],"length":1,"stats":{"Line":0}},{"line":75,"address":[4213755],"length":1,"stats":{"Line":0}},{"line":76,"address":[8419907],"length":1,"stats":{"Line":0}},{"line":80,"address":[8439484,8439317,8440716,8438738],"length":1,"stats":{"Line":0}},{"line":81,"address":[8420396],"length":1,"stats":{"Line":0}},{"line":83,"address":[8734996],"length":1,"stats":{"Line":0}},{"line":84,"address":[8439634,8439878],"length":1,"stats":{"Line":0}},{"line":85,"address":[8420825],"length":1,"stats":{"Line":0}},{"line":86,"address":[4214588,4214531],"length":1,"stats":{"Line":0}},{"line":88,"address":[4214812,4214558],"length":1,"stats":{"Line":0}},{"line":89,"address":[8421235,8421177],"length":1,"stats":{"Line":0}},{"line":91,"address":[4215119,4214864],"length":1,"stats":{"Line":0}},{"line":92,"address":[8440605,8440552],"length":1,"stats":{"Line":0}},{"line":94,"address":[4215167,4215264],"length":1,"stats":{"Line":0}},{"line":97,"address":[8735079,8735013],"length":1,"stats":{"Line":0}},{"line":98,"address":[5473854],"length":1,"stats":{"Line":0}},{"line":101,"address":[8441257,8444656],"length":1,"stats":{"Line":0}},{"line":102,"address":[4215888],"length":1,"stats":{"Line":0}},{"line":103,"address":[8422278],"length":1,"stats":{"Line":0}},{"line":104,"address":[8441526,8441396],"length":1,"stats":{"Line":0}},{"line":106,"address":[8441665,8441445],"length":1,"stats":{"Line":0}},{"line":107,"address":[8441690,8441770],"length":1,"stats":{"Line":0}},{"line":109,"address":[8441739,8442057],"length":1,"stats":{"Line":0}},{"line":110,"address":[4216642,4216736],"length":1,"stats":{"Line":0}},{"line":113,"address":[4216923],"length":1,"stats":{"Line":0}},{"line":114,"address":[],"length":0,"stats":{"Line":0}},{"line":115,"address":[8423255,8423055],"length":1,"stats":{"Line":0}},{"line":116,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[4217387,4217243,4217346],"length":1,"stats":{"Line":0}},{"line":120,"address":[8423716,8424327,8414051,8424035,8424612],"length":1,"stats":{"Line":0}},{"line":121,"address":[8739095,8739230,8739258],"length":1,"stats":{"Line":0}},{"line":123,"address":[8444252,8443781],"length":1,"stats":{"Line":0}},{"line":130,"address":[8420656],"length":1,"stats":{"Line":0}},{"line":134,"address":[5652144],"length":1,"stats":{"Line":0}},{"line":139,"address":[5139697],"length":1,"stats":{"Line":0}},{"line":142,"address":[5640016],"length":1,"stats":{"Line":0}},{"line":146,"address":[5139760],"length":1,"stats":{"Line":0}},{"line":157,"address":[8444959,8445066,8445579,8445968,8445149,8444864],"length":1,"stats":{"Line":0}},{"line":158,"address":[8445958,8445060],"length":1,"stats":{"Line":0}},{"line":160,"address":[8445296,8445529,8445139],"length":1,"stats":{"Line":0}},{"line":164,"address":[8740572,8740941,8741279,8740453],"length":1,"stats":{"Line":0}},{"line":167,"address":[8426406],"length":1,"stats":{"Line":0}},{"line":170,"address":[4220505,4220618,4220480,4221195,4220655,4220767],"length":1,"stats":{"Line":0}},{"line":171,"address":[8427649,8427138,8427035,8427237,8427081],"length":1,"stats":{"Line":0}},{"line":172,"address":[8427581],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":73},{"path":["/","workspaces","homemetrics","src","config.rs"],"content":"use anyhow::Result;\nuse serde::Deserialize;\n\n#[derive(Debug, Deserialize, Clone)]\npub struct Config {\n    pub gmail: GmailConfig,\n    pub database: DatabaseConfig,\n    pub data_dir: String,\n    pub scheduler: SchedulerConfig,\n    pub slack: Option\u003cSlackConfig\u003e,\n}\n\n#[derive(Debug, Deserialize, Clone)]\npub struct SchedulerConfig {\n    pub enabled: bool,\n    pub schedule_times: Vec\u003cString\u003e, // Format: \"HH:MM\" (e.g., [\"02:00\", \"14:00\"])\n}\n\n#[derive(Debug, Deserialize, Clone)]\npub struct GmailConfig {\n    pub credentials_path: String,\n    pub token_cache_path: String,\n}\n\n#[derive(Debug, Deserialize, Clone)]\npub struct DatabaseConfig {\n    pub host: String,\n    pub port: u16,\n    pub database: String,\n    pub username: String,\n    pub password: String,\n}\n\n#[derive(Debug, Deserialize, Clone)]\npub struct SlackConfig {\n    pub bot_token: String,\n    pub channel_id: String,\n}\n\nimpl Config {\n    pub fn new() -\u003e Result\u003cSelf\u003e {\n        // Check that essential variables are defined\n        Self::check_required_env_vars()?;\n        \n        // Configuration loaded from environment variables\n        Ok(Config {\n            gmail: GmailConfig {\n                credentials_path: std::env::var(\"GMAIL_CREDENTIALS_PATH\")\n                    .expect(\"GMAIL_CREDENTIALS_PATH must be defined\"),\n                token_cache_path: std::env::var(\"GMAIL_TOKEN_CACHE_PATH\")\n                    .unwrap_or_else(|_| \"./gmail-token-cache.json\".to_string()),\n            },\n            database: DatabaseConfig {\n                host: std::env::var(\"DB_HOST\")\n                    .unwrap_or_else(|_| \"localhost\".to_string()),\n                port: std::env::var(\"DB_PORT\")\n                    .unwrap_or_else(|_| \"5432\".to_string())\n                    .parse()\n                    .unwrap_or(5432),\n                database: std::env::var(\"DB_NAME\")\n                    .unwrap_or_else(|_| \"homemetrics\".to_string()),\n                username: std::env::var(\"DB_USERNAME\")\n                    .unwrap_or_else(|_| \"postgres\".to_string()),\n                password: std::env::var(\"DB_PASSWORD\")\n                    .expect(\"DB_PASSWORD must be defined\"),\n            },\n            data_dir: std::env::var(\"DATA_DIR\")\n                .unwrap_or_else(|_| \"./data\".to_string()),\n            scheduler: SchedulerConfig {\n                enabled: std::env::var(\"SCHEDULER_ENABLED\")\n                    .unwrap_or_else(|_| \"false\".to_string())\n                    .parse()\n                    .unwrap_or(false),\n                schedule_times: std::env::var(\"SCHEDULER_TIMES\")\n                    .unwrap_or_else(|_| \"02:00\".to_string())\n                    .split(',')\n                    .map(|s| s.trim().to_string())\n                    .collect(),\n            },\n            slack: match (std::env::var(\"SLACK_BOT_TOKEN\"), std::env::var(\"SLACK_CHANNEL_ID\")) {\n                (Ok(bot_token), Ok(channel_id)) =\u003e Some(SlackConfig {\n                    bot_token,\n                    channel_id,\n                }),\n                _ =\u003e {\n                    log::warn!(\"SLACK_BOT_TOKEN or SLACK_CHANNEL_ID not defined - Slack notifications disabled\");\n                    None\n                }\n            },\n        })\n    }\n    \n    fn check_required_env_vars() -\u003e Result\u003c()\u003e {\n        let required_vars = [\n            \"GMAIL_CREDENTIALS_PATH\",\n        ];\n        \n        let mut missing_vars = Vec::new();\n        \n        for var in \u0026required_vars {\n            if std::env::var(var).is_err() {\n                missing_vars.push(*var);\n            }\n        }\n        \n        if !missing_vars.is_empty() {\n            anyhow::bail!(\n                \"Missing environment variables: {}\\n\\\n                 \\n\\\n                 üí° Solutions:\\n\\\n                 1. Create a .env file with your credentials:\\n\\\n                    cp .env.example .env\\n\\\n                    # Then edit .env with your values\\n\\\n                 \\n\\\n                 2. Or set variables manually:\\n\\\n                    export GMAIL_CREDENTIALS_PATH=/path/to/client_credentials.json\\n\\\n                    export GMAIL_TOKEN_CACHE_PATH=./gmail-token-cache.json\\n\\\n                    cargo run -- --dry-run\\n\\\n                 \\n\\\n                 3. See GMAIL_API_MIGRATION.md for more information\",\n                missing_vars.join(\", \")\n            );\n        }\n        \n        Ok(())\n    }\n}","traces":[{"line":40,"address":[12932850],"length":1,"stats":{"Line":0}},{"line":41,"address":[5954983,5955172,5951632],"length":1,"stats":{"Line":0}},{"line":43,"address":[5959156],"length":1,"stats":{"Line":0}},{"line":46,"address":[5954023],"length":1,"stats":{"Line":0}},{"line":47,"address":[5951952],"length":1,"stats":{"Line":0}},{"line":48,"address":[12933032],"length":1,"stats":{"Line":0}},{"line":49,"address":[44415444,44415585],"length":1,"stats":{"Line":0}},{"line":50,"address":[25806455],"length":1,"stats":{"Line":0}},{"line":51,"address":[25806736,25806463],"length":1,"stats":{"Line":0}},{"line":53,"address":[5952689],"length":1,"stats":{"Line":0}},{"line":54,"address":[5259021,5258950],"length":1,"stats":{"Line":0}},{"line":55,"address":[6592048,6592064],"length":1,"stats":{"Line":0}},{"line":56,"address":[5259232,5259051,5259123],"length":1,"stats":{"Line":0}},{"line":57,"address":[6592160,6592176],"length":1,"stats":{"Line":0}},{"line":60,"address":[5959896],"length":1,"stats":{"Line":0}},{"line":61,"address":[5855584,5855568],"length":1,"stats":{"Line":0}},{"line":62,"address":[5960036,5959961],"length":1,"stats":{"Line":0}},{"line":63,"address":[5855696,5855680],"length":1,"stats":{"Line":0}},{"line":64,"address":[5259480,5259552],"length":1,"stats":{"Line":0}},{"line":67,"address":[5952825,5952900],"length":1,"stats":{"Line":0}},{"line":68,"address":[7944832,7944816],"length":1,"stats":{"Line":0}},{"line":69,"address":[4137718],"length":1,"stats":{"Line":0}},{"line":70,"address":[5960438,5960510,5960623],"length":1,"stats":{"Line":0}},{"line":71,"address":[5855920,5855904],"length":1,"stats":{"Line":0}},{"line":74,"address":[4137644,4137504],"length":1,"stats":{"Line":0}},{"line":75,"address":[25659136,25655792,25658838],"length":1,"stats":{"Line":0}},{"line":76,"address":[25655823],"length":1,"stats":{"Line":0}},{"line":77,"address":[17224091],"length":1,"stats":{"Line":0}},{"line":78,"address":[17224766],"length":1,"stats":{"Line":0}},{"line":80,"address":[16932777,16932834],"length":1,"stats":{"Line":0}},{"line":81,"address":[5260667],"length":1,"stats":{"Line":0}},{"line":82,"address":[16933124,16932989,16933070],"length":1,"stats":{"Line":0}},{"line":85,"address":[17225395,17225034],"length":1,"stats":{"Line":0}},{"line":86,"address":[17227776],"length":1,"stats":{"Line":0}},{"line":87,"address":[17224812],"length":1,"stats":{"Line":0}},{"line":93,"address":[4140325,4140165,4139488],"length":1,"stats":{"Line":0}},{"line":94,"address":[5955207],"length":1,"stats":{"Line":0}},{"line":95,"address":[17226428],"length":1,"stats":{"Line":0}},{"line":98,"address":[4139521],"length":1,"stats":{"Line":0}},{"line":100,"address":[17225597,17225748],"length":1,"stats":{"Line":0}},{"line":101,"address":[12933815],"length":1,"stats":{"Line":0}},{"line":102,"address":[5262846],"length":1,"stats":{"Line":0}},{"line":106,"address":[5955446],"length":1,"stats":{"Line":0}},{"line":107,"address":[17225169,17225539],"length":1,"stats":{"Line":0}},{"line":125,"address":[5955502],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":45},{"path":["/","workspaces","homemetrics","src","database.rs"],"content":"use anyhow::{Result, Context};\nuse log::{info, debug, warn};\nuse sqlx::PgPool;\n\nuse crate::config::DatabaseConfig;\nuse crate::xsense::TemperatureReading;\nuse crate::blueriot::PoolReading;\n\npub struct Database {\n    pool: PgPool,\n}\n\nimpl Database {\n    pub async fn new(config: \u0026DatabaseConfig) -\u003e Result\u003cSelf\u003e {\n        info!(\"Connecting to TimescaleDB database\");\n        \n        let database_url = format!(\n            \"postgres://{}:{}@{}:{}/{}\",\n            config.username, config.password, config.host, config.port, config.database\n        );\n        \n        let pool = PgPool::connect(\u0026database_url)\n            .await\n            .context(\"Impossible de se connecter √† la base de donn√©es\")?;\n        \n        info!(\"Database connection established\");\n        \n        let db = Database { pool };\n        \n        // Create tables if they don't exist\n        db.create_tables_if_not_exists().await?;\n        \n        Ok(db)\n    }\n    \n    async fn create_tables_if_not_exists(\u0026self) -\u003e Result\u003c()\u003e {\n        info!(\"Checking/creating database tables\");\n        \n        // Try to create TimescaleDB extension if available\n        let _timescaledb_available = match sqlx::query(\"CREATE EXTENSION IF NOT EXISTS timescaledb CASCADE\")\n            .execute(\u0026self.pool)\n            .await {\n                Ok(_) =\u003e {\n                    info!(\"‚úÖ TimescaleDB extension created/available\");\n                    true\n                },\n                Err(e) =\u003e {\n                    warn!(\"‚ö†Ô∏è  TimescaleDB not available, using standard PostgreSQL: {}\", e);\n                    false\n                }\n            };\n        \n        // Create sensors table\n        sqlx::query(\n            r#\"\n            CREATE TABLE IF NOT EXISTS sensors (\n                id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n                sensor_id VARCHAR(255) UNIQUE NOT NULL,\n                location VARCHAR(255),\n                created_at TIMESTAMPTZ DEFAULT NOW(),\n                updated_at TIMESTAMPTZ DEFAULT NOW()\n            )\n            \"#\n        )\n        .execute(\u0026self.pool)\n        .await\n        .context(\"Unable to create sensors table\")?;\n        \n        // Create temperature readings table\n        sqlx::query(\n            r#\"\n            CREATE TABLE IF NOT EXISTS temperature_readings (\n                id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n                sensor_id VARCHAR(255) NOT NULL,\n                timestamp TIMESTAMPTZ NOT NULL,\n                temperature DOUBLE PRECISION NOT NULL,\n                humidity DOUBLE PRECISION,\n                location VARCHAR(255),\n                processed_at TIMESTAMPTZ DEFAULT NOW(),\n                FOREIGN KEY (sensor_id) REFERENCES sensors(sensor_id) ON DELETE CASCADE\n            )\n            \"#\n        )\n        .execute(\u0026self.pool)\n        .await\n        .context(\"Unable to create temperature_readings table\")?;\n        \n        // Create TimescaleDB hypertable for temperature readings\n        let _result = sqlx::query(\n            \"SELECT create_hypertable('temperature_readings', 'timestamp', if_not_exists =\u003e TRUE)\"\n        )\n        .execute(\u0026self.pool)\n        .await;\n        // Ignore error if hypertable already exists\n        \n        // Create indexes to optimize queries\n        sqlx::query(\n            \"CREATE INDEX IF NOT EXISTS idx_temp_readings_sensor_time ON temperature_readings (sensor_id, timestamp DESC)\"\n        )\n        .execute(\u0026self.pool)\n        .await\n        .context(\"Unable to create index sur sensor_id et timestamp\")?;\n        \n        sqlx::query(\n            \"CREATE INDEX IF NOT EXISTS idx_temp_readings_timestamp ON temperature_readings (timestamp DESC)\"\n        )\n        .execute(\u0026self.pool)\n        .await\n        .context(\"Unable to create index sur timestamp\")?;\n        \n        // Create pool_readings table for Blue Riot pool monitoring\n        sqlx::query(\n            r#\"\n            CREATE TABLE IF NOT EXISTS pool_readings (\n                id SERIAL,\n                timestamp TIMESTAMPTZ NOT NULL,\n                temperature NUMERIC(5,2),\n                ph NUMERIC(4,2),\n                orp INTEGER,\n                email_id VARCHAR(255),\n                created_at TIMESTAMPTZ DEFAULT NOW(),\n                PRIMARY KEY (id, timestamp)\n            )\n            \"#\n        )\n        .execute(\u0026self.pool)\n        .await\n        .context(\"Unable to create pool_readings table\")?;\n        \n        // Create TimescaleDB hypertable for pool readings\n        let _result = sqlx::query(\n            \"SELECT create_hypertable('pool_readings', 'timestamp', if_not_exists =\u003e TRUE)\"\n        )\n        .execute(\u0026self.pool)\n        .await;\n        // Ignore error if hypertable already exists\n        \n        // Create indexes for pool readings\n        sqlx::query(\n            \"CREATE INDEX IF NOT EXISTS idx_pool_readings_timestamp ON pool_readings (timestamp DESC)\"\n        )\n        .execute(\u0026self.pool)\n        .await\n        .context(\"Unable to create index on pool_readings timestamp\")?;\n        \n        sqlx::query(\n            \"CREATE INDEX IF NOT EXISTS idx_pool_readings_email ON pool_readings (email_id)\"\n        )\n        .execute(\u0026self.pool)\n        .await\n        .context(\"Unable to create index on pool_readings email_id\")?;\n        \n        info!(\"Database tables checked/created successfully\");\n        Ok(())\n    }\n    \n    pub async fn save_temperature_readings(\u0026self, readings: \u0026[TemperatureReading]) -\u003e Result\u003cusize\u003e {\n        if readings.is_empty() {\n            return Ok(0);\n        }\n        \n        info!(\"Saving {} temperature readings\", readings.len());\n        \n        let mut transaction = self.pool.begin()\n            .await\n            .context(\"Unable to start transaction\")?;\n        \n        let mut saved_count = 0;\n        \n        for reading in readings {\n            // First, make sure the sensor exists\n            self.ensure_sensor_exists(\u0026mut transaction, \u0026reading.sensor_id, \u0026reading.location).await?;\n            \n            // Check if this reading already exists (avoid duplicates)\n            let exists = sqlx::query(\n                \"SELECT 1 FROM temperature_readings WHERE sensor_id = $1 AND timestamp = $2\"\n            )\n            .bind(\u0026reading.sensor_id)\n            .bind(reading.timestamp)\n            .fetch_optional(\u0026mut *transaction)\n            .await\n            .context(\"Error checking for duplicates\")?;\n            \n            if exists.is_some() {\n                saved_count += 1; // We count duplicates as \"saved\" to reflect total processed\n                debug!(\"Existing reading skipped: {} √† {}\", reading.sensor_id, reading.timestamp);\n                continue;\n            }\n            \n            // Insert new reading\n            sqlx::query(\n                r#\"\n                INSERT INTO temperature_readings \n                (sensor_id, timestamp, temperature, humidity, location)\n                VALUES ($1, $2, $3, $4, $5)\n                \"#\n            )\n            .bind(\u0026reading.sensor_id)\n            .bind(reading.timestamp)\n            .bind(reading.temperature)\n            .bind(reading.humidity)\n            .bind(\u0026reading.location)\n            .execute(\u0026mut *transaction)\n            .await\n            .context(\"Error inserting temperature reading\")?;\n            \n            saved_count += 1;\n            \n            debug!(\"Reading saved: {} = {}¬∞C √† {}\", \n                   reading.sensor_id, reading.temperature, reading.timestamp);\n        }\n        \n        transaction.commit()\n            .await\n            .context(\"Error committing transaction\")?;\n        \n        info!(\"Save completed: {} new readings out of {} processed\", saved_count, readings.len());\n        Ok(saved_count)\n    }\n    \n    async fn ensure_sensor_exists(\n        \u0026self, \n        transaction: \u0026mut sqlx::Transaction\u003c'_, sqlx::Postgres\u003e,\n        sensor_id: \u0026str,\n        location: \u0026Option\u003cString\u003e\n    ) -\u003e Result\u003c()\u003e {\n        let exists = sqlx::query(\"SELECT 1 FROM sensors WHERE sensor_id = $1\")\n            .bind(sensor_id)\n            .fetch_optional(\u0026mut **transaction)\n            .await\n            .context(\"Error checking sensor existence\")?;\n        \n        if exists.is_none() {\n            sqlx::query(\n                \"INSERT INTO sensors (sensor_id, location) VALUES ($1, $2)\"\n            )\n            .bind(sensor_id)\n            .bind(location)\n            .execute(\u0026mut **transaction)\n            .await\n            .context(\"Error inserting sensor\")?;\n            \n            debug!(\"New sensor created: {}\", sensor_id);\n        } else if let Some(loc) = location {\n            // Update location if provided\n            sqlx::query(\n                \"UPDATE sensors SET location = $2, updated_at = NOW() WHERE sensor_id = $1 AND location IS NULL\"\n            )\n            .bind(sensor_id)\n            .bind(loc)\n            .execute(\u0026mut **transaction)\n            .await\n            .context(\"Error updating sensor location\")?;\n        }\n        \n        Ok(())\n    }\n    \n    /// Save a pool reading to the database\n    pub async fn save_pool_reading(\u0026self, reading: \u0026PoolReading, email_id: \u0026str) -\u003e Result\u003c()\u003e {\n        debug!(\"Saving pool reading: temp={:?}¬∞C, pH={:?}, ORP={:?} mV\", \n               reading.temperature, reading.ph, reading.orp);\n        \n        // Check if this reading already exists (by email_id)\n        let exists = sqlx::query_scalar::\u003c_, bool\u003e(\n            \"SELECT EXISTS(SELECT 1 FROM pool_readings WHERE email_id = $1)\"\n        )\n        .bind(email_id)\n        .fetch_one(\u0026self.pool)\n        .await\n        .context(\"Failed to check for duplicate pool reading\")?;\n        \n        if exists {\n            info!(\"Pool reading from email {} already exists, skipping\", email_id);\n            return Ok(());\n        }\n        \n        sqlx::query(\n            r#\"\n            INSERT INTO pool_readings (timestamp, temperature, ph, orp, email_id)\n            VALUES ($1, $2, $3, $4, $5)\n            \"#\n        )\n        .bind(reading.timestamp)\n        .bind(reading.temperature)\n        .bind(reading.ph)\n        .bind(reading.orp)\n        .bind(email_id)\n        .execute(\u0026self.pool)\n        .await\n        .context(\"Failed to insert pool reading\")?;\n        \n        info!(\"‚úÖ Pool reading saved: temp={:?}¬∞C, pH={:?}, ORP={:?} mV\", \n              reading.temperature, reading.ph, reading.orp);\n        \n        Ok(())\n    }\n    \n}","traces":[{"line":13,"address":[33171136,33171161],"length":1,"stats":{"Line":0}},{"line":14,"address":[8257503,8257216,8259364,8257292,8258324,8257439],"length":1,"stats":{"Line":0}},{"line":15,"address":[6073901,6073698,6073861],"length":1,"stats":{"Line":0}},{"line":17,"address":[6074142,6073875],"length":1,"stats":{"Line":0}},{"line":22,"address":[8258114,8258518,8258589,8258217,8259314,8258723,8258263],"length":1,"stats":{"Line":0}},{"line":23,"address":[8265854,8265740,8265797,8264973,8266070],"length":1,"stats":{"Line":0}},{"line":26,"address":[8258790,8258953,8258881],"length":1,"stats":{"Line":0}},{"line":28,"address":[5298323],"length":1,"stats":{"Line":0}},{"line":31,"address":[8266423,8264994,8267339,8266723,8266874],"length":1,"stats":{"Line":0}},{"line":33,"address":[8267199],"length":1,"stats":{"Line":0}},{"line":36,"address":[8260075,8259904,8260761,8261992,8259950,8260307],"length":1,"stats":{"Line":0}},{"line":37,"address":[6076625,6076251,6076585],"length":1,"stats":{"Line":0}},{"line":40,"address":[8268204,8268530,8268150,8267871,8268459],"length":1,"stats":{"Line":0}},{"line":41,"address":[5300026],"length":1,"stats":{"Line":0}},{"line":42,"address":[5408833],"length":1,"stats":{"Line":0}},{"line":44,"address":[8268734,8268663],"length":1,"stats":{"Line":0}},{"line":45,"address":[8268721],"length":1,"stats":{"Line":0}},{"line":47,"address":[8268567],"length":1,"stats":{"Line":0}},{"line":48,"address":[5300916,5300479,5300949],"length":1,"stats":{"Line":0}},{"line":49,"address":[8269058],"length":1,"stats":{"Line":0}},{"line":65,"address":[6078061],"length":1,"stats":{"Line":0}},{"line":66,"address":[5408856],"length":1,"stats":{"Line":0}},{"line":84,"address":[8269969],"length":1,"stats":{"Line":0}},{"line":85,"address":[6697847],"length":1,"stats":{"Line":0}},{"line":92,"address":[5302431],"length":1,"stats":{"Line":0}},{"line":93,"address":[5421126],"length":1,"stats":{"Line":0}},{"line":100,"address":[5302917],"length":1,"stats":{"Line":0}},{"line":101,"address":[5408925],"length":1,"stats":{"Line":0}},{"line":107,"address":[6080307],"length":1,"stats":{"Line":0}},{"line":108,"address":[6697904],"length":1,"stats":{"Line":0}},{"line":126,"address":[6080907],"length":1,"stats":{"Line":0}},{"line":127,"address":[5421195],"length":1,"stats":{"Line":0}},{"line":134,"address":[6081486],"length":1,"stats":{"Line":0}},{"line":135,"address":[5421218],"length":1,"stats":{"Line":0}},{"line":142,"address":[8273511],"length":1,"stats":{"Line":0}},{"line":143,"address":[8260273,8266046,8266103,8266344,8266131],"length":1,"stats":{"Line":0}},{"line":149,"address":[8266568],"length":1,"stats":{"Line":0}},{"line":150,"address":[9094732],"length":1,"stats":{"Line":0}},{"line":153,"address":[8267227,8267137],"length":1,"stats":{"Line":0}},{"line":154,"address":[8274693],"length":1,"stats":{"Line":0}},{"line":157,"address":[7154434,7154416],"length":1,"stats":{"Line":0}},{"line":158,"address":[6083637,6083860],"length":1,"stats":{"Line":0}},{"line":159,"address":[6083911],"length":1,"stats":{"Line":0}},{"line":162,"address":[8275551,8275594,8275470],"length":1,"stats":{"Line":0}},{"line":164,"address":[8276468,8275970,8276358,8276815,8276330,8275557],"length":1,"stats":{"Line":0}},{"line":165,"address":[8267806,8268633,8268499,8268439,8268828],"length":1,"stats":{"Line":0}},{"line":168,"address":[8269104],"length":1,"stats":{"Line":0}},{"line":170,"address":[8278044,8276762,8276627,8276740],"length":1,"stats":{"Line":0}},{"line":172,"address":[8269353,8273503,8270879,8270602,8267827,8270982],"length":1,"stats":{"Line":0}},{"line":178,"address":[8271416],"length":1,"stats":{"Line":0}},{"line":179,"address":[6087262,6087330],"length":1,"stats":{"Line":0}},{"line":180,"address":[8271542,8271381,8271653,8273455,8271569],"length":1,"stats":{"Line":0}},{"line":181,"address":[5407989],"length":1,"stats":{"Line":0}},{"line":184,"address":[8272322],"length":1,"stats":{"Line":0}},{"line":185,"address":[8272393,8272952,8273009],"length":1,"stats":{"Line":0}},{"line":186,"address":[5311942,5311875,5311977],"length":1,"stats":{"Line":0}},{"line":198,"address":[5311396],"length":1,"stats":{"Line":0}},{"line":199,"address":[8280018],"length":1,"stats":{"Line":0}},{"line":200,"address":[8272586],"length":1,"stats":{"Line":0}},{"line":201,"address":[5311549],"length":1,"stats":{"Line":0}},{"line":202,"address":[8280233,8280187],"length":1,"stats":{"Line":0}},{"line":203,"address":[8272737,8272761,8272842,8272433,8272915],"length":1,"stats":{"Line":0}},{"line":204,"address":[5408015],"length":1,"stats":{"Line":0}},{"line":207,"address":[6085903,6085801],"length":1,"stats":{"Line":0}},{"line":209,"address":[6085858,6085965,6085930],"length":1,"stats":{"Line":0}},{"line":213,"address":[8273756,8270670,8273830,8274432,8270777,8273947],"length":1,"stats":{"Line":0}},{"line":214,"address":[6697005],"length":1,"stats":{"Line":0}},{"line":217,"address":[8274085,8273978],"length":1,"stats":{"Line":0}},{"line":218,"address":[6089754],"length":1,"stats":{"Line":0}},{"line":221,"address":[5158432],"length":1,"stats":{"Line":0}},{"line":227,"address":[6091103,6090419,6090813,6092507,6091316,6090586,6090701,6091205],"length":1,"stats":{"Line":0}},{"line":228,"address":[6090570,6090613],"length":1,"stats":{"Line":0}},{"line":229,"address":[8282528,8282444,8282327,8282413,8282680],"length":1,"stats":{"Line":0}},{"line":230,"address":[5313648,5314014,5313924,5314105,5314351],"length":1,"stats":{"Line":0}},{"line":233,"address":[8275901,8275816],"length":1,"stats":{"Line":0}},{"line":237,"address":[8283996],"length":1,"stats":{"Line":0}},{"line":238,"address":[8284039,8284078],"length":1,"stats":{"Line":0}},{"line":239,"address":[8276799,8276582,8276697,8276457,8276613],"length":1,"stats":{"Line":0}},{"line":240,"address":[5417784],"length":1,"stats":{"Line":0}},{"line":243,"address":[8277329],"length":1,"stats":{"Line":0}},{"line":244,"address":[6091663,6091583,6093755],"length":1,"stats":{"Line":0}},{"line":249,"address":[6091795],"length":1,"stats":{"Line":0}},{"line":250,"address":[6091869],"length":1,"stats":{"Line":0}},{"line":251,"address":[8276320,8276236,8276084,8276205,8276425],"length":1,"stats":{"Line":0}},{"line":252,"address":[8274810,8276328,8277918,8277696,8276388],"length":1,"stats":{"Line":0}},{"line":256,"address":[8276046],"length":1,"stats":{"Line":0}},{"line":260,"address":[6093985,6094675,6095870,6093823,6094049,6093792],"length":1,"stats":{"Line":0}},{"line":261,"address":[6094143,6094103,6093940],"length":1,"stats":{"Line":0}},{"line":268,"address":[8286389],"length":1,"stats":{"Line":0}},{"line":269,"address":[8278928],"length":1,"stats":{"Line":0}},{"line":270,"address":[8286528,8285871,8286585,8286471,8286801],"length":1,"stats":{"Line":0}},{"line":273,"address":[5318231],"length":1,"stats":{"Line":0}},{"line":274,"address":[8287434,8287006,8287457],"length":1,"stats":{"Line":0}},{"line":275,"address":[6095504],"length":1,"stats":{"Line":0}},{"line":284,"address":[8287051],"length":1,"stats":{"Line":0}},{"line":285,"address":[5318376],"length":1,"stats":{"Line":0}},{"line":286,"address":[8287167],"length":1,"stats":{"Line":0}},{"line":287,"address":[5318463],"length":1,"stats":{"Line":0}},{"line":288,"address":[8279756],"length":1,"stats":{"Line":0}},{"line":289,"address":[6095379],"length":1,"stats":{"Line":0}},{"line":290,"address":[5403106],"length":1,"stats":{"Line":0}},{"line":293,"address":[8280783,8280714],"length":1,"stats":{"Line":0}},{"line":296,"address":[8280766],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":103},{"path":["/","workspaces","homemetrics","src","email","mod.rs"],"content":"pub mod processor_base;\n\n// Re-export commonly used items\npub use processor_base::{EmailProcessingStrategy, BaseEmailProcessor};\n","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","homemetrics","src","email","processor_base.rs"],"content":"use anyhow::{Result, Context};\nuse log::{info, error, warn};\n\nuse crate::config::Config;\nuse crate::gmail_client::GmailClient;\nuse crate::database::Database;\nuse crate::slack_notifier::SlackNotifier;\n\n/// Trait that defines the specific processing logic for each email type\npub trait EmailProcessingStrategy: Send {\n    /// Search for emails to process (returns message IDs)\n    fn search_emails\u003c'a, 'b: 'a\u003e(\u0026'a self, gmail: \u0026'b GmailClient) -\u003e \n        std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003cVec\u003cString\u003e\u003e\u003e + Send + 'a\u003e\u003e;\n    \n    /// Process a single email and return the number of records processed\n    fn process_single_email\u003c'a, 'b: 'a, 'c: 'a\u003e(\n        \u0026'a self,\n        gmail: \u0026'b GmailClient,\n        database: Option\u003c\u0026'c Database\u003e,\n        slack: Option\u003c\u0026'c SlackNotifier\u003e,\n        message_id: \u0026'a str,\n        is_dry_run: bool,\n    ) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003cusize\u003e\u003e + Send + 'a\u003e\u003e;\n    \n    /// Mark email as processed (labels, archive, etc.)\n    fn mark_email_processed\u003c'a, 'b: 'a\u003e(\n        \u0026'a self,\n        gmail: \u0026'b GmailClient,\n        message_id: \u0026'a str,\n    ) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003c()\u003e\u003e + Send + 'a\u003e\u003e;\n    \n    /// Get the name of this processor (for logging)\n    fn processor_name(\u0026self) -\u003e \u0026str;\n    \n    /// Get the label name (for logging)\n    fn label_name(\u0026self) -\u003e \u0026str;\n}\n\n/// Base email processor that handles common logic\npub struct BaseEmailProcessor\u003cS: EmailProcessingStrategy\u003e {\n    config: Config,\n    database: Option\u003cDatabase\u003e,\n    slack: Option\u003cSlackNotifier\u003e,\n    strategy: S,\n}\n\nimpl\u003cS: EmailProcessingStrategy\u003e BaseEmailProcessor\u003cS\u003e {\n    pub async fn new(config: Config, strategy: S) -\u003e Result\u003cSelf\u003e {\n        info!(\"Initializing {} email processor\", strategy.processor_name());\n        \n        // Initialize database connection\n        let database = Database::new(\u0026config.database).await\n            .context(\"Unable to initialize database\")?;\n        \n        // Initialize Slack notifier if configured\n        let slack = if let Some(slack_config) = \u0026config.slack {\n            match SlackNotifier::new(slack_config) {\n                Ok(notifier) =\u003e {\n                    info!(\"‚úÖ Slack notifications enabled\");\n                    Some(notifier)\n                },\n                Err(e) =\u003e {\n                    warn!(\"‚ö†Ô∏è  Unable to initialize Slack notifier: {} - notifications disabled\", e);\n                    None\n                }\n            }\n        } else {\n            info!(\"‚ÑπÔ∏è  Slack notifications not configured\");\n            None\n        };\n        \n        Ok(BaseEmailProcessor {\n            config,\n            database: Some(database),\n            slack,\n            strategy,\n        })\n    }\n    \n    pub fn new_dry_run(config: Config, strategy: S) -\u003e Result\u003cSelf\u003e {\n        info!(\"üß™ Initializing {} email processor in dry-run mode (without database)\", strategy.processor_name());\n        \n        Ok(BaseEmailProcessor {\n            config,\n            database: None,\n            slack: None,  // No Slack notifications in dry-run mode\n            strategy,\n        })\n    }\n    \n    pub async fn process_emails(\u0026self, limit: Option\u003cusize\u003e) -\u003e Result\u003cusize\u003e {\n        info!(\"Starting {} email processing\", self.strategy.processor_name());\n        self.process_emails_common(limit, false).await\n    }\n    \n    pub async fn process_emails_dry_run(\u0026self, limit: Option\u003cusize\u003e) -\u003e Result\u003cusize\u003e {\n        println!(\"\\n{}\", \"=\".repeat(80));\n        println!(\"üß™ MODE DRY-RUN - {} ANALYSIS\", self.strategy.processor_name().to_uppercase());\n        println!(\"{}\", \"=\".repeat(80));\n        \n        self.process_emails_common(limit, true).await\n    }\n    \n    /// Common processing logic for both normal and dry-run modes\n    async fn process_emails_common(\u0026self, limit: Option\u003cusize\u003e, is_dry_run: bool) -\u003e Result\u003cusize\u003e {\n        // 1. Connect to Gmail API\n        let gmail_client = GmailClient::new(\u0026self.config.gmail).await\n            .context(\"Unable to connect to Gmail API\")?;\n        \n        // 2. Search for emails using strategy\n        let message_ids = self.strategy.search_emails(\u0026gmail_client).await\n            .context(\"Error searching for emails\")?;\n        \n        if message_ids.is_empty() {\n            if is_dry_run {\n                println!(\"‚ùå No emails found with label '{}'\", self.strategy.label_name());\n                println!(\"   Hint: Add the label '{}' to emails to process\", self.strategy.label_name());\n            } else {\n                info!(\"No emails found with label '{}'\", self.strategy.label_name());\n            }\n            return Ok(0);\n        }\n        \n        if is_dry_run {\n            println!(\"‚úÖ Found {} email(s) matching criteria\\n\", message_ids.len());\n        }\n        \n        let mut total_processed = 0;\n        let mut total_records_saved = 0;\n        \n        // 3. Process each found email (with optional limit)\n        let emails_to_process = if let Some(limit) = limit {\n            message_ids.into_iter().take(limit).collect()\n        } else {\n            message_ids\n        };\n        \n        for (index, message_id) in emails_to_process.iter().enumerate() {\n            if is_dry_run {\n                println!(\"üìß Email {}/{} (ID: {})\", index + 1, emails_to_process.len(), message_id);\n                println!(\"{}\", \"-\".repeat(60));\n            }\n            \n            match self.strategy.process_single_email(\n                \u0026gmail_client,\n                self.database.as_ref(),\n                self.slack.as_ref(),\n                message_id,\n                is_dry_run\n            ).await {\n                Ok(records_count) =\u003e {\n                    total_processed += 1;\n                    \n                    if records_count == 0 {\n                        // Special case: email skipped (no data extracted)\n                        if is_dry_run {\n                            println!(\"‚ö†Ô∏è  Email {} analyzed but no data extracted\\n\", message_id);\n                        } else {\n                            warn!(\"Email {} processed but no data extracted\", message_id);\n                        }\n                        continue; // Skip marking as processed if no data\n                    }\n                    \n                    total_records_saved += records_count;\n                    \n                    // Mark email as processed (unless dry-run)\n                    if !is_dry_run {\n                        if let Err(e) = self.strategy.mark_email_processed(\u0026gmail_client, message_id).await {\n                            error!(\"Failed to mark email {} as processed: {}\", message_id, e);\n                        }\n                    }\n                    \n                    if is_dry_run {\n                        println!(\"‚úÖ Email {} analyzed successfully ({} record(s))\\n\", message_id, records_count);\n                    } else {\n                        info!(\"Email {} processed successfully: {} record(s) saved\", message_id, records_count);\n                    }\n                }\n                Err(e) =\u003e {\n                    if is_dry_run {\n                        println!(\"‚ùå Error analyzing email {}: {}\\n\", message_id, e);\n                    } else {\n                        error!(\"Error processing email {}: {}\", message_id, e);\n                        \n                        // Send error notification to Slack\n                        if let Some(slack) = \u0026self.slack {\n                            let _ = slack.send_message(\u0026format!(\n                                \"‚ùå Error processing {} email {}: {}\",\n                                self.strategy.processor_name(),\n                                message_id,\n                                e\n                            )).await;\n                        }\n                    }\n                }\n            }\n        }\n        \n        if is_dry_run {\n            println!(\"{}\", \"=\".repeat(80));\n            println!(\"üèÅ Analysis completed: {} emails analyzed out of {}\", total_processed, emails_to_process.len());\n            println!(\"üìä Total records: {}\", total_records_saved);\n            println!(\"{}\", \"=\".repeat(80));\n        } else {\n            info!(\"Processing completed: {} emails processed, {} records saved\", \n                  total_processed, total_records_saved);\n        }\n        \n        Ok(total_processed)\n    }\n}\n","traces":[{"line":48,"address":[8617180,8611610,8611280,8611344,8614320,8613539,8614412,8616483,8611328,8614554,8611468,8611296,8615126,8612182,8614236,8611376],"length":1,"stats":{"Line":0}},{"line":49,"address":[8592493,8595437,8592658,8595559,8592615,8595602],"length":1,"stats":{"Line":0}},{"line":52,"address":[6505020,6501192,6504072,6501245,6501648,6504528,6502140,6501744,6504624,6504125],"length":1,"stats":{"Line":0}},{"line":56,"address":[5857805,5860685,5861925,5859045],"length":1,"stats":{"Line":0}},{"line":57,"address":[8596734,8596626,8593682,8593790],"length":1,"stats":{"Line":0}},{"line":58,"address":[5858108,5860988],"length":1,"stats":{"Line":0}},{"line":59,"address":[8594008,8594071,8593918,8597015,8596862,8596952],"length":1,"stats":{"Line":0}},{"line":60,"address":[8616030,8613086],"length":1,"stats":{"Line":0}},{"line":62,"address":[8615843,8612899],"length":1,"stats":{"Line":0}},{"line":63,"address":[8616537,8613639,8616583,8613593,8612915,8615859],"length":1,"stats":{"Line":0}},{"line":64,"address":[8613609,8616553],"length":1,"stats":{"Line":0}},{"line":68,"address":[8613938,8612773,8616853,8613909,8616882,8615717],"length":1,"stats":{"Line":0}},{"line":69,"address":[6506291,6503411],"length":1,"stats":{"Line":0}},{"line":72,"address":[6505813,6502933],"length":1,"stats":{"Line":0}},{"line":73,"address":[5858474,5861354],"length":1,"stats":{"Line":0}},{"line":74,"address":[8597263,8594319],"length":1,"stats":{"Line":0}},{"line":75,"address":[8597279,8594335],"length":1,"stats":{"Line":0}},{"line":76,"address":[],"length":0,"stats":{"Line":0}},{"line":80,"address":[5862876,5863468,5862304,5862896],"length":1,"stats":{"Line":0}},{"line":81,"address":[8617894,8617541,8617367,8617975,8617286,8618149],"length":1,"stats":{"Line":0}},{"line":83,"address":[6506850,6507442],"length":1,"stats":{"Line":0}},{"line":84,"address":[5862418,5863010],"length":1,"stats":{"Line":0}},{"line":85,"address":[5863028,5862436],"length":1,"stats":{"Line":0}},{"line":86,"address":[5863040,5862448],"length":1,"stats":{"Line":0}},{"line":87,"address":[],"length":0,"stats":{"Line":0}},{"line":91,"address":[6508700,6509238,6507872,6510103,6507996,6509040,6509068,6507890,6507938,6508166,6508206,6509031,6507968,6507920,6509278,6509772],"length":1,"stats":{"Line":0}},{"line":92,"address":[6509196,6509332,6509374,6508124,6508302,6508260],"length":1,"stats":{"Line":0}},{"line":93,"address":[5455399,5454391],"length":1,"stats":{"Line":0}},{"line":96,"address":[5865746,5866704,5865946,5865986,5865728,5865776,5865801],"length":1,"stats":{"Line":0}},{"line":97,"address":[8621089,8620970],"length":1,"stats":{"Line":0}},{"line":98,"address":[8602178],"length":1,"stats":{"Line":0}},{"line":99,"address":[8602394],"length":1,"stats":{"Line":0}},{"line":101,"address":[8621672,8621029,8621808],"length":1,"stats":{"Line":0}},{"line":105,"address":[5867200,5877637,5877501,5868481,5867008,5867565,5867701,5867104,5867165,5867438,5867261,5877374,5877197,5878417,5877136,5867069],"length":1,"stats":{"Line":0}},{"line":107,"address":[8632971,8633302,8623158,8632640,8632851,8622496,8622827,8632704,8622707,8633678,8622560,8623534],"length":1,"stats":{"Line":0}},{"line":111,"address":[5870706,5877425,5878423,5868818,5878754,5868487,5868284,5878099,5880642,5878220,5867489,5868163],"length":1,"stats":{"Line":0}},{"line":114,"address":[8615172,8605028,8605116,8615260],"length":1,"stats":{"Line":0}},{"line":115,"address":[8605141,8615285],"length":1,"stats":{"Line":0}},{"line":116,"address":[8635194,8625546,8625050,8635690],"length":1,"stats":{"Line":0}},{"line":117,"address":[6524798,6514862],"length":1,"stats":{"Line":0}},{"line":119,"address":[5869833,5879925,5879866,5869989,5869930,5879769],"length":1,"stats":{"Line":0}},{"line":121,"address":[8616184,8606040],"length":1,"stats":{"Line":0}},{"line":124,"address":[8615266,8605122],"length":1,"stats":{"Line":0}},{"line":125,"address":[8624304,8634448],"length":1,"stats":{"Line":0}},{"line":128,"address":[8624239,8634383],"length":1,"stats":{"Line":0}},{"line":129,"address":[8634402,8624258],"length":1,"stats":{"Line":0}},{"line":132,"address":[8605205,8615349,8615527,8605564,8605383,8615708],"length":1,"stats":{"Line":0}},{"line":133,"address":[8624646,8624483,8634790,8634627],"length":1,"stats":{"Line":0}},{"line":135,"address":[8634707,8624563],"length":1,"stats":{"Line":0}},{"line":138,"address":[6525554,6514172,6523966,6524108,6523857,6513921,6514030,6515618],"length":1,"stats":{"Line":0}},{"line":139,"address":[6515712,6525648],"length":1,"stats":{"Line":0}},{"line":140,"address":[6526956,6517020],"length":1,"stats":{"Line":0}},{"line":141,"address":[8638296,8628152],"length":1,"stats":{"Line":0}},{"line":144,"address":[8618853,8609414,8608709,8609506,8619962,8609818,8619650,8609738,8619882,8619558],"length":1,"stats":{"Line":0}},{"line":145,"address":[6516975,6526911],"length":1,"stats":{"Line":0}},{"line":146,"address":[8618895,8608751],"length":1,"stats":{"Line":0}},{"line":147,"address":[5873122,5883058],"length":1,"stats":{"Line":0}},{"line":148,"address":[8609312,8619456],"length":1,"stats":{"Line":0}},{"line":149,"address":[6527562,6517626],"length":1,"stats":{"Line":0}},{"line":150,"address":[6733434,6731898],"length":1,"stats":{"Line":0}},{"line":151,"address":[8639111,8628967],"length":1,"stats":{"Line":0}},{"line":152,"address":[8639141,8639218,8629074,8628997],"length":1,"stats":{"Line":0}},{"line":154,"address":[5873806,5883742],"length":1,"stats":{"Line":0}},{"line":156,"address":[5883783,5873847],"length":1,"stats":{"Line":0}},{"line":157,"address":[8629560,8629213,8639704,8639357],"length":1,"stats":{"Line":0}},{"line":159,"address":[8620329,8610096,8610185,8620240],"length":1,"stats":{"Line":0}},{"line":164,"address":[6528748,6518778,6518250,6528186,6528714,6518812],"length":1,"stats":{"Line":0}},{"line":167,"address":[6518793,6519895,6529831,6528729],"length":1,"stats":{"Line":0}},{"line":168,"address":[8636093,8640003,8622623,8625949,8632767,8629972,8629697,8639841,8640116,8629859],"length":1,"stats":{"Line":0}},{"line":169,"address":[8630437,8640420,8640581,8630276,8640556,8630412],"length":1,"stats":{"Line":0}},{"line":173,"address":[8629766,8639910],"length":1,"stats":{"Line":0}},{"line":174,"address":[5885889,5875953,5875577,5885513],"length":1,"stats":{"Line":0}},{"line":176,"address":[8630807,8640951,8630890,8641034],"length":1,"stats":{"Line":0}},{"line":179,"address":[8639055,8628911],"length":1,"stats":{"Line":0}},{"line":180,"address":[6528013,6518077],"length":1,"stats":{"Line":0}},{"line":181,"address":[8612319,8613207,8623351,8622463],"length":1,"stats":{"Line":0}},{"line":183,"address":[5876237,5886013,5876160,5876077,5886096,5886173],"length":1,"stats":{"Line":0}},{"line":186,"address":[5886102,5876564,5886500,5876166],"length":1,"stats":{"Line":0}},{"line":187,"address":[8636355,8631914,8642058,8642385,8626211,8632241],"length":1,"stats":{"Line":0}},{"line":188,"address":[],"length":0,"stats":{"Line":0}},{"line":189,"address":[5876572,5886508],"length":1,"stats":{"Line":0}},{"line":190,"address":[],"length":0,"stats":{"Line":0}},{"line":191,"address":[],"length":0,"stats":{"Line":0}},{"line":192,"address":[5870790,5871049,5886918,5876942,5880985,5871027,5867552,5880963,5870820,5880726,5886878,5876982,5877488,5880756],"length":1,"stats":{"Line":0}},{"line":199,"address":[8607498,8617642],"length":1,"stats":{"Line":0}},{"line":200,"address":[5881808,5881352,5871416,5871872],"length":1,"stats":{"Line":0}},{"line":201,"address":[5881967,5872031],"length":1,"stats":{"Line":0}},{"line":202,"address":[5872227,5882163],"length":1,"stats":{"Line":0}},{"line":203,"address":[8637690,8627546],"length":1,"stats":{"Line":0}},{"line":205,"address":[8607672,8607602,8617746,8607515,8617816,8617659],"length":1,"stats":{"Line":0}},{"line":206,"address":[],"length":0,"stats":{"Line":0}},{"line":209,"address":[8617752,8607608],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":92},{"path":["/","workspaces","homemetrics","src","gmail_client.rs"],"content":"use anyhow::{Result, Context};\nuse google_gmail1::{Gmail, hyper, hyper_rustls, oauth2};\nuse log::{info, debug, warn};\n\nuse crate::config::GmailConfig;\n\npub struct EmailInfo {\n    pub content: Vec\u003cu8\u003e,\n    pub date: chrono::DateTime\u003cchrono::Utc\u003e,\n    pub headers: String,\n}\n\npub struct GmailClient {\n    hub: Gmail\u003chyper_rustls::HttpsConnector\u003chyper::client::HttpConnector\u003e\u003e,\n}\n\nimpl GmailClient {\n    pub async fn new(config: \u0026GmailConfig) -\u003e Result\u003cSelf\u003e {\n        info!(\"Connecting to Gmail API via OAuth2\");\n        \n        // Read OAuth2 client credentials from file\n        let secret = oauth2::read_application_secret(\u0026config.credentials_path)\n            .await\n            .context(\"Unable to read OAuth2 client credentials file\")?;\n        \n        // Create authenticator with token persistence\n        // Note: We use Scope::Modify on all API calls, which is the broadest scope available\n        // in google-gmail1 (covers reading, modifying labels, and managing emails)\n        let auth = oauth2::InstalledFlowAuthenticator::builder(\n            secret,\n            oauth2::InstalledFlowReturnMethod::HTTPRedirect,\n        )\n        .persist_tokens_to_disk(\u0026config.token_cache_path)\n        .build()\n        .await\n        .context(\"Unable to create OAuth2 authenticator\")?;\n        \n        // Create HTTP client\n        let connector = hyper_rustls::HttpsConnectorBuilder::new()\n            .with_native_roots()?\n            .https_or_http()\n            .enable_http1()\n            .build();\n        \n        let client = hyper::Client::builder().build(connector);\n        \n        // Create Gmail hub with appropriate scopes\n        let hub = Gmail::new(client, auth);\n        \n        info!(\"‚úÖ Gmail API connection established successfully\");\n        \n        Ok(GmailClient { hub })\n    }\n    \n    pub async fn search_xsense_emails(\u0026self) -\u003e Result\u003cVec\u003cString\u003e\u003e {\n        info!(\"Searching for emails with label 'homemetrics/todo/xsense'\");\n        \n        let user_id = \"me\";\n        let query = \"label:homemetrics/todo/xsense\";\n        \n        debug!(\"Search criteria: {}\", query);\n        \n        let result = self.hub\n            .users()\n            .messages_list(user_id)\n            .q(query)\n            .add_scope(google_gmail1::api::Scope::Modify)\n            .doit()\n            .await\n            .context(\"Error searching for emails\")?;\n        \n        let message_ids: Vec\u003cString\u003e = result.1\n            .messages\n            .unwrap_or_default()\n            .into_iter()\n            .filter_map(|msg| msg.id)\n            .collect();\n        \n        info!(\"Found {} email(s) with label 'homemetrics/todo/xsense'\", message_ids.len());\n        \n        Ok(message_ids)\n    }\n    \n    /// List all Gmail labels with their IDs and names\n    pub async fn list_labels(\u0026self) -\u003e Result\u003c()\u003e {\n        info!(\"Retrieving Gmail labels list\");\n        \n        let user_id = \"me\";\n        \n        let result = self.hub\n            .users()\n            .labels_list(user_id)\n            .add_scope(google_gmail1::api::Scope::Modify)\n            .doit()\n            .await\n            .context(\"Unable to list labels\")?;\n        \n        let labels = result.1.labels.unwrap_or_default();\n        \n        if labels.is_empty() {\n            println!(\"No labels found.\");\n            return Ok(());\n        }\n        \n        println!(\"Found {} label(s):\\n\", labels.len());\n        println!(\"{:\u003c40} {:\u003c30} {:\u003c15}\", \"Label Name\", \"Label ID\", \"Type\");\n        println!(\"{}\", \"=\".repeat(85));\n        \n        // Sort labels: homemetrics labels first, then system, then user\n        let mut sorted_labels = labels;\n        sorted_labels.sort_by(|a, b| {\n            let a_name = a.name.as_deref().unwrap_or(\"\");\n            let b_name = b.name.as_deref().unwrap_or(\"\");\n            \n            let a_is_homemetrics = a_name.starts_with(\"homemetrics\");\n            let b_is_homemetrics = b_name.starts_with(\"homemetrics\");\n            \n            match (a_is_homemetrics, b_is_homemetrics) {\n                (true, false) =\u003e std::cmp::Ordering::Less,\n                (false, true) =\u003e std::cmp::Ordering::Greater,\n                _ =\u003e a_name.cmp(b_name),\n            }\n        });\n        \n        for label in sorted_labels {\n            let name = label.name.unwrap_or_else(|| \"Unknown\".to_string());\n            let id = label.id.unwrap_or_else(|| \"Unknown\".to_string());\n            let label_type = label.type_.unwrap_or_else(|| \"Unknown\".to_string());\n            \n            // Highlight homemetrics labels\n            if name.starts_with(\"homemetrics\") {\n                println!(\"‚ú® {:\u003c38} {:\u003c30} {:\u003c15}\", name, id, label_type);\n            } else {\n                println!(\"{:\u003c40} {:\u003c30} {:\u003c15}\", name, id, label_type);\n            }\n        }\n        \n        Ok(())\n    }\n    \n    /// Retrieve only email metadata (subject and sender)\n    pub async fn fetch_email_metadata(\u0026self, message_id: \u0026str) -\u003e Result\u003c(String, String)\u003e {\n        debug!(\"Retrieving email metadata for ID: {}\", message_id);\n        \n        let user_id = \"me\";\n        \n        // Retrieve only headers with METADATA format\n        let result = self.hub\n            .users()\n            .messages_get(user_id, message_id)\n            .format(\"metadata\")\n            .add_metadata_headers(\"From\")\n            .add_metadata_headers(\"Subject\")\n            .add_scope(google_gmail1::api::Scope::Modify)\n            .doit()\n            .await\n            .context(\"Unable to retrieve email metadata\")?;\n        \n        let message = result.1;\n        \n        // Extract subject and sender from headers\n        let mut subject = String::from(\"No subject\");\n        let mut from = String::from(\"Unknown sender\");\n        \n        if let Some(payload) = message.payload {\n            if let Some(headers) = payload.headers {\n                for header in headers {\n                    if let (Some(name), Some(value)) = (header.name, header.value) {\n                        match name.as_str() {\n                            \"Subject\" =\u003e subject = value,\n                            \"From\" =\u003e from = value,\n                            _ =\u003e {}\n                        }\n                    }\n                }\n            }\n        }\n        \n        Ok((subject, from))\n    }\n    \n    pub async fn fetch_email_complete(\u0026self, message_id: \u0026str) -\u003e Result\u003cEmailInfo\u003e {\n        debug!(\"Complete email retrieval for ID: {}\", message_id);\n        \n        let user_id = \"me\";\n        \n        // Retrieve complete message with RAW format\n        let result = self.hub\n            .users()\n            .messages_get(user_id, message_id)\n            .format(\"raw\")\n            .add_scope(google_gmail1::api::Scope::Modify)\n            .doit()\n            .await;\n        \n        let message = match result {\n            Ok((_, msg)) =\u003e msg,\n            Err(e) =\u003e {\n                warn!(\"Error retrieving in RAW format: {}\", e);\n                return Err(anyhow::anyhow!(\"Unable to retrieve email: {}\", e));\n            }\n        };\n        \n        // Raw content is already decoded by Gmail API (RFC822 format)\n        let raw_content = message.raw\n            .context(\"No raw content in email\")?;\n        \n        debug!(\"Email retrieved, size: {} bytes\", raw_content.len());\n        \n        // raw_content is already the raw RFC822 content (not base64)\n        let raw_bytes = raw_content;\n        \n        debug!(\"Email retrieved, size: {} bytes\", raw_bytes.len());\n        \n        // Parser le contenu avec mail-parser\n        let email_str = String::from_utf8_lossy(\u0026raw_bytes);\n        let parsed_email = mail_parser::MessageParser::default()\n            .parse(email_str.as_bytes())\n            .context(\"Unable to parse email\")?;\n        \n        // Extraire la date\n        let email_date = if let Some(date_header) = parsed_email.date() {\n            chrono::DateTime::from_timestamp(date_header.to_timestamp(), 0)\n                .map(|dt| dt.with_timezone(\u0026chrono::Utc))\n                .unwrap_or_else(chrono::Utc::now)\n        } else {\n            warn!(\"No date in email, using current date\");\n            chrono::Utc::now()\n        };\n        \n        // Extraire les headers principaux\n        let from = parsed_email.from()\n            .and_then(|addrs| addrs.first())\n            .map(|addr| {\n                match (\u0026addr.name, \u0026addr.address) {\n                    (Some(name), Some(email)) =\u003e format!(\"{} \u003c{}\u003e\", name, email),\n                    (None, Some(email)) =\u003e email.to_string(),\n                    _ =\u003e \"Unknown sender\".to_string(),\n                }\n            })\n            .unwrap_or_else(|| \"Unknown sender\".to_string());\n        \n        let subject = parsed_email.subject()\n            .unwrap_or(\"No subject\")\n            .to_string();\n        \n        let headers = format!(\"De: {}\\nObjet: {}\", from, subject);\n        \n        Ok(EmailInfo {\n            content: raw_bytes,\n            date: email_date,\n            headers,\n        })\n    }\n    \n    pub async fn mark_email_as_processed(\u0026self, message_id: \u0026str) -\u003e Result\u003c()\u003e {\n        info!(\"Marking email {} as processed\", message_id);\n        \n        let user_id = \"me\";\n        \n        // First, retrieve existing labels to get IDs\n        let labels_result = self.hub\n            .users()\n            .labels_list(user_id)\n            .add_scope(google_gmail1::api::Scope::Modify)\n            .doit()\n            .await\n            .context(\"Unable to list labels\")?;\n        \n        let labels = labels_result.1.labels.unwrap_or_default();\n        \n        // Trouver les IDs des labels\n        let todo_label_id = labels.iter()\n            .find(|l| l.name.as_deref() == Some(\"homemetrics/todo/xsense\"))\n            .and_then(|l| l.id.clone());\n        \n        let done_label_id = labels.iter()\n            .find(|l| l.name.as_deref() == Some(\"homemetrics/done/xsense\"))\n            .and_then(|l| l.id.clone());\n        \n        // Create modification request\n        let mut modify_request = google_gmail1::api::ModifyMessageRequest::default();\n        \n        // Supprimer le label \"todo\"\n        if let Some(todo_id) = todo_label_id {\n            modify_request.remove_label_ids = Some(vec![todo_id]);\n            debug!(\"Removing label 'homemetrics/todo/xsense'\");\n        } else {\n            warn!(\"Label 'homemetrics/todo/xsense' not found\");\n        }\n        \n        // Ajouter le label \"done\"\n        if let Some(done_id) = done_label_id {\n            modify_request.add_label_ids = Some(vec![done_id]);\n            debug!(\"Adding label 'homemetrics/done/xsense'\");\n        } else {\n            warn!(\"Label 'homemetrics/done/xsense' not found, it will need to be created in Gmail\");\n        }\n        \n        // Apply modifications\n        self.hub\n            .users()\n            .messages_modify(modify_request, user_id, message_id)\n            .add_scope(google_gmail1::api::Scope::Modify)\n            .doit()\n            .await\n            .context(\"Unable to modify email labels\")?;\n        \n        info!(\"‚úÖ Email {} marked as processed with label 'homemetrics/done/xsense'\", message_id);\n        Ok(())\n    }\n    \n    // ============================================================================\n    // Blue Riot Pool Monitoring Methods\n    // ============================================================================\n    \n    pub async fn search_pool_emails(\u0026self) -\u003e Result\u003cVec\u003cString\u003e\u003e {\n        info!(\"Searching for emails with label 'homemetrics/todo/blueriot'\");\n        \n        let user_id = \"me\";\n        let query = \"label:homemetrics/todo/blueriot\";\n        \n        debug!(\"Search criteria: {}\", query);\n        \n        let result = self.hub\n            .users()\n            .messages_list(user_id)\n            .q(query)\n            .add_scope(google_gmail1::api::Scope::Modify)\n            .doit()\n            .await\n            .context(\"Error searching for pool emails\")?;\n        \n        let message_ids: Vec\u003cString\u003e = result.1\n            .messages\n            .unwrap_or_default()\n            .into_iter()\n            .filter_map(|msg| msg.id)\n            .collect();\n        \n        info!(\"Found {} email(s) with label 'homemetrics/todo/blueriot'\", message_ids.len());\n        \n        Ok(message_ids)\n    }\n    \n    pub async fn mark_pool_email_as_processed(\u0026self, message_id: \u0026str) -\u003e Result\u003c()\u003e {\n        info!(\"Marking pool email {} as processed\", message_id);\n        \n        let user_id = \"me\";\n        \n        // First, retrieve existing labels to get IDs\n        let labels_result = self.hub\n            .users()\n            .labels_list(user_id)\n            .add_scope(google_gmail1::api::Scope::Modify)\n            .doit()\n            .await\n            .context(\"Unable to list labels\")?;\n        \n        let labels = labels_result.1.labels.unwrap_or_default();\n        \n        // Find label IDs for Blue Riot\n        let todo_label_id = labels.iter()\n            .find(|l| l.name.as_deref() == Some(\"homemetrics/todo/blueriot\"))\n            .and_then(|l| l.id.clone());\n        \n        let done_label_id = labels.iter()\n            .find(|l| l.name.as_deref() == Some(\"homemetrics/done/blueriot\"))\n            .and_then(|l| l.id.clone());\n        \n        let inbox_label_id = labels.iter()\n            .find(|l| l.name.as_deref() == Some(\"INBOX\"))\n            .and_then(|l| l.id.clone());\n        \n        let unread_label_id = labels.iter()\n            .find(|l| l.name.as_deref() == Some(\"UNREAD\"))\n            .and_then(|l| l.id.clone());\n        \n        // Create modification request\n        let mut modify_request = google_gmail1::api::ModifyMessageRequest::default();\n        let mut remove_labels = Vec::new();\n        let mut add_labels = Vec::new();\n        \n        // Remove \"todo\" label\n        if let Some(todo_id) = todo_label_id {\n            remove_labels.push(todo_id);\n            debug!(\"Removing label 'homemetrics/todo/blueriot'\");\n        } else {\n            warn!(\"Label 'homemetrics/todo/blueriot' not found\");\n        }\n        \n        // Remove INBOX\n        if let Some(inbox_id) = inbox_label_id {\n            remove_labels.push(inbox_id);\n            debug!(\"Removing from INBOX\");\n        }\n        \n        // Remove UNREAD (mark as read)\n        if let Some(unread_id) = unread_label_id {\n            remove_labels.push(unread_id);\n            debug!(\"Marking as read\");\n        }\n        \n        // Add \"done\" label\n        if let Some(done_id) = done_label_id {\n            add_labels.push(done_id);\n            debug!(\"Adding label 'homemetrics/done/blueriot'\");\n        } else {\n            warn!(\"Label 'homemetrics/done/blueriot' not found, it will need to be created in Gmail\");\n        }\n        \n        modify_request.remove_label_ids = Some(remove_labels);\n        modify_request.add_label_ids = Some(add_labels);\n        \n        // Apply modifications\n        self.hub\n            .users()\n            .messages_modify(modify_request, user_id, message_id)\n            .add_scope(google_gmail1::api::Scope::Modify)\n            .doit()\n            .await\n            .context(\"Unable to modify pool email labels\")?;\n        \n        info!(\"‚úÖ Pool email {} marked as processed (read, archived, labeled 'done')\", message_id);\n        Ok(())\n    }\n}\n","traces":[{"line":18,"address":[5128072,5128064],"length":1,"stats":{"Line":0}},{"line":19,"address":[4152818,4152655,4152853],"length":1,"stats":{"Line":0}},{"line":22,"address":[4153414,4153435,4153546,4152824,4153148,4153971],"length":1,"stats":{"Line":0}},{"line":23,"address":[4153416,4152730,4153231,4153178,4153141],"length":1,"stats":{"Line":0}},{"line":30,"address":[4943365],"length":1,"stats":{"Line":0}},{"line":31,"address":[4931179],"length":1,"stats":{"Line":0}},{"line":33,"address":[4943501],"length":1,"stats":{"Line":0}},{"line":35,"address":[4931677,4930159,4931346,4931403,4931456],"length":1,"stats":{"Line":0}},{"line":39,"address":[4931951,4931891,4932041],"length":1,"stats":{"Line":0}},{"line":45,"address":[4944479,4944423],"length":1,"stats":{"Line":0}},{"line":48,"address":[4154970],"length":1,"stats":{"Line":0}},{"line":50,"address":[4944855,4944765,4944980],"length":1,"stats":{"Line":0}},{"line":52,"address":[4932637],"length":1,"stats":{"Line":0}},{"line":55,"address":[5655568,5655576],"length":1,"stats":{"Line":0}},{"line":56,"address":[4933583,4933502,4933357],"length":1,"stats":{"Line":0}},{"line":58,"address":[4155710],"length":1,"stats":{"Line":0}},{"line":59,"address":[4945732],"length":1,"stats":{"Line":0}},{"line":61,"address":[5670095,5670374,5670420],"length":1,"stats":{"Line":0}},{"line":63,"address":[5670809,5670388,5671182,5671284,5671161,5670824,5670735,5670901],"length":1,"stats":{"Line":0}},{"line":66,"address":[4156697],"length":1,"stats":{"Line":0}},{"line":67,"address":[4156736],"length":1,"stats":{"Line":0}},{"line":69,"address":[5421959],"length":1,"stats":{"Line":0}},{"line":72,"address":[4947103,4947214],"length":1,"stats":{"Line":0}},{"line":76,"address":[4158192,4158220],"length":1,"stats":{"Line":0}},{"line":79,"address":[4157483,4157665,4157573],"length":1,"stats":{"Line":0}},{"line":81,"address":[4947391],"length":1,"stats":{"Line":0}},{"line":85,"address":[4159345,4158569,4158746,4158789,4158496,4163283],"length":1,"stats":{"Line":0}},{"line":86,"address":[4158701,4158898,4158846],"length":1,"stats":{"Line":0}},{"line":88,"address":[4158542],"length":1,"stats":{"Line":0}},{"line":90,"address":[4949525,4949030,4949390,4948668,4949119,4948976,4949415,4953481],"length":1,"stats":{"Line":0}},{"line":93,"address":[4159206],"length":1,"stats":{"Line":0}},{"line":95,"address":[4937168,4936979,4936925,4936360,4936868],"length":1,"stats":{"Line":0}},{"line":98,"address":[4159773,4159888],"length":1,"stats":{"Line":0}},{"line":100,"address":[4949756,4949821],"length":1,"stats":{"Line":0}},{"line":101,"address":[4159983,4163424],"length":1,"stats":{"Line":0}},{"line":102,"address":[4953347],"length":1,"stats":{"Line":0}},{"line":105,"address":[4937603,4937661],"length":1,"stats":{"Line":0}},{"line":106,"address":[4160121],"length":1,"stats":{"Line":0}},{"line":107,"address":[5674768],"length":1,"stats":{"Line":0}},{"line":110,"address":[5674959],"length":1,"stats":{"Line":0}},{"line":111,"address":[4950875,4953504,4950795],"length":1,"stats":{"Line":0}},{"line":112,"address":[4953539],"length":1,"stats":{"Line":0}},{"line":113,"address":[4953595],"length":1,"stats":{"Line":0}},{"line":115,"address":[5677832],"length":1,"stats":{"Line":0}},{"line":116,"address":[5677870],"length":1,"stats":{"Line":0}},{"line":118,"address":[4941505],"length":1,"stats":{"Line":0}},{"line":119,"address":[4163894],"length":1,"stats":{"Line":0}},{"line":120,"address":[4953784],"length":1,"stats":{"Line":0}},{"line":121,"address":[4941549],"length":1,"stats":{"Line":0}},{"line":125,"address":[5677358,5675280,5675090],"length":1,"stats":{"Line":0}},{"line":126,"address":[4953820,4951171,4953808],"length":1,"stats":{"Line":0}},{"line":127,"address":[5675609,5678044,5678032],"length":1,"stats":{"Line":0}},{"line":128,"address":[4941692,4939319,4941680],"length":1,"stats":{"Line":0}},{"line":131,"address":[4161765,4161833],"length":1,"stats":{"Line":0}},{"line":132,"address":[5675977,5676574],"length":1,"stats":{"Line":0}},{"line":134,"address":[5676007,5675950],"length":1,"stats":{"Line":0}},{"line":138,"address":[5675443],"length":1,"stats":{"Line":0}},{"line":142,"address":[4954290,4953952,4955038,4957506,4954247,4954041],"length":1,"stats":{"Line":0}},{"line":143,"address":[5678378,5678566,5678523],"length":1,"stats":{"Line":0}},{"line":145,"address":[4941790],"length":1,"stats":{"Line":0}},{"line":148,"address":[4955387,4954358,4954735,4954891,4955252,4954980,4954709,4955277],"length":1,"stats":{"Line":0}},{"line":150,"address":[4942503],"length":1,"stats":{"Line":0}},{"line":154,"address":[5679039],"length":1,"stats":{"Line":0}},{"line":156,"address":[4943030,4942840,4942729,4942786,4942053],"length":1,"stats":{"Line":0}},{"line":159,"address":[4943275],"length":1,"stats":{"Line":0}},{"line":162,"address":[4943314],"length":1,"stats":{"Line":0}},{"line":163,"address":[5679725],"length":1,"stats":{"Line":0}},{"line":165,"address":[5679793,5682339],"length":1,"stats":{"Line":0}},{"line":166,"address":[4943539,4943783],"length":1,"stats":{"Line":0}},{"line":167,"address":[4944051,4943916,4943823,4945480],"length":1,"stats":{"Line":0}},{"line":168,"address":[4944118,4944470,4944387],"length":1,"stats":{"Line":0}},{"line":169,"address":[4956858,4956790],"length":1,"stats":{"Line":0}},{"line":170,"address":[4944994,4944650,4944716],"length":1,"stats":{"Line":0}},{"line":171,"address":[4167110,4167051,4166937,4167026],"length":1,"stats":{"Line":0}},{"line":179,"address":[5679925],"length":1,"stats":{"Line":0}},{"line":182,"address":[5655680,5655698],"length":1,"stats":{"Line":0}},{"line":183,"address":[4959454,4959253,4959398],"length":1,"stats":{"Line":0}},{"line":185,"address":[4946862],"length":1,"stats":{"Line":0}},{"line":188,"address":[4947595,4947762,4948064,4947673,4947188,4947569],"length":1,"stats":{"Line":0}},{"line":190,"address":[4169839],"length":1,"stats":{"Line":0}},{"line":192,"address":[5683989],"length":1,"stats":{"Line":0}},{"line":194,"address":[4169360,4170328,4169987,4170077,4170024],"length":1,"stats":{"Line":0}},{"line":196,"address":[5684427],"length":1,"stats":{"Line":0}},{"line":197,"address":[4170453],"length":1,"stats":{"Line":0}},{"line":198,"address":[4960411],"length":1,"stats":{"Line":0}},{"line":199,"address":[4964852,4960413,4964816],"length":1,"stats":{"Line":0}},{"line":200,"address":[5688866,5689138],"length":1,"stats":{"Line":0}},{"line":205,"address":[4964404,4960549,4960752,4960672],"length":1,"stats":{"Line":0}},{"line":208,"address":[4948722,4948824,4948629],"length":1,"stats":{"Line":0}},{"line":211,"address":[4948728],"length":1,"stats":{"Line":0}},{"line":213,"address":[4961426,4961000,4961470],"length":1,"stats":{"Line":0}},{"line":216,"address":[4961813,4961432],"length":1,"stats":{"Line":0}},{"line":217,"address":[4962026,4961832,4962172],"length":1,"stats":{"Line":0}},{"line":218,"address":[4171875,4171967],"length":1,"stats":{"Line":0}},{"line":222,"address":[4962520],"length":1,"stats":{"Line":0}},{"line":223,"address":[4950459,4950386],"length":1,"stats":{"Line":0}},{"line":224,"address":[4965404,4965392],"length":1,"stats":{"Line":0}},{"line":227,"address":[4950588,4950402,4950560],"length":1,"stats":{"Line":0}},{"line":228,"address":[5687067,5686830],"length":1,"stats":{"Line":0}},{"line":232,"address":[4962753,4963037],"length":1,"stats":{"Line":0}},{"line":233,"address":[4965440,4965449],"length":1,"stats":{"Line":0}},{"line":234,"address":[5689472],"length":1,"stats":{"Line":0}},{"line":235,"address":[4965500],"length":1,"stats":{"Line":0}},{"line":236,"address":[5689692],"length":1,"stats":{"Line":0}},{"line":237,"address":[4175555],"length":1,"stats":{"Line":0}},{"line":238,"address":[4175581],"length":1,"stats":{"Line":0}},{"line":241,"address":[4965888,4965900],"length":1,"stats":{"Line":0}},{"line":243,"address":[4173059,4173142],"length":1,"stats":{"Line":0}},{"line":247,"address":[4951032,4951103],"length":1,"stats":{"Line":0}},{"line":249,"address":[4173488],"length":1,"stats":{"Line":0}},{"line":250,"address":[4951246],"length":1,"stats":{"Line":0}},{"line":251,"address":[4963510],"length":1,"stats":{"Line":0}},{"line":256,"address":[5655728,5655746],"length":1,"stats":{"Line":0}},{"line":257,"address":[4953971,4954137,4954218],"length":1,"stats":{"Line":0}},{"line":259,"address":[4954143],"length":1,"stats":{"Line":0}},{"line":262,"address":[4966932,4971152,4967218,4967246,4966787,4967356,4966816,4966843,4966394],"length":1,"stats":{"Line":0}},{"line":264,"address":[4966808],"length":1,"stats":{"Line":0}},{"line":265,"address":[5690827],"length":1,"stats":{"Line":0}},{"line":267,"address":[4954741,4954801,4954681,4954046,4954996],"length":1,"stats":{"Line":0}},{"line":270,"address":[4955268],"length":1,"stats":{"Line":0}},{"line":273,"address":[4955527,4955403],"length":1,"stats":{"Line":0}},{"line":274,"address":[4960654,4960640],"length":1,"stats":{"Line":0}},{"line":275,"address":[4972928,4967871,4972944],"length":1,"stats":{"Line":0}},{"line":277,"address":[5691957,5691815],"length":1,"stats":{"Line":0}},{"line":278,"address":[5696832,5696846],"length":1,"stats":{"Line":0}},{"line":279,"address":[4960800,4960816,4955928],"length":1,"stats":{"Line":0}},{"line":282,"address":[4968167],"length":1,"stats":{"Line":0}},{"line":285,"address":[4968292,4969006],"length":1,"stats":{"Line":0}},{"line":286,"address":[4968792,4968549,4968437],"length":1,"stats":{"Line":0}},{"line":287,"address":[5692853,5692924],"length":1,"stats":{"Line":0}},{"line":289,"address":[4956228,4957163],"length":1,"stats":{"Line":0}},{"line":293,"address":[4958048,4957020,4957408],"length":1,"stats":{"Line":0}},{"line":294,"address":[4179644,4179883,4179532],"length":1,"stats":{"Line":0}},{"line":295,"address":[4180031,4180102],"length":1,"stats":{"Line":0}},{"line":297,"address":[4958370,4957494],"length":1,"stats":{"Line":0}},{"line":301,"address":[4958726,4958767,4958607,4959174,4958856,4959284,4958286,4959146,4960115],"length":1,"stats":{"Line":0}},{"line":303,"address":[4180673],"length":1,"stats":{"Line":0}},{"line":304,"address":[4180800],"length":1,"stats":{"Line":0}},{"line":306,"address":[4180981,4181165,4180918,4180878,4176211],"length":1,"stats":{"Line":0}},{"line":309,"address":[4181545,4181398],"length":1,"stats":{"Line":0}},{"line":310,"address":[4959453],"length":1,"stats":{"Line":0}},{"line":317,"address":[4185298,4183066,4183109,4182921,4184059,4182832],"length":1,"stats":{"Line":0}},{"line":318,"address":[4961166,4961021,4961247],"length":1,"stats":{"Line":0}},{"line":320,"address":[4973118],"length":1,"stats":{"Line":0}},{"line":321,"address":[4973396],"length":1,"stats":{"Line":0}},{"line":323,"address":[4183524,4183199,4183478],"length":1,"stats":{"Line":0}},{"line":325,"address":[4184286,4183839,4184265,4184388,4183928,4183492,4184005,4183913],"length":1,"stats":{"Line":0}},{"line":328,"address":[4961889],"length":1,"stats":{"Line":0}},{"line":329,"address":[5698016],"length":1,"stats":{"Line":0}},{"line":331,"address":[5408423],"length":1,"stats":{"Line":0}},{"line":334,"address":[4184614,4184491],"length":1,"stats":{"Line":0}},{"line":338,"address":[4963440,4963468],"length":1,"stats":{"Line":0}},{"line":341,"address":[4962735,4962917,4962825],"length":1,"stats":{"Line":0}},{"line":343,"address":[4962831],"length":1,"stats":{"Line":0}},{"line":346,"address":[4976029,4976380,4977075,4976316,4975968,4982478],"length":1,"stats":{"Line":0}},{"line":347,"address":[4976271,4976437,4976518],"length":1,"stats":{"Line":0}},{"line":349,"address":[5700251],"length":1,"stats":{"Line":0}},{"line":352,"address":[5700278,5701196,5706115,5701070,5701094,5700667,5700796,5700719,5700704],"length":1,"stats":{"Line":0}},{"line":354,"address":[4964660],"length":1,"stats":{"Line":0}},{"line":355,"address":[4186615],"length":1,"stats":{"Line":0}},{"line":357,"address":[5426946],"length":1,"stats":{"Line":0}},{"line":360,"address":[4187232],"length":1,"stats":{"Line":0}},{"line":363,"address":[4965479,4965603],"length":1,"stats":{"Line":0}},{"line":364,"address":[5708462,5708448],"length":1,"stats":{"Line":0}},{"line":365,"address":[4194432,4187588,4194416],"length":1,"stats":{"Line":0}},{"line":367,"address":[4187745,4187603],"length":1,"stats":{"Line":0}},{"line":368,"address":[5708558,5708544],"length":1,"stats":{"Line":0}},{"line":369,"address":[4972752,4972736,4966004],"length":1,"stats":{"Line":0}},{"line":371,"address":[4966019,4966165],"length":1,"stats":{"Line":0}},{"line":372,"address":[4194544,4194558],"length":1,"stats":{"Line":0}},{"line":373,"address":[5702214,5708704,5708720],"length":1,"stats":{"Line":0}},{"line":375,"address":[4188275,4188133],"length":1,"stats":{"Line":0}},{"line":376,"address":[4985088,4985102],"length":1,"stats":{"Line":0}},{"line":377,"address":[4972944,4972928,4966566],"length":1,"stats":{"Line":0}},{"line":380,"address":[4978805],"length":1,"stats":{"Line":0}},{"line":381,"address":[4188523],"length":1,"stats":{"Line":0}},{"line":382,"address":[4979049],"length":1,"stats":{"Line":0}},{"line":385,"address":[5702842],"length":1,"stats":{"Line":0}},{"line":386,"address":[4188858],"length":1,"stats":{"Line":0}},{"line":387,"address":[4188995,4189106],"length":1,"stats":{"Line":0}},{"line":389,"address":[4967532,4967082],"length":1,"stats":{"Line":0}},{"line":393,"address":[4980001,4979460],"length":1,"stats":{"Line":0}},{"line":394,"address":[4980054],"length":1,"stats":{"Line":0}},{"line":395,"address":[5703837],"length":1,"stats":{"Line":0}},{"line":399,"address":[5703784,5704131],"length":1,"stats":{"Line":0}},{"line":400,"address":[4980495],"length":1,"stats":{"Line":0}},{"line":401,"address":[4190182],"length":1,"stats":{"Line":0}},{"line":405,"address":[4968659,4968312],"length":1,"stats":{"Line":0}},{"line":406,"address":[4190529],"length":1,"stats":{"Line":0}},{"line":407,"address":[4981025,4981197],"length":1,"stats":{"Line":0}},{"line":409,"address":[5705129,5704666],"length":1,"stats":{"Line":0}},{"line":412,"address":[4190676,4191266],"length":1,"stats":{"Line":0}},{"line":413,"address":[4191414,4191525],"length":1,"stats":{"Line":0}},{"line":416,"address":[4191951,4191837,4191874,4192361,4191673,4193422,4192259,4192235],"length":1,"stats":{"Line":0}},{"line":418,"address":[5705835],"length":1,"stats":{"Line":0}},{"line":419,"address":[4191866],"length":1,"stats":{"Line":0}},{"line":421,"address":[9101444],"length":1,"stats":{"Line":0}},{"line":424,"address":[4982929,4983106],"length":1,"stats":{"Line":0}},{"line":425,"address":[4982981],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":199},{"path":["/","workspaces","homemetrics","src","lib.rs"],"content":"// Library exports for homemetrics crate\n// This allows tests and other crates to use the modules\n\npub mod attachment_parser;\npub mod config;\npub mod database;\npub mod gmail_client;\npub mod slack_notifier;\npub mod email;\n\n// X-Sense temperature monitoring module\npub mod xsense;\n\n// Blue Riot pool monitoring module\npub mod blueriot;\n","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","homemetrics","src","main.rs"],"content":"use anyhow::Result;\nuse log::{info, error};\nuse clap::Parser;\n\nmod config;\nmod gmail_client;\nmod attachment_parser;\nmod database;\nmod slack_notifier;\nmod email;\n\n// X-Sense temperature monitoring module\nmod xsense;\n\n// Blue Riot pool monitoring module\nmod blueriot;\n\nuse config::Config;\nuse xsense::XSenseEmailProcessor;\nuse blueriot::BlueRiotEmailProcessor;\n\n#[derive(Parser)]\n#[command(name = \"homemetrics\")]\n#[command(about = \"HomeMetrics mail client to retrieve X-Sense data\")]\n#[command(version = \"0.1.0\")]\nstruct Args {\n    /// Dry-run mode: analyze emails without saving to database\n    #[arg(short, long)]\n    dry_run: bool,\n    \n    /// Daemon mode: run the program as a daemon with scheduling\n    #[arg(long)]\n    daemon: bool,\n    \n    /// Attachment save directory (default: ./data)\n    #[arg(short = 'o', long, default_value = \"./data\")]\n    data_dir: String,\n    \n    /// Limit the number of emails to process (default: unlimited)\n    #[arg(short = 'l', long)]\n    limit: Option\u003cusize\u003e,\n    \n    /// List all Gmail labels with their IDs\n    #[arg(long)]\n    list_labels: bool,\n    \n    /// Check configuration without connecting\n    #[arg(long)]\n    check_config: bool,\n}\n\n#[tokio::main]\nasync fn main() -\u003e Result\u003c()\u003e {\n    // Load .env file if it exists\n    dotenv::dotenv().ok();\n    \n    // Parse CLI arguments\n    let args = Args::parse();\n    \n    // Initialize logging\n    env_logger::init();\n    \n    if args.dry_run {\n        info!(\"üß™ Starting HomeMetrics X-Sense mail client in DRY-RUN mode\");\n    } else {\n        info!(\"üöÄ Starting HomeMetrics X-Sense mail client\");\n    }\n    \n    // Load configuration\n    let mut config = Config::new()?;\n    \n    // If requested, list Gmail labels and exit\n    if args.list_labels {\n        use gmail_client::GmailClient;\n        \n        println!(\"üìã Listing Gmail labels...\\n\");\n        let gmail = GmailClient::new(\u0026config.gmail).await?;\n        gmail.list_labels().await?;\n        return Ok(());\n    }\n    \n    // If requested, only check configuration\n    if args.check_config {\n        println!(\"‚úÖ Configuration valide !\");\n        println!(\"üìß Gmail API OAuth2\");\n        println!(\"üîë Credentials: {}\", config.gmail.credentials_path);\n        println!(\"üíæ Token cache: {}\", config.gmail.token_cache_path);\n        println!(\"üìÅ Data directory: {}\", config.data_dir);\n        if !args.dry_run {\n            println!(\"üóÑÔ∏è  Database: {}@{}:{}/{}\", \n                     config.database.username, config.database.host, \n                     config.database.port, config.database.database);\n        }\n        return Ok(());\n    }\n    \n    // Override data_dir with CLI argument if provided\n    if args.data_dir != \"./data\" {\n        config.data_dir = args.data_dir.clone();\n    }\n    \n    // If daemon mode is enabled\n    if args.daemon {\n        info!(\"üîÑ Starting in daemon mode\");\n        run_daemon_mode(config, args).await?;\n        return Ok(());\n    }\n    \n    // One-shot mode (default behavior)\n    info!(\"üöÄ Processing both X-Sense and Blue Riot emails in parallel\");\n    \n    let result = if args.dry_run {\n        // Dry-run mode: no database connection\n        let xsense_processor = XSenseEmailProcessor::new_dry_run(config.clone())?;\n        let pool_processor = BlueRiotEmailProcessor::new(\u0026config, true).await?;\n        \n        // Process both types in parallel\n        let (xsense_result, pool_result) = tokio::join!(\n            xsense_processor.process_emails_dry_run(args.limit),\n            pool_processor.process_emails(args.limit)\n        );\n        \n        let xsense_count = xsense_result?;\n        pool_result?; // Just check for errors\n        \n        Ok(xsense_count)\n    } else {\n        // Production mode: with database\n        let xsense_processor = XSenseEmailProcessor::new(config.clone()).await?;\n        let pool_processor = BlueRiotEmailProcessor::new(\u0026config, false).await?;\n        \n        // Process both types in parallel\n        let (xsense_result, pool_result) = tokio::join!(\n            xsense_processor.process_emails(args.limit),\n            pool_processor.process_emails(args.limit)\n        );\n        \n        let xsense_count = xsense_result?;\n        pool_result?; // Just check for errors\n        \n        Ok(xsense_count)\n    };\n    \n    match result {\n        Ok(count) =\u003e {\n            if args.dry_run {\n                info!(\"‚úÖ Dry-run analysis completed successfully. {} emails analyzed.\", count);\n            } else {\n                info!(\"‚úÖ Processing completed successfully. {} emails processed.\", count);\n            }\n        }\n        Err(e) =\u003e {\n            error!(\"‚ùå Error processing emails: {}\", e);\n            return Err(e);\n        }\n    }\n    \n    Ok(())\n}\n\nasync fn run_daemon_mode(config: Config, args: Args) -\u003e Result\u003c()\u003e {\n    use tokio_cron_scheduler::{JobScheduler, Job};\n    use chrono::{Local, Timelike};\n    \n    // Check that the scheduler is enabled in configuration\n    if !config.scheduler.enabled {\n        error!(\"‚ùå Daemon mode requires SCHEDULER_ENABLED=true in configuration\");\n        anyhow::bail!(\"Scheduler not enabled in configuration\");\n    }\n    \n    if config.scheduler.schedule_times.is_empty() {\n        error!(\"‚ùå No scheduling times defined (SCHEDULER_TIMES)\");\n        anyhow::bail!(\"No scheduling times defined\");\n    }\n    \n    info!(\"üìÖ Configured retrieval times: {:?}\", config.scheduler.schedule_times);\n    \n    // First, process emails immediately at startup\n    info!(\"üöÄ Daemon starting - processing emails immediately...\");\n    let initial_result = if args.dry_run {\n        let xsense_processor = XSenseEmailProcessor::new_dry_run(config.clone())?;\n        let pool_processor = BlueRiotEmailProcessor::new(\u0026config, true).await?;\n        \n        let (xsense_result, pool_result) = tokio::join!(\n            xsense_processor.process_emails_dry_run(args.limit),\n            pool_processor.process_emails(args.limit)\n        );\n        \n        let _ = pool_result?; // Check for errors\n        xsense_result\n    } else {\n        let xsense_processor = XSenseEmailProcessor::new(config.clone()).await?;\n        let pool_processor = BlueRiotEmailProcessor::new(\u0026config, false).await?;\n        \n        let (xsense_result, pool_result) = tokio::join!(\n            xsense_processor.process_emails(args.limit),\n            pool_processor.process_emails(args.limit)\n        );\n        \n        let _ = pool_result?; // Check for errors\n        xsense_result\n    };\n    \n    match initial_result {\n        Ok(count) =\u003e {\n            info!(\"‚úÖ Initial processing completed. {} emails processed.\", count);\n        }\n        Err(e) =\u003e {\n            error!(\"‚ùå Error during initial processing: {}\", e);\n            error!(\"‚ö†Ô∏è  Continuing with scheduled mode despite initial error...\");\n        }\n    }\n    \n    // Create the scheduler\n    let scheduler = JobScheduler::new().await?;\n    \n    // Add a job for each configured time\n    for schedule_time in \u0026config.scheduler.schedule_times {\n        let parts: Vec\u003c\u0026str\u003e = schedule_time.split(':').collect();\n        if parts.len() != 2 {\n            error!(\"‚ùå Invalid time format: {}. Use HH:MM format\", schedule_time);\n            continue;\n        }\n        \n        let hour = parts[0];\n        let minute = parts[1];\n        \n        // Cron format: \"0 minute hour * * *\" (every day)\n        let cron_expr = format!(\"0 {} {} * * *\", minute, hour);\n        info!(\"üìÜ Adding scheduled job: {} (cron: {})\", schedule_time, cron_expr);\n        \n        // Clone variables needed for the closure\n        let config_clone = config.clone();\n        let dry_run = args.dry_run;\n        let limit = args.limit;\n        let schedule_time_clone = schedule_time.clone();\n        \n        let job = Job::new_async(cron_expr.as_str(), move |_uuid, _l| {\n            let config = config_clone.clone();\n            let schedule_time = schedule_time_clone.clone();\n            \n            Box::pin(async move {\n                info!(\"‚è∞ Scheduled execution at {} - Retrieving emails...\", schedule_time);\n                \n                let result = if dry_run {\n                    let xsense_processor = match XSenseEmailProcessor::new_dry_run(config.clone()) {\n                        Ok(p) =\u003e p,\n                        Err(e) =\u003e {\n                            error!(\"‚ùå Error creating X-Sense processor: {}\", e);\n                            return;\n                        }\n                    };\n                    \n                    let pool_processor = match BlueRiotEmailProcessor::new(\u0026config, true).await {\n                        Ok(p) =\u003e p,\n                        Err(e) =\u003e {\n                            error!(\"‚ùå Error creating pool processor: {}\", e);\n                            return;\n                        }\n                    };\n                    \n                    let (xsense_result, pool_result) = tokio::join!(\n                        xsense_processor.process_emails_dry_run(limit),\n                        pool_processor.process_emails(limit)\n                    );\n                    \n                    let _ = pool_result; // Ignore pool result for count\n                    xsense_result\n                } else {\n                    let xsense_processor = match XSenseEmailProcessor::new(config.clone()).await {\n                        Ok(p) =\u003e p,\n                        Err(e) =\u003e {\n                            error!(\"‚ùå Error creating X-Sense processor: {}\", e);\n                            return;\n                        }\n                    };\n                    \n                    let pool_processor = match BlueRiotEmailProcessor::new(\u0026config, false).await {\n                        Ok(p) =\u003e p,\n                        Err(e) =\u003e {\n                            error!(\"‚ùå Error creating pool processor: {}\", e);\n                            return;\n                        }\n                    };\n                    \n                    let (xsense_result, pool_result) = tokio::join!(\n                        xsense_processor.process_emails(limit),\n                        pool_processor.process_emails(limit)\n                    );\n                    \n                    let _ = pool_result; // Ignore pool result for count\n                    xsense_result\n                };\n                \n                match result {\n                    Ok(count) =\u003e {\n                        info!(\"‚úÖ Scheduled processing completed. {} emails processed at {}\", count, schedule_time);\n                    }\n                    Err(e) =\u003e {\n                        error!(\"‚ùå Error during scheduled processing at {}: {}\", schedule_time, e);\n                    }\n                }\n            })\n        })?;\n        \n        scheduler.add(job).await?;\n    }\n    \n    // Start the scheduler\n    scheduler.start().await?;\n    \n    info!(\"‚úÖ Daemon mode started. Waiting for scheduled times...\");\n    info!(\"üìã Next executions: {:?}\", config.scheduler.schedule_times);\n    info!(\"‚è∏Ô∏è  Press Ctrl+C to stop the daemon\");\n    \n    // Keep the program alive\n    loop {\n        tokio::time::sleep(tokio::time::Duration::from_secs(60)).await;\n        \n        // Periodic log to show the daemon is active\n        let now = Local::now();\n        if now.minute() == 0 {\n            info!(\"üíì Daemon active - {}\", now.format(\"%Y-%m-%d %H:%M\"));\n        }\n    }\n}\n","traces":[{"line":53,"address":[9418311,9418317,9417856],"length":1,"stats":{"Line":0}},{"line":55,"address":[5888846,5889185],"length":1,"stats":{"Line":0}},{"line":58,"address":[5889231],"length":1,"stats":{"Line":0}},{"line":61,"address":[5889295],"length":1,"stats":{"Line":0}},{"line":63,"address":[5889366],"length":1,"stats":{"Line":0}},{"line":64,"address":[5889747,5889428],"length":1,"stats":{"Line":0}},{"line":66,"address":[5889383,5889483,5889507],"length":1,"stats":{"Line":0}},{"line":70,"address":[5889497,5890065,5892922],"length":1,"stats":{"Line":0}},{"line":73,"address":[5890232],"length":1,"stats":{"Line":0}},{"line":76,"address":[5892783,5890268],"length":1,"stats":{"Line":0}},{"line":77,"address":[5893579,5888975,5893012,5892802],"length":1,"stats":{"Line":0}},{"line":78,"address":[5893598,5893408,5893501,5893980,5888996],"length":1,"stats":{"Line":0}},{"line":79,"address":[5893935],"length":1,"stats":{"Line":0}},{"line":83,"address":[5890249],"length":1,"stats":{"Line":0}},{"line":84,"address":[5892137,5890333],"length":1,"stats":{"Line":0}},{"line":85,"address":[5892156],"length":1,"stats":{"Line":0}},{"line":86,"address":[5892201],"length":1,"stats":{"Line":0}},{"line":87,"address":[5892297],"length":1,"stats":{"Line":0}},{"line":88,"address":[5892397],"length":1,"stats":{"Line":0}},{"line":89,"address":[5892500],"length":1,"stats":{"Line":0}},{"line":90,"address":[5892565,5892517],"length":1,"stats":{"Line":0}},{"line":94,"address":[5892548],"length":1,"stats":{"Line":0}},{"line":98,"address":[5890672,5890297,5890417],"length":1,"stats":{"Line":0}},{"line":99,"address":[5890449,5890509],"length":1,"stats":{"Line":0}},{"line":103,"address":[5890423],"length":1,"stats":{"Line":0}},{"line":104,"address":[5890722,5891812,5891632],"length":1,"stats":{"Line":0}},{"line":105,"address":[9204956],"length":1,"stats":{"Line":0}},{"line":106,"address":[5894327],"length":1,"stats":{"Line":0}},{"line":110,"address":[5890777,5890677,5890809],"length":1,"stats":{"Line":0}},{"line":112,"address":[5890783],"length":1,"stats":{"Line":0}},{"line":114,"address":[5891065,5891216,5891591],"length":1,"stats":{"Line":0}},{"line":115,"address":[5895431,5889038,5894365,5891419,5891510],"length":1,"stats":{"Line":0}},{"line":118,"address":[5895152,5895273,5895472,5894951,5889059,5894889],"length":1,"stats":{"Line":0}},{"line":119,"address":[5894779],"length":1,"stats":{"Line":0}},{"line":120,"address":[5894896],"length":1,"stats":{"Line":0}},{"line":123,"address":[5895796,5895692,5896154],"length":1,"stats":{"Line":0}},{"line":124,"address":[5896126,5895891],"length":1,"stats":{"Line":0}},{"line":126,"address":[5896015],"length":1,"stats":{"Line":0}},{"line":129,"address":[5896305,5896885,5889080,5891042,5891104],"length":1,"stats":{"Line":0}},{"line":130,"address":[9205040],"length":1,"stats":{"Line":0}},{"line":133,"address":[5897422,5897806,5889122,5897484,5897685,5898005],"length":1,"stats":{"Line":0}},{"line":134,"address":[5897312],"length":1,"stats":{"Line":0}},{"line":135,"address":[5897429],"length":1,"stats":{"Line":0}},{"line":138,"address":[5898225,5898323,5899880],"length":1,"stats":{"Line":0}},{"line":139,"address":[5899855,5898412],"length":1,"stats":{"Line":0}},{"line":141,"address":[5898527],"length":1,"stats":{"Line":0}},{"line":144,"address":[5896095],"length":1,"stats":{"Line":0}},{"line":145,"address":[5898671],"length":1,"stats":{"Line":0}},{"line":146,"address":[5898687],"length":1,"stats":{"Line":0}},{"line":147,"address":[5898746,5899101],"length":1,"stats":{"Line":0}},{"line":149,"address":[5898795,5898831,5898704],"length":1,"stats":{"Line":0}},{"line":152,"address":[5898610],"length":1,"stats":{"Line":0}},{"line":153,"address":[5899561,5898626,5899588],"length":1,"stats":{"Line":0}},{"line":154,"address":[5899567],"length":1,"stats":{"Line":0}},{"line":158,"address":[5898801],"length":1,"stats":{"Line":0}},{"line":161,"address":[5866909,5866848,5879811,5869453,5867131,5870537],"length":1,"stats":{"Line":0}},{"line":166,"address":[5867105],"length":1,"stats":{"Line":0}},{"line":167,"address":[5867477,5867342,5867512],"length":1,"stats":{"Line":0}},{"line":168,"address":[5867753,5867483],"length":1,"stats":{"Line":0}},{"line":171,"address":[5867387,5867824],"length":1,"stats":{"Line":0}},{"line":172,"address":[5867875,5869133,5869168],"length":1,"stats":{"Line":0}},{"line":173,"address":[5869139,5869409],"length":1,"stats":{"Line":0}},{"line":176,"address":[5867830,5867984,5867930],"length":1,"stats":{"Line":0}},{"line":179,"address":[5867936,5868310,5868278],"length":1,"stats":{"Line":0}},{"line":180,"address":[5868284],"length":1,"stats":{"Line":0}},{"line":181,"address":[5868573,5869113,5868731],"length":1,"stats":{"Line":0}},{"line":182,"address":[9210879],"length":1,"stats":{"Line":0}},{"line":184,"address":[9210900],"length":1,"stats":{"Line":0}},{"line":185,"address":[5869893],"length":1,"stats":{"Line":0}},{"line":186,"address":[5870010],"length":1,"stats":{"Line":0}},{"line":189,"address":[5870884,5870804,5871089],"length":1,"stats":{"Line":0}},{"line":190,"address":[5870961],"length":1,"stats":{"Line":0}},{"line":192,"address":[9210921],"length":1,"stats":{"Line":0}},{"line":193,"address":[5871600,5872852,5871786,5867224,5871695],"length":1,"stats":{"Line":0}},{"line":195,"address":[5872310,5872372,5872694,5872573,5872893,5867245],"length":1,"stats":{"Line":0}},{"line":196,"address":[5872200],"length":1,"stats":{"Line":0}},{"line":197,"address":[5872317],"length":1,"stats":{"Line":0}},{"line":200,"address":[5874566,5873185,5873105],"length":1,"stats":{"Line":0}},{"line":201,"address":[5873265],"length":1,"stats":{"Line":0}},{"line":204,"address":[5871051],"length":1,"stats":{"Line":0}},{"line":205,"address":[5873429],"length":1,"stats":{"Line":0}},{"line":206,"address":[5873532,5873452],"length":1,"stats":{"Line":0}},{"line":208,"address":[5873358],"length":1,"stats":{"Line":0}},{"line":209,"address":[5873381,5873921,5873867],"length":1,"stats":{"Line":0}},{"line":210,"address":[5874208,5873873,5874236],"length":1,"stats":{"Line":0}},{"line":215,"address":[5874663,5873510,5875347,5867266,5874485],"length":1,"stats":{"Line":0}},{"line":218,"address":[5875280,5875302,5875915,5875171],"length":1,"stats":{"Line":0}},{"line":219,"address":[5875977,5876154],"length":1,"stats":{"Line":0}},{"line":220,"address":[5876212],"length":1,"stats":{"Line":0}},{"line":221,"address":[5878052,5876305,5878017],"length":1,"stats":{"Line":0}},{"line":225,"address":[5876260,5876361],"length":1,"stats":{"Line":0}},{"line":226,"address":[5876390],"length":1,"stats":{"Line":0}},{"line":229,"address":[5876473],"length":1,"stats":{"Line":0}},{"line":230,"address":[5876806,5876767,5876664],"length":1,"stats":{"Line":0}},{"line":233,"address":[5876773,5877189],"length":1,"stats":{"Line":0}},{"line":234,"address":[5877204],"length":1,"stats":{"Line":0}},{"line":235,"address":[5877232],"length":1,"stats":{"Line":0}},{"line":236,"address":[5877383,5877286],"length":1,"stats":{"Line":0}},{"line":238,"address":[5877743,5877499,5880704,5877928,5877398,5881105],"length":1,"stats":{"Line":0}},{"line":239,"address":[5880773,5880835],"length":1,"stats":{"Line":0}},{"line":240,"address":[5880843],"length":1,"stats":{"Line":0}},{"line":242,"address":[5882766,5886969,5881326,5881197,5881136,5880912,5880765],"length":1,"stats":{"Line":0}},{"line":243,"address":[5881508,5881540,5881262],"length":1,"stats":{"Line":0}},{"line":245,"address":[5881514],"length":1,"stats":{"Line":0}},{"line":246,"address":[5882010,5881855],"length":1,"stats":{"Line":0}},{"line":247,"address":[5882170],"length":1,"stats":{"Line":0}},{"line":248,"address":[5882054],"length":1,"stats":{"Line":0}},{"line":249,"address":[5882460,5882432,5882070],"length":1,"stats":{"Line":0}},{"line":254,"address":[9115158],"length":1,"stats":{"Line":0}},{"line":255,"address":[5883158],"length":1,"stats":{"Line":0}},{"line":256,"address":[5883042],"length":1,"stats":{"Line":0}},{"line":257,"address":[5883910,5883058,5883882],"length":1,"stats":{"Line":0}},{"line":262,"address":[9115180],"length":1,"stats":{"Line":0}},{"line":263,"address":[5883201],"length":1,"stats":{"Line":0}},{"line":264,"address":[5883311],"length":1,"stats":{"Line":0}},{"line":268,"address":[5884424],"length":1,"stats":{"Line":0}},{"line":270,"address":[5881828,5881898,5881398,5884616],"length":1,"stats":{"Line":0}},{"line":271,"address":[5884976],"length":1,"stats":{"Line":0}},{"line":272,"address":[5884860],"length":1,"stats":{"Line":0}},{"line":273,"address":[5885235,5885263,5884876],"length":1,"stats":{"Line":0}},{"line":278,"address":[9115224],"length":1,"stats":{"Line":0}},{"line":279,"address":[5885903],"length":1,"stats":{"Line":0}},{"line":280,"address":[5885787],"length":1,"stats":{"Line":0}},{"line":281,"address":[5886594,5885803,5886622],"length":1,"stats":{"Line":0}},{"line":286,"address":[5887064,5886411,5881440,5886049,5886296,5886104],"length":1,"stats":{"Line":0}},{"line":287,"address":[5885946],"length":1,"stats":{"Line":0}},{"line":288,"address":[5886056],"length":1,"stats":{"Line":0}},{"line":292,"address":[5887265],"length":1,"stats":{"Line":0}},{"line":295,"address":[5884565],"length":1,"stats":{"Line":0}},{"line":296,"address":[5887477],"length":1,"stats":{"Line":0}},{"line":297,"address":[5887493,5887550],"length":1,"stats":{"Line":0}},{"line":299,"address":[5887416],"length":1,"stats":{"Line":0}},{"line":300,"address":[5887937,5887962,5887432],"length":1,"stats":{"Line":0}},{"line":306,"address":[9211005],"length":1,"stats":{"Line":0}},{"line":310,"address":[5867308,5876015,5879732,5878481],"length":1,"stats":{"Line":0}},{"line":312,"address":[5878809,5878915],"length":1,"stats":{"Line":0}},{"line":313,"address":[5879155,5878867,5879206],"length":1,"stats":{"Line":0}},{"line":314,"address":[5879479,5879509,5879161],"length":1,"stats":{"Line":0}},{"line":318,"address":[5879490,5879959,5879928,5867329,5880600],"length":1,"stats":{"Line":0}},{"line":321,"address":[5880132],"length":1,"stats":{"Line":0}},{"line":322,"address":[5880159],"length":1,"stats":{"Line":0}},{"line":323,"address":[5880183],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":142},{"path":["/","workspaces","homemetrics","src","slack_notifier.rs"],"content":"use anyhow::Result;\nuse log::{info, error};\nuse slack_morphism::prelude::*;\n\nuse crate::config::SlackConfig;\n\npub struct SlackNotifier {\n    client: SlackClient\u003cSlackClientHyperHttpsConnector\u003e,\n    token: SlackApiToken,\n    channel_id: SlackChannelId,\n}\n\nimpl SlackNotifier {\n    pub fn new(config: \u0026SlackConfig) -\u003e Result\u003cSelf\u003e {\n        info!(\"Initializing Slack notifier\");\n        \n        let client = SlackClient::new(SlackClientHyperHttpsConnector::new()?);\n        let token = SlackApiToken::new(config.bot_token.clone().into());\n        let channel_id = SlackChannelId::new(config.channel_id.clone());\n        \n        Ok(SlackNotifier {\n            client,\n            token,\n            channel_id,\n        })\n    }\n    \n    /// Send a simple text message to Slack\n    pub async fn send_message(\u0026self, text: \u0026str) -\u003e Result\u003c()\u003e {\n        info!(\"Sending Slack message\");\n        \n        let post_chat_req = SlackApiChatPostMessageRequest::new(\n            self.channel_id.clone(),\n            SlackMessageContent::new().with_text(text.to_string()),\n        );\n        \n        let session = self.client.open_session(\u0026self.token);\n        \n        match session.chat_post_message(\u0026post_chat_req).await {\n            Ok(response) =\u003e {\n                info!(\"‚úÖ Slack message sent successfully: {:?}\", response.ts);\n                Ok(())\n            }\n            Err(e) =\u003e {\n                error!(\"‚ùå Error sending Slack message: {}\", e);\n                Err(anyhow::anyhow!(\"Unable to send Slack message: {}\", e))\n            }\n        }\n    }\n}\n","traces":[{"line":14,"address":[5241264,5242015,5242021],"length":1,"stats":{"Line":0}},{"line":15,"address":[6635558,6635454],"length":1,"stats":{"Line":0}},{"line":17,"address":[6642989,6643212],"length":1,"stats":{"Line":0}},{"line":18,"address":[6643371,6643308],"length":1,"stats":{"Line":0}},{"line":19,"address":[5162786,5162719],"length":1,"stats":{"Line":0}},{"line":21,"address":[5162857],"length":1,"stats":{"Line":0}},{"line":22,"address":[5241853],"length":1,"stats":{"Line":0}},{"line":23,"address":[6636040],"length":1,"stats":{"Line":0}},{"line":29,"address":[7738534,7738302,7739496,7738491,7739420,7738256],"length":1,"stats":{"Line":0}},{"line":30,"address":[7730945,7731117,7731084],"length":1,"stats":{"Line":0}},{"line":33,"address":[7456551,7456279],"length":1,"stats":{"Line":0}},{"line":34,"address":[7731375,7731466,7731394,7731948],"length":1,"stats":{"Line":0}},{"line":37,"address":[7739156],"length":1,"stats":{"Line":0}},{"line":39,"address":[6696055],"length":1,"stats":{"Line":0}},{"line":40,"address":[7457636],"length":1,"stats":{"Line":0}},{"line":41,"address":[7732580,7732620,7732490],"length":1,"stats":{"Line":0}},{"line":42,"address":[7732586],"length":1,"stats":{"Line":0}},{"line":44,"address":[8156395],"length":1,"stats":{"Line":0}},{"line":45,"address":[7732415,7733047,7733011],"length":1,"stats":{"Line":0}},{"line":46,"address":[7733017,7733313],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":20},{"path":["/","workspaces","homemetrics","src","xsense","extractor.rs"],"content":"use anyhow::{Result, Context};\nuse chrono::{DateTime, Utc, NaiveDateTime};\nuse csv::ReaderBuilder;\nuse log::{info, debug, warn};\nuse regex::Regex;\nuse serde::{Deserialize, Serialize};\n\n\nuse crate::attachment_parser::Attachment;\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct TemperatureReading {\n    pub sensor_id: String,\n    pub timestamp: DateTime\u003cUtc\u003e,\n    pub temperature: f64,\n    pub humidity: Option\u003cf64\u003e,\n    pub location: Option\u003cString\u003e,\n}\n\npub struct TemperatureExtractor;\n\nimpl TemperatureExtractor {\n    pub fn extract_from_attachment(attachment: \u0026Attachment) -\u003e Result\u003cVec\u003cTemperatureReading\u003e\u003e {\n        info!(\"Extracting temperature data from: {}\", attachment.filename);\n        \n        // Extract sensor name from filename\n        let sensor_name = Self::extract_sensor_name(\u0026attachment.filename)?;\n        debug!(\"Extracted sensor name: {}\", sensor_name);\n        \n        match attachment.filename.to_lowercase() {\n            name if name.ends_with(\".csv\") =\u003e {\n                Self::extract_from_xsense_csv(\u0026attachment.content, \u0026sensor_name)\n            }\n            name if name.ends_with(\".json\") =\u003e {\n                Self::extract_from_json(\u0026attachment.content)\n            }\n            name if name.ends_with(\".xml\") =\u003e {\n                Self::extract_from_xml(\u0026attachment.content)\n            }\n            name if name.ends_with(\".txt\") =\u003e {\n                Self::extract_from_text(\u0026attachment.content)\n            }\n            _ =\u003e {\n                warn!(\"Unsupported file format: {}\", attachment.filename);\n                Ok(Vec::new())\n            }\n        }\n    }\n    \n    pub fn extract_sensor_name(filename: \u0026str) -\u003e Result\u003cString\u003e {\n        // Expected format: \"Thermo-{sensor_name}_Export data_{date}.csv\"\n        // Examples: \"Thermo-cabane_...\", \"Thermo-patio_...\", \"Thermo-poolhouse_...\"\n        \n        if let Some(captures) = Regex::new(r\"Thermo-([^_]+)_\")?.captures(filename) {\n            if let Some(sensor_match) = captures.get(1) {\n                return Ok(sensor_match.as_str().to_string());\n            }\n        }\n        \n        // Fallback: use full filename without extension\n        let name = filename\n            .split('.')\n            .next()\n            .unwrap_or(filename);\n        \n        Ok(name.to_string())\n    }\n    \n    pub fn extract_from_xsense_csv(content: \u0026[u8], sensor_name: \u0026str) -\u003e Result\u003cVec\u003cTemperatureReading\u003e\u003e {\n        debug!(\"Extracting from X-Sense CSV file for sensor: {}\", sensor_name);\n        \n        // Try UTF-8 first, then other encodings\n        let content_str = match std::str::from_utf8(content) {\n            Ok(s) =\u003e s.to_string(),\n            Err(_) =\u003e {\n                // Fallback: replace invalid characters with placeholders\n                String::from_utf8_lossy(content).to_string()\n            }\n        };\n        \n        debug!(\"CSV content size: {} characters\", content_str.len());\n        \n        let mut readings = Vec::new();\n        let mut rdr = ReaderBuilder::new()\n            .has_headers(true)\n            .flexible(true)  // Tolerant to column differences\n            .from_reader(content_str.as_bytes());\n        \n        // Check expected headers\n        let headers = rdr.headers()\n            .context(\"Unable to read CSV headers\")?;\n        debug!(\"Found CSV headers: {:?}\", headers);\n        \n        // Validate we have at least 3 columns\n        if headers.len() \u003c 3 {\n            return Err(anyhow::anyhow!(\"Invalid CSV: found {} columns, expected at least 3\", headers.len()));\n        }\n        \n        // Parse each data line\n        for (line_num, result) in rdr.records().enumerate() {\n            let record = result.context(format!(\"Error on line {}\", line_num + 2))?;\n            \n            if record.len() \u003c 3 {\n                warn!(\"Line {} skipped: not enough columns ({} \u003c 3)\", line_num + 2, record.len());\n                continue;\n            }\n            \n            // Column 1: Timestamp (format: \"2023/12/26 23:59\")\n            let timestamp_str = record.get(0).unwrap_or(\"\");\n            let timestamp = Self::parse_xsense_timestamp(timestamp_str)\n                .with_context(|| format!(\"Unable to parse timestamp '{}' on line {}\", timestamp_str, line_num + 2))?;\n            \n            // Column 2: Temperature (format: \"5.5\")\n            let temperature_str = record.get(1).unwrap_or(\"\");\n            let temperature: f64 = temperature_str.parse()\n                .with_context(|| format!(\"Unable to parse temperature '{}' on line {}\", temperature_str, line_num + 2))?;\n            \n            // Column 3: Humidity (format: \"89.6\")\n            let humidity_str = record.get(2).unwrap_or(\"\");\n            let humidity: f64 = humidity_str.parse()\n                .with_context(|| format!(\"Unable to parse humidity '{}' on line {}\", humidity_str, line_num + 2))?;\n            \n            readings.push(TemperatureReading {\n                sensor_id: sensor_name.to_string(),\n                timestamp,\n                temperature,\n                humidity: Some(humidity),\n                location: Some(sensor_name.to_string()),\n            });\n        }\n        \n        info!(\"Extraction completed: {} temperature readings for sensor '{}'\", readings.len(), sensor_name);\n        Ok(readings)\n    }\n    \n    fn parse_xsense_timestamp(timestamp_str: \u0026str) -\u003e Result\u003cDateTime\u003cUtc\u003e\u003e {\n        // X-Sense format: \"2023/12/26 23:59\"\n        let naive_dt = NaiveDateTime::parse_from_str(timestamp_str, \"%Y/%m/%d %H:%M\")\n            .context(format!(\"Invalid timestamp format: '{}'\", timestamp_str))?;\n        \n        // Convert to UTC (assuming data is in local time)\n        Ok(DateTime::from_naive_utc_and_offset(naive_dt, Utc))\n    }\n    \n\n    \n    fn extract_from_json(content: \u0026[u8]) -\u003e Result\u003cVec\u003cTemperatureReading\u003e\u003e {\n        debug!(\"Extracting from JSON file\");\n        \n        let content_str = std::str::from_utf8(content)\n            .context(\"Unable to decode JSON content as UTF-8\")?;\n        \n        // Try to deserialize directly as an array of readings\n        if let Ok(readings) = serde_json::from_str::\u003cVec\u003cTemperatureReading\u003e\u003e(content_str) {\n            info!(\"Extracted {} temperature readings from JSON (direct format)\", readings.len());\n            return Ok(readings);\n        }\n        \n        // Try other common JSON formats\n        let value: serde_json::Value = serde_json::from_str(content_str)\n            .context(\"Unable to parse JSON\")?;\n        \n        let mut readings = Vec::new();\n        \n        // Format: {\"data\": [readings...]}\n        if let Some(data_array) = value.get(\"data\").and_then(|v| v.as_array()) {\n            for item in data_array {\n                if let Ok(reading) = Self::parse_json_reading(item) {\n                    readings.push(reading);\n                }\n            }\n        }\n        // Format: {\"readings\": [readings...]}\n        else if let Some(readings_array) = value.get(\"readings\").and_then(|v| v.as_array()) {\n            for item in readings_array {\n                if let Ok(reading) = Self::parse_json_reading(item) {\n                    readings.push(reading);\n                }\n            }\n        }\n        \n        info!(\"Extracted {} temperature readings from JSON\", readings.len());\n        Ok(readings)\n    }\n    \n    fn parse_json_reading(value: \u0026serde_json::Value) -\u003e Result\u003cTemperatureReading\u003e {\n        let timestamp_str = value.get(\"timestamp\")\n            .or_else(|| value.get(\"time\"))\n            .or_else(|| value.get(\"date\"))\n            .and_then(|v| v.as_str())\n            .context(\"Missing timestamp in JSON\")?;\n        \n        let timestamp = Self::parse_timestamp(timestamp_str)?;\n        \n        let sensor_id = value.get(\"sensor_id\")\n            .or_else(|| value.get(\"sensor\"))\n            .or_else(|| value.get(\"device_id\"))\n            .and_then(|v| v.as_str())\n            .unwrap_or(\"unknown\")\n            .to_string();\n        \n        let temperature = value.get(\"temperature\")\n            .or_else(|| value.get(\"temp\"))\n            .and_then(|v| v.as_f64())\n            .context(\"Missing temperature in JSON\")?;\n        \n        let humidity = value.get(\"humidity\")\n            .or_else(|| value.get(\"hum\"))\n            .and_then(|v| v.as_f64());\n        \n        let location = value.get(\"location\")\n            .or_else(|| value.get(\"room\"))\n            .and_then(|v| v.as_str())\n            .map(|s| s.to_string());\n        \n        Ok(TemperatureReading {\n            sensor_id,\n            timestamp,\n            temperature,\n            humidity,\n            location,\n        })\n    }\n    \n    fn extract_from_xml(_content: \u0026[u8]) -\u003e Result\u003cVec\u003cTemperatureReading\u003e\u003e {\n        debug!(\"Extracting from XML file\");\n        // For now, return empty list\n        // XML implementation to be added according to specific X-Sense format\n        warn!(\"XML extraction not yet implemented\");\n        Ok(Vec::new())\n    }\n    \n    fn extract_from_text(content: \u0026[u8]) -\u003e Result\u003cVec\u003cTemperatureReading\u003e\u003e {\n        debug!(\"Extracting from text file\");\n        \n        let content_str = std::str::from_utf8(content)\n            .context(\"Unable to decode text content as UTF-8\")?;\n        \n        let mut readings = Vec::new();\n        \n        // Regex to capture common temperature patterns\n        let temp_regex = Regex::new(r\"(\\d{4}-\\d{2}-\\d{2}[\\sT]\\d{2}:\\d{2}:\\d{2})[^\\d]*(\\w+)[^\\d]*(-?\\d+\\.?\\d*)[¬∞C]*\")?;\n        \n        for line in content_str.lines() {\n            if let Some(captures) = temp_regex.captures(line) {\n                if let (Some(timestamp_str), Some(sensor_id), Some(temp_str)) = \n                   (captures.get(1), captures.get(2), captures.get(3)) {\n                    \n                    if let (Ok(timestamp), Ok(temperature)) = \n                       (Self::parse_timestamp(timestamp_str.as_str()), temp_str.as_str().parse::\u003cf64\u003e()) {\n                        \n                        readings.push(TemperatureReading {\n                            sensor_id: sensor_id.as_str().to_string(),\n                            timestamp,\n                            temperature,\n                            humidity: None,\n                            location: None,\n                        });\n                    }\n                }\n            }\n        }\n        \n        info!(\"Extracted {} temperature readings from text file\", readings.len());\n        Ok(readings)\n    }\n    \n    fn parse_timestamp(timestamp_str: \u0026str) -\u003e Result\u003cDateTime\u003cUtc\u003e\u003e {\n        // Try different timestamp formats\n        \n        // ISO 8601 format with timezone\n        if let Ok(dt) = DateTime::parse_from_rfc3339(timestamp_str) {\n            return Ok(dt.with_timezone(\u0026Utc));\n        }\n        \n        // ISO 8601 format without timezone (assume UTC)\n        if let Ok(naive_dt) = NaiveDateTime::parse_from_str(timestamp_str, \"%Y-%m-%d %H:%M:%S\") {\n            return Ok(DateTime::from_naive_utc_and_offset(naive_dt, Utc));\n        }\n        \n        // Format with T\n        if let Ok(naive_dt) = NaiveDateTime::parse_from_str(timestamp_str, \"%Y-%m-%dT%H:%M:%S\") {\n            return Ok(DateTime::from_naive_utc_and_offset(naive_dt, Utc));\n        }\n        \n        // European format\n        if let Ok(naive_dt) = NaiveDateTime::parse_from_str(timestamp_str, \"%d/%m/%Y %H:%M:%S\") {\n            return Ok(DateTime::from_naive_utc_and_offset(naive_dt, Utc));\n        }\n        \n        // American format\n        if let Ok(naive_dt) = NaiveDateTime::parse_from_str(timestamp_str, \"%m/%d/%Y %H:%M:%S\") {\n            return Ok(DateTime::from_naive_utc_and_offset(naive_dt, Utc));\n        }\n        \n        anyhow::bail!(\"Unsupported timestamp format: {}\", timestamp_str);\n    }\n}\n","traces":[{"line":23,"address":[5939408,5941617,5942053],"length":1,"stats":{"Line":1}},{"line":24,"address":[5939447,5939590],"length":1,"stats":{"Line":2}},{"line":27,"address":[6594729,6594396],"length":1,"stats":{"Line":1}},{"line":28,"address":[5939933,5940029,5940069],"length":1,"stats":{"Line":3}},{"line":30,"address":[8656251,8656577],"length":1,"stats":{"Line":2}},{"line":31,"address":[6595297,6595478,6595388],"length":1,"stats":{"Line":3}},{"line":32,"address":[8658097,8656833],"length":1,"stats":{"Line":2}},{"line":34,"address":[5715888,5715978,5715759],"length":1,"stats":{"Line":0}},{"line":35,"address":[6595698,6596671],"length":1,"stats":{"Line":0}},{"line":37,"address":[5940933,5940855,5940726],"length":1,"stats":{"Line":0}},{"line":38,"address":[5940973,5941685],"length":1,"stats":{"Line":0}},{"line":40,"address":[5716311,5716113,5716224],"length":1,"stats":{"Line":0}},{"line":41,"address":[8657346,8657799],"length":1,"stats":{"Line":0}},{"line":44,"address":[6596087,6595941,6596063],"length":1,"stats":{"Line":0}},{"line":45,"address":[6596361,6596077],"length":1,"stats":{"Line":0}},{"line":50,"address":[5943082,5942868,5942096],"length":1,"stats":{"Line":1}},{"line":54,"address":[5717641,5717339],"length":1,"stats":{"Line":2}},{"line":55,"address":[8658778,8658863],"length":1,"stats":{"Line":2}},{"line":56,"address":[5942775,5942726],"length":1,"stats":{"Line":2}},{"line":61,"address":[8659128],"length":1,"stats":{"Line":0}},{"line":66,"address":[6597872],"length":1,"stats":{"Line":0}},{"line":69,"address":[5947878,5948686,5943104],"length":1,"stats":{"Line":1}},{"line":70,"address":[6598161,6598055],"length":1,"stats":{"Line":2}},{"line":73,"address":[6598124],"length":1,"stats":{"Line":1}},{"line":74,"address":[6598466],"length":1,"stats":{"Line":1}},{"line":77,"address":[8659739],"length":1,"stats":{"Line":0}},{"line":81,"address":[6598692,6598668,6598512],"length":1,"stats":{"Line":3}},{"line":83,"address":[5943794],"length":1,"stats":{"Line":1}},{"line":84,"address":[8660415,8660347,8660496,8660575],"length":1,"stats":{"Line":4}},{"line":87,"address":[6599258,6599196,6599115],"length":1,"stats":{"Line":2}},{"line":90,"address":[5944652,5944449,5948613],"length":1,"stats":{"Line":1}},{"line":92,"address":[6599657,6599557],"length":1,"stats":{"Line":2}},{"line":95,"address":[8661305,8660971],"length":1,"stats":{"Line":2}},{"line":96,"address":[5945138,5948421],"length":1,"stats":{"Line":0}},{"line":100,"address":[5720509,5720279,5720368],"length":1,"stats":{"Line":3}},{"line":101,"address":[5723475,5723444,5721273,5721220,5720585],"length":1,"stats":{"Line":2}},{"line":103,"address":[8662788,8662721],"length":1,"stats":{"Line":2}},{"line":104,"address":[6602726,6602698,6601425],"length":1,"stats":{"Line":0}},{"line":109,"address":[6601489,6601402],"length":1,"stats":{"Line":2}},{"line":110,"address":[5946751,5946891,5947907],"length":1,"stats":{"Line":1}},{"line":111,"address":[9026266,9026240],"length":1,"stats":{"Line":0}},{"line":114,"address":[5946955],"length":1,"stats":{"Line":1}},{"line":115,"address":[6601963,6601828,6602669],"length":1,"stats":{"Line":1}},{"line":116,"address":[8030496,8030522],"length":1,"stats":{"Line":0}},{"line":119,"address":[6602017],"length":1,"stats":{"Line":1}},{"line":120,"address":[5947461,5947318,5947884],"length":1,"stats":{"Line":1}},{"line":121,"address":[9026752,9026778],"length":1,"stats":{"Line":0}},{"line":123,"address":[5947685],"length":1,"stats":{"Line":1}},{"line":124,"address":[5722594],"length":1,"stats":{"Line":1}},{"line":127,"address":[5722635],"length":1,"stats":{"Line":1}},{"line":128,"address":[8663861,8663776],"length":1,"stats":{"Line":2}},{"line":132,"address":[8661873,8661722],"length":1,"stats":{"Line":2}},{"line":133,"address":[8661788],"length":1,"stats":{"Line":1}},{"line":136,"address":[8664912],"length":1,"stats":{"Line":1}},{"line":138,"address":[8665087,8664939,8665154],"length":1,"stats":{"Line":2}},{"line":139,"address":[5948933,5948765],"length":1,"stats":{"Line":1}},{"line":142,"address":[8665193],"length":1,"stats":{"Line":1}},{"line":147,"address":[6605190,6605149,6603840],"length":1,"stats":{"Line":0}},{"line":148,"address":[5724215,5724392],"length":1,"stats":{"Line":0}},{"line":150,"address":[5949212,5949521],"length":1,"stats":{"Line":0}},{"line":154,"address":[5949587,5949778],"length":1,"stats":{"Line":0}},{"line":155,"address":[5950053,5949810,5949906],"length":1,"stats":{"Line":0}},{"line":156,"address":[6604665],"length":1,"stats":{"Line":0}},{"line":160,"address":[5949672,5950510],"length":1,"stats":{"Line":0}},{"line":163,"address":[6605328],"length":1,"stats":{"Line":0}},{"line":166,"address":[8023513,8023504],"length":1,"stats":{"Line":0}},{"line":167,"address":[5725845,5726388,5725911],"length":1,"stats":{"Line":0}},{"line":168,"address":[8667248,8667321,8667196],"length":1,"stats":{"Line":0}},{"line":169,"address":[6605928,6606012],"length":1,"stats":{"Line":0}},{"line":174,"address":[8667039,8667606],"length":1,"stats":{"Line":0}},{"line":175,"address":[8667686,8668165],"length":1,"stats":{"Line":0}},{"line":176,"address":[8667909,8667829],"length":1,"stats":{"Line":0}},{"line":177,"address":[8668013,8668101],"length":1,"stats":{"Line":0}},{"line":182,"address":[5726980,5727096,5726026],"length":1,"stats":{"Line":0}},{"line":183,"address":[5726994],"length":1,"stats":{"Line":0}},{"line":186,"address":[5953769,5953763,5952416],"length":1,"stats":{"Line":0}},{"line":187,"address":[5952634,5952466],"length":1,"stats":{"Line":0}},{"line":188,"address":[7816181,7816176],"length":1,"stats":{"Line":0}},{"line":189,"address":[7816213,7816208],"length":1,"stats":{"Line":0}},{"line":190,"address":[9027145,9027136],"length":1,"stats":{"Line":0}},{"line":193,"address":[6607343],"length":1,"stats":{"Line":0}},{"line":195,"address":[8669022],"length":1,"stats":{"Line":0}},{"line":196,"address":[7816277,7816272],"length":1,"stats":{"Line":0}},{"line":197,"address":[9027200,9027205],"length":1,"stats":{"Line":0}},{"line":198,"address":[8023728,8023737],"length":1,"stats":{"Line":0}},{"line":202,"address":[5953186,5952952,5953036],"length":1,"stats":{"Line":0}},{"line":203,"address":[8031269,8031264],"length":1,"stats":{"Line":0}},{"line":204,"address":[9027296,9027305],"length":1,"stats":{"Line":0}},{"line":207,"address":[8669447],"length":1,"stats":{"Line":0}},{"line":208,"address":[9027333,9027328],"length":1,"stats":{"Line":0}},{"line":209,"address":[8031369,8031360],"length":1,"stats":{"Line":0}},{"line":211,"address":[5728286],"length":1,"stats":{"Line":0}},{"line":212,"address":[7816501,7816496],"length":1,"stats":{"Line":0}},{"line":213,"address":[8023920,8023929],"length":1,"stats":{"Line":0}},{"line":214,"address":[9027478,9027456],"length":1,"stats":{"Line":0}},{"line":216,"address":[6608130],"length":1,"stats":{"Line":0}},{"line":217,"address":[5953513],"length":1,"stats":{"Line":0}},{"line":225,"address":[5953792],"length":1,"stats":{"Line":0}},{"line":226,"address":[5728775,5728704],"length":1,"stats":{"Line":0}},{"line":229,"address":[5728976,5728735],"length":1,"stats":{"Line":0}},{"line":230,"address":[5728911],"length":1,"stats":{"Line":0}},{"line":233,"address":[8670480,8673404,8673329],"length":1,"stats":{"Line":0}},{"line":234,"address":[6608887,6609064],"length":1,"stats":{"Line":0}},{"line":236,"address":[6609263,6608956],"length":1,"stats":{"Line":0}},{"line":239,"address":[6609325],"length":1,"stats":{"Line":0}},{"line":242,"address":[5954793,5954865],"length":1,"stats":{"Line":0}},{"line":244,"address":[5955077,5955128,5957145],"length":1,"stats":{"Line":0}},{"line":245,"address":[8672004,8671519],"length":1,"stats":{"Line":0}},{"line":246,"address":[6610837,6610868,6610921],"length":1,"stats":{"Line":0}},{"line":249,"address":[5956749,5956707],"length":1,"stats":{"Line":0}},{"line":252,"address":[5731794],"length":1,"stats":{"Line":0}},{"line":253,"address":[6611415,6611348],"length":1,"stats":{"Line":0}},{"line":256,"address":[8673123],"length":1,"stats":{"Line":0}},{"line":257,"address":[8673145],"length":1,"stats":{"Line":0}},{"line":264,"address":[6610007,6609862],"length":1,"stats":{"Line":0}},{"line":265,"address":[5730246],"length":1,"stats":{"Line":0}},{"line":268,"address":[6611744],"length":1,"stats":{"Line":0}},{"line":272,"address":[8673467,8673575],"length":1,"stats":{"Line":0}},{"line":273,"address":[6611899],"length":1,"stats":{"Line":0}},{"line":277,"address":[8673512,8673719],"length":1,"stats":{"Line":0}},{"line":278,"address":[5732377],"length":1,"stats":{"Line":0}},{"line":282,"address":[5732521,5732296],"length":1,"stats":{"Line":0}},{"line":283,"address":[5957700],"length":1,"stats":{"Line":0}},{"line":287,"address":[8674067,8673812],"length":1,"stats":{"Line":0}},{"line":288,"address":[8674097],"length":1,"stats":{"Line":0}},{"line":292,"address":[8673998,8674347],"length":1,"stats":{"Line":0}},{"line":293,"address":[8674377],"length":1,"stats":{"Line":0}},{"line":296,"address":[8674187],"length":1,"stats":{"Line":0}}],"covered":41,"coverable":128},{"path":["/","workspaces","homemetrics","src","xsense","mod.rs"],"content":"/// X-Sense temperature sensor email processing module\npub mod extractor;\npub mod processor;\n\npub use extractor::{TemperatureReading, TemperatureExtractor};\npub use processor::XSenseEmailProcessor;\n","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","homemetrics","src","xsense","processor.rs"],"content":"use anyhow::Result;\nuse log::{debug, info};\n\nuse crate::config::Config;\nuse crate::gmail_client::GmailClient;\nuse crate::database::Database;\nuse crate::slack_notifier::SlackNotifier;\nuse crate::attachment_parser::AttachmentParser;\nuse crate::email::{EmailProcessingStrategy, BaseEmailProcessor};\nuse super::extractor::TemperatureExtractor;\n\n/// X-Sense specific processing strategy\npub struct XSenseStrategy;\n\nimpl EmailProcessingStrategy for XSenseStrategy {\n    fn search_emails\u003c'a, 'b: 'a\u003e(\u0026'a self, gmail: \u0026'b GmailClient) -\u003e \n        std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003cVec\u003cString\u003e\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(gmail.search_xsense_emails())\n    }\n    \n    fn process_single_email\u003c'a, 'b: 'a, 'c: 'a\u003e(\n        \u0026'a self,\n        gmail: \u0026'b GmailClient,\n        database: Option\u003c\u0026'c Database\u003e,\n        slack: Option\u003c\u0026'c SlackNotifier\u003e,\n        message_id: \u0026'a str,\n        is_dry_run: bool,\n    ) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003cusize\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(async move {\n            debug!(\"Processing X-Sense email ID: {}\", message_id);\n            \n            // 1. Retrieve complete email information\n            let email_info = match gmail.fetch_email_complete(message_id).await {\n                Ok(info) =\u003e info,\n                Err(e) =\u003e {\n                    let (subject, from) = gmail.fetch_email_metadata(message_id)\n                        .await\n                        .unwrap_or((String::from(\"Unknown subject\"), String::from(\"Unknown sender\")));\n                    \n                    return Err(anyhow::anyhow!(\n                        \"Unable to retrieve complete email\\n  Subject: {}\\n  From: {}\\n  Error: {}\", \n                        subject, from, e\n                    ));\n                }\n            };\n            \n            // 2. In dry-run mode, display headers and date\n            if is_dry_run {\n                println!(\"üìã Headers:\");\n                println!(\"{}\", email_info.headers);\n                println!();\n                \n                println!(\"üìÖ Email date: {}\", email_info.date.format(\"%Y-%m-%d %H:%M:%S UTC\"));\n                println!();\n                println!(\"üìÑ Email content:\");\n                println!(\"   Size: {} bytes\", email_info.content.len());\n                println!();\n            }\n            \n            // 3. Parse attachments\n            let attachments = AttachmentParser::parse_email(\u0026email_info.content)?;\n            \n            if attachments.is_empty() {\n                if is_dry_run {\n                    println!(\"‚ö†Ô∏è  No attachments found in this email\");\n                }\n                return Ok(0);\n            }\n            \n            if is_dry_run {\n                println!(\"üìé Found {} attachment(s):\", attachments.len());\n                for (i, att) in attachments.iter().enumerate() {\n                    println!(\"   {}. {} ({} bytes, type: {})\", \n                             i + 1, att.filename, att.content.len(), att.content_type);\n                }\n                println!();\n            }\n            \n            // 4. Process each attachment\n            let mut total_readings = 0;\n            \n            for (index, attachment) in attachments.iter().enumerate() {\n                if is_dry_run {\n                    println!(\"üîç Processing attachment {}/{}: {}\", \n                             index + 1, attachments.len(), attachment.filename);\n                }\n                \n                match TemperatureExtractor::extract_from_attachment(attachment) {\n                    Ok(readings) =\u003e {\n                        if is_dry_run {\n                            Self::display_readings_dry_run(\u0026readings);\n                        } else if let Some(db) = database {\n                            // Save to database\n                            match db.save_temperature_readings(\u0026readings).await {\n                                Ok(count) =\u003e {\n                                    total_readings += count;\n                                    debug!(\"Saved {} readings from {}\", count, attachment.filename);\n                                }\n                                Err(e) =\u003e {\n                                    debug!(\"Error saving readings from {}: {}\", attachment.filename, e);\n                                }\n                            }\n                        }\n                    }\n                    Err(e) =\u003e {\n                        if is_dry_run {\n                            println!(\"   ‚ö†Ô∏è  Unable to extract data: {}\", e);\n                        }\n                    }\n                }\n            }\n            \n            // 5. Send Slack notification (if not dry-run and has data)\n            if !is_dry_run \u0026\u0026 total_readings \u003e 0 {\n                if let Some(slack) = slack {\n                    let message = format!(\n                        \"üìä New X-Sense data: {} temperature readings\\nFrom: {}\",\n                        total_readings,\n                        email_info.headers.lines().find(|l| l.starts_with(\"Subject:\"))\n                            .unwrap_or(\"Subject: Unknown\")\n                            .trim_start_matches(\"Subject:\")\n                            .trim()\n                    );\n                    info!(\"Sending Slack notification for X-Sense readings\");\n                    if let Err(e) = slack.send_message(\u0026message).await {\n                        debug!(\"Failed to send Slack notification: {}\", e);\n                    } else {\n                        debug!(\"Slack notification sent successfully\");\n                    }\n                }\n            }\n            \n            Ok(total_readings)\n        })\n    }\n    \n    fn mark_email_processed\u003c'a, 'b: 'a\u003e(\n        \u0026'a self,\n        gmail: \u0026'b GmailClient,\n        message_id: \u0026'a str,\n    ) -\u003e std::pin::Pin\u003cBox\u003cdyn std::future::Future\u003cOutput = Result\u003c()\u003e\u003e + Send + 'a\u003e\u003e {\n        Box::pin(gmail.mark_email_as_processed(message_id))\n    }\n    \n    fn processor_name(\u0026self) -\u003e \u0026str {\n        \"X-Sense\"\n    }\n    \n    fn label_name(\u0026self) -\u003e \u0026str {\n        \"homemetrics-todo-xsense\"\n    }\n}\n\nimpl XSenseStrategy {\n    fn display_readings_dry_run(readings: \u0026[crate::xsense::TemperatureReading]) {\n        if readings.is_empty() {\n            println!(\"   ‚ö†Ô∏è  No valid readings extracted\");\n            return;\n        }\n        \n        println!(\"   ‚úÖ Extracted {} reading(s):\", readings.len());\n        \n        // Group by sensor\n        let mut by_sensor: std::collections::HashMap\u003cString, Vec\u003c\u0026crate::xsense::TemperatureReading\u003e\u003e = \n            std::collections::HashMap::new();\n        \n        for reading in readings {\n            by_sensor.entry(reading.sensor_id.clone())\n                .or_insert_with(Vec::new)\n                .push(reading);\n        }\n        \n        for (sensor_id, sensor_readings) in by_sensor.iter() {\n            println!(\"\\n   üì° Sensor: {}\", sensor_id);\n            \n            // Display first and last reading\n            if let Some(first) = sensor_readings.first() {\n                let humidity_str = first.humidity\n                    .map(|h| format!(\"{:.1}%\", h))\n                    .unwrap_or_else(|| \"N/A\".to_string());\n                println!(\"      First: {} | Temp: {:.1}¬∞C | Humidity: {}\",\n                         first.timestamp.format(\"%Y-%m-%d %H:%M:%S\"),\n                         first.temperature,\n                         humidity_str);\n            }\n            \n            if sensor_readings.len() \u003e 1 {\n                if let Some(last) = sensor_readings.last() {\n                    let humidity_str = last.humidity\n                        .map(|h| format!(\"{:.1}%\", h))\n                        .unwrap_or_else(|| \"N/A\".to_string());\n                    println!(\"      Last:  {} | Temp: {:.1}¬∞C | Humidity: {}\",\n                             last.timestamp.format(\"%Y-%m-%d %H:%M:%S\"),\n                             last.temperature,\n                             humidity_str);\n                }\n                \n                if sensor_readings.len() \u003e 2 {\n                    println!(\"      ... {} more readings\", sensor_readings.len() - 2);\n                }\n            }\n        }\n        println!();\n    }\n}\n\n/// X-Sense email processor (wrapper around BaseEmailProcessor)\npub struct XSenseEmailProcessor {\n    base: BaseEmailProcessor\u003cXSenseStrategy\u003e,\n}\n\nimpl XSenseEmailProcessor {\n    pub async fn new(config: Config) -\u003e Result\u003cSelf\u003e {\n        Ok(XSenseEmailProcessor {\n            base: BaseEmailProcessor::new(config, XSenseStrategy).await?,\n        })\n    }\n    \n    pub fn new_dry_run(config: Config) -\u003e Result\u003cSelf\u003e {\n        Ok(XSenseEmailProcessor {\n            base: BaseEmailProcessor::new_dry_run(config, XSenseStrategy)?,\n        })\n    }\n    \n    pub async fn process_emails(\u0026self, limit: Option\u003cusize\u003e) -\u003e Result\u003cusize\u003e {\n        self.base.process_emails(limit).await\n    }\n    \n    pub async fn process_emails_dry_run(\u0026self, limit: Option\u003cusize\u003e) -\u003e Result\u003cusize\u003e {\n        self.base.process_emails_dry_run(limit).await\n    }\n}\n","traces":[{"line":16,"address":[5662768],"length":1,"stats":{"Line":0}},{"line":18,"address":[7603639],"length":1,"stats":{"Line":0}},{"line":21,"address":[6104448],"length":1,"stats":{"Line":0}},{"line":29,"address":[6104534],"length":1,"stats":{"Line":0}},{"line":30,"address":[7269563,7269790,7269847],"length":1,"stats":{"Line":0}},{"line":33,"address":[8307571,8307220,8307667,8307081],"length":1,"stats":{"Line":0}},{"line":34,"address":[4999122],"length":1,"stats":{"Line":0}},{"line":35,"address":[7270619],"length":1,"stats":{"Line":0}},{"line":36,"address":[5002257,5001899,4999075,5001641,5002304],"length":1,"stats":{"Line":0}},{"line":37,"address":[6746647],"length":1,"stats":{"Line":0}},{"line":38,"address":[5459204,5459248],"length":1,"stats":{"Line":0}},{"line":40,"address":[5002368,5002439],"length":1,"stats":{"Line":0}},{"line":41,"address":[],"length":0,"stats":{"Line":0}},{"line":42,"address":[],"length":0,"stats":{"Line":0}},{"line":48,"address":[7270745],"length":1,"stats":{"Line":0}},{"line":49,"address":[4999233,4999299],"length":1,"stats":{"Line":0}},{"line":50,"address":[8308278],"length":1,"stats":{"Line":0}},{"line":51,"address":[7278493],"length":1,"stats":{"Line":0}},{"line":53,"address":[7278538],"length":1,"stats":{"Line":0}},{"line":54,"address":[7271236],"length":1,"stats":{"Line":0}},{"line":55,"address":[4999694],"length":1,"stats":{"Line":0}},{"line":56,"address":[4999739],"length":1,"stats":{"Line":0}},{"line":57,"address":[7278969],"length":1,"stats":{"Line":0}},{"line":61,"address":[5001491,4999952,4999195],"length":1,"stats":{"Line":0}},{"line":63,"address":[7279241,7279332],"length":1,"stats":{"Line":0}},{"line":64,"address":[8309206],"length":1,"stats":{"Line":0}},{"line":65,"address":[8310373],"length":1,"stats":{"Line":0}},{"line":67,"address":[7280522],"length":1,"stats":{"Line":0}},{"line":70,"address":[5000227],"length":1,"stats":{"Line":0}},{"line":71,"address":[5000332],"length":1,"stats":{"Line":0}},{"line":72,"address":[5000474],"length":1,"stats":{"Line":0}},{"line":73,"address":[7280342,7280221,7280276],"length":1,"stats":{"Line":0}},{"line":74,"address":[7280303,7279926,7280213,7280248],"length":1,"stats":{"Line":0}},{"line":76,"address":[7279952],"length":1,"stats":{"Line":0}},{"line":80,"address":[7271879],"length":1,"stats":{"Line":0}},{"line":82,"address":[5000879,5004183,5001009,5000291],"length":1,"stats":{"Line":0}},{"line":83,"address":[5004277],"length":1,"stats":{"Line":0}},{"line":84,"address":[7277320,7277412],"length":1,"stats":{"Line":0}},{"line":85,"address":[7284791,7284851,7284872],"length":1,"stats":{"Line":0}},{"line":88,"address":[7277243,7277579],"length":1,"stats":{"Line":0}},{"line":89,"address":[7277672],"length":1,"stats":{"Line":0}},{"line":90,"address":[5005979],"length":1,"stats":{"Line":0}},{"line":91,"address":[7278002,7277790],"length":1,"stats":{"Line":0}},{"line":92,"address":[5006074,5005996],"length":1,"stats":{"Line":0}},{"line":94,"address":[7285361,7282380,7277203,7282032,7282066],"length":1,"stats":{"Line":0}},{"line":95,"address":[8312203],"length":1,"stats":{"Line":0}},{"line":96,"address":[8312219,8312325],"length":1,"stats":{"Line":0}},{"line":97,"address":[7282535,7282643,7282608],"length":1,"stats":{"Line":0}},{"line":99,"address":[7282394],"length":1,"stats":{"Line":0}},{"line":100,"address":[5003809,5003837,5003195],"length":1,"stats":{"Line":0}},{"line":105,"address":[5005872],"length":1,"stats":{"Line":0}},{"line":106,"address":[7277646],"length":1,"stats":{"Line":0}},{"line":107,"address":[8315245,8315296],"length":1,"stats":{"Line":0}},{"line":114,"address":[5004303],"length":1,"stats":{"Line":0}},{"line":115,"address":[7279367,7276121],"length":1,"stats":{"Line":0}},{"line":116,"address":[7276506,7276190],"length":1,"stats":{"Line":0}},{"line":117,"address":[],"length":0,"stats":{"Line":0}},{"line":118,"address":[],"length":0,"stats":{"Line":0}},{"line":119,"address":[7282224,7276224,7282238],"length":1,"stats":{"Line":0}},{"line":120,"address":[],"length":0,"stats":{"Line":0}},{"line":121,"address":[],"length":0,"stats":{"Line":0}},{"line":122,"address":[],"length":0,"stats":{"Line":0}},{"line":124,"address":[7284160,7284310,7284263],"length":1,"stats":{"Line":0}},{"line":125,"address":[5471372],"length":1,"stats":{"Line":0}},{"line":126,"address":[5006741,5006876,5006904],"length":1,"stats":{"Line":0}},{"line":128,"address":[8316210,8315743],"length":1,"stats":{"Line":0}},{"line":133,"address":[8313298],"length":1,"stats":{"Line":0}},{"line":137,"address":[7603872],"length":1,"stats":{"Line":0}},{"line":142,"address":[7603911],"length":1,"stats":{"Line":0}},{"line":145,"address":[7596464],"length":1,"stats":{"Line":0}},{"line":149,"address":[7596496],"length":1,"stats":{"Line":0}},{"line":155,"address":[7604032,7605799,7607036],"length":1,"stats":{"Line":0}},{"line":156,"address":[7596567],"length":1,"stats":{"Line":0}},{"line":157,"address":[5663370],"length":1,"stats":{"Line":0}},{"line":161,"address":[7604093],"length":1,"stats":{"Line":0}},{"line":164,"address":[5663326],"length":1,"stats":{"Line":0}},{"line":167,"address":[6105082,6104963],"length":1,"stats":{"Line":0}},{"line":168,"address":[7596969,7599437],"length":1,"stats":{"Line":0}},{"line":173,"address":[5663618],"length":1,"stats":{"Line":0}},{"line":174,"address":[7604708,7604802],"length":1,"stats":{"Line":0}},{"line":177,"address":[7597372],"length":1,"stats":{"Line":0}},{"line":178,"address":[6105686,6105732],"length":1,"stats":{"Line":0}},{"line":179,"address":[8316656,8316679],"length":1,"stats":{"Line":0}},{"line":180,"address":[7287264,7287276],"length":1,"stats":{"Line":0}},{"line":181,"address":[7597577],"length":1,"stats":{"Line":0}},{"line":187,"address":[7605023,7605810],"length":1,"stats":{"Line":0}},{"line":188,"address":[7605825],"length":1,"stats":{"Line":0}},{"line":189,"address":[7598433,7598487],"length":1,"stats":{"Line":0}},{"line":190,"address":[7287312,7287335],"length":1,"stats":{"Line":0}},{"line":191,"address":[8317260,8317248],"length":1,"stats":{"Line":0}},{"line":192,"address":[7606112],"length":1,"stats":{"Line":0}},{"line":198,"address":[7598468,7599249],"length":1,"stats":{"Line":0}},{"line":199,"address":[5665786],"length":1,"stats":{"Line":0}},{"line":203,"address":[6105442],"length":1,"stats":{"Line":0}},{"line":213,"address":[7280128,7280208,7280351,7280314,7280483,7280956],"length":1,"stats":{"Line":0}},{"line":214,"address":[7288358],"length":1,"stats":{"Line":0}},{"line":215,"address":[7280509,7280954,7280398,7280341,7280295],"length":1,"stats":{"Line":0}},{"line":219,"address":[6107744],"length":1,"stats":{"Line":0}},{"line":220,"address":[7607270],"length":1,"stats":{"Line":0}},{"line":221,"address":[7599632],"length":1,"stats":{"Line":0}},{"line":225,"address":[7281583,7281001,7280976,7281155,7281275,7281118],"length":1,"stats":{"Line":0}},{"line":226,"address":[7288805,7288603,7288706,7288649],"length":1,"stats":{"Line":0}},{"line":229,"address":[7281600,7281899,7281742,7281779,7281625,7282207],"length":1,"stats":{"Line":0}},{"line":230,"address":[7281769,7281723,7281925,7281826],"length":1,"stats":{"Line":0}}],"covered":0,"coverable":104},{"path":["/","workspaces","homemetrics","tests","blueriot_test.rs"],"content":"use std::fs;\nuse homemetrics::blueriot::extractor;\n\n#[test]\nfn test_extract_from_blueriot_email() {\n    // Load test email file\n    let email_content = fs::read(\"data_test/blueriot.eml\")\n        .expect(\"Failed to read test email file data_test/blueriot.eml\");\n    \n    // Parse email to extract text body\n    let parsed_email = mail_parser::MessageParser::default()\n        .parse(\u0026email_content)\n        .expect(\"Failed to parse email\");\n    \n    // Extract text from email body\n    let mut text_content = String::new();\n    \n    // Try to get text/plain body first\n    if let Some(text_body) = parsed_email.body_text(0) {\n        text_content.push_str(\u0026text_body);\n    }\n    \n    // If no text/plain, try text/html\n    if text_content.is_empty() {\n        if let Some(html_body) = parsed_email.body_html(0) {\n            // Simple HTML stripping\n            let html_str = html_body.to_string()\n                .replace(\"\u003cbr\u003e\", \"\\n\")\n                .replace(\"\u003cBR\u003e\", \"\\n\")\n                .replace(\"\u003c/p\u003e\", \"\\n\")\n                .replace(\"\u003c/P\u003e\", \"\\n\");\n            let tag_regex = regex::Regex::new(r\"\u003c[^\u003e]+\u003e\").unwrap();\n            text_content = tag_regex.replace_all(\u0026html_str, \"\").to_string();\n        }\n    }\n    \n    assert!(!text_content.is_empty(), \"No text content found in email\");\n    println!(\"üìß Email content extracted ({} chars)\", text_content.len());\n    \n    // Extract pool metrics\n    let email_date = chrono::Utc::now(); // Use current time for test\n    let pool_reading = extractor::extract_pool_metrics(\u0026text_content, email_date)\n        .expect(\"Failed to extract pool metrics\");\n    \n    println!(\"‚úÖ Pool metrics extracted:\");\n    \n    // Verify temperature\n    if let Some(temp) = pool_reading.temperature {\n        println!(\"   üå°Ô∏è  Temperature: {:.1}¬∞C\", temp);\n        assert!(temp \u003e 0.0 \u0026\u0026 temp \u003c 40.0, \n               \"Temperature {} should be in reasonable pool range\", temp);\n    }\n    \n    // Verify pH\n    if let Some(ph) = pool_reading.ph {\n        println!(\"   üß™ pH: {:.2}\", ph);\n        assert!(ph \u003e 0.0 \u0026\u0026 ph \u003c 14.0, \n               \"pH {} should be between 0 and 14\", ph);\n    }\n    \n    // Verify ORP\n    if let Some(orp) = pool_reading.orp {\n        println!(\"   ‚ö° ORP: {} mV\", orp);\n        assert!(orp \u003e -1000 \u0026\u0026 orp \u003c 1000, \n               \"ORP {} should be in reasonable range\", orp);\n    }\n    \n    // At least one metric should be present\n    assert!(\n        pool_reading.temperature.is_some() || \n        pool_reading.ph.is_some() || \n        pool_reading.orp.is_some(),\n        \"At least one pool metric should be extracted\"\n    );\n}\n\n#[test]\nfn test_extract_pool_metrics_from_text() {\n    let text_sample = r#\"\n        Bonjour,\n        \n        Voici les derni√®res mesures de votre piscine:\n        \n        Temp√©rature: 15,8¬∞C\n        pH: 6,80\n        ORP: 249 mV\n        \n        Cordialement,\n        Blue Riot\n    \"#;\n    \n    let email_date = chrono::Utc::now();\n    let pool_reading = extractor::extract_pool_metrics(text_sample, email_date)\n        .expect(\"Failed to extract pool metrics from sample text\");\n    \n    assert_eq!(pool_reading.temperature, Some(15.8));\n    assert_eq!(pool_reading.ph, Some(6.80));\n    assert_eq!(pool_reading.orp, Some(249));\n    \n    println!(\"‚úÖ Text parsing test passed:\");\n    println!(\"   Temperature: {:?}¬∞C\", pool_reading.temperature);\n    println!(\"   pH: {:?}\", pool_reading.ph);\n    println!(\"   ORP: {:?} mV\", pool_reading.orp);\n}\n\n#[test]\nfn test_extract_pool_metrics_various_formats() {\n    // Test with dots as decimal separator\n    let text1 = \"Temperature: 18.5¬∞C, pH: 7.2, ORP: 650 mV\";\n    let result1 = extractor::extract_pool_metrics(text1, chrono::Utc::now())\n        .expect(\"Failed to parse format 1\");\n    assert_eq!(result1.temperature, Some(18.5));\n    assert_eq!(result1.ph, Some(7.2));\n    assert_eq!(result1.orp, Some(650));\n    \n    // Test with commas as decimal separator\n    let text2 = \"Temp√©rature: 16,3¬∞C\\npH: 7,45\\nORP: 550 mV\";\n    let result2 = extractor::extract_pool_metrics(text2, chrono::Utc::now())\n        .expect(\"Failed to parse format 2\");\n    assert_eq!(result2.temperature, Some(16.3));\n    assert_eq!(result2.ph, Some(7.45));\n    assert_eq!(result2.orp, Some(550));\n    \n    println!(\"‚úÖ Various format parsing tests passed\");\n}\n","traces":[],"covered":0,"coverable":0},{"path":["/","workspaces","homemetrics","tests","xsense_test.rs"],"content":"use std::fs;\nuse homemetrics::attachment_parser::AttachmentParser;\nuse homemetrics::xsense::TemperatureExtractor;\n\n#[test]\nfn test_extract_from_xsense_email() {\n    // Load test email file\n    let email_content = fs::read(\"data_test/xsense.eml\")\n        .expect(\"Failed to read test email file data_test/xsense.eml\");\n    \n    // Parse email to extract attachments\n    let attachments = AttachmentParser::parse_email(\u0026email_content)\n        .expect(\"Failed to parse email\");\n    \n    assert!(!attachments.is_empty(), \"No attachments found in test email\");\n    println!(\"üìé Found {} attachment(s)\", attachments.len());\n    \n    // Extract temperature data from first attachment\n    let readings = TemperatureExtractor::extract_from_attachment(\u0026attachments[0])\n        .expect(\"Failed to extract temperature readings\");\n    \n    assert!(!readings.is_empty(), \"No temperature readings extracted\");\n    \n    // Verify data structure\n    for reading in \u0026readings {\n        assert!(!reading.sensor_id.is_empty(), \"Sensor ID should not be empty\");\n        assert!(reading.temperature \u003e -50.0 \u0026\u0026 reading.temperature \u003c 50.0, \n               \"Temperature {} should be in reasonable range\", reading.temperature);\n        if let Some(humidity) = reading.humidity {\n            assert!(humidity \u003e= 0.0 \u0026\u0026 humidity \u003c= 100.0, \n                   \"Humidity {} should be between 0 and 100\", humidity);\n        }\n    }\n    \n    println!(\"‚úÖ Extracted {} temperature readings from X-Sense email\", readings.len());\n    println!(\"   Sensor ID: {}\", readings[0].sensor_id);\n    println!(\"   First reading: {:.1}¬∞C at {}\", \n             readings[0].temperature, \n             readings[0].timestamp);\n    if let Some(humidity) = readings[0].humidity {\n        println!(\"   Humidity: {:.1}%\", humidity);\n    }\n}\n\n#[test]\nfn test_extract_sensor_name() {\n    // Test extracting sensor name from actual X-Sense filename format\n    assert_eq!(\n        TemperatureExtractor::extract_sensor_name(\"Thermo-cabane_Exporter les donn√©es_20251104.csv\").unwrap(),\n        \"cabane\"\n    );\n    \n    assert_eq!(\n        TemperatureExtractor::extract_sensor_name(\"Thermo-patio_Exporter les donn√©es_20251105.csv\").unwrap(),\n        \"patio\"\n    );\n}\n\n#[test]\nfn test_csv_parsing() {\n    // Test CSV parsing with actual X-Sense CSV format\n    let csv_content = b\"Temps,Temp\\xC3\\xA9rature_Celsius,Humidit\\xC3\\xA9 relative_Pourcentage\n2025/11/04 23:59,15.0,84.0\n2025/11/04 23:58,15.1,83.2\n2025/11/04 23:57,15.2,84.0\";\n    \n    let readings = TemperatureExtractor::extract_from_xsense_csv(csv_content, \"TEST_SENSOR\")\n        .expect(\"Failed to parse CSV\");\n    \n    assert_eq!(readings.len(), 3);\n    \n    // Check first reading\n    assert_eq!(readings[0].sensor_id, \"TEST_SENSOR\");\n    assert_eq!(readings[0].temperature, 15.0);\n    assert_eq!(readings[0].humidity, Some(84.0));\n    \n    println!(\"‚úÖ CSV parsing test passed:\");\n    println!(\"   Parsed {} readings\", readings.len());\n    println!(\"   First reading: {}¬∞C, {}% humidity\", \n             readings[0].temperature, \n             readings[0].humidity.unwrap());\n}\n","traces":[],"covered":0,"coverable":0}]};
    </script>
    <script crossorigin>/** @license React v16.13.1
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
'use strict';(function(d,r){"object"===typeof exports&&"undefined"!==typeof module?r(exports):"function"===typeof define&&define.amd?define(["exports"],r):(d=d||self,r(d.React={}))})(this,function(d){function r(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function w(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function da(){}function L(a,b,c){this.props=a;this.context=b;this.refs=ba;this.updater=c||ca}function ea(a,b,c){var g,e={},fa=null,d=null;if(null!=b)for(g in void 0!==b.ref&&(d=b.ref),void 0!==b.key&&(fa=""+b.key),b)ha.call(b,g)&&!ia.hasOwnProperty(g)&&(e[g]=b[g]);var h=arguments.length-2;if(1===h)e.children=c;else if(1<h){for(var k=Array(h),f=0;f<h;f++)k[f]=arguments[f+2];e.children=k}if(a&&a.defaultProps)for(g in h=a.defaultProps,
h)void 0===e[g]&&(e[g]=h[g]);return{$$typeof:x,type:a,key:fa,ref:d,props:e,_owner:M.current}}function va(a,b){return{$$typeof:x,type:a.type,key:b,ref:a.ref,props:a.props,_owner:a._owner}}function N(a){return"object"===typeof a&&null!==a&&a.$$typeof===x}function wa(a){var b={"=":"=0",":":"=2"};return"$"+(""+a).replace(/[=:]/g,function(a){return b[a]})}function ja(a,b,c,g){if(C.length){var e=C.pop();e.result=a;e.keyPrefix=b;e.func=c;e.context=g;e.count=0;return e}return{result:a,keyPrefix:b,func:c,
context:g,count:0}}function ka(a){a.result=null;a.keyPrefix=null;a.func=null;a.context=null;a.count=0;10>C.length&&C.push(a)}function O(a,b,c,g){var e=typeof a;if("undefined"===e||"boolean"===e)a=null;var d=!1;if(null===a)d=!0;else switch(e){case "string":case "number":d=!0;break;case "object":switch(a.$$typeof){case x:case xa:d=!0}}if(d)return c(g,a,""===b?"."+P(a,0):b),1;d=0;b=""===b?".":b+":";if(Array.isArray(a))for(var f=0;f<a.length;f++){e=a[f];var h=b+P(e,f);d+=O(e,h,c,g)}else if(null===a||
"object"!==typeof a?h=null:(h=la&&a[la]||a["@@iterator"],h="function"===typeof h?h:null),"function"===typeof h)for(a=h.call(a),f=0;!(e=a.next()).done;)e=e.value,h=b+P(e,f++),d+=O(e,h,c,g);else if("object"===e)throw c=""+a,Error(r(31,"[object Object]"===c?"object with keys {"+Object.keys(a).join(", ")+"}":c,""));return d}function Q(a,b,c){return null==a?0:O(a,"",b,c)}function P(a,b){return"object"===typeof a&&null!==a&&null!=a.key?wa(a.key):b.toString(36)}function ya(a,b,c){a.func.call(a.context,b,
a.count++)}function za(a,b,c){var g=a.result,e=a.keyPrefix;a=a.func.call(a.context,b,a.count++);Array.isArray(a)?R(a,g,c,function(a){return a}):null!=a&&(N(a)&&(a=va(a,e+(!a.key||b&&b.key===a.key?"":(""+a.key).replace(ma,"$&/")+"/")+c)),g.push(a))}function R(a,b,c,g,e){var d="";null!=c&&(d=(""+c).replace(ma,"$&/")+"/");b=ja(b,d,g,e);Q(a,za,b);ka(b)}function t(){var a=na.current;if(null===a)throw Error(r(321));return a}function S(a,b){var c=a.length;a.push(b);a:for(;;){var g=c-1>>>1,e=a[g];if(void 0!==
e&&0<D(e,b))a[g]=b,a[c]=e,c=g;else break a}}function n(a){a=a[0];return void 0===a?null:a}function E(a){var b=a[0];if(void 0!==b){var c=a.pop();if(c!==b){a[0]=c;a:for(var g=0,e=a.length;g<e;){var d=2*(g+1)-1,f=a[d],h=d+1,k=a[h];if(void 0!==f&&0>D(f,c))void 0!==k&&0>D(k,f)?(a[g]=k,a[h]=c,g=h):(a[g]=f,a[d]=c,g=d);else if(void 0!==k&&0>D(k,c))a[g]=k,a[h]=c,g=h;else break a}}return b}return null}function D(a,b){var c=a.sortIndex-b.sortIndex;return 0!==c?c:a.id-b.id}function F(a){for(var b=n(u);null!==
b;){if(null===b.callback)E(u);else if(b.startTime<=a)E(u),b.sortIndex=b.expirationTime,S(p,b);else break;b=n(u)}}function T(a){y=!1;F(a);if(!v)if(null!==n(p))v=!0,z(U);else{var b=n(u);null!==b&&G(T,b.startTime-a)}}function U(a,b){v=!1;y&&(y=!1,V());H=!0;var c=m;try{F(b);for(l=n(p);null!==l&&(!(l.expirationTime>b)||a&&!W());){var g=l.callback;if(null!==g){l.callback=null;m=l.priorityLevel;var e=g(l.expirationTime<=b);b=q();"function"===typeof e?l.callback=e:l===n(p)&&E(p);F(b)}else E(p);l=n(p)}if(null!==
l)var d=!0;else{var f=n(u);null!==f&&G(T,f.startTime-b);d=!1}return d}finally{l=null,m=c,H=!1}}function oa(a){switch(a){case 1:return-1;case 2:return 250;case 5:return 1073741823;case 4:return 1E4;default:return 5E3}}var f="function"===typeof Symbol&&Symbol.for,x=f?Symbol.for("react.element"):60103,xa=f?Symbol.for("react.portal"):60106,Aa=f?Symbol.for("react.fragment"):60107,Ba=f?Symbol.for("react.strict_mode"):60108,Ca=f?Symbol.for("react.profiler"):60114,Da=f?Symbol.for("react.provider"):60109,
Ea=f?Symbol.for("react.context"):60110,Fa=f?Symbol.for("react.forward_ref"):60112,Ga=f?Symbol.for("react.suspense"):60113,Ha=f?Symbol.for("react.memo"):60115,Ia=f?Symbol.for("react.lazy"):60116,la="function"===typeof Symbol&&Symbol.iterator,pa=Object.getOwnPropertySymbols,Ja=Object.prototype.hasOwnProperty,Ka=Object.prototype.propertyIsEnumerable,I=function(){try{if(!Object.assign)return!1;var a=new String("abc");a[5]="de";if("5"===Object.getOwnPropertyNames(a)[0])return!1;var b={};for(a=0;10>a;a++)b["_"+
String.fromCharCode(a)]=a;if("0123456789"!==Object.getOwnPropertyNames(b).map(function(a){return b[a]}).join(""))return!1;var c={};"abcdefghijklmnopqrst".split("").forEach(function(a){c[a]=a});return"abcdefghijklmnopqrst"!==Object.keys(Object.assign({},c)).join("")?!1:!0}catch(g){return!1}}()?Object.assign:function(a,b){if(null===a||void 0===a)throw new TypeError("Object.assign cannot be called with null or undefined");var c=Object(a);for(var g,e=1;e<arguments.length;e++){var d=Object(arguments[e]);
for(var f in d)Ja.call(d,f)&&(c[f]=d[f]);if(pa){g=pa(d);for(var h=0;h<g.length;h++)Ka.call(d,g[h])&&(c[g[h]]=d[g[h]])}}return c},ca={isMounted:function(a){return!1},enqueueForceUpdate:function(a,b,c){},enqueueReplaceState:function(a,b,c,d){},enqueueSetState:function(a,b,c,d){}},ba={};w.prototype.isReactComponent={};w.prototype.setState=function(a,b){if("object"!==typeof a&&"function"!==typeof a&&null!=a)throw Error(r(85));this.updater.enqueueSetState(this,a,b,"setState")};w.prototype.forceUpdate=
function(a){this.updater.enqueueForceUpdate(this,a,"forceUpdate")};da.prototype=w.prototype;f=L.prototype=new da;f.constructor=L;I(f,w.prototype);f.isPureReactComponent=!0;var M={current:null},ha=Object.prototype.hasOwnProperty,ia={key:!0,ref:!0,__self:!0,__source:!0},ma=/\/+/g,C=[],na={current:null},X;if("undefined"===typeof window||"function"!==typeof MessageChannel){var A=null,qa=null,ra=function(){if(null!==A)try{var a=q();A(!0,a);A=null}catch(b){throw setTimeout(ra,0),b;}},La=Date.now();var q=
function(){return Date.now()-La};var z=function(a){null!==A?setTimeout(z,0,a):(A=a,setTimeout(ra,0))};var G=function(a,b){qa=setTimeout(a,b)};var V=function(){clearTimeout(qa)};var W=function(){return!1};f=X=function(){}}else{var Y=window.performance,sa=window.Date,Ma=window.setTimeout,Na=window.clearTimeout;"undefined"!==typeof console&&(f=window.cancelAnimationFrame,"function"!==typeof window.requestAnimationFrame&&console.error("This browser doesn't support requestAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"),
"function"!==typeof f&&console.error("This browser doesn't support cancelAnimationFrame. Make sure that you load a polyfill in older browsers. https://fb.me/react-polyfills"));if("object"===typeof Y&&"function"===typeof Y.now)q=function(){return Y.now()};else{var Oa=sa.now();q=function(){return sa.now()-Oa}}var J=!1,K=null,Z=-1,ta=5,ua=0;W=function(){return q()>=ua};f=function(){};X=function(a){0>a||125<a?console.error("forceFrameRate takes a positive int between 0 and 125, forcing framerates higher than 125 fps is not unsupported"):
ta=0<a?Math.floor(1E3/a):5};var B=new MessageChannel,aa=B.port2;B.port1.onmessage=function(){if(null!==K){var a=q();ua=a+ta;try{K(!0,a)?aa.postMessage(null):(J=!1,K=null)}catch(b){throw aa.postMessage(null),b;}}else J=!1};z=function(a){K=a;J||(J=!0,aa.postMessage(null))};G=function(a,b){Z=Ma(function(){a(q())},b)};V=function(){Na(Z);Z=-1}}var p=[],u=[],Pa=1,l=null,m=3,H=!1,v=!1,y=!1,Qa=0;B={ReactCurrentDispatcher:na,ReactCurrentOwner:M,IsSomeRendererActing:{current:!1},assign:I};I(B,{Scheduler:{__proto__:null,
unstable_ImmediatePriority:1,unstable_UserBlockingPriority:2,unstable_NormalPriority:3,unstable_IdlePriority:5,unstable_LowPriority:4,unstable_runWithPriority:function(a,b){switch(a){case 1:case 2:case 3:case 4:case 5:break;default:a=3}var c=m;m=a;try{return b()}finally{m=c}},unstable_next:function(a){switch(m){case 1:case 2:case 3:var b=3;break;default:b=m}var c=m;m=b;try{return a()}finally{m=c}},unstable_scheduleCallback:function(a,b,c){var d=q();if("object"===typeof c&&null!==c){var e=c.delay;
e="number"===typeof e&&0<e?d+e:d;c="number"===typeof c.timeout?c.timeout:oa(a)}else c=oa(a),e=d;c=e+c;a={id:Pa++,callback:b,priorityLevel:a,startTime:e,expirationTime:c,sortIndex:-1};e>d?(a.sortIndex=e,S(u,a),null===n(p)&&a===n(u)&&(y?V():y=!0,G(T,e-d))):(a.sortIndex=c,S(p,a),v||H||(v=!0,z(U)));return a},unstable_cancelCallback:function(a){a.callback=null},unstable_wrapCallback:function(a){var b=m;return function(){var c=m;m=b;try{return a.apply(this,arguments)}finally{m=c}}},unstable_getCurrentPriorityLevel:function(){return m},
unstable_shouldYield:function(){var a=q();F(a);var b=n(p);return b!==l&&null!==l&&null!==b&&null!==b.callback&&b.startTime<=a&&b.expirationTime<l.expirationTime||W()},unstable_requestPaint:f,unstable_continueExecution:function(){v||H||(v=!0,z(U))},unstable_pauseExecution:function(){},unstable_getFirstCallbackNode:function(){return n(p)},get unstable_now(){return q},get unstable_forceFrameRate(){return X},unstable_Profiling:null},SchedulerTracing:{__proto__:null,__interactionsRef:null,__subscriberRef:null,
unstable_clear:function(a){return a()},unstable_getCurrent:function(){return null},unstable_getThreadID:function(){return++Qa},unstable_trace:function(a,b,c){return c()},unstable_wrap:function(a){return a},unstable_subscribe:function(a){},unstable_unsubscribe:function(a){}}});d.Children={map:function(a,b,c){if(null==a)return a;var d=[];R(a,d,null,b,c);return d},forEach:function(a,b,c){if(null==a)return a;b=ja(null,null,b,c);Q(a,ya,b);ka(b)},count:function(a){return Q(a,function(){return null},null)},
toArray:function(a){var b=[];R(a,b,null,function(a){return a});return b},only:function(a){if(!N(a))throw Error(r(143));return a}};d.Component=w;d.Fragment=Aa;d.Profiler=Ca;d.PureComponent=L;d.StrictMode=Ba;d.Suspense=Ga;d.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=B;d.cloneElement=function(a,b,c){if(null===a||void 0===a)throw Error(r(267,a));var d=I({},a.props),e=a.key,f=a.ref,m=a._owner;if(null!=b){void 0!==b.ref&&(f=b.ref,m=M.current);void 0!==b.key&&(e=""+b.key);if(a.type&&a.type.defaultProps)var h=
a.type.defaultProps;for(k in b)ha.call(b,k)&&!ia.hasOwnProperty(k)&&(d[k]=void 0===b[k]&&void 0!==h?h[k]:b[k])}var k=arguments.length-2;if(1===k)d.children=c;else if(1<k){h=Array(k);for(var l=0;l<k;l++)h[l]=arguments[l+2];d.children=h}return{$$typeof:x,type:a.type,key:e,ref:f,props:d,_owner:m}};d.createContext=function(a,b){void 0===b&&(b=null);a={$$typeof:Ea,_calculateChangedBits:b,_currentValue:a,_currentValue2:a,_threadCount:0,Provider:null,Consumer:null};a.Provider={$$typeof:Da,_context:a};return a.Consumer=
a};d.createElement=ea;d.createFactory=function(a){var b=ea.bind(null,a);b.type=a;return b};d.createRef=function(){return{current:null}};d.forwardRef=function(a){return{$$typeof:Fa,render:a}};d.isValidElement=N;d.lazy=function(a){return{$$typeof:Ia,_ctor:a,_status:-1,_result:null}};d.memo=function(a,b){return{$$typeof:Ha,type:a,compare:void 0===b?null:b}};d.useCallback=function(a,b){return t().useCallback(a,b)};d.useContext=function(a,b){return t().useContext(a,b)};d.useDebugValue=function(a,b){};
d.useEffect=function(a,b){return t().useEffect(a,b)};d.useImperativeHandle=function(a,b,c){return t().useImperativeHandle(a,b,c)};d.useLayoutEffect=function(a,b){return t().useLayoutEffect(a,b)};d.useMemo=function(a,b){return t().useMemo(a,b)};d.useReducer=function(a,b,c){return t().useReducer(a,b,c)};d.useRef=function(a){return t().useRef(a)};d.useState=function(a){return t().useState(a)};d.version="16.13.1"});
</script>
    <script crossorigin>/** @license React v16.13.1
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */
/*
 Modernizr 3.0.0pre (Custom Build) | MIT
*/
'use strict';(function(I,ea){"object"===typeof exports&&"undefined"!==typeof module?ea(exports,require("react")):"function"===typeof define&&define.amd?define(["exports","react"],ea):(I=I||self,ea(I.ReactDOM={},I.React))})(this,function(I,ea){function k(a){for(var b="https://reactjs.org/docs/error-decoder.html?invariant="+a,c=1;c<arguments.length;c++)b+="&args[]="+encodeURIComponent(arguments[c]);return"Minified React error #"+a+"; visit "+b+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}
function ji(a,b,c,d,e,f,g,h,m){yb=!1;gc=null;ki.apply(li,arguments)}function mi(a,b,c,d,e,f,g,h,m){ji.apply(this,arguments);if(yb){if(yb){var n=gc;yb=!1;gc=null}else throw Error(k(198));hc||(hc=!0,pd=n)}}function lf(a,b,c){var d=a.type||"unknown-event";a.currentTarget=mf(c);mi(d,b,void 0,a);a.currentTarget=null}function nf(){if(ic)for(var a in cb){var b=cb[a],c=ic.indexOf(a);if(!(-1<c))throw Error(k(96,a));if(!jc[c]){if(!b.extractEvents)throw Error(k(97,a));jc[c]=b;c=b.eventTypes;for(var d in c){var e=
void 0;var f=c[d],g=b,h=d;if(qd.hasOwnProperty(h))throw Error(k(99,h));qd[h]=f;var m=f.phasedRegistrationNames;if(m){for(e in m)m.hasOwnProperty(e)&&of(m[e],g,h);e=!0}else f.registrationName?(of(f.registrationName,g,h),e=!0):e=!1;if(!e)throw Error(k(98,d,a));}}}}function of(a,b,c){if(db[a])throw Error(k(100,a));db[a]=b;rd[a]=b.eventTypes[c].dependencies}function pf(a){var b=!1,c;for(c in a)if(a.hasOwnProperty(c)){var d=a[c];if(!cb.hasOwnProperty(c)||cb[c]!==d){if(cb[c])throw Error(k(102,c));cb[c]=
d;b=!0}}b&&nf()}function qf(a){if(a=rf(a)){if("function"!==typeof sd)throw Error(k(280));var b=a.stateNode;b&&(b=td(b),sd(a.stateNode,a.type,b))}}function sf(a){eb?fb?fb.push(a):fb=[a]:eb=a}function tf(){if(eb){var a=eb,b=fb;fb=eb=null;qf(a);if(b)for(a=0;a<b.length;a++)qf(b[a])}}function ud(){if(null!==eb||null!==fb)vd(),tf()}function uf(a,b,c){if(wd)return a(b,c);wd=!0;try{return vf(a,b,c)}finally{wd=!1,ud()}}function ni(a){if(wf.call(xf,a))return!0;if(wf.call(yf,a))return!1;if(oi.test(a))return xf[a]=
!0;yf[a]=!0;return!1}function pi(a,b,c,d){if(null!==c&&0===c.type)return!1;switch(typeof b){case "function":case "symbol":return!0;case "boolean":if(d)return!1;if(null!==c)return!c.acceptsBooleans;a=a.toLowerCase().slice(0,5);return"data-"!==a&&"aria-"!==a;default:return!1}}function qi(a,b,c,d){if(null===b||"undefined"===typeof b||pi(a,b,c,d))return!0;if(d)return!1;if(null!==c)switch(c.type){case 3:return!b;case 4:return!1===b;case 5:return isNaN(b);case 6:return isNaN(b)||1>b}return!1}function L(a,
b,c,d,e,f){this.acceptsBooleans=2===b||3===b||4===b;this.attributeName=d;this.attributeNamespace=e;this.mustUseProperty=c;this.propertyName=a;this.type=b;this.sanitizeURL=f}function xd(a,b,c,d){var e=E.hasOwnProperty(b)?E[b]:null;var f=null!==e?0===e.type:d?!1:!(2<b.length)||"o"!==b[0]&&"O"!==b[0]||"n"!==b[1]&&"N"!==b[1]?!1:!0;f||(qi(b,c,e,d)&&(c=null),d||null===e?ni(b)&&(null===c?a.removeAttribute(b):a.setAttribute(b,""+c)):e.mustUseProperty?a[e.propertyName]=null===c?3===e.type?!1:"":c:(b=e.attributeName,
d=e.attributeNamespace,null===c?a.removeAttribute(b):(e=e.type,c=3===e||4===e&&!0===c?"":""+c,d?a.setAttributeNS(d,b,c):a.setAttribute(b,c))))}function zb(a){if(null===a||"object"!==typeof a)return null;a=zf&&a[zf]||a["@@iterator"];return"function"===typeof a?a:null}function ri(a){if(-1===a._status){a._status=0;var b=a._ctor;b=b();a._result=b;b.then(function(b){0===a._status&&(b=b.default,a._status=1,a._result=b)},function(b){0===a._status&&(a._status=2,a._result=b)})}}function na(a){if(null==a)return null;
if("function"===typeof a)return a.displayName||a.name||null;if("string"===typeof a)return a;switch(a){case Ma:return"Fragment";case gb:return"Portal";case kc:return"Profiler";case Af:return"StrictMode";case lc:return"Suspense";case yd:return"SuspenseList"}if("object"===typeof a)switch(a.$$typeof){case Bf:return"Context.Consumer";case Cf:return"Context.Provider";case zd:var b=a.render;b=b.displayName||b.name||"";return a.displayName||(""!==b?"ForwardRef("+b+")":"ForwardRef");case Ad:return na(a.type);
case Df:return na(a.render);case Ef:if(a=1===a._status?a._result:null)return na(a)}return null}function Bd(a){var b="";do{a:switch(a.tag){case 3:case 4:case 6:case 7:case 10:case 9:var c="";break a;default:var d=a._debugOwner,e=a._debugSource,f=na(a.type);c=null;d&&(c=na(d.type));d=f;f="";e?f=" (at "+e.fileName.replace(si,"")+":"+e.lineNumber+")":c&&(f=" (created by "+c+")");c="\n    in "+(d||"Unknown")+f}b+=c;a=a.return}while(a);return b}function va(a){switch(typeof a){case "boolean":case "number":case "object":case "string":case "undefined":return a;
default:return""}}function Ff(a){var b=a.type;return(a=a.nodeName)&&"input"===a.toLowerCase()&&("checkbox"===b||"radio"===b)}function ti(a){var b=Ff(a)?"checked":"value",c=Object.getOwnPropertyDescriptor(a.constructor.prototype,b),d=""+a[b];if(!a.hasOwnProperty(b)&&"undefined"!==typeof c&&"function"===typeof c.get&&"function"===typeof c.set){var e=c.get,f=c.set;Object.defineProperty(a,b,{configurable:!0,get:function(){return e.call(this)},set:function(a){d=""+a;f.call(this,a)}});Object.defineProperty(a,
b,{enumerable:c.enumerable});return{getValue:function(){return d},setValue:function(a){d=""+a},stopTracking:function(){a._valueTracker=null;delete a[b]}}}}function mc(a){a._valueTracker||(a._valueTracker=ti(a))}function Gf(a){if(!a)return!1;var b=a._valueTracker;if(!b)return!0;var c=b.getValue();var d="";a&&(d=Ff(a)?a.checked?"true":"false":a.value);a=d;return a!==c?(b.setValue(a),!0):!1}function Cd(a,b){var c=b.checked;return M({},b,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:null!=
c?c:a._wrapperState.initialChecked})}function Hf(a,b){var c=null==b.defaultValue?"":b.defaultValue,d=null!=b.checked?b.checked:b.defaultChecked;c=va(null!=b.value?b.value:c);a._wrapperState={initialChecked:d,initialValue:c,controlled:"checkbox"===b.type||"radio"===b.type?null!=b.checked:null!=b.value}}function If(a,b){b=b.checked;null!=b&&xd(a,"checked",b,!1)}function Dd(a,b){If(a,b);var c=va(b.value),d=b.type;if(null!=c)if("number"===d){if(0===c&&""===a.value||a.value!=c)a.value=""+c}else a.value!==
""+c&&(a.value=""+c);else if("submit"===d||"reset"===d){a.removeAttribute("value");return}b.hasOwnProperty("value")?Ed(a,b.type,c):b.hasOwnProperty("defaultValue")&&Ed(a,b.type,va(b.defaultValue));null==b.checked&&null!=b.defaultChecked&&(a.defaultChecked=!!b.defaultChecked)}function Jf(a,b,c){if(b.hasOwnProperty("value")||b.hasOwnProperty("defaultValue")){var d=b.type;if(!("submit"!==d&&"reset"!==d||void 0!==b.value&&null!==b.value))return;b=""+a._wrapperState.initialValue;c||b===a.value||(a.value=
b);a.defaultValue=b}c=a.name;""!==c&&(a.name="");a.defaultChecked=!!a._wrapperState.initialChecked;""!==c&&(a.name=c)}function Ed(a,b,c){if("number"!==b||a.ownerDocument.activeElement!==a)null==c?a.defaultValue=""+a._wrapperState.initialValue:a.defaultValue!==""+c&&(a.defaultValue=""+c)}function ui(a){var b="";ea.Children.forEach(a,function(a){null!=a&&(b+=a)});return b}function Fd(a,b){a=M({children:void 0},b);if(b=ui(b.children))a.children=b;return a}function hb(a,b,c,d){a=a.options;if(b){b={};
for(var e=0;e<c.length;e++)b["$"+c[e]]=!0;for(c=0;c<a.length;c++)e=b.hasOwnProperty("$"+a[c].value),a[c].selected!==e&&(a[c].selected=e),e&&d&&(a[c].defaultSelected=!0)}else{c=""+va(c);b=null;for(e=0;e<a.length;e++){if(a[e].value===c){a[e].selected=!0;d&&(a[e].defaultSelected=!0);return}null!==b||a[e].disabled||(b=a[e])}null!==b&&(b.selected=!0)}}function Gd(a,b){if(null!=b.dangerouslySetInnerHTML)throw Error(k(91));return M({},b,{value:void 0,defaultValue:void 0,children:""+a._wrapperState.initialValue})}
function Kf(a,b){var c=b.value;if(null==c){c=b.children;b=b.defaultValue;if(null!=c){if(null!=b)throw Error(k(92));if(Array.isArray(c)){if(!(1>=c.length))throw Error(k(93));c=c[0]}b=c}null==b&&(b="");c=b}a._wrapperState={initialValue:va(c)}}function Lf(a,b){var c=va(b.value),d=va(b.defaultValue);null!=c&&(c=""+c,c!==a.value&&(a.value=c),null==b.defaultValue&&a.defaultValue!==c&&(a.defaultValue=c));null!=d&&(a.defaultValue=""+d)}function Mf(a,b){b=a.textContent;b===a._wrapperState.initialValue&&""!==
b&&null!==b&&(a.value=b)}function Nf(a){switch(a){case "svg":return"http://www.w3.org/2000/svg";case "math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Hd(a,b){return null==a||"http://www.w3.org/1999/xhtml"===a?Nf(b):"http://www.w3.org/2000/svg"===a&&"foreignObject"===b?"http://www.w3.org/1999/xhtml":a}function nc(a,b){var c={};c[a.toLowerCase()]=b.toLowerCase();c["Webkit"+a]="webkit"+b;c["Moz"+a]="moz"+b;return c}function oc(a){if(Id[a])return Id[a];
if(!ib[a])return a;var b=ib[a],c;for(c in b)if(b.hasOwnProperty(c)&&c in Of)return Id[a]=b[c];return a}function Jd(a){var b=Pf.get(a);void 0===b&&(b=new Map,Pf.set(a,b));return b}function Na(a){var b=a,c=a;if(a.alternate)for(;b.return;)b=b.return;else{a=b;do b=a,0!==(b.effectTag&1026)&&(c=b.return),a=b.return;while(a)}return 3===b.tag?c:null}function Qf(a){if(13===a.tag){var b=a.memoizedState;null===b&&(a=a.alternate,null!==a&&(b=a.memoizedState));if(null!==b)return b.dehydrated}return null}function Rf(a){if(Na(a)!==
a)throw Error(k(188));}function vi(a){var b=a.alternate;if(!b){b=Na(a);if(null===b)throw Error(k(188));return b!==a?null:a}for(var c=a,d=b;;){var e=c.return;if(null===e)break;var f=e.alternate;if(null===f){d=e.return;if(null!==d){c=d;continue}break}if(e.child===f.child){for(f=e.child;f;){if(f===c)return Rf(e),a;if(f===d)return Rf(e),b;f=f.sibling}throw Error(k(188));}if(c.return!==d.return)c=e,d=f;else{for(var g=!1,h=e.child;h;){if(h===c){g=!0;c=e;d=f;break}if(h===d){g=!0;d=e;c=f;break}h=h.sibling}if(!g){for(h=
f.child;h;){if(h===c){g=!0;c=f;d=e;break}if(h===d){g=!0;d=f;c=e;break}h=h.sibling}if(!g)throw Error(k(189));}}if(c.alternate!==d)throw Error(k(190));}if(3!==c.tag)throw Error(k(188));return c.stateNode.current===c?a:b}function Sf(a){a=vi(a);if(!a)return null;for(var b=a;;){if(5===b.tag||6===b.tag)return b;if(b.child)b.child.return=b,b=b.child;else{if(b===a)break;for(;!b.sibling;){if(!b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}}return null}function jb(a,b){if(null==
b)throw Error(k(30));if(null==a)return b;if(Array.isArray(a)){if(Array.isArray(b))return a.push.apply(a,b),a;a.push(b);return a}return Array.isArray(b)?[a].concat(b):[a,b]}function Kd(a,b,c){Array.isArray(a)?a.forEach(b,c):a&&b.call(c,a)}function pc(a){null!==a&&(Ab=jb(Ab,a));a=Ab;Ab=null;if(a){Kd(a,wi);if(Ab)throw Error(k(95));if(hc)throw a=pd,hc=!1,pd=null,a;}}function Ld(a){a=a.target||a.srcElement||window;a.correspondingUseElement&&(a=a.correspondingUseElement);return 3===a.nodeType?a.parentNode:
a}function Tf(a){if(!wa)return!1;a="on"+a;var b=a in document;b||(b=document.createElement("div"),b.setAttribute(a,"return;"),b="function"===typeof b[a]);return b}function Uf(a){a.topLevelType=null;a.nativeEvent=null;a.targetInst=null;a.ancestors.length=0;10>qc.length&&qc.push(a)}function Vf(a,b,c,d){if(qc.length){var e=qc.pop();e.topLevelType=a;e.eventSystemFlags=d;e.nativeEvent=b;e.targetInst=c;return e}return{topLevelType:a,eventSystemFlags:d,nativeEvent:b,targetInst:c,ancestors:[]}}function Wf(a){var b=
a.targetInst,c=b;do{if(!c){a.ancestors.push(c);break}var d=c;if(3===d.tag)d=d.stateNode.containerInfo;else{for(;d.return;)d=d.return;d=3!==d.tag?null:d.stateNode.containerInfo}if(!d)break;b=c.tag;5!==b&&6!==b||a.ancestors.push(c);c=Bb(d)}while(c);for(c=0;c<a.ancestors.length;c++){b=a.ancestors[c];var e=Ld(a.nativeEvent);d=a.topLevelType;var f=a.nativeEvent,g=a.eventSystemFlags;0===c&&(g|=64);for(var h=null,m=0;m<jc.length;m++){var n=jc[m];n&&(n=n.extractEvents(d,b,f,e,g))&&(h=jb(h,n))}pc(h)}}function Md(a,
b,c){if(!c.has(a)){switch(a){case "scroll":Cb(b,"scroll",!0);break;case "focus":case "blur":Cb(b,"focus",!0);Cb(b,"blur",!0);c.set("blur",null);c.set("focus",null);break;case "cancel":case "close":Tf(a)&&Cb(b,a,!0);break;case "invalid":case "submit":case "reset":break;default:-1===Db.indexOf(a)&&w(a,b)}c.set(a,null)}}function xi(a,b){var c=Jd(b);Nd.forEach(function(a){Md(a,b,c)});yi.forEach(function(a){Md(a,b,c)})}function Od(a,b,c,d,e){return{blockedOn:a,topLevelType:b,eventSystemFlags:c|32,nativeEvent:e,
container:d}}function Xf(a,b){switch(a){case "focus":case "blur":xa=null;break;case "dragenter":case "dragleave":ya=null;break;case "mouseover":case "mouseout":za=null;break;case "pointerover":case "pointerout":Eb.delete(b.pointerId);break;case "gotpointercapture":case "lostpointercapture":Fb.delete(b.pointerId)}}function Gb(a,b,c,d,e,f){if(null===a||a.nativeEvent!==f)return a=Od(b,c,d,e,f),null!==b&&(b=Hb(b),null!==b&&Yf(b)),a;a.eventSystemFlags|=d;return a}function zi(a,b,c,d,e){switch(b){case "focus":return xa=
Gb(xa,a,b,c,d,e),!0;case "dragenter":return ya=Gb(ya,a,b,c,d,e),!0;case "mouseover":return za=Gb(za,a,b,c,d,e),!0;case "pointerover":var f=e.pointerId;Eb.set(f,Gb(Eb.get(f)||null,a,b,c,d,e));return!0;case "gotpointercapture":return f=e.pointerId,Fb.set(f,Gb(Fb.get(f)||null,a,b,c,d,e)),!0}return!1}function Ai(a){var b=Bb(a.target);if(null!==b){var c=Na(b);if(null!==c)if(b=c.tag,13===b){if(b=Qf(c),null!==b){a.blockedOn=b;Pd(a.priority,function(){Bi(c)});return}}else if(3===b&&c.stateNode.hydrate){a.blockedOn=
3===c.tag?c.stateNode.containerInfo:null;return}}a.blockedOn=null}function rc(a){if(null!==a.blockedOn)return!1;var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);if(null!==b){var c=Hb(b);null!==c&&Yf(c);a.blockedOn=b;return!1}return!0}function Zf(a,b,c){rc(a)&&c.delete(b)}function Ci(){for(Rd=!1;0<fa.length;){var a=fa[0];if(null!==a.blockedOn){a=Hb(a.blockedOn);null!==a&&Di(a);break}var b=Qd(a.topLevelType,a.eventSystemFlags,a.container,a.nativeEvent);null!==b?a.blockedOn=b:fa.shift()}null!==
xa&&rc(xa)&&(xa=null);null!==ya&&rc(ya)&&(ya=null);null!==za&&rc(za)&&(za=null);Eb.forEach(Zf);Fb.forEach(Zf)}function Ib(a,b){a.blockedOn===b&&(a.blockedOn=null,Rd||(Rd=!0,$f(ag,Ci)))}function bg(a){if(0<fa.length){Ib(fa[0],a);for(var b=1;b<fa.length;b++){var c=fa[b];c.blockedOn===a&&(c.blockedOn=null)}}null!==xa&&Ib(xa,a);null!==ya&&Ib(ya,a);null!==za&&Ib(za,a);b=function(b){return Ib(b,a)};Eb.forEach(b);Fb.forEach(b);for(b=0;b<Jb.length;b++)c=Jb[b],c.blockedOn===a&&(c.blockedOn=null);for(;0<Jb.length&&
(b=Jb[0],null===b.blockedOn);)Ai(b),null===b.blockedOn&&Jb.shift()}function Sd(a,b){for(var c=0;c<a.length;c+=2){var d=a[c],e=a[c+1],f="on"+(e[0].toUpperCase()+e.slice(1));f={phasedRegistrationNames:{bubbled:f,captured:f+"Capture"},dependencies:[d],eventPriority:b};Td.set(d,b);cg.set(d,f);dg[e]=f}}function w(a,b){Cb(b,a,!1)}function Cb(a,b,c){var d=Td.get(b);switch(void 0===d?2:d){case 0:d=Ei.bind(null,b,1,a);break;case 1:d=Fi.bind(null,b,1,a);break;default:d=sc.bind(null,b,1,a)}c?a.addEventListener(b,
d,!0):a.addEventListener(b,d,!1)}function Ei(a,b,c,d){Oa||vd();var e=sc,f=Oa;Oa=!0;try{eg(e,a,b,c,d)}finally{(Oa=f)||ud()}}function Fi(a,b,c,d){Gi(Hi,sc.bind(null,a,b,c,d))}function sc(a,b,c,d){if(tc)if(0<fa.length&&-1<Nd.indexOf(a))a=Od(null,a,b,c,d),fa.push(a);else{var e=Qd(a,b,c,d);if(null===e)Xf(a,d);else if(-1<Nd.indexOf(a))a=Od(e,a,b,c,d),fa.push(a);else if(!zi(e,a,b,c,d)){Xf(a,d);a=Vf(a,d,null,b);try{uf(Wf,a)}finally{Uf(a)}}}}function Qd(a,b,c,d){c=Ld(d);c=Bb(c);if(null!==c){var e=Na(c);if(null===
e)c=null;else{var f=e.tag;if(13===f){c=Qf(e);if(null!==c)return c;c=null}else if(3===f){if(e.stateNode.hydrate)return 3===e.tag?e.stateNode.containerInfo:null;c=null}else e!==c&&(c=null)}}a=Vf(a,d,c,b);try{uf(Wf,a)}finally{Uf(a)}return null}function fg(a,b,c){return null==b||"boolean"===typeof b||""===b?"":c||"number"!==typeof b||0===b||Kb.hasOwnProperty(a)&&Kb[a]?(""+b).trim():b+"px"}function gg(a,b){a=a.style;for(var c in b)if(b.hasOwnProperty(c)){var d=0===c.indexOf("--"),e=fg(c,b[c],d);"float"===
c&&(c="cssFloat");d?a.setProperty(c,e):a[c]=e}}function Ud(a,b){if(b){if(Ii[a]&&(null!=b.children||null!=b.dangerouslySetInnerHTML))throw Error(k(137,a,""));if(null!=b.dangerouslySetInnerHTML){if(null!=b.children)throw Error(k(60));if(!("object"===typeof b.dangerouslySetInnerHTML&&"__html"in b.dangerouslySetInnerHTML))throw Error(k(61));}if(null!=b.style&&"object"!==typeof b.style)throw Error(k(62,""));}}function Vd(a,b){if(-1===a.indexOf("-"))return"string"===typeof b.is;switch(a){case "annotation-xml":case "color-profile":case "font-face":case "font-face-src":case "font-face-uri":case "font-face-format":case "font-face-name":case "missing-glyph":return!1;
default:return!0}}function oa(a,b){a=9===a.nodeType||11===a.nodeType?a:a.ownerDocument;var c=Jd(a);b=rd[b];for(var d=0;d<b.length;d++)Md(b[d],a,c)}function uc(){}function Wd(a){a=a||("undefined"!==typeof document?document:void 0);if("undefined"===typeof a)return null;try{return a.activeElement||a.body}catch(b){return a.body}}function hg(a){for(;a&&a.firstChild;)a=a.firstChild;return a}function ig(a,b){var c=hg(a);a=0;for(var d;c;){if(3===c.nodeType){d=a+c.textContent.length;if(a<=b&&d>=b)return{node:c,
offset:b-a};a=d}a:{for(;c;){if(c.nextSibling){c=c.nextSibling;break a}c=c.parentNode}c=void 0}c=hg(c)}}function jg(a,b){return a&&b?a===b?!0:a&&3===a.nodeType?!1:b&&3===b.nodeType?jg(a,b.parentNode):"contains"in a?a.contains(b):a.compareDocumentPosition?!!(a.compareDocumentPosition(b)&16):!1:!1}function kg(){for(var a=window,b=Wd();b instanceof a.HTMLIFrameElement;){try{var c="string"===typeof b.contentWindow.location.href}catch(d){c=!1}if(c)a=b.contentWindow;else break;b=Wd(a.document)}return b}
function Xd(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return b&&("input"===b&&("text"===a.type||"search"===a.type||"tel"===a.type||"url"===a.type||"password"===a.type)||"textarea"===b||"true"===a.contentEditable)}function lg(a,b){switch(a){case "button":case "input":case "select":case "textarea":return!!b.autoFocus}return!1}function Yd(a,b){return"textarea"===a||"option"===a||"noscript"===a||"string"===typeof b.children||"number"===typeof b.children||"object"===typeof b.dangerouslySetInnerHTML&&
null!==b.dangerouslySetInnerHTML&&null!=b.dangerouslySetInnerHTML.__html}function kb(a){for(;null!=a;a=a.nextSibling){var b=a.nodeType;if(1===b||3===b)break}return a}function mg(a){a=a.previousSibling;for(var b=0;a;){if(8===a.nodeType){var c=a.data;if(c===ng||c===Zd||c===$d){if(0===b)return a;b--}else c===og&&b++}a=a.previousSibling}return null}function Bb(a){var b=a[Aa];if(b)return b;for(var c=a.parentNode;c;){if(b=c[Lb]||c[Aa]){c=b.alternate;if(null!==b.child||null!==c&&null!==c.child)for(a=mg(a);null!==
a;){if(c=a[Aa])return c;a=mg(a)}return b}a=c;c=a.parentNode}return null}function Hb(a){a=a[Aa]||a[Lb];return!a||5!==a.tag&&6!==a.tag&&13!==a.tag&&3!==a.tag?null:a}function Pa(a){if(5===a.tag||6===a.tag)return a.stateNode;throw Error(k(33));}function ae(a){return a[vc]||null}function pa(a){do a=a.return;while(a&&5!==a.tag);return a?a:null}function pg(a,b){var c=a.stateNode;if(!c)return null;var d=td(c);if(!d)return null;c=d[b];a:switch(b){case "onClick":case "onClickCapture":case "onDoubleClick":case "onDoubleClickCapture":case "onMouseDown":case "onMouseDownCapture":case "onMouseMove":case "onMouseMoveCapture":case "onMouseUp":case "onMouseUpCapture":case "onMouseEnter":(d=
!d.disabled)||(a=a.type,d=!("button"===a||"input"===a||"select"===a||"textarea"===a));a=!d;break a;default:a=!1}if(a)return null;if(c&&"function"!==typeof c)throw Error(k(231,b,typeof c));return c}function qg(a,b,c){if(b=pg(a,c.dispatchConfig.phasedRegistrationNames[b]))c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a)}function Ji(a){if(a&&a.dispatchConfig.phasedRegistrationNames){for(var b=a._targetInst,c=[];b;)c.push(b),b=pa(b);for(b=c.length;0<b--;)qg(c[b],
"captured",a);for(b=0;b<c.length;b++)qg(c[b],"bubbled",a)}}function be(a,b,c){a&&c&&c.dispatchConfig.registrationName&&(b=pg(a,c.dispatchConfig.registrationName))&&(c._dispatchListeners=jb(c._dispatchListeners,b),c._dispatchInstances=jb(c._dispatchInstances,a))}function Ki(a){a&&a.dispatchConfig.registrationName&&be(a._targetInst,null,a)}function lb(a){Kd(a,Ji)}function rg(){if(wc)return wc;var a,b=ce,c=b.length,d,e="value"in Ba?Ba.value:Ba.textContent,f=e.length;for(a=0;a<c&&b[a]===e[a];a++);var g=
c-a;for(d=1;d<=g&&b[c-d]===e[f-d];d++);return wc=e.slice(a,1<d?1-d:void 0)}function xc(){return!0}function yc(){return!1}function R(a,b,c,d){this.dispatchConfig=a;this._targetInst=b;this.nativeEvent=c;a=this.constructor.Interface;for(var e in a)a.hasOwnProperty(e)&&((b=a[e])?this[e]=b(c):"target"===e?this.target=d:this[e]=c[e]);this.isDefaultPrevented=(null!=c.defaultPrevented?c.defaultPrevented:!1===c.returnValue)?xc:yc;this.isPropagationStopped=yc;return this}function Li(a,b,c,d){if(this.eventPool.length){var e=
this.eventPool.pop();this.call(e,a,b,c,d);return e}return new this(a,b,c,d)}function Mi(a){if(!(a instanceof this))throw Error(k(279));a.destructor();10>this.eventPool.length&&this.eventPool.push(a)}function sg(a){a.eventPool=[];a.getPooled=Li;a.release=Mi}function tg(a,b){switch(a){case "keyup":return-1!==Ni.indexOf(b.keyCode);case "keydown":return 229!==b.keyCode;case "keypress":case "mousedown":case "blur":return!0;default:return!1}}function ug(a){a=a.detail;return"object"===typeof a&&"data"in
a?a.data:null}function Oi(a,b){switch(a){case "compositionend":return ug(b);case "keypress":if(32!==b.which)return null;vg=!0;return wg;case "textInput":return a=b.data,a===wg&&vg?null:a;default:return null}}function Pi(a,b){if(mb)return"compositionend"===a||!de&&tg(a,b)?(a=rg(),wc=ce=Ba=null,mb=!1,a):null;switch(a){case "paste":return null;case "keypress":if(!(b.ctrlKey||b.altKey||b.metaKey)||b.ctrlKey&&b.altKey){if(b.char&&1<b.char.length)return b.char;if(b.which)return String.fromCharCode(b.which)}return null;
case "compositionend":return xg&&"ko"!==b.locale?null:b.data;default:return null}}function yg(a){var b=a&&a.nodeName&&a.nodeName.toLowerCase();return"input"===b?!!Qi[a.type]:"textarea"===b?!0:!1}function zg(a,b,c){a=R.getPooled(Ag.change,a,b,c);a.type="change";sf(c);lb(a);return a}function Ri(a){pc(a)}function zc(a){var b=Pa(a);if(Gf(b))return a}function Si(a,b){if("change"===a)return b}function Bg(){Mb&&(Mb.detachEvent("onpropertychange",Cg),Nb=Mb=null)}function Cg(a){if("value"===a.propertyName&&
zc(Nb))if(a=zg(Nb,a,Ld(a)),Oa)pc(a);else{Oa=!0;try{ee(Ri,a)}finally{Oa=!1,ud()}}}function Ti(a,b,c){"focus"===a?(Bg(),Mb=b,Nb=c,Mb.attachEvent("onpropertychange",Cg)):"blur"===a&&Bg()}function Ui(a,b){if("selectionchange"===a||"keyup"===a||"keydown"===a)return zc(Nb)}function Vi(a,b){if("click"===a)return zc(b)}function Wi(a,b){if("input"===a||"change"===a)return zc(b)}function Xi(a){var b=this.nativeEvent;return b.getModifierState?b.getModifierState(a):(a=Yi[a])?!!b[a]:!1}function fe(a){return Xi}
function Zi(a,b){return a===b&&(0!==a||1/a===1/b)||a!==a&&b!==b}function Ob(a,b){if(Qa(a,b))return!0;if("object"!==typeof a||null===a||"object"!==typeof b||null===b)return!1;var c=Object.keys(a),d=Object.keys(b);if(c.length!==d.length)return!1;for(d=0;d<c.length;d++)if(!$i.call(b,c[d])||!Qa(a[c[d]],b[c[d]]))return!1;return!0}function Dg(a,b){var c=b.window===b?b.document:9===b.nodeType?b:b.ownerDocument;if(ge||null==nb||nb!==Wd(c))return null;c=nb;"selectionStart"in c&&Xd(c)?c={start:c.selectionStart,
end:c.selectionEnd}:(c=(c.ownerDocument&&c.ownerDocument.defaultView||window).getSelection(),c={anchorNode:c.anchorNode,anchorOffset:c.anchorOffset,focusNode:c.focusNode,focusOffset:c.focusOffset});return Pb&&Ob(Pb,c)?null:(Pb=c,a=R.getPooled(Eg.select,he,a,b),a.type="select",a.target=nb,lb(a),a)}function Ac(a){var b=a.keyCode;"charCode"in a?(a=a.charCode,0===a&&13===b&&(a=13)):a=b;10===a&&(a=13);return 32<=a||13===a?a:0}function q(a,b){0>ob||(a.current=ie[ob],ie[ob]=null,ob--)}function y(a,b,c){ob++;
ie[ob]=a.current;a.current=b}function pb(a,b){var c=a.type.contextTypes;if(!c)return Ca;var d=a.stateNode;if(d&&d.__reactInternalMemoizedUnmaskedChildContext===b)return d.__reactInternalMemoizedMaskedChildContext;var e={},f;for(f in c)e[f]=b[f];d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=b,a.__reactInternalMemoizedMaskedChildContext=e);return e}function N(a){a=a.childContextTypes;return null!==a&&void 0!==a}function Fg(a,b,c){if(B.current!==Ca)throw Error(k(168));y(B,b);y(G,c)}
function Gg(a,b,c){var d=a.stateNode;a=b.childContextTypes;if("function"!==typeof d.getChildContext)return c;d=d.getChildContext();for(var e in d)if(!(e in a))throw Error(k(108,na(b)||"Unknown",e));return M({},c,{},d)}function Bc(a){a=(a=a.stateNode)&&a.__reactInternalMemoizedMergedChildContext||Ca;Ra=B.current;y(B,a);y(G,G.current);return!0}function Hg(a,b,c){var d=a.stateNode;if(!d)throw Error(k(169));c?(a=Gg(a,b,Ra),d.__reactInternalMemoizedMergedChildContext=a,q(G),q(B),y(B,a)):q(G);y(G,c)}function Cc(){switch(aj()){case Dc:return 99;
case Ig:return 98;case Jg:return 97;case Kg:return 96;case Lg:return 95;default:throw Error(k(332));}}function Mg(a){switch(a){case 99:return Dc;case 98:return Ig;case 97:return Jg;case 96:return Kg;case 95:return Lg;default:throw Error(k(332));}}function Da(a,b){a=Mg(a);return bj(a,b)}function Ng(a,b,c){a=Mg(a);return je(a,b,c)}function Og(a){null===qa?(qa=[a],Ec=je(Dc,Pg)):qa.push(a);return Qg}function ha(){if(null!==Ec){var a=Ec;Ec=null;Rg(a)}Pg()}function Pg(){if(!ke&&null!==qa){ke=!0;var a=0;
try{var b=qa;Da(99,function(){for(;a<b.length;a++){var c=b[a];do c=c(!0);while(null!==c)}});qa=null}catch(c){throw null!==qa&&(qa=qa.slice(a+1)),je(Dc,ha),c;}finally{ke=!1}}}function Fc(a,b,c){c/=10;return 1073741821-(((1073741821-a+b/10)/c|0)+1)*c}function aa(a,b){if(a&&a.defaultProps){b=M({},b);a=a.defaultProps;for(var c in a)void 0===b[c]&&(b[c]=a[c])}return b}function le(){Gc=qb=Hc=null}function me(a){var b=Ic.current;q(Ic);a.type._context._currentValue=b}function Sg(a,b){for(;null!==a;){var c=
a.alternate;if(a.childExpirationTime<b)a.childExpirationTime=b,null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);else if(null!==c&&c.childExpirationTime<b)c.childExpirationTime=b;else break;a=a.return}}function rb(a,b){Hc=a;Gc=qb=null;a=a.dependencies;null!==a&&null!==a.firstContext&&(a.expirationTime>=b&&(ia=!0),a.firstContext=null)}function W(a,b){if(Gc!==a&&!1!==b&&0!==b){if("number"!==typeof b||1073741823===b)Gc=a,b=1073741823;b={context:a,observedBits:b,next:null};if(null===qb){if(null===
Hc)throw Error(k(308));qb=b;Hc.dependencies={expirationTime:0,firstContext:b,responders:null}}else qb=qb.next=b}return a._currentValue}function ne(a){a.updateQueue={baseState:a.memoizedState,baseQueue:null,shared:{pending:null},effects:null}}function oe(a,b){a=a.updateQueue;b.updateQueue===a&&(b.updateQueue={baseState:a.baseState,baseQueue:a.baseQueue,shared:a.shared,effects:a.effects})}function Ea(a,b){a={expirationTime:a,suspenseConfig:b,tag:Tg,payload:null,callback:null,next:null};return a.next=
a}function Fa(a,b){a=a.updateQueue;if(null!==a){a=a.shared;var c=a.pending;null===c?b.next=b:(b.next=c.next,c.next=b);a.pending=b}}function Ug(a,b){var c=a.alternate;null!==c&&oe(c,a);a=a.updateQueue;c=a.baseQueue;null===c?(a.baseQueue=b.next=b,b.next=b):(b.next=c.next,c.next=b)}function Qb(a,b,c,d){var e=a.updateQueue;Ga=!1;var f=e.baseQueue,g=e.shared.pending;if(null!==g){if(null!==f){var h=f.next;f.next=g.next;g.next=h}f=g;e.shared.pending=null;h=a.alternate;null!==h&&(h=h.updateQueue,null!==h&&
(h.baseQueue=g))}if(null!==f){h=f.next;var m=e.baseState,n=0,k=null,ba=null,l=null;if(null!==h){var p=h;do{g=p.expirationTime;if(g<d){var t={expirationTime:p.expirationTime,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null};null===l?(ba=l=t,k=m):l=l.next=t;g>n&&(n=g)}else{null!==l&&(l=l.next={expirationTime:1073741823,suspenseConfig:p.suspenseConfig,tag:p.tag,payload:p.payload,callback:p.callback,next:null});Vg(g,p.suspenseConfig);a:{var q=a,r=p;g=b;t=c;switch(r.tag){case 1:q=
r.payload;if("function"===typeof q){m=q.call(t,m,g);break a}m=q;break a;case 3:q.effectTag=q.effectTag&-4097|64;case Tg:q=r.payload;g="function"===typeof q?q.call(t,m,g):q;if(null===g||void 0===g)break a;m=M({},m,g);break a;case Jc:Ga=!0}}null!==p.callback&&(a.effectTag|=32,g=e.effects,null===g?e.effects=[p]:g.push(p))}p=p.next;if(null===p||p===h)if(g=e.shared.pending,null===g)break;else p=f.next=g.next,g.next=h,e.baseQueue=f=g,e.shared.pending=null}while(1)}null===l?k=m:l.next=ba;e.baseState=k;e.baseQueue=
l;Kc(n);a.expirationTime=n;a.memoizedState=m}}function Wg(a,b,c){a=b.effects;b.effects=null;if(null!==a)for(b=0;b<a.length;b++){var d=a[b],e=d.callback;if(null!==e){d.callback=null;d=e;e=c;if("function"!==typeof d)throw Error(k(191,d));d.call(e)}}}function Lc(a,b,c,d){b=a.memoizedState;c=c(d,b);c=null===c||void 0===c?b:M({},b,c);a.memoizedState=c;0===a.expirationTime&&(a.updateQueue.baseState=c)}function Xg(a,b,c,d,e,f,g){a=a.stateNode;return"function"===typeof a.shouldComponentUpdate?a.shouldComponentUpdate(d,
f,g):b.prototype&&b.prototype.isPureReactComponent?!Ob(c,d)||!Ob(e,f):!0}function Yg(a,b,c){var d=!1,e=Ca;var f=b.contextType;"object"===typeof f&&null!==f?f=W(f):(e=N(b)?Ra:B.current,d=b.contextTypes,f=(d=null!==d&&void 0!==d)?pb(a,e):Ca);b=new b(c,f);a.memoizedState=null!==b.state&&void 0!==b.state?b.state:null;b.updater=Mc;a.stateNode=b;b._reactInternalFiber=a;d&&(a=a.stateNode,a.__reactInternalMemoizedUnmaskedChildContext=e,a.__reactInternalMemoizedMaskedChildContext=f);return b}function Zg(a,
b,c,d){a=b.state;"function"===typeof b.componentWillReceiveProps&&b.componentWillReceiveProps(c,d);"function"===typeof b.UNSAFE_componentWillReceiveProps&&b.UNSAFE_componentWillReceiveProps(c,d);b.state!==a&&Mc.enqueueReplaceState(b,b.state,null)}function pe(a,b,c,d){var e=a.stateNode;e.props=c;e.state=a.memoizedState;e.refs=$g;ne(a);var f=b.contextType;"object"===typeof f&&null!==f?e.context=W(f):(f=N(b)?Ra:B.current,e.context=pb(a,f));Qb(a,c,e,d);e.state=a.memoizedState;f=b.getDerivedStateFromProps;
"function"===typeof f&&(Lc(a,b,f,c),e.state=a.memoizedState);"function"===typeof b.getDerivedStateFromProps||"function"===typeof e.getSnapshotBeforeUpdate||"function"!==typeof e.UNSAFE_componentWillMount&&"function"!==typeof e.componentWillMount||(b=e.state,"function"===typeof e.componentWillMount&&e.componentWillMount(),"function"===typeof e.UNSAFE_componentWillMount&&e.UNSAFE_componentWillMount(),b!==e.state&&Mc.enqueueReplaceState(e,e.state,null),Qb(a,c,e,d),e.state=a.memoizedState);"function"===
typeof e.componentDidMount&&(a.effectTag|=4)}function Rb(a,b,c){a=c.ref;if(null!==a&&"function"!==typeof a&&"object"!==typeof a){if(c._owner){c=c._owner;if(c){if(1!==c.tag)throw Error(k(309));var d=c.stateNode}if(!d)throw Error(k(147,a));var e=""+a;if(null!==b&&null!==b.ref&&"function"===typeof b.ref&&b.ref._stringRef===e)return b.ref;b=function(a){var b=d.refs;b===$g&&(b=d.refs={});null===a?delete b[e]:b[e]=a};b._stringRef=e;return b}if("string"!==typeof a)throw Error(k(284));if(!c._owner)throw Error(k(290,
a));}return a}function Nc(a,b){if("textarea"!==a.type)throw Error(k(31,"[object Object]"===Object.prototype.toString.call(b)?"object with keys {"+Object.keys(b).join(", ")+"}":b,""));}function ah(a){function b(b,c){if(a){var d=b.lastEffect;null!==d?(d.nextEffect=c,b.lastEffect=c):b.firstEffect=b.lastEffect=c;c.nextEffect=null;c.effectTag=8}}function c(c,d){if(!a)return null;for(;null!==d;)b(c,d),d=d.sibling;return null}function d(a,b){for(a=new Map;null!==b;)null!==b.key?a.set(b.key,b):a.set(b.index,
b),b=b.sibling;return a}function e(a,b){a=Sa(a,b);a.index=0;a.sibling=null;return a}function f(b,c,d){b.index=d;if(!a)return c;d=b.alternate;if(null!==d)return d=d.index,d<c?(b.effectTag=2,c):d;b.effectTag=2;return c}function g(b){a&&null===b.alternate&&(b.effectTag=2);return b}function h(a,b,c,d){if(null===b||6!==b.tag)return b=qe(c,a.mode,d),b.return=a,b;b=e(b,c);b.return=a;return b}function m(a,b,c,d){if(null!==b&&b.elementType===c.type)return d=e(b,c.props),d.ref=Rb(a,b,c),d.return=a,d;d=Oc(c.type,
c.key,c.props,null,a.mode,d);d.ref=Rb(a,b,c);d.return=a;return d}function n(a,b,c,d){if(null===b||4!==b.tag||b.stateNode.containerInfo!==c.containerInfo||b.stateNode.implementation!==c.implementation)return b=re(c,a.mode,d),b.return=a,b;b=e(b,c.children||[]);b.return=a;return b}function l(a,b,c,d,f){if(null===b||7!==b.tag)return b=Ha(c,a.mode,d,f),b.return=a,b;b=e(b,c);b.return=a;return b}function ba(a,b,c){if("string"===typeof b||"number"===typeof b)return b=qe(""+b,a.mode,c),b.return=a,b;if("object"===
typeof b&&null!==b){switch(b.$$typeof){case Pc:return c=Oc(b.type,b.key,b.props,null,a.mode,c),c.ref=Rb(a,null,b),c.return=a,c;case gb:return b=re(b,a.mode,c),b.return=a,b}if(Qc(b)||zb(b))return b=Ha(b,a.mode,c,null),b.return=a,b;Nc(a,b)}return null}function p(a,b,c,d){var e=null!==b?b.key:null;if("string"===typeof c||"number"===typeof c)return null!==e?null:h(a,b,""+c,d);if("object"===typeof c&&null!==c){switch(c.$$typeof){case Pc:return c.key===e?c.type===Ma?l(a,b,c.props.children,d,e):m(a,b,c,
d):null;case gb:return c.key===e?n(a,b,c,d):null}if(Qc(c)||zb(c))return null!==e?null:l(a,b,c,d,null);Nc(a,c)}return null}function t(a,b,c,d,e){if("string"===typeof d||"number"===typeof d)return a=a.get(c)||null,h(b,a,""+d,e);if("object"===typeof d&&null!==d){switch(d.$$typeof){case Pc:return a=a.get(null===d.key?c:d.key)||null,d.type===Ma?l(b,a,d.props.children,e,d.key):m(b,a,d,e);case gb:return a=a.get(null===d.key?c:d.key)||null,n(b,a,d,e)}if(Qc(d)||zb(d))return a=a.get(c)||null,l(b,a,d,e,null);
Nc(b,d)}return null}function q(e,g,h,m){for(var n=null,k=null,l=g,r=g=0,C=null;null!==l&&r<h.length;r++){l.index>r?(C=l,l=null):C=l.sibling;var O=p(e,l,h[r],m);if(null===O){null===l&&(l=C);break}a&&l&&null===O.alternate&&b(e,l);g=f(O,g,r);null===k?n=O:k.sibling=O;k=O;l=C}if(r===h.length)return c(e,l),n;if(null===l){for(;r<h.length;r++)l=ba(e,h[r],m),null!==l&&(g=f(l,g,r),null===k?n=l:k.sibling=l,k=l);return n}for(l=d(e,l);r<h.length;r++)C=t(l,e,r,h[r],m),null!==C&&(a&&null!==C.alternate&&l.delete(null===
C.key?r:C.key),g=f(C,g,r),null===k?n=C:k.sibling=C,k=C);a&&l.forEach(function(a){return b(e,a)});return n}function w(e,g,h,n){var m=zb(h);if("function"!==typeof m)throw Error(k(150));h=m.call(h);if(null==h)throw Error(k(151));for(var l=m=null,r=g,C=g=0,O=null,v=h.next();null!==r&&!v.done;C++,v=h.next()){r.index>C?(O=r,r=null):O=r.sibling;var q=p(e,r,v.value,n);if(null===q){null===r&&(r=O);break}a&&r&&null===q.alternate&&b(e,r);g=f(q,g,C);null===l?m=q:l.sibling=q;l=q;r=O}if(v.done)return c(e,r),m;
if(null===r){for(;!v.done;C++,v=h.next())v=ba(e,v.value,n),null!==v&&(g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);return m}for(r=d(e,r);!v.done;C++,v=h.next())v=t(r,e,C,v.value,n),null!==v&&(a&&null!==v.alternate&&r.delete(null===v.key?C:v.key),g=f(v,g,C),null===l?m=v:l.sibling=v,l=v);a&&r.forEach(function(a){return b(e,a)});return m}return function(a,d,f,h){var m="object"===typeof f&&null!==f&&f.type===Ma&&null===f.key;m&&(f=f.props.children);var n="object"===typeof f&&null!==f;if(n)switch(f.$$typeof){case Pc:a:{n=
f.key;for(m=d;null!==m;){if(m.key===n){switch(m.tag){case 7:if(f.type===Ma){c(a,m.sibling);d=e(m,f.props.children);d.return=a;a=d;break a}break;default:if(m.elementType===f.type){c(a,m.sibling);d=e(m,f.props);d.ref=Rb(a,m,f);d.return=a;a=d;break a}}c(a,m);break}else b(a,m);m=m.sibling}f.type===Ma?(d=Ha(f.props.children,a.mode,h,f.key),d.return=a,a=d):(h=Oc(f.type,f.key,f.props,null,a.mode,h),h.ref=Rb(a,d,f),h.return=a,a=h)}return g(a);case gb:a:{for(m=f.key;null!==d;){if(d.key===m)if(4===d.tag&&d.stateNode.containerInfo===
f.containerInfo&&d.stateNode.implementation===f.implementation){c(a,d.sibling);d=e(d,f.children||[]);d.return=a;a=d;break a}else{c(a,d);break}else b(a,d);d=d.sibling}d=re(f,a.mode,h);d.return=a;a=d}return g(a)}if("string"===typeof f||"number"===typeof f)return f=""+f,null!==d&&6===d.tag?(c(a,d.sibling),d=e(d,f),d.return=a,a=d):(c(a,d),d=qe(f,a.mode,h),d.return=a,a=d),g(a);if(Qc(f))return q(a,d,f,h);if(zb(f))return w(a,d,f,h);n&&Nc(a,f);if("undefined"===typeof f&&!m)switch(a.tag){case 1:case 0:throw a=
a.type,Error(k(152,a.displayName||a.name||"Component"));}return c(a,d)}}function Ta(a){if(a===Sb)throw Error(k(174));return a}function se(a,b){y(Tb,b);y(Ub,a);y(ja,Sb);a=b.nodeType;switch(a){case 9:case 11:b=(b=b.documentElement)?b.namespaceURI:Hd(null,"");break;default:a=8===a?b.parentNode:b,b=a.namespaceURI||null,a=a.tagName,b=Hd(b,a)}q(ja);y(ja,b)}function tb(a){q(ja);q(Ub);q(Tb)}function bh(a){Ta(Tb.current);var b=Ta(ja.current);var c=Hd(b,a.type);b!==c&&(y(Ub,a),y(ja,c))}function te(a){Ub.current===
a&&(q(ja),q(Ub))}function Rc(a){for(var b=a;null!==b;){if(13===b.tag){var c=b.memoizedState;if(null!==c&&(c=c.dehydrated,null===c||c.data===$d||c.data===Zd))return b}else if(19===b.tag&&void 0!==b.memoizedProps.revealOrder){if(0!==(b.effectTag&64))return b}else if(null!==b.child){b.child.return=b;b=b.child;continue}if(b===a)break;for(;null===b.sibling;){if(null===b.return||b.return===a)return null;b=b.return}b.sibling.return=b.return;b=b.sibling}return null}function ue(a,b){return{responder:a,props:b}}
function S(){throw Error(k(321));}function ve(a,b){if(null===b)return!1;for(var c=0;c<b.length&&c<a.length;c++)if(!Qa(a[c],b[c]))return!1;return!0}function we(a,b,c,d,e,f){Ia=f;z=b;b.memoizedState=null;b.updateQueue=null;b.expirationTime=0;Sc.current=null===a||null===a.memoizedState?dj:ej;a=c(d,e);if(b.expirationTime===Ia){f=0;do{b.expirationTime=0;if(!(25>f))throw Error(k(301));f+=1;J=K=null;b.updateQueue=null;Sc.current=fj;a=c(d,e)}while(b.expirationTime===Ia)}Sc.current=Tc;b=null!==K&&null!==K.next;
Ia=0;J=K=z=null;Uc=!1;if(b)throw Error(k(300));return a}function ub(){var a={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};null===J?z.memoizedState=J=a:J=J.next=a;return J}function vb(){if(null===K){var a=z.alternate;a=null!==a?a.memoizedState:null}else a=K.next;var b=null===J?z.memoizedState:J.next;if(null!==b)J=b,K=a;else{if(null===a)throw Error(k(310));K=a;a={memoizedState:K.memoizedState,baseState:K.baseState,baseQueue:K.baseQueue,queue:K.queue,next:null};null===J?z.memoizedState=
J=a:J=J.next=a}return J}function Ua(a,b){return"function"===typeof b?b(a):b}function Vc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=K,e=d.baseQueue,f=c.pending;if(null!==f){if(null!==e){var g=e.next;e.next=f.next;f.next=g}d.baseQueue=e=f;c.pending=null}if(null!==e){e=e.next;d=d.baseState;var h=g=f=null,m=e;do{var n=m.expirationTime;if(n<Ia){var l={expirationTime:m.expirationTime,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,
next:null};null===h?(g=h=l,f=d):h=h.next=l;n>z.expirationTime&&(z.expirationTime=n,Kc(n))}else null!==h&&(h=h.next={expirationTime:1073741823,suspenseConfig:m.suspenseConfig,action:m.action,eagerReducer:m.eagerReducer,eagerState:m.eagerState,next:null}),Vg(n,m.suspenseConfig),d=m.eagerReducer===a?m.eagerState:a(d,m.action);m=m.next}while(null!==m&&m!==e);null===h?f=d:h.next=g;Qa(d,b.memoizedState)||(ia=!0);b.memoizedState=d;b.baseState=f;b.baseQueue=h;c.lastRenderedState=d}return[b.memoizedState,
c.dispatch]}function Wc(a,b,c){b=vb();c=b.queue;if(null===c)throw Error(k(311));c.lastRenderedReducer=a;var d=c.dispatch,e=c.pending,f=b.memoizedState;if(null!==e){c.pending=null;var g=e=e.next;do f=a(f,g.action),g=g.next;while(g!==e);Qa(f,b.memoizedState)||(ia=!0);b.memoizedState=f;null===b.baseQueue&&(b.baseState=f);c.lastRenderedState=f}return[f,d]}function xe(a){var b=ub();"function"===typeof a&&(a=a());b.memoizedState=b.baseState=a;a=b.queue={pending:null,dispatch:null,lastRenderedReducer:Ua,
lastRenderedState:a};a=a.dispatch=ch.bind(null,z,a);return[b.memoizedState,a]}function ye(a,b,c,d){a={tag:a,create:b,destroy:c,deps:d,next:null};b=z.updateQueue;null===b?(b={lastEffect:null},z.updateQueue=b,b.lastEffect=a.next=a):(c=b.lastEffect,null===c?b.lastEffect=a.next=a:(d=c.next,c.next=a,a.next=d,b.lastEffect=a));return a}function dh(a){return vb().memoizedState}function ze(a,b,c,d){var e=ub();z.effectTag|=a;e.memoizedState=ye(1|b,c,void 0,void 0===d?null:d)}function Ae(a,b,c,d){var e=vb();
d=void 0===d?null:d;var f=void 0;if(null!==K){var g=K.memoizedState;f=g.destroy;if(null!==d&&ve(d,g.deps)){ye(b,c,f,d);return}}z.effectTag|=a;e.memoizedState=ye(1|b,c,f,d)}function eh(a,b){return ze(516,4,a,b)}function Xc(a,b){return Ae(516,4,a,b)}function fh(a,b){return Ae(4,2,a,b)}function gh(a,b){if("function"===typeof b)return a=a(),b(a),function(){b(null)};if(null!==b&&void 0!==b)return a=a(),b.current=a,function(){b.current=null}}function hh(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;
return Ae(4,2,gh.bind(null,b,a),c)}function Be(a,b){}function ih(a,b){ub().memoizedState=[a,void 0===b?null:b];return a}function Yc(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];c.memoizedState=[a,b];return a}function jh(a,b){var c=vb();b=void 0===b?null:b;var d=c.memoizedState;if(null!==d&&null!==b&&ve(b,d[1]))return d[0];a=a();c.memoizedState=[a,b];return a}function Ce(a,b,c){var d=Cc();Da(98>d?98:d,function(){a(!0)});Da(97<d?97:d,function(){var d=
X.suspense;X.suspense=void 0===b?null:b;try{a(!1),c()}finally{X.suspense=d}})}function ch(a,b,c){var d=ka(),e=Vb.suspense;d=Va(d,a,e);e={expirationTime:d,suspenseConfig:e,action:c,eagerReducer:null,eagerState:null,next:null};var f=b.pending;null===f?e.next=e:(e.next=f.next,f.next=e);b.pending=e;f=a.alternate;if(a===z||null!==f&&f===z)Uc=!0,e.expirationTime=Ia,z.expirationTime=Ia;else{if(0===a.expirationTime&&(null===f||0===f.expirationTime)&&(f=b.lastRenderedReducer,null!==f))try{var g=b.lastRenderedState,
h=f(g,c);e.eagerReducer=f;e.eagerState=h;if(Qa(h,g))return}catch(m){}finally{}Ja(a,d)}}function kh(a,b){var c=la(5,null,null,0);c.elementType="DELETED";c.type="DELETED";c.stateNode=b;c.return=a;c.effectTag=8;null!==a.lastEffect?(a.lastEffect.nextEffect=c,a.lastEffect=c):a.firstEffect=a.lastEffect=c}function lh(a,b){switch(a.tag){case 5:var c=a.type;b=1!==b.nodeType||c.toLowerCase()!==b.nodeName.toLowerCase()?null:b;return null!==b?(a.stateNode=b,!0):!1;case 6:return b=""===a.pendingProps||3!==b.nodeType?
null:b,null!==b?(a.stateNode=b,!0):!1;case 13:return!1;default:return!1}}function De(a){if(Wa){var b=Ka;if(b){var c=b;if(!lh(a,b)){b=kb(c.nextSibling);if(!b||!lh(a,b)){a.effectTag=a.effectTag&-1025|2;Wa=!1;ra=a;return}kh(ra,c)}ra=a;Ka=kb(b.firstChild)}else a.effectTag=a.effectTag&-1025|2,Wa=!1,ra=a}}function mh(a){for(a=a.return;null!==a&&5!==a.tag&&3!==a.tag&&13!==a.tag;)a=a.return;ra=a}function Zc(a){if(a!==ra)return!1;if(!Wa)return mh(a),Wa=!0,!1;var b=a.type;if(5!==a.tag||"head"!==b&&"body"!==
b&&!Yd(b,a.memoizedProps))for(b=Ka;b;)kh(a,b),b=kb(b.nextSibling);mh(a);if(13===a.tag){a=a.memoizedState;a=null!==a?a.dehydrated:null;if(!a)throw Error(k(317));a:{a=a.nextSibling;for(b=0;a;){if(8===a.nodeType){var c=a.data;if(c===og){if(0===b){Ka=kb(a.nextSibling);break a}b--}else c!==ng&&c!==Zd&&c!==$d||b++}a=a.nextSibling}Ka=null}}else Ka=ra?kb(a.stateNode.nextSibling):null;return!0}function Ee(){Ka=ra=null;Wa=!1}function T(a,b,c,d){b.child=null===a?Fe(b,null,c,d):wb(b,a.child,c,d)}function nh(a,
b,c,d,e){c=c.render;var f=b.ref;rb(b,e);d=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,d,e);return b.child}function oh(a,b,c,d,e,f){if(null===a){var g=c.type;if("function"===typeof g&&!Ge(g)&&void 0===g.defaultProps&&null===c.compare&&void 0===c.defaultProps)return b.tag=15,b.type=g,ph(a,b,g,d,e,f);a=Oc(c.type,null,d,null,b.mode,f);a.ref=b.ref;a.return=b;return b.child=a}g=a.child;if(e<
f&&(e=g.memoizedProps,c=c.compare,c=null!==c?c:Ob,c(e,d)&&a.ref===b.ref))return sa(a,b,f);b.effectTag|=1;a=Sa(g,d);a.ref=b.ref;a.return=b;return b.child=a}function ph(a,b,c,d,e,f){return null!==a&&Ob(a.memoizedProps,d)&&a.ref===b.ref&&(ia=!1,e<f)?(b.expirationTime=a.expirationTime,sa(a,b,f)):He(a,b,c,d,f)}function qh(a,b){var c=b.ref;if(null===a&&null!==c||null!==a&&a.ref!==c)b.effectTag|=128}function He(a,b,c,d,e){var f=N(c)?Ra:B.current;f=pb(b,f);rb(b,e);c=we(a,b,c,d,f,e);if(null!==a&&!ia)return b.updateQueue=
a.updateQueue,b.effectTag&=-517,a.expirationTime<=e&&(a.expirationTime=0),sa(a,b,e);b.effectTag|=1;T(a,b,c,e);return b.child}function rh(a,b,c,d,e){if(N(c)){var f=!0;Bc(b)}else f=!1;rb(b,e);if(null===b.stateNode)null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),Yg(b,c,d),pe(b,c,d,e),d=!0;else if(null===a){var g=b.stateNode,h=b.memoizedProps;g.props=h;var m=g.context,n=c.contextType;"object"===typeof n&&null!==n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n));var l=c.getDerivedStateFromProps,k="function"===
typeof l||"function"===typeof g.getSnapshotBeforeUpdate;k||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n);Ga=!1;var p=b.memoizedState;g.state=p;Qb(b,d,g,e);m=b.memoizedState;h!==d||p!==m||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),m=b.memoizedState),(h=Ga||Xg(b,c,h,d,p,m,n))?(k||"function"!==typeof g.UNSAFE_componentWillMount&&"function"!==typeof g.componentWillMount||("function"===typeof g.componentWillMount&&
g.componentWillMount(),"function"===typeof g.UNSAFE_componentWillMount&&g.UNSAFE_componentWillMount()),"function"===typeof g.componentDidMount&&(b.effectTag|=4)):("function"===typeof g.componentDidMount&&(b.effectTag|=4),b.memoizedProps=d,b.memoizedState=m),g.props=d,g.state=m,g.context=n,d=h):("function"===typeof g.componentDidMount&&(b.effectTag|=4),d=!1)}else g=b.stateNode,oe(a,b),h=b.memoizedProps,g.props=b.type===b.elementType?h:aa(b.type,h),m=g.context,n=c.contextType,"object"===typeof n&&null!==
n?n=W(n):(n=N(c)?Ra:B.current,n=pb(b,n)),l=c.getDerivedStateFromProps,(k="function"===typeof l||"function"===typeof g.getSnapshotBeforeUpdate)||"function"!==typeof g.UNSAFE_componentWillReceiveProps&&"function"!==typeof g.componentWillReceiveProps||(h!==d||m!==n)&&Zg(b,g,d,n),Ga=!1,m=b.memoizedState,g.state=m,Qb(b,d,g,e),p=b.memoizedState,h!==d||m!==p||G.current||Ga?("function"===typeof l&&(Lc(b,c,l,d),p=b.memoizedState),(l=Ga||Xg(b,c,h,d,m,p,n))?(k||"function"!==typeof g.UNSAFE_componentWillUpdate&&
"function"!==typeof g.componentWillUpdate||("function"===typeof g.componentWillUpdate&&g.componentWillUpdate(d,p,n),"function"===typeof g.UNSAFE_componentWillUpdate&&g.UNSAFE_componentWillUpdate(d,p,n)),"function"===typeof g.componentDidUpdate&&(b.effectTag|=4),"function"===typeof g.getSnapshotBeforeUpdate&&(b.effectTag|=256)):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===
a.memoizedState||(b.effectTag|=256),b.memoizedProps=d,b.memoizedState=p),g.props=d,g.state=p,g.context=n,d=l):("function"!==typeof g.componentDidUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=4),"function"!==typeof g.getSnapshotBeforeUpdate||h===a.memoizedProps&&m===a.memoizedState||(b.effectTag|=256),d=!1);return Ie(a,b,c,d,f,e)}function Ie(a,b,c,d,e,f){qh(a,b);var g=0!==(b.effectTag&64);if(!d&&!g)return e&&Hg(b,c,!1),sa(a,b,f);d=b.stateNode;gj.current=b;var h=g&&"function"!==typeof c.getDerivedStateFromError?
null:d.render();b.effectTag|=1;null!==a&&g?(b.child=wb(b,a.child,null,f),b.child=wb(b,null,h,f)):T(a,b,h,f);b.memoizedState=d.state;e&&Hg(b,c,!0);return b.child}function sh(a){var b=a.stateNode;b.pendingContext?Fg(a,b.pendingContext,b.pendingContext!==b.context):b.context&&Fg(a,b.context,!1);se(a,b.containerInfo)}function th(a,b,c){var d=b.mode,e=b.pendingProps,f=D.current,g=!1,h;(h=0!==(b.effectTag&64))||(h=0!==(f&2)&&(null===a||null!==a.memoizedState));h?(g=!0,b.effectTag&=-65):null!==a&&null===
a.memoizedState||void 0===e.fallback||!0===e.unstable_avoidThisFallback||(f|=1);y(D,f&1);if(null===a){void 0!==e.fallback&&De(b);if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;b.memoizedState=Je;b.child=e;return c}d=e.children;b.memoizedState=null;return b.child=Fe(b,null,d,c)}if(null!==a.memoizedState){a=a.child;d=a.sibling;if(g){e=e.fallback;
c=Sa(a,a.pendingProps);c.return=b;if(0===(b.mode&2)&&(g=null!==b.memoizedState?b.child.child:b.child,g!==a.child))for(c.child=g;null!==g;)g.return=c,g=g.sibling;d=Sa(d,e);d.return=b;c.sibling=d;c.childExpirationTime=0;b.memoizedState=Je;b.child=c;return d}c=wb(b,a.child,e.children,c);b.memoizedState=null;return b.child=c}a=a.child;if(g){g=e.fallback;e=Ha(null,d,0,null);e.return=b;e.child=a;null!==a&&(a.return=e);if(0===(b.mode&2))for(a=null!==b.memoizedState?b.child.child:b.child,e.child=a;null!==
a;)a.return=e,a=a.sibling;c=Ha(g,d,c,null);c.return=b;e.sibling=c;c.effectTag|=2;e.childExpirationTime=0;b.memoizedState=Je;b.child=e;return c}b.memoizedState=null;return b.child=wb(b,a,e.children,c)}function uh(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);Sg(a.return,b)}function Ke(a,b,c,d,e,f){var g=a.memoizedState;null===g?a.memoizedState={isBackwards:b,rendering:null,renderingStartTime:0,last:d,tail:c,tailExpiration:0,tailMode:e,
lastEffect:f}:(g.isBackwards=b,g.rendering=null,g.renderingStartTime=0,g.last=d,g.tail=c,g.tailExpiration=0,g.tailMode=e,g.lastEffect=f)}function vh(a,b,c){var d=b.pendingProps,e=d.revealOrder,f=d.tail;T(a,b,d.children,c);d=D.current;if(0!==(d&2))d=d&1|2,b.effectTag|=64;else{if(null!==a&&0!==(a.effectTag&64))a:for(a=b.child;null!==a;){if(13===a.tag)null!==a.memoizedState&&uh(a,c);else if(19===a.tag)uh(a,c);else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===b)break a;for(;null===a.sibling;){if(null===
a.return||a.return===b)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}d&=1}y(D,d);if(0===(b.mode&2))b.memoizedState=null;else switch(e){case "forwards":c=b.child;for(e=null;null!==c;)a=c.alternate,null!==a&&null===Rc(a)&&(e=c),c=c.sibling;c=e;null===c?(e=b.child,b.child=null):(e=c.sibling,c.sibling=null);Ke(b,!1,e,c,f,b.lastEffect);break;case "backwards":c=null;e=b.child;for(b.child=null;null!==e;){a=e.alternate;if(null!==a&&null===Rc(a)){b.child=e;break}a=e.sibling;e.sibling=c;c=e;e=a}Ke(b,
!0,c,null,f,b.lastEffect);break;case "together":Ke(b,!1,null,null,void 0,b.lastEffect);break;default:b.memoizedState=null}return b.child}function sa(a,b,c){null!==a&&(b.dependencies=a.dependencies);var d=b.expirationTime;0!==d&&Kc(d);if(b.childExpirationTime<c)return null;if(null!==a&&b.child!==a.child)throw Error(k(153));if(null!==b.child){a=b.child;c=Sa(a,a.pendingProps);b.child=c;for(c.return=b;null!==a.sibling;)a=a.sibling,c=c.sibling=Sa(a,a.pendingProps),c.return=b;c.sibling=null}return b.child}
function $c(a,b){switch(a.tailMode){case "hidden":b=a.tail;for(var c=null;null!==b;)null!==b.alternate&&(c=b),b=b.sibling;null===c?a.tail=null:c.sibling=null;break;case "collapsed":c=a.tail;for(var d=null;null!==c;)null!==c.alternate&&(d=c),c=c.sibling;null===d?b||null===a.tail?a.tail=null:a.tail.sibling=null:d.sibling=null}}function hj(a,b,c){var d=b.pendingProps;switch(b.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return null;case 1:return N(b.type)&&(q(G),q(B)),
null;case 3:return tb(),q(G),q(B),c=b.stateNode,c.pendingContext&&(c.context=c.pendingContext,c.pendingContext=null),null!==a&&null!==a.child||!Zc(b)||(b.effectTag|=4),wh(b),null;case 5:te(b);c=Ta(Tb.current);var e=b.type;if(null!==a&&null!=b.stateNode)ij(a,b,e,d,c),a.ref!==b.ref&&(b.effectTag|=128);else{if(!d){if(null===b.stateNode)throw Error(k(166));return null}a=Ta(ja.current);if(Zc(b)){d=b.stateNode;e=b.type;var f=b.memoizedProps;d[Aa]=b;d[vc]=f;switch(e){case "iframe":case "object":case "embed":w("load",
d);break;case "video":case "audio":for(a=0;a<Db.length;a++)w(Db[a],d);break;case "source":w("error",d);break;case "img":case "image":case "link":w("error",d);w("load",d);break;case "form":w("reset",d);w("submit",d);break;case "details":w("toggle",d);break;case "input":Hf(d,f);w("invalid",d);oa(c,"onChange");break;case "select":d._wrapperState={wasMultiple:!!f.multiple};w("invalid",d);oa(c,"onChange");break;case "textarea":Kf(d,f),w("invalid",d),oa(c,"onChange")}Ud(e,f);a=null;for(var g in f)if(f.hasOwnProperty(g)){var h=
f[g];"children"===g?"string"===typeof h?d.textContent!==h&&(a=["children",h]):"number"===typeof h&&d.textContent!==""+h&&(a=["children",""+h]):db.hasOwnProperty(g)&&null!=h&&oa(c,g)}switch(e){case "input":mc(d);Jf(d,f,!0);break;case "textarea":mc(d);Mf(d);break;case "select":case "option":break;default:"function"===typeof f.onClick&&(d.onclick=uc)}c=a;b.updateQueue=c;null!==c&&(b.effectTag|=4)}else{g=9===c.nodeType?c:c.ownerDocument;"http://www.w3.org/1999/xhtml"===a&&(a=Nf(e));"http://www.w3.org/1999/xhtml"===
a?"script"===e?(a=g.createElement("div"),a.innerHTML="<script>\x3c/script>",a=a.removeChild(a.firstChild)):"string"===typeof d.is?a=g.createElement(e,{is:d.is}):(a=g.createElement(e),"select"===e&&(g=a,d.multiple?g.multiple=!0:d.size&&(g.size=d.size))):a=g.createElementNS(a,e);a[Aa]=b;a[vc]=d;jj(a,b,!1,!1);b.stateNode=a;g=Vd(e,d);switch(e){case "iframe":case "object":case "embed":w("load",a);h=d;break;case "video":case "audio":for(h=0;h<Db.length;h++)w(Db[h],a);h=d;break;case "source":w("error",a);
h=d;break;case "img":case "image":case "link":w("error",a);w("load",a);h=d;break;case "form":w("reset",a);w("submit",a);h=d;break;case "details":w("toggle",a);h=d;break;case "input":Hf(a,d);h=Cd(a,d);w("invalid",a);oa(c,"onChange");break;case "option":h=Fd(a,d);break;case "select":a._wrapperState={wasMultiple:!!d.multiple};h=M({},d,{value:void 0});w("invalid",a);oa(c,"onChange");break;case "textarea":Kf(a,d);h=Gd(a,d);w("invalid",a);oa(c,"onChange");break;default:h=d}Ud(e,h);var m=h;for(f in m)if(m.hasOwnProperty(f)){var n=
m[f];"style"===f?gg(a,n):"dangerouslySetInnerHTML"===f?(n=n?n.__html:void 0,null!=n&&xh(a,n)):"children"===f?"string"===typeof n?("textarea"!==e||""!==n)&&Wb(a,n):"number"===typeof n&&Wb(a,""+n):"suppressContentEditableWarning"!==f&&"suppressHydrationWarning"!==f&&"autoFocus"!==f&&(db.hasOwnProperty(f)?null!=n&&oa(c,f):null!=n&&xd(a,f,n,g))}switch(e){case "input":mc(a);Jf(a,d,!1);break;case "textarea":mc(a);Mf(a);break;case "option":null!=d.value&&a.setAttribute("value",""+va(d.value));break;case "select":a.multiple=
!!d.multiple;c=d.value;null!=c?hb(a,!!d.multiple,c,!1):null!=d.defaultValue&&hb(a,!!d.multiple,d.defaultValue,!0);break;default:"function"===typeof h.onClick&&(a.onclick=uc)}lg(e,d)&&(b.effectTag|=4)}null!==b.ref&&(b.effectTag|=128)}return null;case 6:if(a&&null!=b.stateNode)kj(a,b,a.memoizedProps,d);else{if("string"!==typeof d&&null===b.stateNode)throw Error(k(166));c=Ta(Tb.current);Ta(ja.current);Zc(b)?(c=b.stateNode,d=b.memoizedProps,c[Aa]=b,c.nodeValue!==d&&(b.effectTag|=4)):(c=(9===c.nodeType?
c:c.ownerDocument).createTextNode(d),c[Aa]=b,b.stateNode=c)}return null;case 13:q(D);d=b.memoizedState;if(0!==(b.effectTag&64))return b.expirationTime=c,b;c=null!==d;d=!1;null===a?void 0!==b.memoizedProps.fallback&&Zc(b):(e=a.memoizedState,d=null!==e,c||null===e||(e=a.child.sibling,null!==e&&(f=b.firstEffect,null!==f?(b.firstEffect=e,e.nextEffect=f):(b.firstEffect=b.lastEffect=e,e.nextEffect=null),e.effectTag=8)));if(c&&!d&&0!==(b.mode&2))if(null===a&&!0!==b.memoizedProps.unstable_avoidThisFallback||
0!==(D.current&1))F===Xa&&(F=ad);else{if(F===Xa||F===ad)F=bd;0!==Xb&&null!==U&&(Ya(U,P),yh(U,Xb))}if(c||d)b.effectTag|=4;return null;case 4:return tb(),wh(b),null;case 10:return me(b),null;case 17:return N(b.type)&&(q(G),q(B)),null;case 19:q(D);d=b.memoizedState;if(null===d)return null;e=0!==(b.effectTag&64);f=d.rendering;if(null===f)if(e)$c(d,!1);else{if(F!==Xa||null!==a&&0!==(a.effectTag&64))for(f=b.child;null!==f;){a=Rc(f);if(null!==a){b.effectTag|=64;$c(d,!1);e=a.updateQueue;null!==e&&(b.updateQueue=
e,b.effectTag|=4);null===d.lastEffect&&(b.firstEffect=null);b.lastEffect=d.lastEffect;for(d=b.child;null!==d;)e=d,f=c,e.effectTag&=2,e.nextEffect=null,e.firstEffect=null,e.lastEffect=null,a=e.alternate,null===a?(e.childExpirationTime=0,e.expirationTime=f,e.child=null,e.memoizedProps=null,e.memoizedState=null,e.updateQueue=null,e.dependencies=null):(e.childExpirationTime=a.childExpirationTime,e.expirationTime=a.expirationTime,e.child=a.child,e.memoizedProps=a.memoizedProps,e.memoizedState=a.memoizedState,
e.updateQueue=a.updateQueue,f=a.dependencies,e.dependencies=null===f?null:{expirationTime:f.expirationTime,firstContext:f.firstContext,responders:f.responders}),d=d.sibling;y(D,D.current&1|2);return b.child}f=f.sibling}}else{if(!e)if(a=Rc(f),null!==a){if(b.effectTag|=64,e=!0,c=a.updateQueue,null!==c&&(b.updateQueue=c,b.effectTag|=4),$c(d,!0),null===d.tail&&"hidden"===d.tailMode&&!f.alternate)return b=b.lastEffect=d.lastEffect,null!==b&&(b.nextEffect=null),null}else 2*Y()-d.renderingStartTime>d.tailExpiration&&
1<c&&(b.effectTag|=64,e=!0,$c(d,!1),b.expirationTime=b.childExpirationTime=c-1);d.isBackwards?(f.sibling=b.child,b.child=f):(c=d.last,null!==c?c.sibling=f:b.child=f,d.last=f)}return null!==d.tail?(0===d.tailExpiration&&(d.tailExpiration=Y()+500),c=d.tail,d.rendering=c,d.tail=c.sibling,d.lastEffect=b.lastEffect,d.renderingStartTime=Y(),c.sibling=null,b=D.current,y(D,e?b&1|2:b&1),c):null}throw Error(k(156,b.tag));}function lj(a,b){switch(a.tag){case 1:return N(a.type)&&(q(G),q(B)),b=a.effectTag,b&4096?
(a.effectTag=b&-4097|64,a):null;case 3:tb();q(G);q(B);b=a.effectTag;if(0!==(b&64))throw Error(k(285));a.effectTag=b&-4097|64;return a;case 5:return te(a),null;case 13:return q(D),b=a.effectTag,b&4096?(a.effectTag=b&-4097|64,a):null;case 19:return q(D),null;case 4:return tb(),null;case 10:return me(a),null;default:return null}}function Le(a,b){return{value:a,source:b,stack:Bd(b)}}function Me(a,b){var c=b.source,d=b.stack;null===d&&null!==c&&(d=Bd(c));null!==c&&na(c.type);b=b.value;null!==a&&1===a.tag&&
na(a.type);try{console.error(b)}catch(e){setTimeout(function(){throw e;})}}function mj(a,b){try{b.props=a.memoizedProps,b.state=a.memoizedState,b.componentWillUnmount()}catch(c){Za(a,c)}}function zh(a){var b=a.ref;if(null!==b)if("function"===typeof b)try{b(null)}catch(c){Za(a,c)}else b.current=null}function nj(a,b){switch(b.tag){case 0:case 11:case 15:case 22:return;case 1:if(b.effectTag&256&&null!==a){var c=a.memoizedProps,d=a.memoizedState;a=b.stateNode;b=a.getSnapshotBeforeUpdate(b.elementType===
b.type?c:aa(b.type,c),d);a.__reactInternalSnapshotBeforeUpdate=b}return;case 3:case 5:case 6:case 4:case 17:return}throw Error(k(163));}function Ah(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.destroy;c.destroy=void 0;void 0!==d&&d()}c=c.next}while(c!==b)}}function Bh(a,b){b=b.updateQueue;b=null!==b?b.lastEffect:null;if(null!==b){var c=b=b.next;do{if((c.tag&a)===a){var d=c.create;c.destroy=d()}c=c.next}while(c!==b)}}function oj(a,b,c,d){switch(c.tag){case 0:case 11:case 15:case 22:Bh(3,
c);return;case 1:a=c.stateNode;c.effectTag&4&&(null===b?a.componentDidMount():(d=c.elementType===c.type?b.memoizedProps:aa(c.type,b.memoizedProps),a.componentDidUpdate(d,b.memoizedState,a.__reactInternalSnapshotBeforeUpdate)));b=c.updateQueue;null!==b&&Wg(c,b,a);return;case 3:b=c.updateQueue;if(null!==b){a=null;if(null!==c.child)switch(c.child.tag){case 5:a=c.child.stateNode;break;case 1:a=c.child.stateNode}Wg(c,b,a)}return;case 5:a=c.stateNode;null===b&&c.effectTag&4&&lg(c.type,c.memoizedProps)&&
a.focus();return;case 6:return;case 4:return;case 12:return;case 13:null===c.memoizedState&&(c=c.alternate,null!==c&&(c=c.memoizedState,null!==c&&(c=c.dehydrated,null!==c&&bg(c))));return;case 19:case 17:case 20:case 21:return}throw Error(k(163));}function Ch(a,b,c){"function"===typeof Ne&&Ne(b);switch(b.tag){case 0:case 11:case 14:case 15:case 22:a=b.updateQueue;if(null!==a&&(a=a.lastEffect,null!==a)){var d=a.next;Da(97<c?97:c,function(){var a=d;do{var c=a.destroy;if(void 0!==c){var g=b;try{c()}catch(h){Za(g,
h)}}a=a.next}while(a!==d)})}break;case 1:zh(b);c=b.stateNode;"function"===typeof c.componentWillUnmount&&mj(b,c);break;case 5:zh(b);break;case 4:Dh(a,b,c)}}function Eh(a){var b=a.alternate;a.return=null;a.child=null;a.memoizedState=null;a.updateQueue=null;a.dependencies=null;a.alternate=null;a.firstEffect=null;a.lastEffect=null;a.pendingProps=null;a.memoizedProps=null;a.stateNode=null;null!==b&&Eh(b)}function Fh(a){return 5===a.tag||3===a.tag||4===a.tag}function Gh(a){a:{for(var b=a.return;null!==
b;){if(Fh(b)){var c=b;break a}b=b.return}throw Error(k(160));}b=c.stateNode;switch(c.tag){case 5:var d=!1;break;case 3:b=b.containerInfo;d=!0;break;case 4:b=b.containerInfo;d=!0;break;default:throw Error(k(161));}c.effectTag&16&&(Wb(b,""),c.effectTag&=-17);a:b:for(c=a;;){for(;null===c.sibling;){if(null===c.return||Fh(c.return)){c=null;break a}c=c.return}c.sibling.return=c.return;for(c=c.sibling;5!==c.tag&&6!==c.tag&&18!==c.tag;){if(c.effectTag&2)continue b;if(null===c.child||4===c.tag)continue b;
else c.child.return=c,c=c.child}if(!(c.effectTag&2)){c=c.stateNode;break a}}d?Oe(a,c,b):Pe(a,c,b)}function Oe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?8===c.nodeType?c.parentNode.insertBefore(a,b):c.insertBefore(a,b):(8===c.nodeType?(b=c.parentNode,b.insertBefore(a,c)):(b=c,b.appendChild(a)),c=c._reactRootContainer,null!==c&&void 0!==c||null!==b.onclick||(b.onclick=uc));else if(4!==d&&(a=a.child,null!==a))for(Oe(a,b,c),a=a.sibling;null!==a;)Oe(a,b,c),a=a.sibling}
function Pe(a,b,c){var d=a.tag,e=5===d||6===d;if(e)a=e?a.stateNode:a.stateNode.instance,b?c.insertBefore(a,b):c.appendChild(a);else if(4!==d&&(a=a.child,null!==a))for(Pe(a,b,c),a=a.sibling;null!==a;)Pe(a,b,c),a=a.sibling}function Dh(a,b,c){for(var d=b,e=!1,f,g;;){if(!e){e=d.return;a:for(;;){if(null===e)throw Error(k(160));f=e.stateNode;switch(e.tag){case 5:g=!1;break a;case 3:f=f.containerInfo;g=!0;break a;case 4:f=f.containerInfo;g=!0;break a}e=e.return}e=!0}if(5===d.tag||6===d.tag){a:for(var h=
a,m=d,n=c,l=m;;)if(Ch(h,l,n),null!==l.child&&4!==l.tag)l.child.return=l,l=l.child;else{if(l===m)break a;for(;null===l.sibling;){if(null===l.return||l.return===m)break a;l=l.return}l.sibling.return=l.return;l=l.sibling}g?(h=f,m=d.stateNode,8===h.nodeType?h.parentNode.removeChild(m):h.removeChild(m)):f.removeChild(d.stateNode)}else if(4===d.tag){if(null!==d.child){f=d.stateNode.containerInfo;g=!0;d.child.return=d;d=d.child;continue}}else if(Ch(a,d,c),null!==d.child){d.child.return=d;d=d.child;continue}if(d===
b)break;for(;null===d.sibling;){if(null===d.return||d.return===b)return;d=d.return;4===d.tag&&(e=!1)}d.sibling.return=d.return;d=d.sibling}}function Qe(a,b){switch(b.tag){case 0:case 11:case 14:case 15:case 22:Ah(3,b);return;case 1:return;case 5:var c=b.stateNode;if(null!=c){var d=b.memoizedProps,e=null!==a?a.memoizedProps:d;a=b.type;var f=b.updateQueue;b.updateQueue=null;if(null!==f){c[vc]=d;"input"===a&&"radio"===d.type&&null!=d.name&&If(c,d);Vd(a,e);b=Vd(a,d);for(e=0;e<f.length;e+=2){var g=f[e],
h=f[e+1];"style"===g?gg(c,h):"dangerouslySetInnerHTML"===g?xh(c,h):"children"===g?Wb(c,h):xd(c,g,h,b)}switch(a){case "input":Dd(c,d);break;case "textarea":Lf(c,d);break;case "select":b=c._wrapperState.wasMultiple,c._wrapperState.wasMultiple=!!d.multiple,a=d.value,null!=a?hb(c,!!d.multiple,a,!1):b!==!!d.multiple&&(null!=d.defaultValue?hb(c,!!d.multiple,d.defaultValue,!0):hb(c,!!d.multiple,d.multiple?[]:"",!1))}}}return;case 6:if(null===b.stateNode)throw Error(k(162));b.stateNode.nodeValue=b.memoizedProps;
return;case 3:b=b.stateNode;b.hydrate&&(b.hydrate=!1,bg(b.containerInfo));return;case 12:return;case 13:c=b;null===b.memoizedState?d=!1:(d=!0,c=b.child,Re=Y());if(null!==c)a:for(a=c;;){if(5===a.tag)f=a.stateNode,d?(f=f.style,"function"===typeof f.setProperty?f.setProperty("display","none","important"):f.display="none"):(f=a.stateNode,e=a.memoizedProps.style,e=void 0!==e&&null!==e&&e.hasOwnProperty("display")?e.display:null,f.style.display=fg("display",e));else if(6===a.tag)a.stateNode.nodeValue=d?
"":a.memoizedProps;else if(13===a.tag&&null!==a.memoizedState&&null===a.memoizedState.dehydrated){f=a.child.sibling;f.return=a;a=f;continue}else if(null!==a.child){a.child.return=a;a=a.child;continue}if(a===c)break;for(;null===a.sibling;){if(null===a.return||a.return===c)break a;a=a.return}a.sibling.return=a.return;a=a.sibling}Hh(b);return;case 19:Hh(b);return;case 17:return}throw Error(k(163));}function Hh(a){var b=a.updateQueue;if(null!==b){a.updateQueue=null;var c=a.stateNode;null===c&&(c=a.stateNode=
new pj);b.forEach(function(b){var d=qj.bind(null,a,b);c.has(b)||(c.add(b),b.then(d,d))})}}function Ih(a,b,c){c=Ea(c,null);c.tag=3;c.payload={element:null};var d=b.value;c.callback=function(){cd||(cd=!0,Se=d);Me(a,b)};return c}function Jh(a,b,c){c=Ea(c,null);c.tag=3;var d=a.type.getDerivedStateFromError;if("function"===typeof d){var e=b.value;c.payload=function(){Me(a,b);return d(e)}}var f=a.stateNode;null!==f&&"function"===typeof f.componentDidCatch&&(c.callback=function(){"function"!==typeof d&&
(null===La?La=new Set([this]):La.add(this),Me(a,b));var c=b.stack;this.componentDidCatch(b.value,{componentStack:null!==c?c:""})});return c}function ka(){return(p&(ca|ma))!==H?1073741821-(Y()/10|0):0!==dd?dd:dd=1073741821-(Y()/10|0)}function Va(a,b,c){b=b.mode;if(0===(b&2))return 1073741823;var d=Cc();if(0===(b&4))return 99===d?1073741823:1073741822;if((p&ca)!==H)return P;if(null!==c)a=Fc(a,c.timeoutMs|0||5E3,250);else switch(d){case 99:a=1073741823;break;case 98:a=Fc(a,150,100);break;case 97:case 96:a=
Fc(a,5E3,250);break;case 95:a=2;break;default:throw Error(k(326));}null!==U&&a===P&&--a;return a}function ed(a,b){a.expirationTime<b&&(a.expirationTime=b);var c=a.alternate;null!==c&&c.expirationTime<b&&(c.expirationTime=b);var d=a.return,e=null;if(null===d&&3===a.tag)e=a.stateNode;else for(;null!==d;){c=d.alternate;d.childExpirationTime<b&&(d.childExpirationTime=b);null!==c&&c.childExpirationTime<b&&(c.childExpirationTime=b);if(null===d.return&&3===d.tag){e=d.stateNode;break}d=d.return}null!==e&&
(U===e&&(Kc(b),F===bd&&Ya(e,P)),yh(e,b));return e}function fd(a){var b=a.lastExpiredTime;if(0!==b)return b;b=a.firstPendingTime;if(!Kh(a,b))return b;var c=a.lastPingedTime;a=a.nextKnownPendingLevel;a=c>a?c:a;return 2>=a&&b!==a?0:a}function V(a){if(0!==a.lastExpiredTime)a.callbackExpirationTime=1073741823,a.callbackPriority=99,a.callbackNode=Og(Te.bind(null,a));else{var b=fd(a),c=a.callbackNode;if(0===b)null!==c&&(a.callbackNode=null,a.callbackExpirationTime=0,a.callbackPriority=90);else{var d=ka();
1073741823===b?d=99:1===b||2===b?d=95:(d=10*(1073741821-b)-10*(1073741821-d),d=0>=d?99:250>=d?98:5250>=d?97:95);if(null!==c){var e=a.callbackPriority;if(a.callbackExpirationTime===b&&e>=d)return;c!==Qg&&Rg(c)}a.callbackExpirationTime=b;a.callbackPriority=d;b=1073741823===b?Og(Te.bind(null,a)):Ng(d,Lh.bind(null,a),{timeout:10*(1073741821-b)-Y()});a.callbackNode=b}}}function Lh(a,b){dd=0;if(b)return b=ka(),Ue(a,b),V(a),null;var c=fd(a);if(0!==c){b=a.callbackNode;if((p&(ca|ma))!==H)throw Error(k(327));
xb();a===U&&c===P||$a(a,c);if(null!==t){var d=p;p|=ca;var e=Mh();do try{rj();break}catch(h){Nh(a,h)}while(1);le();p=d;gd.current=e;if(F===hd)throw b=id,$a(a,c),Ya(a,c),V(a),b;if(null===t)switch(e=a.finishedWork=a.current.alternate,a.finishedExpirationTime=c,d=F,U=null,d){case Xa:case hd:throw Error(k(345));case Oh:Ue(a,2<c?2:c);break;case ad:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(1073741823===ta&&(e=Re+Ph-Y(),10<e)){if(jd){var f=a.lastPingedTime;if(0===f||f>=c){a.lastPingedTime=
c;$a(a,c);break}}f=fd(a);if(0!==f&&f!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}a.timeoutHandle=We(ab.bind(null,a),e);break}ab(a);break;case bd:Ya(a,c);d=a.lastSuspendedTime;c===d&&(a.nextKnownPendingLevel=Ve(e));if(jd&&(e=a.lastPingedTime,0===e||e>=c)){a.lastPingedTime=c;$a(a,c);break}e=fd(a);if(0!==e&&e!==c)break;if(0!==d&&d!==c){a.lastPingedTime=d;break}1073741823!==Yb?d=10*(1073741821-Yb)-Y():1073741823===ta?d=0:(d=10*(1073741821-ta)-5E3,e=Y(),c=10*(1073741821-c)-e,d=e-d,0>d&&(d=0),d=
(120>d?120:480>d?480:1080>d?1080:1920>d?1920:3E3>d?3E3:4320>d?4320:1960*sj(d/1960))-d,c<d&&(d=c));if(10<d){a.timeoutHandle=We(ab.bind(null,a),d);break}ab(a);break;case Xe:if(1073741823!==ta&&null!==kd){f=ta;var g=kd;d=g.busyMinDurationMs|0;0>=d?d=0:(e=g.busyDelayMs|0,f=Y()-(10*(1073741821-f)-(g.timeoutMs|0||5E3)),d=f<=e?0:e+d-f);if(10<d){Ya(a,c);a.timeoutHandle=We(ab.bind(null,a),d);break}}ab(a);break;default:throw Error(k(329));}V(a);if(a.callbackNode===b)return Lh.bind(null,a)}}return null}function Te(a){var b=
a.lastExpiredTime;b=0!==b?b:1073741823;if((p&(ca|ma))!==H)throw Error(k(327));xb();a===U&&b===P||$a(a,b);if(null!==t){var c=p;p|=ca;var d=Mh();do try{tj();break}catch(e){Nh(a,e)}while(1);le();p=c;gd.current=d;if(F===hd)throw c=id,$a(a,b),Ya(a,b),V(a),c;if(null!==t)throw Error(k(261));a.finishedWork=a.current.alternate;a.finishedExpirationTime=b;U=null;ab(a);V(a)}return null}function uj(){if(null!==bb){var a=bb;bb=null;a.forEach(function(a,c){Ue(c,a);V(c)});ha()}}function Qh(a,b){var c=p;p|=1;try{return a(b)}finally{p=
c,p===H&&ha()}}function Rh(a,b){var c=p;p&=-2;p|=Ye;try{return a(b)}finally{p=c,p===H&&ha()}}function $a(a,b){a.finishedWork=null;a.finishedExpirationTime=0;var c=a.timeoutHandle;-1!==c&&(a.timeoutHandle=-1,vj(c));if(null!==t)for(c=t.return;null!==c;){var d=c;switch(d.tag){case 1:d=d.type.childContextTypes;null!==d&&void 0!==d&&(q(G),q(B));break;case 3:tb();q(G);q(B);break;case 5:te(d);break;case 4:tb();break;case 13:q(D);break;case 19:q(D);break;case 10:me(d)}c=c.return}U=a;t=Sa(a.current,null);
P=b;F=Xa;id=null;Yb=ta=1073741823;kd=null;Xb=0;jd=!1}function Nh(a,b){do{try{le();Sc.current=Tc;if(Uc)for(var c=z.memoizedState;null!==c;){var d=c.queue;null!==d&&(d.pending=null);c=c.next}Ia=0;J=K=z=null;Uc=!1;if(null===t||null===t.return)return F=hd,id=b,t=null;a:{var e=a,f=t.return,g=t,h=b;b=P;g.effectTag|=2048;g.firstEffect=g.lastEffect=null;if(null!==h&&"object"===typeof h&&"function"===typeof h.then){var m=h;if(0===(g.mode&2)){var n=g.alternate;n?(g.updateQueue=n.updateQueue,g.memoizedState=
n.memoizedState,g.expirationTime=n.expirationTime):(g.updateQueue=null,g.memoizedState=null)}var l=0!==(D.current&1),k=f;do{var p;if(p=13===k.tag){var q=k.memoizedState;if(null!==q)p=null!==q.dehydrated?!0:!1;else{var w=k.memoizedProps;p=void 0===w.fallback?!1:!0!==w.unstable_avoidThisFallback?!0:l?!1:!0}}if(p){var y=k.updateQueue;if(null===y){var r=new Set;r.add(m);k.updateQueue=r}else y.add(m);if(0===(k.mode&2)){k.effectTag|=64;g.effectTag&=-2981;if(1===g.tag)if(null===g.alternate)g.tag=17;else{var O=
Ea(1073741823,null);O.tag=Jc;Fa(g,O)}g.expirationTime=1073741823;break a}h=void 0;g=b;var v=e.pingCache;null===v?(v=e.pingCache=new wj,h=new Set,v.set(m,h)):(h=v.get(m),void 0===h&&(h=new Set,v.set(m,h)));if(!h.has(g)){h.add(g);var x=xj.bind(null,e,m,g);m.then(x,x)}k.effectTag|=4096;k.expirationTime=b;break a}k=k.return}while(null!==k);h=Error((na(g.type)||"A React component")+" suspended while rendering, but no fallback UI was specified.\n\nAdd a <Suspense fallback=...> component higher in the tree to provide a loading indicator or placeholder to display."+
Bd(g))}F!==Xe&&(F=Oh);h=Le(h,g);k=f;do{switch(k.tag){case 3:m=h;k.effectTag|=4096;k.expirationTime=b;var A=Ih(k,m,b);Ug(k,A);break a;case 1:m=h;var u=k.type,B=k.stateNode;if(0===(k.effectTag&64)&&("function"===typeof u.getDerivedStateFromError||null!==B&&"function"===typeof B.componentDidCatch&&(null===La||!La.has(B)))){k.effectTag|=4096;k.expirationTime=b;var H=Jh(k,m,b);Ug(k,H);break a}}k=k.return}while(null!==k)}t=Sh(t)}catch(cj){b=cj;continue}break}while(1)}function Mh(a){a=gd.current;gd.current=
Tc;return null===a?Tc:a}function Vg(a,b){a<ta&&2<a&&(ta=a);null!==b&&a<Yb&&2<a&&(Yb=a,kd=b)}function Kc(a){a>Xb&&(Xb=a)}function tj(){for(;null!==t;)t=Th(t)}function rj(){for(;null!==t&&!yj();)t=Th(t)}function Th(a){var b=zj(a.alternate,a,P);a.memoizedProps=a.pendingProps;null===b&&(b=Sh(a));Uh.current=null;return b}function Sh(a){t=a;do{var b=t.alternate;a=t.return;if(0===(t.effectTag&2048)){b=hj(b,t,P);if(1===P||1!==t.childExpirationTime){for(var c=0,d=t.child;null!==d;){var e=d.expirationTime,
f=d.childExpirationTime;e>c&&(c=e);f>c&&(c=f);d=d.sibling}t.childExpirationTime=c}if(null!==b)return b;null!==a&&0===(a.effectTag&2048)&&(null===a.firstEffect&&(a.firstEffect=t.firstEffect),null!==t.lastEffect&&(null!==a.lastEffect&&(a.lastEffect.nextEffect=t.firstEffect),a.lastEffect=t.lastEffect),1<t.effectTag&&(null!==a.lastEffect?a.lastEffect.nextEffect=t:a.firstEffect=t,a.lastEffect=t))}else{b=lj(t);if(null!==b)return b.effectTag&=2047,b;null!==a&&(a.firstEffect=a.lastEffect=null,a.effectTag|=
2048)}b=t.sibling;if(null!==b)return b;t=a}while(null!==t);F===Xa&&(F=Xe);return null}function Ve(a){var b=a.expirationTime;a=a.childExpirationTime;return b>a?b:a}function ab(a){var b=Cc();Da(99,Aj.bind(null,a,b));return null}function Aj(a,b){do xb();while(null!==Zb);if((p&(ca|ma))!==H)throw Error(k(327));var c=a.finishedWork,d=a.finishedExpirationTime;if(null===c)return null;a.finishedWork=null;a.finishedExpirationTime=0;if(c===a.current)throw Error(k(177));a.callbackNode=null;a.callbackExpirationTime=
0;a.callbackPriority=90;a.nextKnownPendingLevel=0;var e=Ve(c);a.firstPendingTime=e;d<=a.lastSuspendedTime?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:d<=a.firstSuspendedTime&&(a.firstSuspendedTime=d-1);d<=a.lastPingedTime&&(a.lastPingedTime=0);d<=a.lastExpiredTime&&(a.lastExpiredTime=0);a===U&&(t=U=null,P=0);1<c.effectTag?null!==c.lastEffect?(c.lastEffect.nextEffect=c,e=c.firstEffect):e=c:e=c.firstEffect;if(null!==e){var f=p;p|=ma;Uh.current=null;Ze=tc;var g=kg();if(Xd(g)){if("selectionStart"in
g)var h={start:g.selectionStart,end:g.selectionEnd};else a:{h=(h=g.ownerDocument)&&h.defaultView||window;var m=h.getSelection&&h.getSelection();if(m&&0!==m.rangeCount){h=m.anchorNode;var n=m.anchorOffset,q=m.focusNode;m=m.focusOffset;try{h.nodeType,q.nodeType}catch(sb){h=null;break a}var ba=0,w=-1,y=-1,B=0,D=0,r=g,z=null;b:for(;;){for(var v;;){r!==h||0!==n&&3!==r.nodeType||(w=ba+n);r!==q||0!==m&&3!==r.nodeType||(y=ba+m);3===r.nodeType&&(ba+=r.nodeValue.length);if(null===(v=r.firstChild))break;z=r;
r=v}for(;;){if(r===g)break b;z===h&&++B===n&&(w=ba);z===q&&++D===m&&(y=ba);if(null!==(v=r.nextSibling))break;r=z;z=r.parentNode}r=v}h=-1===w||-1===y?null:{start:w,end:y}}else h=null}h=h||{start:0,end:0}}else h=null;$e={activeElementDetached:null,focusedElem:g,selectionRange:h};tc=!1;l=e;do try{Bj()}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=e;do try{for(g=a,h=b;null!==l;){var x=l.effectTag;x&16&&Wb(l.stateNode,"");if(x&128){var A=l.alternate;if(null!==A){var u=
A.ref;null!==u&&("function"===typeof u?u(null):u.current=null)}}switch(x&1038){case 2:Gh(l);l.effectTag&=-3;break;case 6:Gh(l);l.effectTag&=-3;Qe(l.alternate,l);break;case 1024:l.effectTag&=-1025;break;case 1028:l.effectTag&=-1025;Qe(l.alternate,l);break;case 4:Qe(l.alternate,l);break;case 8:n=l,Dh(g,n,h),Eh(n)}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);u=$e;A=kg();x=u.focusedElem;h=u.selectionRange;if(A!==x&&x&&x.ownerDocument&&jg(x.ownerDocument.documentElement,
x)){null!==h&&Xd(x)&&(A=h.start,u=h.end,void 0===u&&(u=A),"selectionStart"in x?(x.selectionStart=A,x.selectionEnd=Math.min(u,x.value.length)):(u=(A=x.ownerDocument||document)&&A.defaultView||window,u.getSelection&&(u=u.getSelection(),n=x.textContent.length,g=Math.min(h.start,n),h=void 0===h.end?g:Math.min(h.end,n),!u.extend&&g>h&&(n=h,h=g,g=n),n=ig(x,g),q=ig(x,h),n&&q&&(1!==u.rangeCount||u.anchorNode!==n.node||u.anchorOffset!==n.offset||u.focusNode!==q.node||u.focusOffset!==q.offset)&&(A=A.createRange(),
A.setStart(n.node,n.offset),u.removeAllRanges(),g>h?(u.addRange(A),u.extend(q.node,q.offset)):(A.setEnd(q.node,q.offset),u.addRange(A))))));A=[];for(u=x;u=u.parentNode;)1===u.nodeType&&A.push({element:u,left:u.scrollLeft,top:u.scrollTop});"function"===typeof x.focus&&x.focus();for(x=0;x<A.length;x++)u=A[x],u.element.scrollLeft=u.left,u.element.scrollTop=u.top}tc=!!Ze;$e=Ze=null;a.current=c;l=e;do try{for(x=a;null!==l;){var F=l.effectTag;F&36&&oj(x,l.alternate,l);if(F&128){A=void 0;var E=l.ref;if(null!==
E){var G=l.stateNode;switch(l.tag){case 5:A=G;break;default:A=G}"function"===typeof E?E(A):E.current=A}}l=l.nextEffect}}catch(sb){if(null===l)throw Error(k(330));Za(l,sb);l=l.nextEffect}while(null!==l);l=null;Cj();p=f}else a.current=c;if(ld)ld=!1,Zb=a,$b=b;else for(l=e;null!==l;)b=l.nextEffect,l.nextEffect=null,l=b;b=a.firstPendingTime;0===b&&(La=null);1073741823===b?a===af?ac++:(ac=0,af=a):ac=0;"function"===typeof bf&&bf(c.stateNode,d);V(a);if(cd)throw cd=!1,a=Se,Se=null,a;if((p&Ye)!==H)return null;
ha();return null}function Bj(){for(;null!==l;){var a=l.effectTag;0!==(a&256)&&nj(l.alternate,l);0===(a&512)||ld||(ld=!0,Ng(97,function(){xb();return null}));l=l.nextEffect}}function xb(){if(90!==$b){var a=97<$b?97:$b;$b=90;return Da(a,Dj)}}function Dj(){if(null===Zb)return!1;var a=Zb;Zb=null;if((p&(ca|ma))!==H)throw Error(k(331));var b=p;p|=ma;for(a=a.current.firstEffect;null!==a;){try{var c=a;if(0!==(c.effectTag&512))switch(c.tag){case 0:case 11:case 15:case 22:Ah(5,c),Bh(5,c)}}catch(d){if(null===
a)throw Error(k(330));Za(a,d)}c=a.nextEffect;a.nextEffect=null;a=c}p=b;ha();return!0}function Vh(a,b,c){b=Le(c,b);b=Ih(a,b,1073741823);Fa(a,b);a=ed(a,1073741823);null!==a&&V(a)}function Za(a,b){if(3===a.tag)Vh(a,a,b);else for(var c=a.return;null!==c;){if(3===c.tag){Vh(c,a,b);break}else if(1===c.tag){var d=c.stateNode;if("function"===typeof c.type.getDerivedStateFromError||"function"===typeof d.componentDidCatch&&(null===La||!La.has(d))){a=Le(b,a);a=Jh(c,a,1073741823);Fa(c,a);c=ed(c,1073741823);null!==
c&&V(c);break}}c=c.return}}function xj(a,b,c){var d=a.pingCache;null!==d&&d.delete(b);U===a&&P===c?F===bd||F===ad&&1073741823===ta&&Y()-Re<Ph?$a(a,P):jd=!0:Kh(a,c)&&(b=a.lastPingedTime,0!==b&&b<c||(a.lastPingedTime=c,V(a)))}function qj(a,b){var c=a.stateNode;null!==c&&c.delete(b);b=0;0===b&&(b=ka(),b=Va(b,a,null));a=ed(a,b);null!==a&&V(a)}function Ej(a){if("undefined"===typeof __REACT_DEVTOOLS_GLOBAL_HOOK__)return!1;var b=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(b.isDisabled||!b.supportsFiber)return!0;try{var c=
b.inject(a);bf=function(a,e){try{b.onCommitFiberRoot(c,a,void 0,64===(a.current.effectTag&64))}catch(f){}};Ne=function(a){try{b.onCommitFiberUnmount(c,a)}catch(e){}}}catch(d){}return!0}function Fj(a,b,c,d){this.tag=a;this.key=c;this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null;this.index=0;this.ref=null;this.pendingProps=b;this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null;this.mode=d;this.effectTag=0;this.lastEffect=this.firstEffect=this.nextEffect=
null;this.childExpirationTime=this.expirationTime=0;this.alternate=null}function Ge(a){a=a.prototype;return!(!a||!a.isReactComponent)}function Gj(a){if("function"===typeof a)return Ge(a)?1:0;if(void 0!==a&&null!==a){a=a.$$typeof;if(a===zd)return 11;if(a===Ad)return 14}return 2}function Sa(a,b){var c=a.alternate;null===c?(c=la(a.tag,b,a.key,a.mode),c.elementType=a.elementType,c.type=a.type,c.stateNode=a.stateNode,c.alternate=a,a.alternate=c):(c.pendingProps=b,c.effectTag=0,c.nextEffect=null,c.firstEffect=
null,c.lastEffect=null);c.childExpirationTime=a.childExpirationTime;c.expirationTime=a.expirationTime;c.child=a.child;c.memoizedProps=a.memoizedProps;c.memoizedState=a.memoizedState;c.updateQueue=a.updateQueue;b=a.dependencies;c.dependencies=null===b?null:{expirationTime:b.expirationTime,firstContext:b.firstContext,responders:b.responders};c.sibling=a.sibling;c.index=a.index;c.ref=a.ref;return c}function Oc(a,b,c,d,e,f){var g=2;d=a;if("function"===typeof a)Ge(a)&&(g=1);else if("string"===typeof a)g=
5;else a:switch(a){case Ma:return Ha(c.children,e,f,b);case Hj:g=8;e|=7;break;case Af:g=8;e|=1;break;case kc:return a=la(12,c,b,e|8),a.elementType=kc,a.type=kc,a.expirationTime=f,a;case lc:return a=la(13,c,b,e),a.type=lc,a.elementType=lc,a.expirationTime=f,a;case yd:return a=la(19,c,b,e),a.elementType=yd,a.expirationTime=f,a;default:if("object"===typeof a&&null!==a)switch(a.$$typeof){case Cf:g=10;break a;case Bf:g=9;break a;case zd:g=11;break a;case Ad:g=14;break a;case Ef:g=16;d=null;break a;case Df:g=
22;break a}throw Error(k(130,null==a?a:typeof a,""));}b=la(g,c,b,e);b.elementType=a;b.type=d;b.expirationTime=f;return b}function Ha(a,b,c,d){a=la(7,a,d,b);a.expirationTime=c;return a}function qe(a,b,c){a=la(6,a,null,b);a.expirationTime=c;return a}function re(a,b,c){b=la(4,null!==a.children?a.children:[],a.key,b);b.expirationTime=c;b.stateNode={containerInfo:a.containerInfo,pendingChildren:null,implementation:a.implementation};return b}function Ij(a,b,c){this.tag=b;this.current=null;this.containerInfo=
a;this.pingCache=this.pendingChildren=null;this.finishedExpirationTime=0;this.finishedWork=null;this.timeoutHandle=-1;this.pendingContext=this.context=null;this.hydrate=c;this.callbackNode=null;this.callbackPriority=90;this.lastExpiredTime=this.lastPingedTime=this.nextKnownPendingLevel=this.lastSuspendedTime=this.firstSuspendedTime=this.firstPendingTime=0}function Kh(a,b){var c=a.firstSuspendedTime;a=a.lastSuspendedTime;return 0!==c&&c>=b&&a<=b}function Ya(a,b){var c=a.firstSuspendedTime,d=a.lastSuspendedTime;
c<b&&(a.firstSuspendedTime=b);if(d>b||0===c)a.lastSuspendedTime=b;b<=a.lastPingedTime&&(a.lastPingedTime=0);b<=a.lastExpiredTime&&(a.lastExpiredTime=0)}function yh(a,b){b>a.firstPendingTime&&(a.firstPendingTime=b);var c=a.firstSuspendedTime;0!==c&&(b>=c?a.firstSuspendedTime=a.lastSuspendedTime=a.nextKnownPendingLevel=0:b>=a.lastSuspendedTime&&(a.lastSuspendedTime=b+1),b>a.nextKnownPendingLevel&&(a.nextKnownPendingLevel=b))}function Ue(a,b){var c=a.lastExpiredTime;if(0===c||c>b)a.lastExpiredTime=b}
function md(a,b,c,d){var e=b.current,f=ka(),g=Vb.suspense;f=Va(f,e,g);a:if(c){c=c._reactInternalFiber;b:{if(Na(c)!==c||1!==c.tag)throw Error(k(170));var h=c;do{switch(h.tag){case 3:h=h.stateNode.context;break b;case 1:if(N(h.type)){h=h.stateNode.__reactInternalMemoizedMergedChildContext;break b}}h=h.return}while(null!==h);throw Error(k(171));}if(1===c.tag){var m=c.type;if(N(m)){c=Gg(c,m,h);break a}}c=h}else c=Ca;null===b.context?b.context=c:b.pendingContext=c;b=Ea(f,g);b.payload={element:a};d=void 0===
d?null:d;null!==d&&(b.callback=d);Fa(e,b);Ja(e,f);return f}function cf(a){a=a.current;if(!a.child)return null;switch(a.child.tag){case 5:return a.child.stateNode;default:return a.child.stateNode}}function Wh(a,b){a=a.memoizedState;null!==a&&null!==a.dehydrated&&a.retryTime<b&&(a.retryTime=b)}function df(a,b){Wh(a,b);(a=a.alternate)&&Wh(a,b)}function ef(a,b,c){c=null!=c&&!0===c.hydrate;var d=new Ij(a,b,c),e=la(3,null,null,2===b?7:1===b?3:0);d.current=e;e.stateNode=d;ne(e);a[Lb]=d.current;c&&0!==b&&
xi(a,9===a.nodeType?a:a.ownerDocument);this._internalRoot=d}function bc(a){return!(!a||1!==a.nodeType&&9!==a.nodeType&&11!==a.nodeType&&(8!==a.nodeType||" react-mount-point-unstable "!==a.nodeValue))}function Jj(a,b){b||(b=a?9===a.nodeType?a.documentElement:a.firstChild:null,b=!(!b||1!==b.nodeType||!b.hasAttribute("data-reactroot")));if(!b)for(var c;c=a.lastChild;)a.removeChild(c);return new ef(a,0,b?{hydrate:!0}:void 0)}function nd(a,b,c,d,e){var f=c._reactRootContainer;if(f){var g=f._internalRoot;
if("function"===typeof e){var h=e;e=function(){var a=cf(g);h.call(a)}}md(b,g,a,e)}else{f=c._reactRootContainer=Jj(c,d);g=f._internalRoot;if("function"===typeof e){var m=e;e=function(){var a=cf(g);m.call(a)}}Rh(function(){md(b,g,a,e)})}return cf(g)}function Kj(a,b,c){var d=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;return{$$typeof:gb,key:null==d?null:""+d,children:a,containerInfo:b,implementation:c}}function Xh(a,b){var c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:null;
if(!bc(b))throw Error(k(200));return Kj(a,b,null,c)}if(!ea)throw Error(k(227));var ki=function(a,b,c,d,e,f,g,h,m){var n=Array.prototype.slice.call(arguments,3);try{b.apply(c,n)}catch(C){this.onError(C)}},yb=!1,gc=null,hc=!1,pd=null,li={onError:function(a){yb=!0;gc=a}},td=null,rf=null,mf=null,ic=null,cb={},jc=[],qd={},db={},rd={},wa=!("undefined"===typeof window||"undefined"===typeof window.document||"undefined"===typeof window.document.createElement),M=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.assign,
sd=null,eb=null,fb=null,ee=function(a,b){return a(b)},eg=function(a,b,c,d,e){return a(b,c,d,e)},vd=function(){},vf=ee,Oa=!1,wd=!1,Z=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.Scheduler,Lj=Z.unstable_cancelCallback,ff=Z.unstable_now,$f=Z.unstable_scheduleCallback,Mj=Z.unstable_shouldYield,Yh=Z.unstable_requestPaint,Pd=Z.unstable_runWithPriority,Nj=Z.unstable_getCurrentPriorityLevel,Oj=Z.unstable_ImmediatePriority,Zh=Z.unstable_UserBlockingPriority,ag=Z.unstable_NormalPriority,Pj=Z.unstable_LowPriority,
Qj=Z.unstable_IdlePriority,oi=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,wf=Object.prototype.hasOwnProperty,yf={},xf={},E={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(a){E[a]=
new L(a,0,!1,a,null,!1)});[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(a){var b=a[0];E[b]=new L(b,1,!1,a[1],null,!1)});["contentEditable","draggable","spellCheck","value"].forEach(function(a){E[a]=new L(a,2,!1,a.toLowerCase(),null,!1)});["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(a){E[a]=new L(a,2,!1,a,null,!1)});"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(a){E[a]=
new L(a,3,!1,a.toLowerCase(),null,!1)});["checked","multiple","muted","selected"].forEach(function(a){E[a]=new L(a,3,!0,a,null,!1)});["capture","download"].forEach(function(a){E[a]=new L(a,4,!1,a,null,!1)});["cols","rows","size","span"].forEach(function(a){E[a]=new L(a,6,!1,a,null,!1)});["rowSpan","start"].forEach(function(a){E[a]=new L(a,5,!1,a.toLowerCase(),null,!1)});var gf=/[\-:]([a-z])/g,hf=function(a){return a[1].toUpperCase()};"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(a){var b=
a.replace(gf,hf);E[b]=new L(b,1,!1,a,null,!1)});"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/1999/xlink",!1)});["xml:base","xml:lang","xml:space"].forEach(function(a){var b=a.replace(gf,hf);E[b]=new L(b,1,!1,a,"http://www.w3.org/XML/1998/namespace",!1)});["tabIndex","crossOrigin"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!1)});E.xlinkHref=new L("xlinkHref",1,
!1,"xlink:href","http://www.w3.org/1999/xlink",!0);["src","href","action","formAction"].forEach(function(a){E[a]=new L(a,1,!1,a.toLowerCase(),null,!0)});var da=ea.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;da.hasOwnProperty("ReactCurrentDispatcher")||(da.ReactCurrentDispatcher={current:null});da.hasOwnProperty("ReactCurrentBatchConfig")||(da.ReactCurrentBatchConfig={suspense:null});var si=/^(.*)[\\\/]/,Q="function"===typeof Symbol&&Symbol.for,Pc=Q?Symbol.for("react.element"):60103,gb=Q?Symbol.for("react.portal"):
60106,Ma=Q?Symbol.for("react.fragment"):60107,Af=Q?Symbol.for("react.strict_mode"):60108,kc=Q?Symbol.for("react.profiler"):60114,Cf=Q?Symbol.for("react.provider"):60109,Bf=Q?Symbol.for("react.context"):60110,Hj=Q?Symbol.for("react.concurrent_mode"):60111,zd=Q?Symbol.for("react.forward_ref"):60112,lc=Q?Symbol.for("react.suspense"):60113,yd=Q?Symbol.for("react.suspense_list"):60120,Ad=Q?Symbol.for("react.memo"):60115,Ef=Q?Symbol.for("react.lazy"):60116,Df=Q?Symbol.for("react.block"):60121,zf="function"===
typeof Symbol&&Symbol.iterator,od,xh=function(a){return"undefined"!==typeof MSApp&&MSApp.execUnsafeLocalFunction?function(b,c,d,e){MSApp.execUnsafeLocalFunction(function(){return a(b,c,d,e)})}:a}(function(a,b){if("http://www.w3.org/2000/svg"!==a.namespaceURI||"innerHTML"in a)a.innerHTML=b;else{od=od||document.createElement("div");od.innerHTML="<svg>"+b.valueOf().toString()+"</svg>";for(b=od.firstChild;a.firstChild;)a.removeChild(a.firstChild);for(;b.firstChild;)a.appendChild(b.firstChild)}}),Wb=function(a,
b){if(b){var c=a.firstChild;if(c&&c===a.lastChild&&3===c.nodeType){c.nodeValue=b;return}}a.textContent=b},ib={animationend:nc("Animation","AnimationEnd"),animationiteration:nc("Animation","AnimationIteration"),animationstart:nc("Animation","AnimationStart"),transitionend:nc("Transition","TransitionEnd")},Id={},Of={};wa&&(Of=document.createElement("div").style,"AnimationEvent"in window||(delete ib.animationend.animation,delete ib.animationiteration.animation,delete ib.animationstart.animation),"TransitionEvent"in
window||delete ib.transitionend.transition);var $h=oc("animationend"),ai=oc("animationiteration"),bi=oc("animationstart"),ci=oc("transitionend"),Db="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Pf=new ("function"===typeof WeakMap?WeakMap:Map),Ab=null,wi=function(a){if(a){var b=a._dispatchListeners,c=a._dispatchInstances;
if(Array.isArray(b))for(var d=0;d<b.length&&!a.isPropagationStopped();d++)lf(a,b[d],c[d]);else b&&lf(a,b,c);a._dispatchListeners=null;a._dispatchInstances=null;a.isPersistent()||a.constructor.release(a)}},qc=[],Rd=!1,fa=[],xa=null,ya=null,za=null,Eb=new Map,Fb=new Map,Jb=[],Nd="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput close cancel copy cut paste click change contextmenu reset submit".split(" "),
yi="focus blur dragenter dragleave mouseover mouseout pointerover pointerout gotpointercapture lostpointercapture".split(" "),dg={},cg=new Map,Td=new Map,Rj=["abort","abort",$h,"animationEnd",ai,"animationIteration",bi,"animationStart","canplay","canPlay","canplaythrough","canPlayThrough","durationchange","durationChange","emptied","emptied","encrypted","encrypted","ended","ended","error","error","gotpointercapture","gotPointerCapture","load","load","loadeddata","loadedData","loadedmetadata","loadedMetadata",
"loadstart","loadStart","lostpointercapture","lostPointerCapture","playing","playing","progress","progress","seeking","seeking","stalled","stalled","suspend","suspend","timeupdate","timeUpdate",ci,"transitionEnd","waiting","waiting"];Sd("blur blur cancel cancel click click close close contextmenu contextMenu copy copy cut cut auxclick auxClick dblclick doubleClick dragend dragEnd dragstart dragStart drop drop focus focus input input invalid invalid keydown keyDown keypress keyPress keyup keyUp mousedown mouseDown mouseup mouseUp paste paste pause pause play play pointercancel pointerCancel pointerdown pointerDown pointerup pointerUp ratechange rateChange reset reset seeked seeked submit submit touchcancel touchCancel touchend touchEnd touchstart touchStart volumechange volumeChange".split(" "),
0);Sd("drag drag dragenter dragEnter dragexit dragExit dragleave dragLeave dragover dragOver mousemove mouseMove mouseout mouseOut mouseover mouseOver pointermove pointerMove pointerout pointerOut pointerover pointerOver scroll scroll toggle toggle touchmove touchMove wheel wheel".split(" "),1);Sd(Rj,2);(function(a,b){for(var c=0;c<a.length;c++)Td.set(a[c],b)})("change selectionchange textInput compositionstart compositionend compositionupdate".split(" "),0);var Hi=Zh,Gi=Pd,tc=!0,Kb={animationIterationCount:!0,
borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,
strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Sj=["Webkit","ms","Moz","O"];Object.keys(Kb).forEach(function(a){Sj.forEach(function(b){b=b+a.charAt(0).toUpperCase()+a.substring(1);Kb[b]=Kb[a]})});var Ii=M({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0}),ng="$",og="/$",$d="$?",Zd="$!",Ze=null,$e=null,We="function"===typeof setTimeout?setTimeout:void 0,vj="function"===
typeof clearTimeout?clearTimeout:void 0,jf=Math.random().toString(36).slice(2),Aa="__reactInternalInstance$"+jf,vc="__reactEventHandlers$"+jf,Lb="__reactContainere$"+jf,Ba=null,ce=null,wc=null;M(R.prototype,{preventDefault:function(){this.defaultPrevented=!0;var a=this.nativeEvent;a&&(a.preventDefault?a.preventDefault():"unknown"!==typeof a.returnValue&&(a.returnValue=!1),this.isDefaultPrevented=xc)},stopPropagation:function(){var a=this.nativeEvent;a&&(a.stopPropagation?a.stopPropagation():"unknown"!==
typeof a.cancelBubble&&(a.cancelBubble=!0),this.isPropagationStopped=xc)},persist:function(){this.isPersistent=xc},isPersistent:yc,destructor:function(){var a=this.constructor.Interface,b;for(b in a)this[b]=null;this.nativeEvent=this._targetInst=this.dispatchConfig=null;this.isPropagationStopped=this.isDefaultPrevented=yc;this._dispatchInstances=this._dispatchListeners=null}});R.Interface={type:null,target:null,currentTarget:function(){return null},eventPhase:null,bubbles:null,cancelable:null,timeStamp:function(a){return a.timeStamp||
Date.now()},defaultPrevented:null,isTrusted:null};R.extend=function(a){function b(){return c.apply(this,arguments)}var c=this,d=function(){};d.prototype=c.prototype;d=new d;M(d,b.prototype);b.prototype=d;b.prototype.constructor=b;b.Interface=M({},c.Interface,a);b.extend=c.extend;sg(b);return b};sg(R);var Tj=R.extend({data:null}),Uj=R.extend({data:null}),Ni=[9,13,27,32],de=wa&&"CompositionEvent"in window,cc=null;wa&&"documentMode"in document&&(cc=document.documentMode);var Vj=wa&&"TextEvent"in window&&
!cc,xg=wa&&(!de||cc&&8<cc&&11>=cc),wg=String.fromCharCode(32),ua={beforeInput:{phasedRegistrationNames:{bubbled:"onBeforeInput",captured:"onBeforeInputCapture"},dependencies:["compositionend","keypress","textInput","paste"]},compositionEnd:{phasedRegistrationNames:{bubbled:"onCompositionEnd",captured:"onCompositionEndCapture"},dependencies:"blur compositionend keydown keypress keyup mousedown".split(" ")},compositionStart:{phasedRegistrationNames:{bubbled:"onCompositionStart",captured:"onCompositionStartCapture"},
dependencies:"blur compositionstart keydown keypress keyup mousedown".split(" ")},compositionUpdate:{phasedRegistrationNames:{bubbled:"onCompositionUpdate",captured:"onCompositionUpdateCapture"},dependencies:"blur compositionupdate keydown keypress keyup mousedown".split(" ")}},vg=!1,mb=!1,Wj={eventTypes:ua,extractEvents:function(a,b,c,d,e){var f;if(de)b:{switch(a){case "compositionstart":var g=ua.compositionStart;break b;case "compositionend":g=ua.compositionEnd;break b;case "compositionupdate":g=
ua.compositionUpdate;break b}g=void 0}else mb?tg(a,c)&&(g=ua.compositionEnd):"keydown"===a&&229===c.keyCode&&(g=ua.compositionStart);g?(xg&&"ko"!==c.locale&&(mb||g!==ua.compositionStart?g===ua.compositionEnd&&mb&&(f=rg()):(Ba=d,ce="value"in Ba?Ba.value:Ba.textContent,mb=!0)),e=Tj.getPooled(g,b,c,d),f?e.data=f:(f=ug(c),null!==f&&(e.data=f)),lb(e),f=e):f=null;(a=Vj?Oi(a,c):Pi(a,c))?(b=Uj.getPooled(ua.beforeInput,b,c,d),b.data=a,lb(b)):b=null;return null===f?b:null===b?f:[f,b]}},Qi={color:!0,date:!0,
datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0},Ag={change:{phasedRegistrationNames:{bubbled:"onChange",captured:"onChangeCapture"},dependencies:"blur change click focus input keydown keyup selectionchange".split(" ")}},Mb=null,Nb=null,kf=!1;wa&&(kf=Tf("input")&&(!document.documentMode||9<document.documentMode));var Xj={eventTypes:Ag,_isInputEventSupported:kf,extractEvents:function(a,b,c,d,e){e=b?Pa(b):window;var f=
e.nodeName&&e.nodeName.toLowerCase();if("select"===f||"input"===f&&"file"===e.type)var g=Si;else if(yg(e))if(kf)g=Wi;else{g=Ui;var h=Ti}else(f=e.nodeName)&&"input"===f.toLowerCase()&&("checkbox"===e.type||"radio"===e.type)&&(g=Vi);if(g&&(g=g(a,b)))return zg(g,c,d);h&&h(a,e,b);"blur"===a&&(a=e._wrapperState)&&a.controlled&&"number"===e.type&&Ed(e,"number",e.value)}},dc=R.extend({view:null,detail:null}),Yi={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"},di=0,ei=0,fi=!1,gi=!1,ec=dc.extend({screenX:null,
screenY:null,clientX:null,clientY:null,pageX:null,pageY:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,getModifierState:fe,button:null,buttons:null,relatedTarget:function(a){return a.relatedTarget||(a.fromElement===a.srcElement?a.toElement:a.fromElement)},movementX:function(a){if("movementX"in a)return a.movementX;var b=di;di=a.screenX;return fi?"mousemove"===a.type?a.screenX-b:0:(fi=!0,0)},movementY:function(a){if("movementY"in a)return a.movementY;var b=ei;ei=a.screenY;return gi?"mousemove"===
a.type?a.screenY-b:0:(gi=!0,0)}}),hi=ec.extend({pointerId:null,width:null,height:null,pressure:null,tangentialPressure:null,tiltX:null,tiltY:null,twist:null,pointerType:null,isPrimary:null}),fc={mouseEnter:{registrationName:"onMouseEnter",dependencies:["mouseout","mouseover"]},mouseLeave:{registrationName:"onMouseLeave",dependencies:["mouseout","mouseover"]},pointerEnter:{registrationName:"onPointerEnter",dependencies:["pointerout","pointerover"]},pointerLeave:{registrationName:"onPointerLeave",dependencies:["pointerout",
"pointerover"]}},Yj={eventTypes:fc,extractEvents:function(a,b,c,d,e){var f="mouseover"===a||"pointerover"===a,g="mouseout"===a||"pointerout"===a;if(f&&0===(e&32)&&(c.relatedTarget||c.fromElement)||!g&&!f)return null;f=d.window===d?d:(f=d.ownerDocument)?f.defaultView||f.parentWindow:window;if(g){if(g=b,b=(b=c.relatedTarget||c.toElement)?Bb(b):null,null!==b){var h=Na(b);if(b!==h||5!==b.tag&&6!==b.tag)b=null}}else g=null;if(g===b)return null;if("mouseout"===a||"mouseover"===a){var m=ec;var n=fc.mouseLeave;
var l=fc.mouseEnter;var k="mouse"}else if("pointerout"===a||"pointerover"===a)m=hi,n=fc.pointerLeave,l=fc.pointerEnter,k="pointer";a=null==g?f:Pa(g);f=null==b?f:Pa(b);n=m.getPooled(n,g,c,d);n.type=k+"leave";n.target=a;n.relatedTarget=f;c=m.getPooled(l,b,c,d);c.type=k+"enter";c.target=f;c.relatedTarget=a;d=g;k=b;if(d&&k)a:{m=d;l=k;g=0;for(a=m;a;a=pa(a))g++;a=0;for(b=l;b;b=pa(b))a++;for(;0<g-a;)m=pa(m),g--;for(;0<a-g;)l=pa(l),a--;for(;g--;){if(m===l||m===l.alternate)break a;m=pa(m);l=pa(l)}m=null}else m=
null;l=m;for(m=[];d&&d!==l;){g=d.alternate;if(null!==g&&g===l)break;m.push(d);d=pa(d)}for(d=[];k&&k!==l;){g=k.alternate;if(null!==g&&g===l)break;d.push(k);k=pa(k)}for(k=0;k<m.length;k++)be(m[k],"bubbled",n);for(k=d.length;0<k--;)be(d[k],"captured",c);return 0===(e&64)?[n]:[n,c]}},Qa="function"===typeof Object.is?Object.is:Zi,$i=Object.prototype.hasOwnProperty,Zj=wa&&"documentMode"in document&&11>=document.documentMode,Eg={select:{phasedRegistrationNames:{bubbled:"onSelect",captured:"onSelectCapture"},
dependencies:"blur contextmenu dragend focus keydown keyup mousedown mouseup selectionchange".split(" ")}},nb=null,he=null,Pb=null,ge=!1,ak={eventTypes:Eg,extractEvents:function(a,b,c,d,e,f){e=f||(d.window===d?d.document:9===d.nodeType?d:d.ownerDocument);if(!(f=!e)){a:{e=Jd(e);f=rd.onSelect;for(var g=0;g<f.length;g++)if(!e.has(f[g])){e=!1;break a}e=!0}f=!e}if(f)return null;e=b?Pa(b):window;switch(a){case "focus":if(yg(e)||"true"===e.contentEditable)nb=e,he=b,Pb=null;break;case "blur":Pb=he=nb=null;
break;case "mousedown":ge=!0;break;case "contextmenu":case "mouseup":case "dragend":return ge=!1,Dg(c,d);case "selectionchange":if(Zj)break;case "keydown":case "keyup":return Dg(c,d)}return null}},bk=R.extend({animationName:null,elapsedTime:null,pseudoElement:null}),ck=R.extend({clipboardData:function(a){return"clipboardData"in a?a.clipboardData:window.clipboardData}}),dk=dc.extend({relatedTarget:null}),ek={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",
Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},fk={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",
224:"Meta"},gk=dc.extend({key:function(a){if(a.key){var b=ek[a.key]||a.key;if("Unidentified"!==b)return b}return"keypress"===a.type?(a=Ac(a),13===a?"Enter":String.fromCharCode(a)):"keydown"===a.type||"keyup"===a.type?fk[a.keyCode]||"Unidentified":""},location:null,ctrlKey:null,shiftKey:null,altKey:null,metaKey:null,repeat:null,locale:null,getModifierState:fe,charCode:function(a){return"keypress"===a.type?Ac(a):0},keyCode:function(a){return"keydown"===a.type||"keyup"===a.type?a.keyCode:0},which:function(a){return"keypress"===
a.type?Ac(a):"keydown"===a.type||"keyup"===a.type?a.keyCode:0}}),hk=ec.extend({dataTransfer:null}),ik=dc.extend({touches:null,targetTouches:null,changedTouches:null,altKey:null,metaKey:null,ctrlKey:null,shiftKey:null,getModifierState:fe}),jk=R.extend({propertyName:null,elapsedTime:null,pseudoElement:null}),kk=ec.extend({deltaX:function(a){return"deltaX"in a?a.deltaX:"wheelDeltaX"in a?-a.wheelDeltaX:0},deltaY:function(a){return"deltaY"in a?a.deltaY:"wheelDeltaY"in a?-a.wheelDeltaY:"wheelDelta"in a?
-a.wheelDelta:0},deltaZ:null,deltaMode:null}),lk={eventTypes:dg,extractEvents:function(a,b,c,d,e){e=cg.get(a);if(!e)return null;switch(a){case "keypress":if(0===Ac(c))return null;case "keydown":case "keyup":a=gk;break;case "blur":case "focus":a=dk;break;case "click":if(2===c.button)return null;case "auxclick":case "dblclick":case "mousedown":case "mousemove":case "mouseup":case "mouseout":case "mouseover":case "contextmenu":a=ec;break;case "drag":case "dragend":case "dragenter":case "dragexit":case "dragleave":case "dragover":case "dragstart":case "drop":a=
hk;break;case "touchcancel":case "touchend":case "touchmove":case "touchstart":a=ik;break;case $h:case ai:case bi:a=bk;break;case ci:a=jk;break;case "scroll":a=dc;break;case "wheel":a=kk;break;case "copy":case "cut":case "paste":a=ck;break;case "gotpointercapture":case "lostpointercapture":case "pointercancel":case "pointerdown":case "pointermove":case "pointerout":case "pointerover":case "pointerup":a=hi;break;default:a=R}b=a.getPooled(e,b,c,d);lb(b);return b}};(function(a){if(ic)throw Error(k(101));
ic=Array.prototype.slice.call(a);nf()})("ResponderEventPlugin SimpleEventPlugin EnterLeaveEventPlugin ChangeEventPlugin SelectEventPlugin BeforeInputEventPlugin".split(" "));(function(a,b,c){td=a;rf=b;mf=c})(ae,Hb,Pa);pf({SimpleEventPlugin:lk,EnterLeaveEventPlugin:Yj,ChangeEventPlugin:Xj,SelectEventPlugin:ak,BeforeInputEventPlugin:Wj});var ie=[],ob=-1,Ca={},B={current:Ca},G={current:!1},Ra=Ca,bj=Pd,je=$f,Rg=Lj,aj=Nj,Dc=Oj,Ig=Zh,Jg=ag,Kg=Pj,Lg=Qj,Qg={},yj=Mj,Cj=void 0!==Yh?Yh:function(){},qa=null,
Ec=null,ke=!1,ii=ff(),Y=1E4>ii?ff:function(){return ff()-ii},Ic={current:null},Hc=null,qb=null,Gc=null,Tg=0,Jc=2,Ga=!1,Vb=da.ReactCurrentBatchConfig,$g=(new ea.Component).refs,Mc={isMounted:function(a){return(a=a._reactInternalFiber)?Na(a)===a:!1},enqueueSetState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;d=Va(d,a,e);e=Ea(d,e);e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueReplaceState:function(a,b,c){a=a._reactInternalFiber;var d=ka(),e=Vb.suspense;
d=Va(d,a,e);e=Ea(d,e);e.tag=1;e.payload=b;void 0!==c&&null!==c&&(e.callback=c);Fa(a,e);Ja(a,d)},enqueueForceUpdate:function(a,b){a=a._reactInternalFiber;var c=ka(),d=Vb.suspense;c=Va(c,a,d);d=Ea(c,d);d.tag=Jc;void 0!==b&&null!==b&&(d.callback=b);Fa(a,d);Ja(a,c)}},Qc=Array.isArray,wb=ah(!0),Fe=ah(!1),Sb={},ja={current:Sb},Ub={current:Sb},Tb={current:Sb},D={current:0},Sc=da.ReactCurrentDispatcher,X=da.ReactCurrentBatchConfig,Ia=0,z=null,K=null,J=null,Uc=!1,Tc={readContext:W,useCallback:S,useContext:S,
useEffect:S,useImperativeHandle:S,useLayoutEffect:S,useMemo:S,useReducer:S,useRef:S,useState:S,useDebugValue:S,useResponder:S,useDeferredValue:S,useTransition:S},dj={readContext:W,useCallback:ih,useContext:W,useEffect:eh,useImperativeHandle:function(a,b,c){c=null!==c&&void 0!==c?c.concat([a]):null;return ze(4,2,gh.bind(null,b,a),c)},useLayoutEffect:function(a,b){return ze(4,2,a,b)},useMemo:function(a,b){var c=ub();b=void 0===b?null:b;a=a();c.memoizedState=[a,b];return a},useReducer:function(a,b,c){var d=
ub();b=void 0!==c?c(b):b;d.memoizedState=d.baseState=b;a=d.queue={pending:null,dispatch:null,lastRenderedReducer:a,lastRenderedState:b};a=a.dispatch=ch.bind(null,z,a);return[d.memoizedState,a]},useRef:function(a){var b=ub();a={current:a};return b.memoizedState=a},useState:xe,useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=xe(a),d=c[0],e=c[1];eh(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=
xe(!1),c=b[0];b=b[1];return[ih(Ce.bind(null,b,a),[b,a]),c]}},ej={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Vc,useRef:dh,useState:function(a){return Vc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Vc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Vc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,
b,a),[b,a]),c]}},fj={readContext:W,useCallback:Yc,useContext:W,useEffect:Xc,useImperativeHandle:hh,useLayoutEffect:fh,useMemo:jh,useReducer:Wc,useRef:dh,useState:function(a){return Wc(Ua)},useDebugValue:Be,useResponder:ue,useDeferredValue:function(a,b){var c=Wc(Ua),d=c[0],e=c[1];Xc(function(){var c=X.suspense;X.suspense=void 0===b?null:b;try{e(a)}finally{X.suspense=c}},[a,b]);return d},useTransition:function(a){var b=Wc(Ua),c=b[0];b=b[1];return[Yc(Ce.bind(null,b,a),[b,a]),c]}},ra=null,Ka=null,Wa=
!1,gj=da.ReactCurrentOwner,ia=!1,Je={dehydrated:null,retryTime:0};var jj=function(a,b,c,d){for(c=b.child;null!==c;){if(5===c.tag||6===c.tag)a.appendChild(c.stateNode);else if(4!==c.tag&&null!==c.child){c.child.return=c;c=c.child;continue}if(c===b)break;for(;null===c.sibling;){if(null===c.return||c.return===b)return;c=c.return}c.sibling.return=c.return;c=c.sibling}};var wh=function(a){};var ij=function(a,b,c,d,e){var f=a.memoizedProps;if(f!==d){var g=b.stateNode;Ta(ja.current);a=null;switch(c){case "input":f=
Cd(g,f);d=Cd(g,d);a=[];break;case "option":f=Fd(g,f);d=Fd(g,d);a=[];break;case "select":f=M({},f,{value:void 0});d=M({},d,{value:void 0});a=[];break;case "textarea":f=Gd(g,f);d=Gd(g,d);a=[];break;default:"function"!==typeof f.onClick&&"function"===typeof d.onClick&&(g.onclick=uc)}Ud(c,d);var h,m;c=null;for(h in f)if(!d.hasOwnProperty(h)&&f.hasOwnProperty(h)&&null!=f[h])if("style"===h)for(m in g=f[h],g)g.hasOwnProperty(m)&&(c||(c={}),c[m]="");else"dangerouslySetInnerHTML"!==h&&"children"!==h&&"suppressContentEditableWarning"!==
h&&"suppressHydrationWarning"!==h&&"autoFocus"!==h&&(db.hasOwnProperty(h)?a||(a=[]):(a=a||[]).push(h,null));for(h in d){var k=d[h];g=null!=f?f[h]:void 0;if(d.hasOwnProperty(h)&&k!==g&&(null!=k||null!=g))if("style"===h)if(g){for(m in g)!g.hasOwnProperty(m)||k&&k.hasOwnProperty(m)||(c||(c={}),c[m]="");for(m in k)k.hasOwnProperty(m)&&g[m]!==k[m]&&(c||(c={}),c[m]=k[m])}else c||(a||(a=[]),a.push(h,c)),c=k;else"dangerouslySetInnerHTML"===h?(k=k?k.__html:void 0,g=g?g.__html:void 0,null!=k&&g!==k&&(a=a||
[]).push(h,k)):"children"===h?g===k||"string"!==typeof k&&"number"!==typeof k||(a=a||[]).push(h,""+k):"suppressContentEditableWarning"!==h&&"suppressHydrationWarning"!==h&&(db.hasOwnProperty(h)?(null!=k&&oa(e,h),a||g===k||(a=[])):(a=a||[]).push(h,k))}c&&(a=a||[]).push("style",c);e=a;if(b.updateQueue=e)b.effectTag|=4}};var kj=function(a,b,c,d){c!==d&&(b.effectTag|=4)};var pj="function"===typeof WeakSet?WeakSet:Set,wj="function"===typeof WeakMap?WeakMap:Map,sj=Math.ceil,gd=da.ReactCurrentDispatcher,
Uh=da.ReactCurrentOwner,H=0,Ye=8,ca=16,ma=32,Xa=0,hd=1,Oh=2,ad=3,bd=4,Xe=5,p=H,U=null,t=null,P=0,F=Xa,id=null,ta=1073741823,Yb=1073741823,kd=null,Xb=0,jd=!1,Re=0,Ph=500,l=null,cd=!1,Se=null,La=null,ld=!1,Zb=null,$b=90,bb=null,ac=0,af=null,dd=0,Ja=function(a,b){if(50<ac)throw ac=0,af=null,Error(k(185));a=ed(a,b);if(null!==a){var c=Cc();1073741823===b?(p&Ye)!==H&&(p&(ca|ma))===H?Te(a):(V(a),p===H&&ha()):V(a);(p&4)===H||98!==c&&99!==c||(null===bb?bb=new Map([[a,b]]):(c=bb.get(a),(void 0===c||c>b)&&bb.set(a,
b)))}};var zj=function(a,b,c){var d=b.expirationTime;if(null!==a){var e=b.pendingProps;if(a.memoizedProps!==e||G.current)ia=!0;else{if(d<c){ia=!1;switch(b.tag){case 3:sh(b);Ee();break;case 5:bh(b);if(b.mode&4&&1!==c&&e.hidden)return b.expirationTime=b.childExpirationTime=1,null;break;case 1:N(b.type)&&Bc(b);break;case 4:se(b,b.stateNode.containerInfo);break;case 10:d=b.memoizedProps.value;e=b.type._context;y(Ic,e._currentValue);e._currentValue=d;break;case 13:if(null!==b.memoizedState){d=b.child.childExpirationTime;
if(0!==d&&d>=c)return th(a,b,c);y(D,D.current&1);b=sa(a,b,c);return null!==b?b.sibling:null}y(D,D.current&1);break;case 19:d=b.childExpirationTime>=c;if(0!==(a.effectTag&64)){if(d)return vh(a,b,c);b.effectTag|=64}e=b.memoizedState;null!==e&&(e.rendering=null,e.tail=null);y(D,D.current);if(!d)return null}return sa(a,b,c)}ia=!1}}else ia=!1;b.expirationTime=0;switch(b.tag){case 2:d=b.type;null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;e=pb(b,B.current);rb(b,c);e=we(null,
b,d,a,e,c);b.effectTag|=1;if("object"===typeof e&&null!==e&&"function"===typeof e.render&&void 0===e.$$typeof){b.tag=1;b.memoizedState=null;b.updateQueue=null;if(N(d)){var f=!0;Bc(b)}else f=!1;b.memoizedState=null!==e.state&&void 0!==e.state?e.state:null;ne(b);var g=d.getDerivedStateFromProps;"function"===typeof g&&Lc(b,d,g,a);e.updater=Mc;b.stateNode=e;e._reactInternalFiber=b;pe(b,d,a,c);b=Ie(null,b,d,!0,f,c)}else b.tag=0,T(null,b,e,c),b=b.child;return b;case 16:a:{e=b.elementType;null!==a&&(a.alternate=
null,b.alternate=null,b.effectTag|=2);a=b.pendingProps;ri(e);if(1!==e._status)throw e._result;e=e._result;b.type=e;f=b.tag=Gj(e);a=aa(e,a);switch(f){case 0:b=He(null,b,e,a,c);break a;case 1:b=rh(null,b,e,a,c);break a;case 11:b=nh(null,b,e,a,c);break a;case 14:b=oh(null,b,e,aa(e.type,a),d,c);break a}throw Error(k(306,e,""));}return b;case 0:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),He(a,b,d,e,c);case 1:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),rh(a,b,d,e,c);
case 3:sh(b);d=b.updateQueue;if(null===a||null===d)throw Error(k(282));d=b.pendingProps;e=b.memoizedState;e=null!==e?e.element:null;oe(a,b);Qb(b,d,null,c);d=b.memoizedState.element;if(d===e)Ee(),b=sa(a,b,c);else{if(e=b.stateNode.hydrate)Ka=kb(b.stateNode.containerInfo.firstChild),ra=b,e=Wa=!0;if(e)for(c=Fe(b,null,d,c),b.child=c;c;)c.effectTag=c.effectTag&-3|1024,c=c.sibling;else T(a,b,d,c),Ee();b=b.child}return b;case 5:return bh(b),null===a&&De(b),d=b.type,e=b.pendingProps,f=null!==a?a.memoizedProps:
null,g=e.children,Yd(d,e)?g=null:null!==f&&Yd(d,f)&&(b.effectTag|=16),qh(a,b),b.mode&4&&1!==c&&e.hidden?(b.expirationTime=b.childExpirationTime=1,b=null):(T(a,b,g,c),b=b.child),b;case 6:return null===a&&De(b),null;case 13:return th(a,b,c);case 4:return se(b,b.stateNode.containerInfo),d=b.pendingProps,null===a?b.child=wb(b,null,d,c):T(a,b,d,c),b.child;case 11:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),nh(a,b,d,e,c);case 7:return T(a,b,b.pendingProps,c),b.child;case 8:return T(a,
b,b.pendingProps.children,c),b.child;case 12:return T(a,b,b.pendingProps.children,c),b.child;case 10:a:{d=b.type._context;e=b.pendingProps;g=b.memoizedProps;f=e.value;var h=b.type._context;y(Ic,h._currentValue);h._currentValue=f;if(null!==g)if(h=g.value,f=Qa(h,f)?0:("function"===typeof d._calculateChangedBits?d._calculateChangedBits(h,f):1073741823)|0,0===f){if(g.children===e.children&&!G.current){b=sa(a,b,c);break a}}else for(h=b.child,null!==h&&(h.return=b);null!==h;){var m=h.dependencies;if(null!==
m){g=h.child;for(var l=m.firstContext;null!==l;){if(l.context===d&&0!==(l.observedBits&f)){1===h.tag&&(l=Ea(c,null),l.tag=Jc,Fa(h,l));h.expirationTime<c&&(h.expirationTime=c);l=h.alternate;null!==l&&l.expirationTime<c&&(l.expirationTime=c);Sg(h.return,c);m.expirationTime<c&&(m.expirationTime=c);break}l=l.next}}else g=10===h.tag?h.type===b.type?null:h.child:h.child;if(null!==g)g.return=h;else for(g=h;null!==g;){if(g===b){g=null;break}h=g.sibling;if(null!==h){h.return=g.return;g=h;break}g=g.return}h=
g}T(a,b,e.children,c);b=b.child}return b;case 9:return e=b.type,f=b.pendingProps,d=f.children,rb(b,c),e=W(e,f.unstable_observedBits),d=d(e),b.effectTag|=1,T(a,b,d,c),b.child;case 14:return e=b.type,f=aa(e,b.pendingProps),f=aa(e.type,f),oh(a,b,e,f,d,c);case 15:return ph(a,b,b.type,b.pendingProps,d,c);case 17:return d=b.type,e=b.pendingProps,e=b.elementType===d?e:aa(d,e),null!==a&&(a.alternate=null,b.alternate=null,b.effectTag|=2),b.tag=1,N(d)?(a=!0,Bc(b)):a=!1,rb(b,c),Yg(b,d,e),pe(b,d,e,c),Ie(null,
b,d,!0,a,c);case 19:return vh(a,b,c)}throw Error(k(156,b.tag));};var bf=null,Ne=null,la=function(a,b,c,d){return new Fj(a,b,c,d)};ef.prototype.render=function(a){md(a,this._internalRoot,null,null)};ef.prototype.unmount=function(){var a=this._internalRoot,b=a.containerInfo;md(null,a,null,function(){b[Lb]=null})};var Di=function(a){if(13===a.tag){var b=Fc(ka(),150,100);Ja(a,b);df(a,b)}};var Yf=function(a){13===a.tag&&(Ja(a,3),df(a,3))};var Bi=function(a){if(13===a.tag){var b=ka();b=Va(b,a,null);Ja(a,
b);df(a,b)}};sd=function(a,b,c){switch(b){case "input":Dd(a,c);b=c.name;if("radio"===c.type&&null!=b){for(c=a;c.parentNode;)c=c.parentNode;c=c.querySelectorAll("input[name="+JSON.stringify(""+b)+'][type="radio"]');for(b=0;b<c.length;b++){var d=c[b];if(d!==a&&d.form===a.form){var e=ae(d);if(!e)throw Error(k(90));Gf(d);Dd(d,e)}}}break;case "textarea":Lf(a,c);break;case "select":b=c.value,null!=b&&hb(a,!!c.multiple,b,!1)}};(function(a,b,c,d){ee=a;eg=b;vd=c;vf=d})(Qh,function(a,b,c,d,e){var f=p;p|=4;
try{return Da(98,a.bind(null,b,c,d,e))}finally{p=f,p===H&&ha()}},function(){(p&(1|ca|ma))===H&&(uj(),xb())},function(a,b){var c=p;p|=2;try{return a(b)}finally{p=c,p===H&&ha()}});var mk={Events:[Hb,Pa,ae,pf,qd,lb,function(a){Kd(a,Ki)},sf,tf,sc,pc,xb,{current:!1}]};(function(a){var b=a.findFiberByHostInstance;return Ej(M({},a,{overrideHookState:null,overrideProps:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:da.ReactCurrentDispatcher,findHostInstanceByFiber:function(a){a=Sf(a);
return null===a?null:a.stateNode},findFiberByHostInstance:function(a){return b?b(a):null},findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null}))})({findFiberByHostInstance:Bb,bundleType:0,version:"16.13.1",rendererPackageName:"react-dom"});I.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=mk;I.createPortal=Xh;I.findDOMNode=function(a){if(null==a)return null;if(1===a.nodeType)return a;var b=a._reactInternalFiber;if(void 0===
b){if("function"===typeof a.render)throw Error(k(188));throw Error(k(268,Object.keys(a)));}a=Sf(b);a=null===a?null:a.stateNode;return a};I.flushSync=function(a,b){if((p&(ca|ma))!==H)throw Error(k(187));var c=p;p|=1;try{return Da(99,a.bind(null,b))}finally{p=c,ha()}};I.hydrate=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!0,c)};I.render=function(a,b,c){if(!bc(b))throw Error(k(200));return nd(null,a,b,!1,c)};I.unmountComponentAtNode=function(a){if(!bc(a))throw Error(k(40));return a._reactRootContainer?
(Rh(function(){nd(null,null,a,!1,function(){a._reactRootContainer=null;a[Lb]=null})}),!0):!1};I.unstable_batchedUpdates=Qh;I.unstable_createPortal=function(a,b){return Xh(a,b,2<arguments.length&&void 0!==arguments[2]?arguments[2]:null)};I.unstable_renderSubtreeIntoContainer=function(a,b,c,d){if(!bc(c))throw Error(k(200));if(null==a||void 0===a._reactInternalFiber)throw Error(k(38));return nd(a,b,c,!1,d)};I.version="16.13.1"});
</script>
    <script>const e = React.createElement;

function pathToString(path) {
  if (path[0] === '/') {
    return '/' + path.slice(1).join('/');
  } else {
    return path.join('/');
  }
}

function findCommonPath(files) {
  if (!files || !files.length) {
    return [];
  }

  function isPrefix(arr, prefix) {
    if (arr.length < prefix.length) {
      return false;
    }
    for (let i = prefix.length - 1; i >= 0; --i) {
      if (arr[i] !== prefix[i]) {
        return false;
      }
    }
    return true;
  }

  let commonPath = files[0].path.slice(0, -1);
  while (commonPath.length) {
    if (files.every(file => isPrefix(file.path, commonPath))) {
      break;
    }
    commonPath.pop();
  }
  return commonPath;
}

function findFolders(files) {
  if (!files || !files.length) {
    return [];
  }

  let folders = files.filter(file => file.path.length > 1).map(file => file.path[0]);
  folders = [...new Set(folders)]; // unique
  folders.sort();

  folders = folders.map(folder => {
    let filesInFolder = files
      .filter(file => file.path[0] === folder)
      .map(file => ({
        ...file,
        path: file.path.slice(1),
        parent: [...file.parent, file.path[0]],
      }));

    const children = findFolders(filesInFolder); // recursion

    return {
      is_folder: true,
      path: [folder],
      parent: files[0].parent,
      children,
      covered: children.reduce((sum, file) => sum + file.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.coverable, 0),
      prevRun: {
        covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
        coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
      },
    };
  });

  return [...folders, ...files.filter(file => file.path.length === 1)];
}

class App extends React.Component {
  constructor(...args) {
    super(...args);

    this.state = {
      current: [],
    };
  }

  componentDidMount() {
    this.updateStateFromLocation();
    window.addEventListener('hashchange', () => this.updateStateFromLocation(), false);
  }

  updateStateFromLocation() {
    if (window.location.hash.length > 1) {
      const current = window.location.hash.slice(1).split('/');
      this.setState({current});
    } else {
      this.setState({current: []});
    }
  }

  getCurrentPath() {
    let file = this.props.root;
    let path = [file];
    for (let p of this.state.current) {
      file = file.children.find(file => file.path[0] === p);
      if (!file) {
        return path;
      }
      path.push(file);
    }
    return path;
  }

  render() {
    const path = this.getCurrentPath();
    const file = path[path.length - 1];

    let w = null;
    if (file.is_folder) {
      w = e(FilesList, {
        folder: file,
        onSelectFile: this.selectFile.bind(this),
        onBack: path.length > 1 ? this.back.bind(this) : null,
      });
    } else {
      w = e(DisplayFile, {
        file,
        onBack: this.back.bind(this),
      });
    }

    return e('div', {className: 'app'}, w);
  }

  selectFile(file) {
    this.setState(
      ({current}) => {
        return {current: [...current, file.path[0]]};
      },
      () => this.updateHash(),
    );
  }

  back(file) {
    this.setState(
      ({current}) => {
        return {current: current.slice(0, current.length - 1)};
      },
      () => this.updateHash(),
    );
  }

  updateHash() {
    if (!this.state.current || !this.state.current.length) {
      window.location = '#';
    } else {
      window.location = '#' + this.state.current.join('/');
    }
  }
}

function FilesList({folder, onSelectFile, onBack}) {
  let files = folder.children;
  return e(
    'div',
    {className: 'display-folder'},
    e(FileHeader, {file: folder, onBack}),
    e(
      'table',
      {className: 'files-list'},
      e('thead', {className: 'files-list__head'}, e('tr', null, e('th', null, 'Path'), e('th', null, 'Coverage'))),
      e(
        'tbody',
        {className: 'files-list__body'},
        files.map(file => e(File, {file, onClick: onSelectFile})),
      ),
    ),
  );
}

function File({file, onClick}) {
  const coverage = file.coverable ? (file.covered / file.coverable) * 100 : -1;
  const coverageDelta =
    file.prevRun && (file.covered / file.coverable) * 100 - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'tr',
    {
      className:
        'files-list__file' +
        (coverage >= 0 && coverage < 50 ? ' files-list__file_low' : '') +
        (coverage >= 50 && coverage < 80 ? ' files-list__file_medium' : '') +
        (coverage >= 80 ? ' files-list__file_high' : '') +
        (file.is_folder ? ' files-list__file_folder' : ''),
      onClick: () => onClick(file),
    },
    e('td', null, e('a', null, pathToString(file.path))),
    e(
      'td',
      null,
      file.covered + ' / ' + file.coverable + (coverage >= 0 ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
    ),
  );
}

function DisplayFile({file, onBack}) {
  return e('div', {className: 'display-file'}, e(FileHeader, {file, onBack}), e(FileContent, {file}));
}

function FileHeader({file, onBack}) {
  const coverage = (file.covered / file.coverable) * 100;
  const coverageDelta = file.prevRun && coverage - (file.prevRun.covered / file.prevRun.coverable) * 100;

  return e(
    'div',
    {className: 'file-header'},
    onBack ? e('a', {className: 'file-header__back', onClick: onBack}, 'Back') : null,
    e('div', {className: 'file-header__name'}, pathToString([...file.parent, ...file.path])),
    e(
      'div',
      {className: 'file-header__stat'},
      'Covered: ' + file.covered + ' of ' + file.coverable + (file.coverable ? ' (' + coverage.toFixed(2) + '%)' : ''),
      e(
        'span',
        {title: 'Change from the previous run'},
        coverageDelta ? ` (${coverageDelta > 0 ? '+' : ''}${coverageDelta.toFixed(2)}%)` : '',
      ),
      e('input', {id: 'theme-toggle', type: 'checkbox', hidden: true}),
      e('label', {for: 'theme-toggle', id: 'theme-toggle-label'}, 'üåô'),
    ),
  );
}

function FileContent({file}) {
  return e(
    'pre',
    {className: 'file-content'},
    file.content.split(/\r?\n/).map((line, index) => {
      const trace = file.traces.find(trace => trace.line === index + 1);
      const covered = trace && trace.stats.Line;
      const uncovered = trace && !trace.stats.Line;
      return e(
        'code',
        {
          className: 'code-line' + (covered ? ' code-line_covered' : '') + (uncovered ? ' code-line_uncovered' : ''),
          title: trace ? JSON.stringify(trace.stats, null, 2) : null,
        },
        line,
      );
    }),
  );
}

(function () {
  const commonPath = findCommonPath(data.files);
  const prevFilesMap = new Map();

  previousData &&
    previousData.files.forEach(file => {
      const path = file.path.slice(commonPath.length).join('/');
      prevFilesMap.set(path, file);
    });

  const files = data.files.map(file => {
    const path = file.path.slice(commonPath.length);
    const {covered = 0, coverable = 0} = prevFilesMap.get(path.join('/')) || {};
    return {
      ...file,
      path,
      parent: commonPath,
      prevRun: {covered, coverable},
    };
  });

  const children = findFolders(files);

  const root = {
    is_folder: true,
    children,
    path: commonPath,
    parent: [],
    covered: children.reduce((sum, file) => sum + file.covered, 0),
    coverable: children.reduce((sum, file) => sum + file.coverable, 0),
    prevRun: {
      covered: children.reduce((sum, file) => sum + file.prevRun.covered, 0),
      coverable: children.reduce((sum, file) => sum + file.prevRun.coverable, 0),
    },
  };

  ReactDOM.render(e(App, {root, prevFilesMap}), document.getElementById('root'));

  const toggle = document.getElementById('theme-toggle');
  const label = document.getElementById('theme-toggle-label');
  label.textContent = 'üåô';

  toggle.addEventListener('change', () => {
    if (toggle.checked) {
      document.documentElement.setAttribute('data-theme', 'dark');
      label.textContent = '‚òÄÔ∏è';
    } else {
      document.documentElement.removeAttribute('data-theme');
      label.textContent = 'üåô';
    }
  });
})();
</script>
</body>
</html>